{% extends "base.html" %}

{% block title %}ê³ ê¸‰ ì„¤ì • - QuickRail{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2 style="margin: 0;">ğŸ” ê³ ê¸‰ ì„¤ì •</h2>
        <a href="{{ url_for('main.settings') }}" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
            â† ì„¤ì •ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
    </div>
    
    <!-- API í‚¤ ê´€ë¦¬ (Super Adminë§Œ) -->
    <div id="apikeySettings" class="settings-section">
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
            <h3 style="margin-top: 0;">OpenAI API í‚¤ ê´€ë¦¬</h3>
            <p style="color: #666; margin-bottom: 0;">
                ë²ˆì—­ ê¸°ëŠ¥ì— ì‚¬ìš©ë˜ëŠ” OpenAI API í‚¤ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.<br>
                <strong>âš ï¸ Super Adminë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</strong>
            </p>
        </div>
        
        <!-- í˜„ì¬ í™œì„± API í‚¤ -->
        <div style="background: #e8f5e9; padding: 1.5rem; border-radius: 8px; border: 2px solid #4caf50; margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="margin: 0; color: #2e7d32;">âœ“ í˜„ì¬ í™œì„± API í‚¤</h4>
                <button class="btn btn-primary" onclick="editAPIKey({{ active_api_key.id if active_api_key else 'null' }})" style="padding: 0.5rem 1rem;">
                    í¸ì§‘
                </button>
            </div>
            {% if active_api_key %}
            <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>ì´ë¦„:</strong> {{ active_api_key.name }}
            </div>
            <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>API í‚¤:</strong> <code>{{ active_api_key.api_key[:10] }}...{{ active_api_key.api_key[-4:] }}</code>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>ë§ˆì§€ë§‰ ì‚¬ìš©:</strong> {{ active_api_key.last_used_at.strftime('%Y-%m-%d %H:%M') if active_api_key.last_used_at else 'ì‚¬ìš© ê¸°ë¡ ì—†ìŒ' }}
            </div>
            <div style="margin-top: 1rem;">
                <button class="btn btn-info" onclick="checkAPIUsage()" style="padding: 0.5rem 1rem;">
                    ğŸ“Š ì‚¬ìš©ëŸ‰ í™•ì¸
                </button>
            </div>
            {% else %}
            <div style="background: white; padding: 1rem; border-radius: 4px; color: #999;">
                í™œì„±í™”ëœ API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. API í‚¤ë¥¼ ì¶”ê°€í•˜ê³  í™œì„±í™”í•˜ì„¸ìš”.
            </div>
            {% endif %}
        </div>
        
        <!-- ì‚¬ìš©ëŸ‰ í†µê³„ -->
        <div id="usageStats" style="background: #fff3cd; padding: 1.5rem; border-radius: 8px; border: 1px solid #ffc107; margin-bottom: 2rem; display: none;">
            <h4 style="margin-top: 0;">ğŸ“Š API ì‚¬ìš©ëŸ‰ í†µê³„</h4>
            <div id="usageContent" style="font-family: monospace;">
                ë¡œë”© ì¤‘...
            </div>
        </div>
        
        <!-- API í‚¤ ëª©ë¡ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h4>ì €ì¥ëœ API í‚¤</h4>
            <button class="btn btn-success" onclick="createNewAPIKey()" style="padding: 0.5rem 1rem;">
                + ìƒˆ API í‚¤ ì¶”ê°€
            </button>
        </div>
        
        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f5f5f5;">
                    <tr>
                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">ì´ë¦„</th>
                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">API í‚¤</th>
                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">ìƒíƒœ</th>
                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">ë§ˆì§€ë§‰ ì‚¬ìš©</th>
                        <th style="padding: 1rem; text-align: center; border-bottom: 1px solid #ddd;">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key in api_keys %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 1rem;">{{ key.name }}</td>
                        <td style="padding: 1rem;"><code>{{ key.api_key[:10] }}...{{ key.api_key[-4:] }}</code></td>
                        <td style="padding: 1rem;">
                            {% if key.is_active %}
                            <span style="background: #4caf50; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">í™œì„±</span>
                            {% else %}
                            <span style="background: #999; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">ë¹„í™œì„±</span>
                            {% endif %}
                        </td>
                        <td style="padding: 1rem; color: #666;">{{ key.last_used_at.strftime('%Y-%m-%d %H:%M') if key.last_used_at else '-' }}</td>
                        <td style="padding: 1rem; text-align: center;">
                            <button class="btn btn-sm btn-primary" onclick="editAPIKey({{ key.id }})" style="padding: 0.25rem 0.75rem; margin-right: 0.5rem;">í¸ì§‘</button>
                            {% if not key.is_active %}
                            <button class="btn btn-sm btn-success" onclick="activateAPIKey({{ key.id }})" style="padding: 0.25rem 0.75rem; margin-right: 0.5rem;">í™œì„±í™”</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAPIKey({{ key.id }})" style="padding: 0.25rem 0.75rem;">ì‚­ì œ</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not api_keys %}
                    <tr>
                        <td colspan="5" style="padding: 2rem; text-align: center; color: #999;">
                            ì €ì¥ëœ API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- API í‚¤ í¸ì§‘ ëª¨ë‹¬ -->
<div id="apikeyModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="apikeyModalTitle">API í‚¤ í¸ì§‘</h3>
            <button class="close" onclick="closeAPIKeyModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="apikeyForm">
                <input type="hidden" id="apikeyId">
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">í‚¤ ì´ë¦„</label>
                    <input type="text" id="apikeyName" class="form-control" required 
                           placeholder="ì˜ˆ: Production, Test" 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666;">êµ¬ë¶„í•˜ê¸° ì‰¬ìš´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">OpenAI API í‚¤</label>
                    <input type="password" id="apikeyValue" class="form-control" required 
                           placeholder="sk-..." 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                    <small style="color: #666;">
                        OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (sk-ë¡œ ì‹œì‘)<br>
                        <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI API í‚¤ ë°œê¸‰ â†’</a>
                    </small>
                </div>
                
                <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; border: 1px solid #ffc107;">
                    <strong>âš ï¸ ë³´ì•ˆ ì£¼ì˜ì‚¬í•­</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                        <li>API í‚¤ëŠ” ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤</li>
                        <li>Super Adminë§Œ ì¡°íšŒ ë° ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                        <li>API í‚¤ëŠ” ì ˆëŒ€ ì™¸ë¶€ì— ê³µìœ í•˜ì§€ ë§ˆì„¸ìš”</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeAPIKeyModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.btn-sm {
    font-size: 0.85rem;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 0;
    border: 1px solid #888;
    width: 90%;
    max-width: 600px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
}

.modal-body {
    padding: 1.5rem;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    border: none;
    background: none;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #000;
}

/* Toast ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
.toast-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.toast {
    background: #2ecc71;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 300px;
    max-width: 400px;
    animation: slideInRight 0.3s ease-out;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 500;
}

.toast.error {
    background: #e74c3c;
}

.toast.warning {
    background: #f39c12;
}

.toast.info {
    background: #3498db;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.toast.hiding {
    animation: slideOutRight 0.3s ease-out forwards;
}
</style>

<!-- Toast ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
<div class="toast-container" id="toastContainer"></div>

<script>
// Toast ì•Œë¦¼ í•¨ìˆ˜
function showToast(message, type = 'success', duration = 3000) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    // ì•„ì´ì½˜ ì„¤ì •
    let icon = 'âœ“';
    if (type === 'error') icon = 'âœ•';
    else if (type === 'warning') icon = 'âš ';
    else if (type === 'info') icon = 'â„¹';
    
    toast.innerHTML = `
        <span style="font-size: 1.2rem;">${icon}</span>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    // ìë™ ì œê±°
    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, duration);
}

// ============================================================
// API í‚¤ ê´€ë¦¬ í•¨ìˆ˜
// ============================================================

function createNewAPIKey() {
    document.getElementById('apikeyModalTitle').textContent = 'ìƒˆ API í‚¤ ì¶”ê°€';
    document.getElementById('apikeyId').value = '';
    document.getElementById('apikeyName').value = '';
    document.getElementById('apikeyValue').value = '';
    document.getElementById('apikeyModal').classList.add('show');
}

async function editAPIKey(keyId) {
    try {
        const res = await fetch(`/api/api-keys/${keyId}`);
        if (!res.ok) throw new Error('API í‚¤ ë¡œë“œ ì‹¤íŒ¨');
        
        const key = await res.json();
        
        document.getElementById('apikeyModalTitle').textContent = 'API í‚¤ í¸ì§‘';
        document.getElementById('apikeyId').value = key.id;
        document.getElementById('apikeyName').value = key.name;
        document.getElementById('apikeyValue').value = key.api_key;
        document.getElementById('apikeyModal').classList.add('show');
    } catch (err) {
        showToast('API í‚¤ ë¡œë“œ ì‹¤íŒ¨: ' + err.message, 'error');
    }
}

async function activateAPIKey(keyId) {
    if (!confirm('ì´ API í‚¤ë¥¼ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const res = await fetch(`/api/api-keys/${keyId}/activate`, {
            method: 'POST'
        });
        
        if (!res.ok) throw new Error('í™œì„±í™” ì‹¤íŒ¨');
        
        showToast('API í‚¤ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (err) {
        showToast('í™œì„±í™” ì‹¤íŒ¨: ' + err.message, 'error');
    }
}

async function deleteAPIKey(keyId) {
    if (!confirm('ì´ API í‚¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ í‚¤ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    
    try {
        const res = await fetch(`/api/api-keys/${keyId}`, {
            method: 'DELETE'
        });
        
        if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
        
        showToast('API í‚¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (err) {
        showToast('ì‚­ì œ ì‹¤íŒ¨: ' + err.message, 'error');
    }
}

function closeAPIKeyModal() {
    document.getElementById('apikeyModal').classList.remove('show');
}

// API í‚¤ í¼ ì œì¶œ
document.getElementById('apikeyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const keyId = document.getElementById('apikeyId').value;
    const data = {
        name: document.getElementById('apikeyName').value,
        api_key: document.getElementById('apikeyValue').value
    };
    
    try {
        const url = keyId ? `/api/api-keys/${keyId}` : '/api/api-keys';
        const method = keyId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'ì €ì¥ ì‹¤íŒ¨');
        }
        
        showToast('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (err) {
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + err.message, 'error');
    }
});

// API ì‚¬ìš©ëŸ‰ í™•ì¸
async function checkAPIUsage() {
    const usageDiv = document.getElementById('usageStats');
    const contentDiv = document.getElementById('usageContent');
    
    usageDiv.style.display = 'block';
    contentDiv.innerHTML = 'ë¡œë”© ì¤‘...';
    
    try {
        const res = await fetch('/api/api-keys/usage');
        if (!res.ok) throw new Error('ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨');
        
        const data = await res.json();
        
        let html = '<div style="line-height: 1.8;">';
        
        // QuickRail ì‚¬ìš©ëŸ‰ í†µê³„
        html += '<h5 style="margin: 0 0 1rem 0; color: #1976d2;">ğŸ“Š QuickRail ë²ˆì—­ ì‚¬ìš©ëŸ‰</h5>';
        
        // ì „ì²´ ì‚¬ìš©ëŸ‰
        html += '<div style="background: #e3f2fd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">';
        html += '<div style="font-weight: bold; margin-bottom: 0.5rem;">ì „ì²´ ëˆ„ì </div>';
        html += `<div>â€¢ ì´ ìš”ì²­: ${data.quickrail_usage.total.requests.toLocaleString()}íšŒ</div>`;
        html += `<div>â€¢ ì´ í† í°: ${data.quickrail_usage.total.tokens.toLocaleString()} tokens</div>`;
        html += `<div>â€¢ ëˆ„ì  ë¹„ìš©: $${data.quickrail_usage.total.cost.toFixed(4)}</div>`;
        html += '</div>';
        
        // ìµœê·¼ 30ì¼
        html += '<div style="background: #fff3e0; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">';
        html += '<div style="font-weight: bold; margin-bottom: 0.5rem;">ìµœê·¼ 30ì¼</div>';
        html += `<div>â€¢ ìš”ì²­ ìˆ˜: ${data.quickrail_usage.last_30_days.requests.toLocaleString()}íšŒ</div>`;
        html += `<div>â€¢ í† í°: ${data.quickrail_usage.last_30_days.tokens.toLocaleString()} tokens</div>`;
        html += `<div>â€¢ ë¹„ìš©: $${data.quickrail_usage.last_30_days.cost.toFixed(4)}</div>`;
        html += '</div>';
        
        // ìµœê·¼ 7ì¼
        html += '<div style="background: #e8f5e9; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">';
        html += '<div style="font-weight: bold; margin-bottom: 0.5rem;">ìµœê·¼ 7ì¼</div>';
        html += `<div>â€¢ ìš”ì²­ ìˆ˜: ${data.quickrail_usage.last_7_days.requests.toLocaleString()}íšŒ</div>`;
        html += `<div>â€¢ í† í°: ${data.quickrail_usage.last_7_days.tokens.toLocaleString()} tokens</div>`;
        html += `<div>â€¢ ë¹„ìš©: $${data.quickrail_usage.last_7_days.cost.toFixed(4)}</div>`;
        html += '</div>';
        
        // ì¼ë³„ ìƒì„¸ í†µê³„
        if (data.daily_breakdown && data.daily_breakdown.length > 0) {
            html += '<hr style="margin: 1rem 0;">';
            html += '<h6 style="margin: 0.5rem 0;">ì¼ë³„ ì‚¬ìš©ëŸ‰ (ìµœê·¼ 7ì¼)</h6>';
            html += '<table style="width: 100%; margin-top: 0.5rem; border-collapse: collapse; font-size: 0.9rem;">';
            html += '<tr style="background: #f5f5f5;"><th style="padding: 0.5rem; text-align: left;">ë‚ ì§œ</th><th style="padding: 0.5rem; text-align: right;">ìš”ì²­</th><th style="padding: 0.5rem; text-align: right;">í† í°</th><th style="padding: 0.5rem; text-align: right;">ë¹„ìš©</th></tr>';
            data.daily_breakdown.forEach(day => {
                html += `<tr style="border-bottom: 1px solid #eee;">`;
                html += `<td style="padding: 0.5rem;">${day.date}</td>`;
                html += `<td style="padding: 0.5rem; text-align: right;">${day.requests.toLocaleString()}</td>`;
                html += `<td style="padding: 0.5rem; text-align: right;">${day.tokens.toLocaleString()}</td>`;
                html += `<td style="padding: 0.5rem; text-align: right;">$${day.cost.toFixed(4)}</td>`;
                html += `</tr>`;
            });
            html += '</table>';
        }
        
        // ì–¸ì–´ë³„ í†µê³„
        if (data.language_breakdown && data.language_breakdown.length > 0) {
            html += '<hr style="margin: 1rem 0;">';
            html += '<h6 style="margin: 0.5rem 0;">ì–¸ì–´ë³„ ì‚¬ìš©ëŸ‰ (ìµœê·¼ 30ì¼)</h6>';
            html += '<table style="width: 100%; margin-top: 0.5rem; border-collapse: collapse; font-size: 0.9rem;">';
            html += '<tr style="background: #f5f5f5;"><th style="padding: 0.5rem; text-align: left;">ë²ˆì—­ ë°©í–¥</th><th style="padding: 0.5rem; text-align: right;">ìš”ì²­</th><th style="padding: 0.5rem; text-align: right;">í† í°</th></tr>';
            data.language_breakdown.forEach(lang => {
                html += `<tr style="border-bottom: 1px solid #eee;">`;
                html += `<td style="padding: 0.5rem;">${lang.direction}</td>`;
                html += `<td style="padding: 0.5rem; text-align: right;">${lang.requests.toLocaleString()}</td>`;
                html += `<td style="padding: 0.5rem; text-align: right;">${lang.tokens.toLocaleString()}</td>`;
                html += `</tr>`;
            });
            html += '</table>';
        }
        
        // ì°¸ê³  ì‚¬í•­
        html += '<hr style="margin: 1rem 0;">';
        html += `<div style="font-size: 0.85rem; color: #666;">`;
        html += `<strong>ì°¸ê³ :</strong> ${data.note}`;
        html += `</div>`;
        
        html += '</div>';
        contentDiv.innerHTML = html;
    } catch (err) {
        contentDiv.innerHTML = `<div style="color: #d32f2f;">âŒ ${err.message}</div>`;
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('apikeyModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAPIKeyModal();
    }
});
</script>
{% endblock %}


