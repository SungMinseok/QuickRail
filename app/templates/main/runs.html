{% extends "base.html" %}

{% block title %}{{ project.name }} - ëŸ° ê´€ë¦¬{% endblock %}

{% block extra_css %}
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        border-radius: 8px;
        width: 80%;
        max-width: 900px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }
    
    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        background: none;
    }
    
    .close:hover {
        color: #000;
    }
    
    .case-selector {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 1.5rem;
        min-height: 400px;
    }
    
    .section-list {
        border-right: 1px solid #e0e0e0;
        padding-right: 1rem;
        overflow-y: auto;
    }
    
    .section-list-item {
        padding: 0.75rem;
        margin: 0.25rem 0;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-list-item:hover {
        background: #f5f5f5;
    }
    
    .section-list-item.active {
        background: #e3f2fd;
        border-left: 3px solid #3498db;
    }
    
    .section-list-item.has-selection {
        font-weight: 500;
        color: #3498db;
    }
    
    .case-list {
        overflow-y: auto;
    }
    
    .case-checkbox-item {
        padding: 0.75rem;
        margin: 0.5rem 0;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        display: flex;
        align-items: start;
        gap: 0.75rem;
        transition: all 0.2s;
    }
    
    .case-checkbox-item:hover {
        background: #f9f9f9;
        border-color: #3498db;
    }
    
    .case-checkbox-item.selected {
        background: #e8f5e9;
        border-color: #27ae60;
    }
    
    .case-checkbox-item input[type="checkbox"] {
        margin-top: 0.25rem;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .case-info {
        flex: 1;
    }
    
    .case-title {
        font-weight: 500;
        margin-bottom: 0.25rem;
    }
    
    .case-meta {
        font-size: 0.85rem;
        color: #666;
        display: flex;
        gap: 0.75rem;
    }
    
    .selected-count {
        background: #3498db;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .select-all-section {
        padding: 0.5rem;
        background: #f5f5f5;
        border-radius: 4px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <h2>{{ project.name }}</h2>
    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
        <a href="{{ url_for('main.cases', project_id=project.id) }}" class="btn btn-secondary">ì¼€ì´ìŠ¤</a>
        <a href="{{ url_for('main.runs', project_id=project.id) }}" class="btn btn-primary">ëŸ°</a>
        <a href="{{ url_for('main.dashboard', project_id=project.id) }}" class="btn btn-secondary">ë¦¬í¬íŠ¸</a>
    </div>
</div>

<div style="max-width: 1200px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h3>í…ŒìŠ¤íŠ¸ ëŸ°</h3>
        <div style="display: flex; gap: 1rem;">
            <button class="btn btn-secondary" onclick="showTemplates()">ğŸ“‹ í…œí”Œë¦¿</button>
            <button class="btn btn-success" onclick="showCreateRun()">+ ìƒˆ ëŸ° ìƒì„±</button>
        </div>
    </div>
    
    <!-- í…œí”Œë¦¿ ëª©ë¡ (ìˆ¨ê¹€) -->
    <div id="templatesSection" class="card" style="display: none; margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h4>ëŸ° í…œí”Œë¦¿</h4>
            <button class="btn btn-secondary" onclick="hideTemplates()">ë‹«ê¸°</button>
        </div>
        <div id="templatesList">
            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>
    </div>
    
    <!-- ëŸ° ìƒì„± í¼ -->
    <div id="createRunForm" class="card" style="display: none; margin-bottom: 2rem;">
        <h4 style="margin-bottom: 1rem;">ìƒˆ ëŸ° ìƒì„±</h4>
        <form onsubmit="createRun(event)">
            <div class="form-group">
                <label class="form-label">ëŸ° ì´ë¦„</label>
                <input type="text" id="runName" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">ì„¤ëª… (ì„ íƒ)</label>
                <textarea id="runDescription" class="form-control"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">íƒ€ì…</label>
                <select id="runType" class="form-control">
                    <option value="smoke">Smoke</option>
                    <option value="regression">Regression</option>
                    <option value="hotfix">Hotfix</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">í¬í•¨í•  ì¼€ì´ìŠ¤ ì„ íƒ</label>
                <button type="button" class="btn btn-primary" onclick="event.preventDefault(); openCaseSelector()">
                    ì¼€ì´ìŠ¤ ì„ íƒ (<span id="selectedCaseCount">0</span>ê°œ)
                </button>
                <input type="hidden" id="selectedCaseIds" value="">
                <div id="selectedCasePreview" style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;"></div>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-success">ìƒì„±</button>
                <button type="button" class="btn btn-primary" onclick="saveAsTemplate()">í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</button>
                <button type="button" class="btn btn-secondary" onclick="hideCreateRun()">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
    
    <!-- Open Runs -->
    <div class="card" style="margin-bottom: 2rem;">
        <h4 style="margin-bottom: 1rem; color: #27ae60;">ì§„í–‰ ì¤‘ì¸ ëŸ° ({{ open_runs|length }})</h4>
        {% for run in open_runs %}
        {% set stats = run.get_stats() %}
        <div style="padding: 1rem; border-bottom: 1px solid #eee; display: flex; gap: 1rem; align-items: start;">
            <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h5 style="margin-bottom: 0.5rem;">
                            <a href="{{ url_for('main.run_execute', run_id=run.id) }}" style="color: #2c3e50; text-decoration: none;">
                                {{ run.name }}
                            </a>
                        </h5>
                        <div style="font-size: 0.9rem; color: #666;">
                            <span>{{ run.run_type or 'custom' }}</span> | 
                            <span>ìƒì„±ì: {{ run.creator.name }}</span> | 
                            <span>{{ run.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        {% if run.description %}
                        <p style="margin-top: 0.5rem; color: #666;">{{ run.description }}</p>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #3498db;">
                            {{ stats.progress }}%
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                            {{ stats.executed }} / {{ stats.total }}
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span style="color: #27ae60;">âœ“ {{ stats.pass }}</span>
                            <span style="color: #e74c3c; margin-left: 0.5rem;">âœ— {{ stats.fail }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% if current_user.role in ['admin', 'author'] or run.created_by == current_user.id %}
            <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;" 
                    onclick="deleteRun({{ run.id }})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
            {% endif %}
        </div>
        {% endfor %}
        
        {% if not open_runs %}
        <div style="text-align: center; padding: 2rem; color: #999;">
            ì§„í–‰ ì¤‘ì¸ ëŸ°ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
        {% endif %}
    </div>
    
    <!-- Closed Runs -->
    <div class="card">
        <h4 style="margin-bottom: 1rem; color: #95a5a6;">ì™„ë£Œëœ ëŸ° (ìµœê·¼ 20ê°œ)</h4>
        {% for run in closed_runs %}
        {% set stats = run.get_stats() %}
        <div style="padding: 1rem; border-bottom: 1px solid #eee; display: flex; gap: 1rem; align-items: start;">
            <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h5 style="margin-bottom: 0.5rem; color: #666;">{{ run.name }}</h5>
                        <div style="font-size: 0.9rem; color: #999;">
                            <span>{{ run.run_type or 'custom' }}</span> | 
                            <span>{{ run.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.1rem; font-weight: bold; color: {% if stats.pass_rate >= 90 %}#27ae60{% elif stats.pass_rate >= 70 %}#f39c12{% else %}#e74c3c{% endif %}">
                            Pass: {{ stats.pass_rate }}%
                        </div>
                        <div style="font-size: 0.85rem; color: #999;">
                            <span style="color: #27ae60;">âœ“ {{ stats.pass }}</span>
                            <span style="color: #e74c3c; margin-left: 0.5rem;">âœ— {{ stats.fail }}</span>
                            <span style="color: #95a5a6; margin-left: 0.5rem;">âŠ˜ {{ stats.blocked }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% if current_user.role in ['admin', 'author'] or run.created_by == current_user.id %}
            <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;" 
                    onclick="deleteRun({{ run.id }})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
            {% endif %}
        </div>
        {% endfor %}
        
        {% if not closed_runs %}
        <div style="text-align: center; padding: 2rem; color: #999;">
            ì™„ë£Œëœ ëŸ°ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
        {% endif %}
    </div>
</div>

<!-- ì¼€ì´ìŠ¤ ì„ íƒ ëª¨ë‹¬ -->
<div id="caseSelectorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ì¼€ì´ìŠ¤ ì„ íƒ</h3>
            <button class="close" onclick="closeCaseSelector()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="case-selector">
                <div class="section-list">
                    <h4 style="margin-bottom: 1rem; font-size: 1rem;">ì„¹ì…˜</h4>
                    <div id="modalSectionList">
                        <div class="section-list-item active" data-section-id="all" onclick="selectModalSection('all')">
                            <span>ğŸ“‹</span>
                            <span>ì „ì²´ ì¼€ì´ìŠ¤</span>
                            <span class="selected-count" id="count-all" style="margin-left: auto;">0</span>
                        </div>
                    </div>
                </div>
                <div class="case-list">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; font-size: 1rem;">ì¼€ì´ìŠ¤ ëª©ë¡</h4>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; cursor: pointer;">
                            <input type="checkbox" id="selectAllCases" onchange="toggleSelectAll()">
                            <span>ì „ì²´ ì„ íƒ</span>
                        </label>
                    </div>
                    <div id="caseCheckboxList">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div style="color: #666; font-size: 0.9rem;">
                <span id="modalSelectionCount">0</span>ê°œ ì¼€ì´ìŠ¤ ì„ íƒë¨
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-success" onclick="confirmCaseSelection()">í™•ì¸</button>
                <button class="btn btn-secondary" onclick="closeCaseSelector()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<script>
const projectId = {{ project.id }};

// ì¼€ì´ìŠ¤ ì„ íƒ ëª¨ë‹¬ ì „ì—­ ë³€ìˆ˜
let allSections = [];
let allCases = [];
let selectedCaseIds = new Set();
let currentModalSection = 'all';

function showCreateRun() {
    document.getElementById('createRunForm').style.display = 'block';
    // ìë™ ì´ë¦„ ìƒì„±
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('runName').value = `${today} Regression`;
}

function hideCreateRun() {
    document.getElementById('createRunForm').style.display = 'none';
}

// í…œí”Œë¦¿ ê´€ë ¨ í•¨ìˆ˜ë“¤
async function showTemplates() {
    document.getElementById('templatesSection').style.display = 'block';
    await loadTemplates();
}

function hideTemplates() {
    document.getElementById('templatesSection').style.display = 'none';
}

async function loadTemplates() {
    try {
        const res = await fetch(`/api/projects/${projectId}/run-templates`);
        const templates = await res.json();
        
        const container = document.getElementById('templatesList');
        
        if (templates.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        
        container.innerHTML = templates.map(t => `
            <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h5 style="margin-bottom: 0.5rem;">${t.name}</h5>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">${t.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                        <div style="font-size: 0.85rem; color: #999;">
                            <span>${t.run_type || 'custom'}</span> | 
                            <span>${t.case_count}ê°œ ì¼€ì´ìŠ¤</span> | 
                            <span>ìƒì„±ì: ${t.created_by}</span> |
                            <span>${t.is_public ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="createRunFromTemplate(${t.id}, '${t.name}')">ëŸ° ìƒì„±</button>
                        ${t.is_mine ? `<button class="btn btn-danger" onclick="deleteTemplate(${t.id})">ì‚­ì œ</button>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
    } catch (err) {
        alert('í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨: ' + err);
    }
}

async function saveAsTemplate() {
    const runName = document.getElementById('runName').value;
    const runDescription = document.getElementById('runDescription').value;
    const runType = document.getElementById('runType').value;
    const caseIdsStr = document.getElementById('selectedCaseIds').value;
    
    const caseIds = caseIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
    
    if (caseIds.length === 0) {
        alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const templateName = prompt('í…œí”Œë¦¿ ì´ë¦„:', runName || 'ìƒˆ í…œí”Œë¦¿');
    if (!templateName) return;
    
    const isPublic = confirm('íŒ€ ì „ì²´ì— ê³µê°œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì•„ë‹ˆì˜¤ ì„ íƒ ì‹œ ë³¸ì¸ë§Œ ì‚¬ìš© ê°€ëŠ¥)');
    
    try {
        const res = await fetch(`/api/projects/${projectId}/run-templates`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: templateName,
                description: runDescription,
                run_type: runType,
                case_ids: caseIds,
                is_public: isPublic
            })
        });
        
        if (res.ok) {
            alert('í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            hideCreateRun();
        } else {
            alert('í…œí”Œë¦¿ ì €ì¥ ì‹¤íŒ¨');
        }
    } catch (err) {
        alert('í…œí”Œë¦¿ ì €ì¥ ì‹¤íŒ¨: ' + err);
    }
}

async function createRunFromTemplate(templateId, templateName) {
    const runName = prompt('ëŸ° ì´ë¦„:', `${templateName} - ${new Date().toISOString().split('T')[0]}`);
    if (!runName) return;
    
    try {
        const res = await fetch(`/api/run-templates/${templateId}/create-run`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: runName })
        });
        
        if (res.ok) {
            location.reload();
        } else {
            alert('ëŸ° ìƒì„± ì‹¤íŒ¨');
        }
    } catch (err) {
        alert('ëŸ° ìƒì„± ì‹¤íŒ¨: ' + err);
    }
}

async function deleteTemplate(templateId) {
    if (!confirm('ì´ í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const res = await fetch(`/api/run-templates/${templateId}`, {
            method: 'DELETE'
        });
        
        if (res.ok) {
            await loadTemplates();
        } else {
            alert('í…œí”Œë¦¿ ì‚­ì œ ì‹¤íŒ¨');
        }
    } catch (err) {
        alert('í…œí”Œë¦¿ ì‚­ì œ ì‹¤íŒ¨: ' + err);
    }
}

// ëŸ° ì‚­ì œ
async function deleteRun(runId) {
    if (!confirm('ì´ ëŸ°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ëª¨ë“  ì‹¤í–‰ ê²°ê³¼ê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) return;
    
    try {
        const res = await fetch(`/api/runs/${runId}`, {
            method: 'DELETE'
        });
        
        if (res.ok) {
            location.reload();
        } else {
            alert('ëŸ° ì‚­ì œ ì‹¤íŒ¨');
        }
    } catch (err) {
        alert('ëŸ° ì‚­ì œ ì‹¤íŒ¨: ' + err);
    }
}

function createRun(event) {
    event.preventDefault();
    
    const name = document.getElementById('runName').value;
    const description = document.getElementById('runDescription').value;
    const runType = document.getElementById('runType').value;
    const caseIdsStr = document.getElementById('selectedCaseIds').value;
    
    const caseIds = caseIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
    
    if (caseIds.length === 0) {
        alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    fetch(`/api/projects/${projectId}/runs`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: name,
            description: description,
            run_type: runType,
            case_ids: caseIds
        })
    })
    .then(res => res.json())
    .then(data => {
        location.reload();
    })
    .catch(err => alert('ëŸ° ìƒì„± ì‹¤íŒ¨: ' + err));
}

// ì¼€ì´ìŠ¤ ì„ íƒ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
async function openCaseSelector() {
    document.getElementById('caseSelectorModal').style.display = 'block';
    
    // ë°ì´í„° ë¡œë“œ
    await loadSectionsAndCases();
    renderSectionList();
    renderCaseList('all');
}

function closeCaseSelector() {
    document.getElementById('caseSelectorModal').style.display = 'none';
}

async function loadSectionsAndCases() {
    try {
        // ì„¹ì…˜ ë¡œë“œ
        const sectionsRes = await fetch(`/api/projects/${projectId}/sections`);
        if (!sectionsRes.ok) {
            throw new Error(`ì„¹ì…˜ ë¡œë“œ ì‹¤íŒ¨: ${sectionsRes.status}`);
        }
        allSections = await sectionsRes.json();
        console.log('ì„¹ì…˜ ë¡œë“œ ì™„ë£Œ:', allSections.length);
        
        // ëª¨ë“  ì¼€ì´ìŠ¤ ë¡œë“œ
        const casesRes = await fetch(`/api/projects/${projectId}/cases?status=active`);
        if (!casesRes.ok) {
            throw new Error(`ì¼€ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨: ${casesRes.status}`);
        }
        allCases = await casesRes.json();
        console.log('ì¼€ì´ìŠ¤ ë¡œë“œ ì™„ë£Œ:', allCases.length);
    } catch (err) {
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', err);
        alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
    }
}

function renderSectionList() {
    const container = document.getElementById('modalSectionList');
    
    // ê¸°ì¡´ ì„¹ì…˜ í•­ëª© ì œê±° (ì „ì²´ ì¼€ì´ìŠ¤ ì œì™¸)
    const existingSections = container.querySelectorAll('.section-list-item:not([data-section-id="all"])');
    existingSections.forEach(item => item.remove());
    
    // ì „ì²´ ì¼€ì´ìŠ¤ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    updateSectionCount('all');
    
    // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
    const escapeHtml = (text) => {
        if (!text) return '';
        const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
        return text.replace(/[&<>"']/g, m => map[m]);
    };
    
    console.log('ì„¹ì…˜ ë Œë”ë§ ì‹œì‘:', allSections.length);
    
    // ì„¹ì…˜ í•­ëª© ì¶”ê°€
    allSections.forEach(section => {
        const item = document.createElement('div');
        item.className = 'section-list-item';
        item.dataset.sectionId = section.id;
        item.onclick = () => selectModalSection(section.id);
        
        const icon = section.parent_id ? 'ğŸ“„' : 'ğŸ“‚';
        const indent = section.parent_id ? 'ã€€' : '';
        
        item.innerHTML = `
            ${indent}<span>${icon}</span>
            <span>${escapeHtml(section.name)}</span>
            <span class="selected-count" id="count-${section.id}" style="margin-left: auto; display: none;">0</span>
        `;
        
        container.appendChild(item);
        updateSectionCount(section.id);
    });
    
    console.log('ì„¹ì…˜ ë Œë”ë§ ì™„ë£Œ');
}

function selectModalSection(sectionId) {
    currentModalSection = sectionId;
    
    // í™œì„±í™” í‘œì‹œ
    document.querySelectorAll('.section-list-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-section-id="${sectionId}"]`).classList.add('active');
    
    // ì¼€ì´ìŠ¤ ëª©ë¡ ë Œë”ë§
    renderCaseList(sectionId);
}

function renderCaseList(sectionId) {
    const container = document.getElementById('caseCheckboxList');
    container.innerHTML = '';
    
    console.log('ì¼€ì´ìŠ¤ ë Œë”ë§:', sectionId, 'ì „ì²´ ì¼€ì´ìŠ¤:', allCases.length);
    
    const filteredCases = sectionId === 'all' 
        ? allCases 
        : allCases.filter(c => c.section_id == sectionId);
    
    console.log('í•„í„°ë§ëœ ì¼€ì´ìŠ¤:', filteredCases.length);
    
    if (filteredCases.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">ì´ ì„¹ì…˜ì— ì¼€ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        document.getElementById('selectAllCases').checked = false;
        return;
    }
    
    filteredCases.forEach(caseItem => {
        const div = document.createElement('div');
        div.className = 'case-checkbox-item';
        if (selectedCaseIds.has(caseItem.id)) {
            div.classList.add('selected');
        }
        
        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        const escapeHtml = (text) => {
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return text.replace(/[&<>"']/g, m => map[m]);
        };
        
        div.innerHTML = `
            <input type="checkbox" 
                   id="case-${caseItem.id}" 
                   value="${caseItem.id}"
                   ${selectedCaseIds.has(caseItem.id) ? 'checked' : ''}
                   onchange="toggleCase(${caseItem.id})">
            <label for="case-${caseItem.id}" class="case-info" style="cursor: pointer;">
                <div class="case-title">${escapeHtml(caseItem.title)}</div>
                <div class="case-meta">
                    <span class="priority-badge priority-${caseItem.priority}">${caseItem.priority}</span>
                    <span>ğŸ“‚ ${escapeHtml(caseItem.section_name)}</span>
                    ${caseItem.owner_name ? `<span>ğŸ‘¤ ${escapeHtml(caseItem.owner_name)}</span>` : ''}
                </div>
            </label>
        `;
        
        container.appendChild(div);
    });
    
    // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateSelectAllCheckbox();
}

function toggleCase(caseId) {
    if (selectedCaseIds.has(caseId)) {
        selectedCaseIds.delete(caseId);
    } else {
        selectedCaseIds.add(caseId);
    }
    
    updateSelectionUI();
}

function toggleSelectAll() {
    const checkbox = document.getElementById('selectAllCases');
    const filteredCases = currentModalSection === 'all' 
        ? allCases 
        : allCases.filter(c => c.section_id == currentModalSection);
    
    if (checkbox.checked) {
        filteredCases.forEach(c => selectedCaseIds.add(c.id));
    } else {
        filteredCases.forEach(c => selectedCaseIds.delete(c.id));
    }
    
    renderCaseList(currentModalSection);
    updateSelectionUI();
}

function updateSelectAllCheckbox() {
    const filteredCases = currentModalSection === 'all' 
        ? allCases 
        : allCases.filter(c => c.section_id == currentModalSection);
    
    if (filteredCases.length === 0) {
        document.getElementById('selectAllCases').checked = false;
        return;
    }
    
    const allSelected = filteredCases.every(c => selectedCaseIds.has(c.id));
    document.getElementById('selectAllCases').checked = allSelected;
}

function updateSelectionUI() {
    // ì„ íƒ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    const count = selectedCaseIds.size;
    document.getElementById('modalSelectionCount').textContent = count;
    
    // ê° ì„¹ì…˜ì˜ ì„ íƒ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    updateSectionCount('all');
    allSections.forEach(section => {
        updateSectionCount(section.id);
    });
    
    // ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.case-checkbox-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox.checked) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
    
    updateSelectAllCheckbox();
}

function updateSectionCount(sectionId) {
    const cases = sectionId === 'all' 
        ? allCases 
        : allCases.filter(c => c.section_id == sectionId);
    
    const selectedCount = cases.filter(c => selectedCaseIds.has(c.id)).length;
    const countElement = document.getElementById(`count-${sectionId}`);
    
    if (countElement) {
        if (selectedCount > 0) {
            countElement.textContent = selectedCount;
            countElement.style.display = 'inline-block';
            document.querySelector(`[data-section-id="${sectionId}"]`)?.classList.add('has-selection');
        } else {
            countElement.style.display = 'none';
            document.querySelector(`[data-section-id="${sectionId}"]`)?.classList.remove('has-selection');
        }
    }
}

function confirmCaseSelection() {
    const selectedIds = Array.from(selectedCaseIds);
    document.getElementById('selectedCaseIds').value = selectedIds.join(',');
    document.getElementById('selectedCaseCount').textContent = selectedIds.length;
    
    // ì„ íƒëœ ì¼€ì´ìŠ¤ ë¯¸ë¦¬ë³´ê¸°
    if (selectedIds.length > 0) {
        const preview = selectedIds.length <= 5 
            ? `ì„ íƒë¨: ${selectedIds.slice(0, 5).join(', ')}${selectedIds.length > 5 ? '...' : ''}`
            : `${selectedIds.length}ê°œ ì¼€ì´ìŠ¤ ì„ íƒë¨`;
        document.getElementById('selectedCasePreview').textContent = preview;
    } else {
        document.getElementById('selectedCasePreview').textContent = '';
    }
    
    closeCaseSelector();
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
window.onclick = function(event) {
    const modal = document.getElementById('caseSelectorModal');
    if (event.target === modal) {
        closeCaseSelector();
    }
}
</script>
{% endblock %}


