{% extends "base.html" %}

{% block title %}{{ project.name }} - ì¼€ì´ìŠ¤ ê´€ë¦¬{% endblock %}

{# ì¬ê·€ ë§¤í¬ë¡œ: ì„¹ì…˜ íŠ¸ë¦¬ë¥¼ ìµœëŒ€ 4ë‹¨ê³„ê¹Œì§€ ë Œë”ë§ #}
{% macro render_sections(sections, current_section_id, current_user, depth) %}
    {% if depth < 4 %}
        {% for section in sections %}
            <div class="section-wrapper" data-section-id="{{ section.id }}" data-depth="{{ depth }}">
                <div class="section-item {% if current_section_id == section.id %}active{% endif %}" data-section-id="{{ section.id }}">
                    <span>{% if depth == 0 %}ğŸ“‚{% elif depth == 1 %}ğŸ“„{% elif depth == 2 %}ğŸ“‹{% else %}ğŸ“Œ{% endif %}</span>
                    <span class="section-name" onclick="goToSection({{ section.id }})">{{ section.name }}</span>
                    {% if current_user.role in ['admin', 'author'] %}
                    <div class="section-actions">
                        {% if depth < 3 %}
                        <button class="section-btn" onclick="event.stopPropagation(); addSection({{ section.id }}, {{ depth + 1 }})" title="í•˜ìœ„ ì„¹ì…˜ ì¶”ê°€">+</button>
                        {% endif %}
                        <button class="section-btn" onclick="event.stopPropagation(); editSection({{ section.id }}, '{{ section.name }}')" title="ì´ë¦„ ë³€ê²½">âœï¸</button>
                        <button class="section-btn" onclick="event.stopPropagation(); deleteSection({{ section.id }})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                    </div>
                    {% endif %}
                </div>
                {% if section.children %}
                <div class="section-children sortable-list" data-parent-id="{{ section.id }}" data-depth="{{ depth + 1 }}">
                    {{ render_sections(section.children, current_section_id, current_user, depth + 1) }}
                </div>
                {% endif %}
            </div>
        {% endfor %}
    {% endif %}
{% endmacro %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
    .two-pane-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 1.5rem;
        height: calc(100vh - 150px);
    }
    
    .section-tree {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        overflow-y: auto;
    }
    
    .section-item {
        padding: 0.5rem 0.75rem;
        margin: 0.25rem 0;
        border-radius: 4px;
        cursor: move;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        position: relative;
    }
    
    .section-item:hover {
        background: #f0f0f0;
    }
    
    .section-item.active {
        background: #3498db;
        color: white;
    }
    
    .section-item.sortable-ghost {
        opacity: 0.4;
        background: #e3f2fd;
    }
    
    .section-item.sortable-drag {
        opacity: 0.8;
    }
    
    .section-children {
        margin-left: 1.5rem;
        padding-left: 0.5rem;
        border-left: 2px solid #e0e0e0;
    }
    
    .section-name {
        flex: 1;
    }
    
    .section-actions {
        display: none;
        gap: 0.25rem;
    }
    
    .section-item:hover .section-actions {
        display: flex;
    }
    
    .section-btn {
        padding: 0.25rem 0.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        border-radius: 3px;
        font-size: 0.85rem;
    }
    
    .section-btn:hover {
        background: rgba(0,0,0,0.1);
    }
    
    .sortable-list {
        min-height: 20px;
    }
    
    .case-panel {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .case-filters {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .case-list {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        overflow-y: auto;
    }
    
    .case-item {
        padding: 1rem;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
        display: flex;
        gap: 1rem;
        align-items: start;
    }
    
    .case-item:hover {
        background: #f9f9f9;
    }
    
    .case-item:last-child {
        border-bottom: none;
    }
    
    .case-content {
        flex: 1;
    }
    
    .case-actions {
        display: none;
        gap: 0.25rem;
        flex-shrink: 0;
    }
    
    .case-item:hover .case-actions {
        display: flex;
    }
    
    .case-action-btn {
        padding: 0.25rem 0.5rem;
        background: transparent;
        border: 1px solid #ddd;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
    }
    
    .case-action-btn:hover {
        background: #f0f0f0;
        border-color: #999;
    }
    
    .case-action-btn.edit:hover {
        background: #e3f2fd;
        border-color: #3498db;
        color: #3498db;
    }
    
    .case-action-btn.delete:hover {
        background: #ffebee;
        border-color: #e74c3c;
        color: #e74c3c;
    }
    
    .case-title {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        cursor: pointer;
    }
    
    .case-title:hover {
        color: #3498db;
    }
    
    .case-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.9rem;
        color: #666;
        flex-wrap: wrap;
    }
    
    .priority-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .priority-P0 { background: #e74c3c; color: white; }
    .priority-P1 { background: #e67e22; color: white; }
    .priority-P2 { background: #f39c12; color: white; }
    .priority-P3 { background: #95a5a6; color: white; }
    
    .tag-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        background: #3498db;
        color: white;
        font-size: 0.8rem;
    }
    
    .quick-add-form {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <h2>{{ project.name }}</h2>
    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
        <a href="{{ url_for('main.cases', project_id=project.id) }}" class="btn btn-primary">ì¼€ì´ìŠ¤</a>
        <a href="{{ url_for('main.runs', project_id=project.id) }}" class="btn btn-secondary">ëŸ°</a>
        <a href="{{ url_for('main.dashboard', project_id=project.id) }}" class="btn btn-secondary">ë¦¬í¬íŠ¸</a>
    </div>
</div>

<div class="two-pane-layout">
    <!-- ì¢Œì¸¡: Section íŠ¸ë¦¬ -->
    <div class="section-tree">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>ì„¹ì…˜</h3>
            {% if current_user.role in ['admin', 'author'] %}
            <button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.9rem;" onclick="addSection(null)">+ ë£¨íŠ¸</button>
            {% endif %}
        </div>
        
        <div class="section-item {% if not current_section_id %}active{% endif %}" onclick="goToSection(null)" style="cursor: pointer;">
            <span>ğŸ“</span>
            <span class="section-name">ì „ì²´ ì¼€ì´ìŠ¤</span>
        </div>
        
        <div id="sectionTree" class="sortable-list">
            {{ render_sections(sections, current_section_id, current_user, 0) }}
        </div>
    </div>
    
    <!-- ìš°ì¸¡: Case ë¦¬ìŠ¤íŠ¸ -->
    <div class="case-panel">
        <!-- í•„í„° -->
        <div class="case-filters">
            <input type="text" placeholder="ê²€ìƒ‰..." class="form-control" style="max-width: 300px;" value="{{ search }}" 
                   onkeyup="if(event.key=='Enter') filterCases()">
            
            <select class="form-control" style="max-width: 150px;" onchange="filterCases()">
                <option value="">ëª¨ë“  ìš°ì„ ìˆœìœ„</option>
                <option value="Critical" {% if priority=='Critical' %}selected{% endif %}>Critical</option>
                <option value="High" {% if priority=='High' %}selected{% endif %}>High</option>
                <option value="Medium" {% if priority=='Medium' %}selected{% endif %}>Medium</option>
                <option value="Low" {% if priority=='Low' %}selected{% endif %}>Low</option>
            </select>
            
            <select class="form-control" style="max-width: 200px;" onchange="filterCases()">
                <option value="">ëª¨ë“  íƒœê·¸</option>
                {% for tag in tags %}
                <option value="{{ tag.name }}" {% if selected_tag==tag.name %}selected{% endif %}>{{ tag.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Quick Add -->
        {% if current_user.role in ['admin', 'author'] %}
        <div class="card">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <button type="button" class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="toggleBulkAdd()">ğŸ“ ì—¬ëŸ¬ ê°œ ì¶”ê°€</button>
            </div>
            <form class="quick-add-form" id="singleAddForm" onsubmit="quickAddCase(event)">
                <input type="text" id="quickAddTitle" placeholder="ì¼€ì´ìŠ¤ ì œëª© ì…ë ¥ í›„ Enter..." class="form-control" required 
                       oninput="checkDuplicates(this.value)">
                <button type="submit" class="btn btn-success">ì¶”ê°€</button>
            </form>
            <form id="bulkAddForm" style="display: none;" onsubmit="bulkAddCases(event)">
                <textarea id="bulkAddText" class="form-control" placeholder="ì¼€ì´ìŠ¤ ì œëª©ë“¤ì„ ê°œí–‰(ì—”í„°)ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”..." 
                          style="min-height: 150px; font-family: monospace;"></textarea>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="submit" class="btn btn-success">ì¼ê´„ ì¶”ê°€</button>
                    <button type="button" class="btn btn-secondary" onclick="toggleBulkAdd()">ì·¨ì†Œ</button>
                </div>
            </form>
            <div id="duplicateWarning" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px;">
                <strong>âš ï¸ ìœ ì‚¬í•œ ì¼€ì´ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤:</strong>
                <div id="duplicateList" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
            </div>
        </div>
        {% endif %}
        
        <!-- Case ë¦¬ìŠ¤íŠ¸ -->
        <div class="case-list">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>ì¼€ì´ìŠ¤ ({{ cases|length }})</h3>
                <select class="form-control" style="width: auto;" onchange="changeSort(this.value)">
                    <option value="default" {% if current_sort == 'default' or not current_sort %}selected{% endif %}>ê¸°ë³¸</option>
                    <option value="recent" {% if current_sort == 'recent' %}selected{% endif %}>ìµœê·¼ìˆœ</option>
                    <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>ì˜¤ë˜ëœ ìˆœ</option>
                    <option value="title" {% if current_sort == 'title' %}selected{% endif %}>ì œëª©ìˆœ</option>
                    <option value="priority" {% if current_sort == 'priority' %}selected{% endif %}>ìš°ì„ ìˆœìœ„</option>
                </select>
            </div>
            
            <div id="caseListSortable">
            {% for case in cases %}
            <div class="case-item" data-case-id="{{ case.id }}">
                <div class="case-content" onclick="showCaseDetail({{ case.id }})" style="cursor: pointer; flex: 1;">
                    <div class="case-title">{{ case.title }}</div>
                    <div class="case-meta">
                        <span class="priority-badge priority-{{ case.priority }}">{{ case.priority }}</span>
                        {% if case.owner %}
                        <span>ğŸ‘¤ {{ case.owner.name }}</span>
                        {% endif %}
                        {% for tag in case.tags %}
                        <span class="tag-badge">{{ tag.name }}</span>
                        {% endfor %}
                        <span>ğŸ• {{ case.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        <span style="font-size: 0.85rem; color: #999;">
                            {% if case.creator %}
                            | ìƒì„±: {{ case.creator.name }}
                            {% endif %}
                            {% if case.updater and case.updated_at != case.created_at %}
                            | ìˆ˜ì •: {{ case.updater.name }}
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% if current_user.role in ['admin', 'author'] %}
                <div class="case-actions">
                    <button class="case-action-btn edit" onclick="event.stopPropagation(); editCase({{ case.id }}, '{{ case.title }}')" title="í¸ì§‘">âœï¸</button>
                    <button class="case-action-btn" onclick="event.stopPropagation(); copyCase({{ case.id }})" title="ë³µì‚¬" style="border-color: #9b59b6; color: #9b59b6;">ğŸ“‹</button>
                    <button class="case-action-btn delete" onclick="event.stopPropagation(); deleteCase({{ case.id }})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            </div>
            
            {% if not cases %}
            <div style="text-align: center; padding: 3rem; color: #999;">
                ì¼€ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. Quick Addë¡œ ë¹ ë¥´ê²Œ ì¶”ê°€í•´ë³´ì„¸ìš”!
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ì¼€ì´ìŠ¤ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
<div id="caseDetailModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="modalCaseTitle">ì¼€ì´ìŠ¤ ìƒì„¸</h3>
            <button class="close" onclick="closeCaseDetail()">&times;</button>
        </div>
        <div class="modal-body" id="modalCaseContent">
            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
        </div>
    </div>
</div>

<script>
const projectId = {{ project.id }};
const currentSectionId = {{ current_section_id or 'null' }};

// ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initSortable();
});

function initSortable() {
    const sortableLists = document.querySelectorAll('.sortable-list');
    
    sortableLists.forEach(list => {
        new Sortable(list, {
            group: 'nested',
            animation: 150,
            fallbackOnBody: true,
            swapThreshold: 0.65,
            handle: '.section-item',
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            onEnd: function(evt) {
                updateSectionOrder(evt);
            }
        });
    });
}

function updateSectionOrder(evt) {
    const sectionWrapper = evt.item;
    const sectionId = sectionWrapper.dataset.sectionId;
    const newParentList = evt.to;
    const newParentId = newParentList.dataset.parentId || null;
    const newIndex = evt.newIndex;
    
    fetch(`/api/sections/${sectionId}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            parent_id: newParentId,
            order_index: newIndex
        })
    })
    .then(res => res.json())
    .then(data => {
        console.log('ì„¹ì…˜ ìˆœì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    })
    .catch(err => {
        alert('ì„¹ì…˜ ì´ë™ ì‹¤íŒ¨: ' + err);
        location.reload();
    });
}

function goToSection(sectionId) {
    if (sectionId) {
        location.href = `/p/${projectId}/cases?section_id=${sectionId}`;
    } else {
        location.href = `/p/${projectId}/cases`;
    }
}

function quickAddCase(event) {
    event.preventDefault();
    const title = document.getElementById('quickAddTitle').value;
    
    if (!currentSectionId) {
        alert('ì„¹ì…˜ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    fetch(`/api/projects/${projectId}/cases`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            title: title,
            section_id: currentSectionId
        })
    })
    .then(res => res.json())
    .then(data => {
        location.reload();
    })
    .catch(err => alert('ì¼€ì´ìŠ¤ ì¶”ê°€ ì‹¤íŒ¨: ' + err));
}

function filterCases() {
    const search = document.querySelector('input[placeholder="ê²€ìƒ‰..."]').value;
    const priority = document.querySelectorAll('select')[0].value;
    const tag = document.querySelectorAll('select')[1].value;
    
    let url = `/p/${projectId}/cases?`;
    if (currentSectionId) url += `section_id=${currentSectionId}&`;
    if (search) url += `q=${search}&`;
    if (priority) url += `priority=${priority}&`;
    if (tag) url += `tag=${tag}&`;
    
    location.href = url;
}

function addSection(parentId, depth = 0) {
    // ìµœëŒ€ ê¹Šì´ ì²´í¬ (0: ë£¨íŠ¸, 1: 1ë‹¨ê³„, 2: 2ë‹¨ê³„, 3: 3ë‹¨ê³„)
    if (depth >= 4) {
        alert('ì„¹ì…˜ì€ ìµœëŒ€ 4ë‹¨ê³„ê¹Œì§€ë§Œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    const name = prompt('ì„¹ì…˜ ì´ë¦„:');
    if (!name) return;
    
    fetch(`/api/projects/${projectId}/sections`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: name,
            parent_id: parentId
        })
    })
    .then(res => res.json())
    .then(data => {
        location.reload();
    })
    .catch(err => alert('ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨: ' + err));
}

function editSection(sectionId, currentName) {
    const name = prompt('ìƒˆ ì„¹ì…˜ ì´ë¦„:', currentName);
    if (!name || name === currentName) return;
    
    fetch(`/api/sections/${sectionId}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name: name })
    })
    .then(res => res.json())
    .then(data => {
        location.reload();
    })
    .catch(err => alert('ì„¹ì…˜ ìˆ˜ì • ì‹¤íŒ¨: ' + err));
}

function deleteSection(sectionId) {
    if (!confirm('ì´ ì„¹ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í•˜ìœ„ ì¼€ì´ìŠ¤ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) return;
    
    fetch(`/api/sections/${sectionId}`, {
        method: 'DELETE'
    })
    .then(() => {
        location.reload();
    })
    .catch(err => alert('ì„¹ì…˜ ì‚­ì œ ì‹¤íŒ¨: ' + err));
}

function showCaseDetail(caseId) {
    // TODO: ìŠ¬ë¼ì´ë“œ íŒ¨ë„ë¡œ ì¼€ì´ìŠ¤ ìƒì„¸/í¸ì§‘ í‘œì‹œ
    alert('ì¼€ì´ìŠ¤ ìƒì„¸ ë³´ê¸° (í–¥í›„ êµ¬í˜„)');
}

// ì¤‘ë³µ ê°ì§€
let duplicateCheckTimeout;
async function checkDuplicates(title) {
    clearTimeout(duplicateCheckTimeout);
    
    const warningDiv = document.getElementById('duplicateWarning');
    const listDiv = document.getElementById('duplicateList');
    
    if (!title || title.length < 3) {
        warningDiv.style.display = 'none';
        return;
    }
    
    duplicateCheckTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`/api/projects/${projectId}/cases/check-duplicates`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ title: title })
            });
            
            const data = await res.json();
            
            if (data.duplicates && data.duplicates.length > 0) {
                listDiv.innerHTML = data.duplicates.map(dup => {
                    const matchIcon = dup.match_type === 'exact' ? 'ğŸ”´' : 
                                    dup.match_type === 'substring' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                    return `
                        <div style="padding: 0.5rem; margin: 0.25rem 0; background: white; border-radius: 3px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                ${matchIcon} <strong>${dup.title}</strong>
                                <span style="color: #666; font-size: 0.85rem;">(${dup.section_name}, ${dup.similarity}% ìœ ì‚¬)</span>
                            </div>
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;" onclick="goToCaseDetail(${dup.id})">ë³´ê¸°</button>
                        </div>
                    `;
                }).join('');
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        } catch (err) {
            console.error('ì¤‘ë³µ ì²´í¬ ì‹¤íŒ¨:', err);
        }
    }, 500);  // 500ms debounce
}

function goToCaseDetail(caseId) {
    // ì¼€ì´ìŠ¤ ìƒì„¸ë¡œ ì´ë™ (í˜„ì¬ëŠ” alert)
    alert(`ì¼€ì´ìŠ¤ #${caseId} ìƒì„¸ ë³´ê¸° (í–¥í›„ êµ¬í˜„)`);
}

// ì¼€ì´ìŠ¤ í¸ì§‘
function editCase(caseId, currentTitle) {
    const newTitle = prompt('ì¼€ì´ìŠ¤ ì œëª©:', currentTitle);
    if (!newTitle || newTitle === currentTitle) return;
    
    fetch(`/api/cases/${caseId}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ title: newTitle })
    })
    .then(res => res.json())
    .then(data => {
        location.reload();
    })
    .catch(err => alert('ì¼€ì´ìŠ¤ ìˆ˜ì • ì‹¤íŒ¨: ' + err));
}

// ì¼€ì´ìŠ¤ ì‚­ì œ (ì•„ì¹´ì´ë¸Œ)
function deleteCase(caseId) {
    if (!confirm('ì´ ì¼€ì´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    fetch(`/api/cases/${caseId}/archive`, {
        method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
        location.reload();
    })
    .catch(err => alert('ì¼€ì´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨: ' + err));
}

// ì¼ê´„ ì¶”ê°€ í† ê¸€
function toggleBulkAdd() {
    const singleForm = document.getElementById('singleAddForm');
    const bulkForm = document.getElementById('bulkAddForm');
    
    if (bulkForm.style.display === 'none') {
        singleForm.style.display = 'none';
        bulkForm.style.display = 'block';
        document.getElementById('bulkAddText').focus();
    } else {
        singleForm.style.display = 'flex';
        bulkForm.style.display = 'none';
        document.getElementById('bulkAddText').value = '';
    }
}

// ì—¬ëŸ¬ ì¼€ì´ìŠ¤ ì¼ê´„ ì¶”ê°€
async function bulkAddCases(event) {
    event.preventDefault();
    
    if (!currentSectionId) {
        alert('ì„¹ì…˜ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const text = document.getElementById('bulkAddText').value;
    const titles = text.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
    
    if (titles.length === 0) {
        alert('ì¶”ê°€í•  ì¼€ì´ìŠ¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!confirm(`${titles.length}ê°œì˜ ì¼€ì´ìŠ¤ë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    let successCount = 0;
    let failCount = 0;
    
    for (const title of titles) {
        try {
            const res = await fetch(`/api/projects/${projectId}/cases`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title: title,
                    section_id: currentSectionId
                })
            });
            
            if (res.ok) {
                successCount++;
            } else {
                failCount++;
            }
        } catch (err) {
            failCount++;
        }
    }
    
    alert(`ì™„ë£Œ!\nì„±ê³µ: ${successCount}ê°œ\nì‹¤íŒ¨: ${failCount}ê°œ`);
    location.reload();
}

// ì •ë ¬ ë³€ê²½
function changeSort(sortType) {
    const url = new URL(window.location.href);
    url.searchParams.set('sort', sortType);
    window.location.href = url.toString();
}

// ì¼€ì´ìŠ¤ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™”
function initCaseSortable() {
    const caseList = document.getElementById('caseListSortable');
    if (!caseList || typeof Sortable === 'undefined') return;
    
    // ê¸°ë³¸ ì •ë ¬ì¼ ë•Œë§Œ ë“œë˜ê·¸ ê°€ëŠ¥
    const isDefaultSort = currentSort === 'default' || currentSort === '';
    
    new Sortable(caseList, {
        animation: 150,
        handle: '.case-content',
        ghostClass: 'sortable-ghost',
        disabled: !isDefaultSort,  // ê¸°ë³¸ ì •ë ¬ì´ ì•„ë‹ˆë©´ ë¹„í™œì„±í™”
        onEnd: function(evt) {
            updateCaseOrder(evt);
        }
    });
    
    console.log('Sortable ì´ˆê¸°í™”:', isDefaultSort ? 'ë“œë˜ê·¸ ê°€ëŠ¥' : 'ë“œë˜ê·¸ ë¶ˆê°€');
}

// ì¼€ì´ìŠ¤ ìˆœì„œ ì—…ë°ì´íŠ¸
function updateCaseOrder(evt) {
    const caseId = evt.item.dataset.caseId;
    const newIndex = evt.newIndex;
    
    fetch(`/api/cases/${caseId}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            order_index: newIndex
        })
    })
    .then(res => res.json())
    .then(data => {
        console.log('ì¼€ì´ìŠ¤ ìˆœì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    })
    .catch(err => {
        alert('ìˆœì„œ ë³€ê²½ ì‹¤íŒ¨: ' + err);
        location.reload();
    });
}

// ì¼€ì´ìŠ¤ ë³µì‚¬
async function copyCase(caseId) {
    if (!confirm('ì´ ì¼€ì´ìŠ¤ë¥¼ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        // í˜„ì¬ ì¼€ì´ìŠ¤ì˜ order_index ì°¾ê¸°
        const caseItem = document.querySelector(`.case-item[data-case-id="${caseId}"]`);
        const allCases = Array.from(document.querySelectorAll('.case-item'));
        const currentIndex = allCases.indexOf(caseItem);
        
        const res = await fetch(`/api/cases/${caseId}/copy`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                insert_after: currentIndex  // í˜„ì¬ ìœ„ì¹˜ ë°”ë¡œ ë‹¤ìŒì— ì‚½ì…
            })
        });
        
        if (res.ok) {
            alert('ì¼€ì´ìŠ¤ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.reload();
        } else {
            alert('ë³µì‚¬ ì‹¤íŒ¨');
        }
    } catch (err) {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + err);
    }
}

// ì¼€ì´ìŠ¤ ìƒì„¸ë³´ê¸°
let currentCaseId = null;

async function showCaseDetail(caseId) {
    try {
        const res = await fetch(`/api/cases/${caseId}`);
        if (!res.ok) throw new Error('ì¼€ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨');
        
        const caseData = await res.json();
        currentCaseId = caseId;
        
        const modalTitle = document.getElementById('modalCaseTitle');
        const modalContent = document.getElementById('modalCaseContent');
        const modal = document.getElementById('caseDetailModal');
        
        if (!modalTitle || !modalContent || !modal) {
            console.error('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            alert('ëª¨ë‹¬ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        const escapeHtml = (text) => {
            if (!text) return '';
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return String(text).replace(/[&<>"']/g, m => map[m]);
        };
        
        modalTitle.innerHTML = `
            <div contenteditable="true" id="modalTitle" 
                 style="display: inline-block; min-width: 300px; border: 1px solid transparent; padding: 0.25rem; border-radius: 4px; outline: none;"
                 onblur="updateModalField('title', this.textContent.trim())"
                 onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                 onblur="this.style.border='1px solid transparent'; this.style.background='transparent';">
${escapeHtml(caseData.title)}</div>
        `;
        
        modalContent.innerHTML = `
            <div style="margin-bottom: 1rem;">
                <strong>ìš°ì„ ìˆœìœ„:</strong>
                <select id="modalPriority" class="form-control" style="display: inline-block; width: auto; margin-left: 0.5rem;" 
                        onchange="updateModalField('priority', this.value)">
                    <option value="Critical" ${caseData.priority === 'Critical' ? 'selected' : ''}>Critical</option>
                    <option value="High" ${caseData.priority === 'High' ? 'selected' : ''}>High</option>
                    <option value="Medium" ${caseData.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                    <option value="Low" ${caseData.priority === 'Low' ? 'selected' : ''}>Low</option>
                </select>
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>ë‹´ë‹¹ì:</strong> ${escapeHtml(caseData.owner_name) || 'ì—†ìŒ'}
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>ì„¹ì…˜:</strong> ${escapeHtml(caseData.section_name)}
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>íƒœê·¸:</strong> ${caseData.tags.length > 0 ? caseData.tags.map(t => `<span class="tag-badge">${escapeHtml(t)}</span>`).join(' ') : 'ì—†ìŒ'}
            </div>
            <hr>
            <div style="margin-bottom: 1rem;">
                <h4>í…ŒìŠ¤íŠ¸ ìŠ¤í… <small style="color: #999; font-weight: normal;">ğŸ’¡ í´ë¦­í•˜ì—¬ í¸ì§‘</small></h4>
                <div contenteditable="true" id="modalSteps" 
                     style="white-space: pre-wrap; background: #f9f9f9; padding: 1rem; border-radius: 4px; border: 1px solid transparent; min-height: 100px; outline: none;"
                     onblur="updateModalField('steps', this.textContent.trim())"
                     onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                     onblur="this.style.border='1px solid transparent'; this.style.background='#f9f9f9';">${escapeHtml(caseData.steps) || 'ìŠ¤í… ì •ë³´ ì—†ìŒ'}</div>
            </div>
            <div style="margin-bottom: 1rem;">
                <h4>ê¸°ëŒ€ ê²°ê³¼ <small style="color: #999; font-weight: normal;">ğŸ’¡ í´ë¦­í•˜ì—¬ í¸ì§‘</small></h4>
                <div contenteditable="true" id="modalExpected" 
                     style="white-space: pre-wrap; background: #f9f9f9; padding: 1rem; border-radius: 4px; border: 1px solid transparent; min-height: 100px; outline: none;"
                     onblur="updateModalField('expected_result', this.textContent.trim())"
                     onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                     onblur="this.style.border='1px solid transparent'; this.style.background='#f9f9f9';">${escapeHtml(caseData.expected_result) || 'ê¸°ëŒ€ ê²°ê³¼ ì—†ìŒ'}</div>
            </div>
            <hr>
            <div style="font-size: 0.9rem; color: #666;">
                <div>ìƒì„±: ${new Date(caseData.created_at).toLocaleString('ko-KR')}</div>
                <div>ìˆ˜ì •: ${new Date(caseData.updated_at).toLocaleString('ko-KR')}</div>
            </div>
        `;
        
        modal.style.display = 'block';
    } catch (err) {
        console.error('ì¼€ì´ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', err);
        alert('ì¼€ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
    }
}

// ëª¨ë‹¬ í•„ë“œ ì—…ë°ì´íŠ¸
async function updateModalField(field, value) {
    if (!currentCaseId) return;
    
    try {
        const response = await fetch(`/api/cases/${currentCaseId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ [field]: value })
        });
        
        if (!response.ok) {
            throw new Error('ì €ì¥ ì‹¤íŒ¨');
        }
        
        console.log('ì €ì¥ ì™„ë£Œ:', field, value);
        
        // í˜ì´ì§€ì˜ ì¼€ì´ìŠ¤ ëª©ë¡ë„ ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨ ì—†ì´)
        const caseItem = document.querySelector(`.case-item[data-case-id="${currentCaseId}"]`);
        if (caseItem && field === 'title') {
            const titleElement = caseItem.querySelector('.case-title');
            if (titleElement) titleElement.textContent = value;
        }
        
    } catch (err) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', err);
        alert('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
    }
}

function closeCaseDetail() {
    document.getElementById('caseDetailModal').style.display = 'none';
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
window.onclick = function(event) {
    const modal = document.getElementById('caseDetailModal');
    if (event.target === modal) {
        closeCaseDetail();
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initCaseSortable();
});
</script>
{% endblock %}


