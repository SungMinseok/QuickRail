{% extends "base.html" %}

{% block title %}{{ project.name }} - ì¼€ì´ìŠ¤ ê´€ë¦¬{% endblock %}

{# ì¬ê·€ ë§¤í¬ë¡œ: ì„¹ì…˜ íŠ¸ë¦¬ë¥¼ ìµœëŒ€ 4ë‹¨ê³„ê¹Œì§€ ë Œë”ë§ #}
{% macro render_sections(sections, current_section_id, current_user, depth) %}
    {% if depth < 4 %}
        {% for section in sections %}
            <div class="section-wrapper" data-section-id="{{ section.id }}" data-depth="{{ depth }}" data-section-name="{{ section.name }}">
                <div class="section-item {% if current_section_id == section.id %}active{% endif %}" data-section-id="{{ section.id }}">
                    {% if section.children %}
                    <span class="section-toggle" onclick="event.stopPropagation(); toggleSection({{ section.id }})" title="ì ‘ê¸°/í¼ì¹˜ê¸°" style="cursor: pointer; display: inline-block; width: 16px; text-align: center; user-select: none;">â–¼</span>
                    {% else %}
                    <span style="display: inline-block; width: 16px;"></span>
                    {% endif %}
                    <span onclick="goToSection({{ section.id }})" style="cursor: pointer; flex: 1; display: flex; align-items: center; gap: 0.5rem; min-width: 0;">
                        <span style="flex-shrink: 0;">{% if depth == 0 %}ğŸ“‚{% elif depth == 1 %}ğŸ“„{% elif depth == 2 %}ğŸ“‹{% else %}ğŸ“Œ{% endif %}</span>
                        <span class="section-name">{{ section.name }}</span>
                    </span>
                    {% if current_user.role in ['admin', 'author'] %}
                    <button class="section-menu-trigger" onclick="event.stopPropagation(); toggleSectionMenu({{ section.id }}, event)" title="ë©”ë‰´">â‹®</button>
                    <div class="section-context-menu" id="section-menu-{{ section.id }}">
                        {% if depth < 4 %}
                        <button class="section-context-menu-item" onclick="event.stopPropagation(); addSection({{ section.id }}, {{ depth + 1 }}); closeSectionMenu({{ section.id }})">
                            <span>â•</span>
                            <span>í•˜ìœ„ ì„¹ì…˜ ì¶”ê°€</span>
                        </button>
                        {% endif %}
                        <button class="section-context-menu-item" onclick="event.stopPropagation(); editSection({{ section.id }}, '{{ section.name }}'); closeSectionMenu({{ section.id }})">
                            <span>âœï¸</span>
                            <span>ì´ë¦„ ë³€ê²½</span>
                        </button>
                        <button class="section-context-menu-item danger" onclick="event.stopPropagation(); deleteSection({{ section.id }}); closeSectionMenu({{ section.id }})">
                            <span>ğŸ—‘ï¸</span>
                            <span>ì‚­ì œ</span>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% if section.children %}
                <div class="section-children sortable-list" data-parent-id="{{ section.id }}" data-depth="{{ depth + 1 }}">
                    {{ render_sections(section.children, current_section_id, current_user, depth + 1) }}
                </div>
                {% endif %}
            </div>
        {% endfor %}
    {% endif %}
{% endmacro %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
    .two-pane-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 1.5rem;
        min-height: calc(100vh - 80px - 4rem); /* ìµœì†Œ ë†’ì´ ì„¤ì • */
        align-items: start; /* ìƒë‹¨ ì •ë ¬ */
    }
    
    .section-tree {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        overflow: hidden; /* ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        height: calc(100vh - 80px - 4rem); /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ë†’ì´(80px) + ì»¨í…Œì´ë„ˆ íŒ¨ë”©(4rem) ì œì™¸ */
        position: sticky; /* ìŠ¤í¬ë¡¤ ì‹œ ìƒë‹¨ ê³ ì • */
        top: calc(80px + 2rem); /* ë„¤ë¹„ê²Œì´ì…˜ ë°” + ì»¨í…Œì´ë„ˆ ìƒë‹¨ íŒ¨ë”© */
        display: flex;
        flex-direction: column;
    }
    
    .section-tree > div:first-child {
        flex-shrink: 0; /* í—¤ë” ì˜ì—­ì€ ê³ ì • */
    }
    
    .section-tree > div:nth-child(2) {
        flex-shrink: 0; /* ê²€ìƒ‰ ë° ì»¨íŠ¸ë¡¤ ì˜ì—­ì€ ê³ ì • */
    }
    
    #sectionTree {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0; /* Flexbox ì œì•½ í•´ì œ */
        padding-right: 0.5rem; /* ìŠ¤í¬ë¡¤ë°” ì—¬ë°± */
    }
    
    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
    #sectionTree::-webkit-scrollbar {
        width: 8px;
    }
    
    #sectionTree::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    #sectionTree::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    
    #sectionTree::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    .section-wrapper {
        margin: 0;
        padding: 0;
    }
    
    .section-item {
        padding: 0.5rem 0.75rem;
        margin: 0;
        border-radius: 4px;
        cursor: move;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        position: relative;
    }
    
    .section-item:hover {
        background: #f0f0f0;
    }
    
    .section-item.active {
        background: #3498db;
        color: white;
    }
    
    .section-toggle {
        font-size: 0.8rem;
        transition: transform 0.2s;
        flex-shrink: 0;
    }
    
    .section-wrapper.collapsed > .section-item .section-toggle {
        transform: rotate(-90deg);
    }
    
    .section-wrapper.collapsed > .section-children {
        display: none;
    }
    
    .section-wrapper.hidden {
        display: none;
    }
    
    .section-item.sortable-ghost {
        opacity: 0.4;
        background: #e3f2fd;
    }
    
    .section-item.sortable-drag {
        opacity: 0.8;
    }
    
    .section-children {
        margin-left: 1.5rem;
        margin-top: 0;
        margin-bottom: 0;
        padding-left: 0.5rem;
        padding-top: 0;
        padding-bottom: 0;
        border-left: 2px solid #e0e0e0;
    }
    
    .section-name {
        flex: 1;
        cursor: pointer;
        word-break: break-word; /* ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ */
        line-height: 1.4;
        min-width: 0;
    }
    
    /* ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë²„íŠ¼ (â‹®) */
    .section-menu-trigger {
        display: none;
        width: 24px;
        height: 24px;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 4px;
        font-size: 1.2rem;
        line-height: 1;
        flex-shrink: 0;
        background: transparent;
        border: none;
        padding: 0;
        color: inherit;
    }
    
    .section-item:hover .section-menu-trigger {
        display: flex;
    }
    
    .section-menu-trigger:hover {
        background: rgba(0,0,0,0.1);
    }
    
    .section-item.active .section-menu-trigger:hover {
        background: rgba(255,255,255,0.2);
    }
    
    /* ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ */
    .section-context-menu {
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 150px;
        padding: 0.25rem 0;
        display: none;
        margin-top: 2px;
    }
    
    .section-context-menu.show {
        display: block;
    }
    
    .section-context-menu-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #333;
        background: white;
        border: none;
        width: 100%;
        text-align: left;
        transition: background 0.2s;
    }
    
    .section-context-menu-item:hover {
        background: #f5f5f5;
    }
    
    .section-context-menu-item:active {
        background: #e8e8e8;
    }
    
    .section-context-menu-item.danger:hover {
        background: #ffebee;
        color: #e74c3c;
    }
    
    /* ê¸°ì¡´ section-actions ìˆ¨ê¹€ */
    .section-actions {
        display: none !important;
    }
    
    .section-btn {
        padding: 0.2rem 0.4rem;
        background: transparent;
        border: none;
        cursor: pointer;
        border-radius: 3px;
        font-size: 1rem;
        line-height: 1;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .section-btn:hover {
        background: rgba(0,0,0,0.1);
    }
    
    .section-item.active .section-btn:hover {
        background: rgba(255,255,255,0.2);
    }
    
    .sortable-list {
        min-height: 20px;
    }
    
    .case-panel {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .case-filters {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .case-list {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        overflow-y: auto;
        position: relative;
    }
    
    .case-list.loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .case-list-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        z-index: 100;
        background: rgba(255, 255, 255, 0.95);
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .case-list.loading .case-list-loading {
        display: flex;
    }
    
    .case-list-loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .case-list-loading-text {
        color: #666;
        font-size: 0.9rem;
    }
    
    .case-item {
        padding: 1rem;
        border-bottom: 1px solid #eee;
        display: flex;
        gap: 1rem;
        align-items: start;
        transition: none; /* ì• ë‹ˆë©”ì´ì…˜ ì™„ì „íˆ ì œê±° */
    }
    
    .case-item:hover {
        background: #f9f9f9;
    }
    
    .case-item:last-child {
        border-bottom: none;
    }
    
    .case-drag-handle {
        cursor: grab;
        color: #999;
        font-size: 0.5em;
        padding: 0.25rem 0.5rem;
        display: flex;
        /* align-items: first baseline; */
        user-select: none;
        margin-top: 6px;
    }
    
    .case-drag-handle:active {
        cursor: grabbing;
        margin-top: 8px;
    }
    
    .case-checkbox {
        margin-top: 0.25rem;
        width: 18px;
        height: 18px;
        cursor: pointer;
        margin-top: 8px;
    }
    
    .case-content {
        transition: none; /* ì• ë‹ˆë©”ì´ì…˜ ì œê±° */
        flex: 1;
    }
    
    .case-item.sortable-ghost {
        opacity: 0.4;
        background: #e3f2fd;
    }
    
    .case-item.sortable-drag {
        opacity: 0.8;
    }
    
    .view-toggle {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .view-toggle-btn {
        padding: 0.25rem 0.75rem;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: none; /* ì• ë‹ˆë©”ì´ì…˜ ì œê±° */
    }
    
    .view-toggle-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }
    
    .view-toggle-btn:hover {
        background: #e0e0e0;
    }
    
    .view-toggle-btn.active:hover {
        background: #2980b9;
    }
    
    /* í¸ì§‘ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
    .case-list-container.edit-mode {
        border: 2px solid #3498db;
        border-radius: 8px;
    }
    
    .case-item.edit-mode-selected {
        background: #e3f2fd !important;
        border: 2px solid #2196f3 !important;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }
    
    .case-item.edit-mode-selected .case-title {
        font-weight: 600;
        color: #1976d2;
    }
    
    .case-list-container.edit-mode .case-item {
        cursor: default;
    }
    
    /* í¸ì§‘ ëª¨ë“œ ë‹¨ì¶•í‚¤ ê°€ì´ë“œ */
    #editModeShortcutGuide {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        font-size: 0.85rem;
        z-index: 1000;
        display: block; /* í¸ì§‘ëª¨ë“œê°€ ì•„ë‹ ë•Œë„ í‘œì‹œ */
        min-width: 280px;
        transition: all 0.3s ease;
    }
    
    #editModeShortcutGuide.edit-mode-only {
        display: none; /* í¸ì§‘ëª¨ë“œê°€ ì•„ë‹ ë•Œ ìˆ¨ê¹€ (ê¸°ë³¸ê°’) */
    }
    
    #editModeShortcutGuide.edit-mode-only.show {
        display: block; /* í¸ì§‘ëª¨ë“œì¼ ë•Œ í‘œì‹œ */
    }
    
    #editModeShortcutGuide:not(.edit-mode-active) .shortcut-item:not(:first-child) {
        display: none; /* í¸ì§‘ëª¨ë“œê°€ ì•„ë‹ ë•ŒëŠ” ì²« ë²ˆì§¸ í•­ëª©(í† ê¸€ í‚¤)ë§Œ í‘œì‹œ */
    }
    
    #editModeShortcutGuide.edit-mode-active .shortcut-item {
        display: flex; /* í¸ì§‘ëª¨ë“œì¼ ë•ŒëŠ” ëª¨ë“  í•­ëª© í‘œì‹œ */
    }
    
    #editModeShortcutGuide.collapsed {
        position: fixed;
        bottom: 20px;
        right: 20px;
        top: auto;
        padding: 0.3rem 0.5rem;
        min-width: auto;
        width: auto;
        background: rgba(0, 0, 0, 0.7);
    }
    
    #editModeShortcutGuide.collapsed .shortcut-content {
        display: none;
    }
    
    #editModeShortcutGuide.collapsed .shortcut-toggle-btn {
        display: flex;
    }
    
    #editModeShortcutGuide .shortcut-content {
        display: block;
    }
    
    #editModeShortcutGuide .shortcut-toggle-btn {
        display: none;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        cursor: pointer;
        border: none;
        background: transparent;
        color: white;
        font-size: 1rem;
        padding: 0;
        margin: 0;
    }
    
    #editModeShortcutGuide .shortcut-toggle-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
    }
    
    #editModeShortcutGuide h4 {
        margin: 0 0 0.75rem 0;
        font-size: 0.95rem;
        color: #3498db;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    #editModeShortcutGuide .shortcut-toggle-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    #editModeShortcutGuide .shortcut-collapse-btn {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        font-size: 0.9rem;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        transition: all 0.2s;
    }
    
    #editModeShortcutGuide .shortcut-collapse-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }
    
    #editModeShortcutGuide .shortcut-item {
        display: flex;
        justify-content: space-between;
        margin: 0.4rem 0;
        line-height: 1.4;
    }
    
    #editModeShortcutGuide .shortcut-key {
        background: rgba(255, 255, 255, 0.15);
        padding: 0.15rem 0.5rem;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.8rem;
        margin-left: 1rem;
        white-space: nowrap;
    }
    
    #editModeShortcutGuide .shortcut-desc {
        flex: 1;
    }
    
    .case-item.compact-view .case-meta {
        display: none;
        transition: none !important; /* ì• ë‹ˆë©”ì´ì…˜ ì œê±° */
    }
    
    .case-item.compact-view {
        transition: none !important; /* ì• ë‹ˆë©”ì´ì…˜ ì™„ì „íˆ ì œê±° */
        padding: 0.5rem 1rem;
        min-height: auto;
    }
    
    .case-item.compact-view .case-content {
        transition: none !important; /* ì• ë‹ˆë©”ì´ì…˜ ì œê±° */
    }
    
    .case-item.compact-view .case-title {
        margin-bottom: 0;
        font-size: 1rem;
        transition: none !important; /* ë·° ì „í™˜ ì‹œ ë ˆì´ì•„ì›ƒ ë³€í™” ì• ë‹ˆë©”ì´ì…˜ ë°©ì§€ */
    }
    
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        animation: fadeIn 0.3s;
    }
    
    .modal.show {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        position: relative;
    }
    
    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }
    
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .close:hover {
        color: #000;
    }
    
    .case-item.selected {
        background: #e8f5e9;
    }
    
    /* ì²´í¬ë°•ìŠ¤ë¡œ ì¸í•œ ì„ íƒì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ border-left í‘œì‹œ */
    .case-item.selected:not(.checkbox-selected) {
        border-left: 3px solid #27ae60;
    }
    
    .case-actions {
        display: none;
        flex-shrink: 0;
        position: relative;
    }
    
    .case-item:hover .case-actions {
        display: block;
    }
    
    .case-menu-trigger {
        display: none;
        width: 24px;
        height: 24px;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 4px;
        font-size: 1.2rem;
        line-height: 1;
        flex-shrink: 0;
        background: transparent;
        border: none;
        padding: 0;
        color: inherit;
    }
    
    .case-item:hover .case-menu-trigger {
        display: flex;
    }
    
    .case-menu-trigger:hover {
        background: rgba(0,0,0,0.1);
    }
    
    /* ì¼€ì´ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ */
    .case-context-menu {
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 150px;
        padding: 0.25rem 0;
        display: none;
        margin-top: 2px;
    }
    
    .case-context-menu.show {
        display: block;
    }
    
    .case-context-menu-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #333;
        background: white;
        border: none;
        width: 100%;
        text-align: left;
        transition: background 0.2s;
    }
    
    .case-context-menu-item:hover {
        background: #f5f5f5;
    }
    
    .case-context-menu-item:active {
        background: #e0e0e0;
    }
    
    .case-context-menu-item.danger {
        color: #e74c3c;
    }
    
    .case-context-menu-item.danger:hover {
        background: #fee;
        color: #c0392b;
    }
    
    .case-action-btn {
        padding: 0.25rem 0.5rem;
        background: transparent;
        border: 1px solid #ddd;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
    }
    
    .case-action-btn:hover {
        background: #f0f0f0;
        border-color: #999;
    }
    
    .case-action-btn.edit:hover {
        background: #e3f2fd;
        border-color: #3498db;
        color: #3498db;
    }
    
    .case-action-btn.delete:hover {
        background: #ffebee;
        border-color: #e74c3c;
        color: #e74c3c;
    }
    
    .case-title {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        cursor: default;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        /* 'all'ì€ font-size/margin ë“± ë ˆì´ì•„ì›ƒê¹Œì§€ ì• ë‹ˆë©”ì´ì…˜ë˜ì–´ ë·° ì „í™˜ ì‹œ í”ë“¤ë¦¼ ë°œìƒ */
        transition: color 0.2s, background 0.2s, border-color 0.2s;
        border: 1px solid transparent;
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* contenteditable í¬ì»¤ìŠ¤ ì‹œ ë¸Œë¼ìš°ì € ê¸°ë³¸ outline(ê²€ì€/í‘¸ë¥¸ í…Œë‘ë¦¬) ì œê±° */
    .case-title-text[contenteditable="true"] {
        outline: none !important;
        border: none !important;
        box-shadow: none !important;
    }
    .case-title-text[contenteditable="true"]:focus {
        outline: none !important;
        border: none !important;
        box-shadow: none !important;
    }
    
    .case-title:hover {
        color: #3498db;
        background: #f0f8ff;
    }
    
    /* ì—°í•„ ì•„ì´ì½˜ ì œê±°ë¨ */
    
    /* í˜¸ë²„ ì‹œ í¸ì§‘ ì•ˆë‚´ í…ìŠ¤íŠ¸ */
    .case-title-edit-hint {
        display: none;
        color: #3498db;
        font-size: 0.85rem;
        margin-left: auto;
        margin-right: 0.5rem;
        user-select: none;
    }
    
    .case-title:hover .case-title-edit-hint {
        display: inline-block;
    }
    
    .case-title.editing .case-title-edit-hint {
        display: none;
    }
    
    .case-title.editing {
        background: #fff;
        border: 2px solid #3498db;
        outline: none;
        cursor: text;
        padding: 0.25rem 0.5rem;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    /* ì²´í¬ë°•ìŠ¤ë¡œ ì¸í•œ ì„ íƒì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ìŠ¤íƒ€ì¼ ì ìš© */
    .case-item.selected:not(.checkbox-selected) .case-title {
        background: #e8f5e9;
        font-weight: 600;
        border-color: #27ae60;
    }
    
    .case-item.selected:not(.checkbox-selected) .case-title:hover {
        background: #c8e6c9;
        border-color: #27ae60;
    }
    
    
    .case-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.9rem;
        color: #666;
        flex-wrap: wrap;
    }
    
    .priority-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .priority-P0 { background: #e74c3c; color: white; }
    .priority-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .priority-badge svg {
        width: 16px;
        height: 16px;
        margin-right: 0.25rem;
    }
    
    .priority-Blocker { background: #ffebe6; color: #bf2600; border: 1px solid #ff5630; }
    .priority-Critical { background: #ffebe6; color: #bf2600; border: 1px solid #ff5630; }
    .priority-High { background: #ffebe6; color: #bf2600; border: 1px solid #ff5630; }
    .priority-Medium { background: #fff4e6; color: #974f0c; border: 1px solid #ff991f; }
    .priority-Low { background: #deebff; color: #0747a6; border: 1px solid #4c9aff; }
    
    .tag-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        background: #3498db;
        color: white;
        font-size: 0.8rem;
    }
    
    .quick-add-form {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}

<div class="two-pane-layout">
    <!-- ì¢Œì¸¡: Section íŠ¸ë¦¬ -->
    <div class="section-tree">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>ì„¹ì…˜</h3>
            {% if current_user.role in ['admin', 'author'] %}
            <button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.9rem;" onclick="addSection(null)">+ ë£¨íŠ¸</button>
            {% endif %}
        </div>
        
        <!-- ì„¹ì…˜ ê²€ìƒ‰ ë° ì»¨íŠ¸ë¡¤ -->
        <div style="padding: 0.5rem 1rem;">
            <input type="text" id="sectionSearchInput" class="form-control" placeholder="ğŸ” ì„¹ì…˜ ê²€ìƒ‰..." 
                   oninput="filterSectionTree(this.value)" 
                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; margin-bottom: 0.5rem;">
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="expandAllSections()" class="btn btn-secondary" style="flex: 1; padding: 0.4rem; font-size: 0.85rem;">
                    â–¼ ëª¨ë‘ í¼ì¹˜ê¸°
                </button>
                <button onclick="collapseAllSections()" class="btn btn-secondary" style="flex: 1; padding: 0.4rem; font-size: 0.85rem;">
                    â–¶ ëª¨ë‘ ì ‘ê¸°
                </button>
            </div>
        </div>
        
        <!-- ì „ì²´ ì¼€ì´ìŠ¤ ì„¹ì…˜ ìˆ¨ê¹€ -->
        <!-- <div class="section-item {% if not current_section_id %}active{% endif %}" onclick="goToSection(null)" style="cursor: pointer;">
            <span>ğŸ“</span>
            <span class="section-name">ì „ì²´ ì¼€ì´ìŠ¤</span>
        </div> -->
        
        <div id="sectionTree" class="sortable-list">
            {{ render_sections(sections, current_section_id, current_user, 0) }}
        </div>
    </div>
    
    <!-- ìš°ì¸¡: Case ë¦¬ìŠ¤íŠ¸ -->
    <div class="case-panel">
        <!-- í•„í„° -->
        <div class="case-filters">
            <input type="text" placeholder="ê²€ìƒ‰..." class="form-control" style="max-width: 300px;" value="{{ search }}" 
                   onkeyup="if(event.key=='Enter') filterCases()">
            
            <select class="form-control" style="max-width: 150px;" onchange="filterCases()">
                <option value="">ëª¨ë“  ìš°ì„ ìˆœìœ„</option>
                <option value="Blocker" {% if priority=='Blocker' %}selected{% endif %}>Blocker</option>
                <option value="Critical" {% if priority=='Critical' %}selected{% endif %}>Critical</option>
                <option value="High" {% if priority=='High' %}selected{% endif %}>High</option>
                <option value="Medium" {% if priority=='Medium' %}selected{% endif %}>Medium</option>
                <option value="Low" {% if priority=='Low' %}selected{% endif %}>Low</option>
            </select>
            
            <select class="form-control" style="max-width: 200px;" onchange="filterCases()">
                <option value="">ëª¨ë“  íƒœê·¸</option>
                {% for tag in tags %}
                <option value="{{ tag.name }}" {% if selected_tag==tag.name %}selected{% endif %}>{{ tag.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Quick Add -->
        {% if current_user.role in ['admin', 'author'] %}
        <div class="card">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <button type="button" class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="toggleBulkAdd()">ğŸ“ ì—¬ëŸ¬ ê°œ ì¶”ê°€</button>
                <button type="button" class="btn btn-primary" style="padding: 0.5rem 1rem;" onclick="openImportModal()">ğŸ“¥ Import (CSV/Excel)</button>
            </div>
            <form class="quick-add-form" id="singleAddForm" onsubmit="quickAddCase(event)">
                <input type="text" id="quickAddTitle" placeholder="ì¼€ì´ìŠ¤ ì œëª© ì…ë ¥ í›„ Enter..." class="form-control" required 
                       oninput="checkDuplicates(this.value)">
                <button type="submit" class="btn btn-success" style="width: 100px;">ì¶”ê°€</button> 
            </form>
            <form id="bulkAddForm" style="display: none;" onsubmit="bulkAddCases(event)">
                <textarea id="bulkAddText" class="form-control" placeholder="ì¼€ì´ìŠ¤ ì œëª©ë“¤ì„ ê°œí–‰(ì—”í„°)ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”..." 
                          style="min-height: 150px; font-family: monospace;"></textarea>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="submit" class="btn btn-success">ì¼ê´„ ì¶”ê°€</button>
                    <button type="button" class="btn btn-secondary" onclick="toggleBulkAdd()">ì·¨ì†Œ</button>
                </div>
            </form>
            <div id="duplicateWarning" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px;">
                <strong>âš ï¸ ìœ ì‚¬í•œ ì¼€ì´ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤:</strong>
                <div id="duplicateList" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
            </div>
        </div>
        {% endif %}
        
        <!-- Case ë¦¬ìŠ¤íŠ¸ -->
        <div class="case-list" id="caseList">
            <div class="case-list-loading">
                <div class="case-list-loading-spinner"></div>
                <div class="case-list-loading-text">ì¼€ì´ìŠ¤ ë¡œë”© ì¤‘...</div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <h3 style="margin: 0;">ì¼€ì´ìŠ¤ ({{ cases|length }})</h3>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="selectAllCases" onchange="toggleSelectAll(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>ì „ì²´ ì„ íƒ</span>
                    </label>
                    {% if current_user.role in ['admin', 'author'] %}
                    <button class="btn btn-danger" id="deleteSelectedBtn" onclick="deleteSelectedCases()" style="padding: 0.25rem 0.75rem; font-size: 0.85rem; display: none;">
                        ì„ íƒ ì‚­ì œ
                    </button>
                    <div style="display: none; align-items: center; gap: 0.5rem;" id="bulkPriorityContainer">
                        <label style="font-size: 0.85rem; margin: 0;">ìš°ì„ ìˆœìœ„ ì¼ê´„ë³€ê²½:</label>
                        <select id="bulkPrioritySelect" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">ì„ íƒ...</option>
                            <option value="Blocker">Blocker</option>
                            <option value="Critical">Critical</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                        <button class="btn btn-primary" onclick="bulkChangePriority()" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                            ì ìš©
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    {% if current_section_id %}
                    <button class="btn btn-primary" onclick="exportSectionCasesCSV()" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                        ë‚´ë³´ë‚´ê¸°
                    </button>
                    {% endif %}
                    <div class="view-toggle">
                        <button class="view-toggle-btn" id="editModeToggle" onclick="toggleEditMode()">
                            í¸ì§‘
                        </button>
                        <button class="view-toggle-btn" id="viewToggleBtn" onclick="toggleViewMode()" title="ê°„í¸ë³´ê¸°/ìƒì„¸ë³´ê¸° í† ê¸€">
                            <span id="viewToggleIcon">ğŸ“„</span>
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
                        <span style="font-size: 0.9rem;">ğŸŒ</span>
                        <select id="languageSelect" onchange="changeLanguage(this.value)" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="original" selected>ì›ë³¸</option>
                            <option value="ko">í•œêµ­ì–´</option>
                            <option value="en">English</option>
                        </select>
                        <button id="retranslateBtn" class="btn btn-secondary" type="button"
                                onclick="retranslateCurrentLanguage()"
                                title="í˜„ì¬ ì–¸ì–´ë¡œ ì¬ë²ˆì—­ (ê¸°ì¡´ ë²ˆì—­ ìºì‹œ ë¬´ì‹œ)"
                                style="padding: 0.25rem 0.75rem; font-size: 0.85rem; display: none;">
                            ğŸ”„ ì¬ë²ˆì—­
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="caseListSortable">
            {% if cases_by_section and cases_by_section|length > 0 %}
                {# ì„¹ì…˜ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ í‘œì‹œ #}
                {% for section_id, section_data in cases_by_section.items() %}
                <div class="section-group-header" data-section-id="{{ section_id }}" style="padding: 0.75rem 1rem; background: #f5f5f5; border-left: 3px solid #3498db; margin: 1rem 0 0.5rem 0; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.75rem;" onclick="goToSection({{ section_id }})">
                    <input type="checkbox"
                           class="section-select-checkbox"
                           data-section-id="{{ section_id }}"
                           onclick="event.stopPropagation()"
                           onchange="toggleSectionCasesSelection({{ section_id }}, this, event)"
                           style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="flex: 1;">ğŸ“ {{ section_data.section.get_full_path() }} ({{ section_data.cases|length }})</span>
                </div>
                {% for case in section_data.cases %}
                <div class="case-item" data-case-id="{{ case.id }}" data-section-id="{{ case.section_id }}" data-order-index="{{ case.order_index }}">
                    <div class="case-drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â˜°</div>
                    <input type="checkbox" class="case-checkbox" data-case-id="{{ case.id }}" data-case-index="{{ loop.index0 }}" onchange="handleCheckboxChange(this, event)" onclick="event.stopPropagation()">
                    <div class="case-content" onclick="selectCase({{ case.id }}, event)" style="cursor: pointer; flex: 1;">
                        <div class="case-title" id="case-title-{{ case.id }}" data-case-id="{{ case.id }}" contenteditable="false" onclick="handleCaseTitleClick({{ case.id }}, event)">
                            <span class="case-title-text">{{ case.title }}</span>
                            <span class="case-title-edit-hint">í´ë¦­í•˜ì—¬ í¸ì§‘</span>
                        </div>
                        <div class="case-meta">
                            <span class="priority-badge priority-{{ case.priority }}">
                                {% if case.priority == 'Blocker' %}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 15c-3.9 0-7-3.1-7-7s3.1-7 7-7 7 3.1 7 7-3.1 7-7 7zM4 7c-.6 0-1 .4-1 1s.4 1 1 1h8c.6 0 1-.4 1-1s-.4-1-1-1H4z" fill="#ff5630"/></svg>
                                {% elif case.priority == 'Critical' %}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><linearGradient id="grad-critical-{{ case.id }}" gradientUnits="userSpaceOnUse" x1="-46.25" y1="65.1105" x2="-46.25" y2="64.1105" gradientTransform="matrix(12 0 0 -13.1121 563 854.7415)"><stop offset="0" stop-color="#ff5630"/><stop offset="1" stop-color="#ff8f73"/></linearGradient><path d="M2.5 4l5-2.9c.3-.2.7-.2 1 0l5 2.9c.3.2.5.5.5.9v8.2c0 .6-.4 1-1 1-.2 0-.4 0-.5-.1L8 11.4 3.5 14c-.5.3-1.1.1-1.4-.4-.1-.1-.1-.3-.1-.5V4.9c0-.4.2-.7.5-.9z" fill="url(#grad-critical-{{ case.id }})"/></svg>
                                {% elif case.priority == 'High' %}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M7.984436 3.200867l-4.5 2.7c-.5.3-1.1.1-1.3-.4s-.2-1.1.3-1.3l5-3c.3-.2.7-.2 1 0l5 3c.5.3.6.9.3 1.4-.3.5-.9.6-1.4.3l-4.4-2.7z" fill="#ff5630"/><path d="M3.484436 10.200867c-.5.3-1.1.1-1.3-.3s-.2-1.1.3-1.4l5-3c.3-.2.7-.2 1 0l5 3c.5.3.6.9.3 1.4-.3.5-.9.6-1.4.3l-4.4-2.7-4.5 2.7z" fill="#ff7452"/><path d="M3.484436 14.500867c-.5.3-1.1.2-1.3-.3s-.2-1.1.3-1.4l5-3c.3-.2.7-.2 1 0l5 3c.5.3.6.9.3 1.4-.3.5-.9.6-1.4.3l-4.4-2.7-4.5 2.7z" fill="#ff8f73"/></svg>
                                {% elif case.priority == 'Medium' %}
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14 6.5L2 6.5L2 5L14 5L14 6.5ZM14 11L2 11L2 9.5L14 9.5L14 11Z" fill="#E06C00"/></svg>
                                {% elif case.priority == 'Low' %}
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.5874 10.8762L2.0874 7.25122L2.91287 5.99878L8.00014 9.35175L13.0874 5.99878L13.9129 7.25122L8.41287 10.8762C8.16246 11.0413 7.83781 11.0413 7.5874 10.8762Z" fill="#4688EC"/></svg>
                                {% endif %}
                            </span>
                            {% if case.owner %}
                            <span>ğŸ‘¤ {{ case.owner.name }}</span>
                            {% endif %}
                            {% for tag in case.tags %}
                            <span class="tag-badge">{{ tag.name }}</span>
                            {% endfor %}
                            <span style="font-size: 0.85rem; color: #666;">ğŸ“… ìƒì„±: {{ case.created_at.strftime('%Y-%m-%d %H:%M') }}{% if case.creator %} ({{ case.creator.name }}){% endif %}</span>
                            <span style="font-size: 0.85rem; color: #666;">ğŸ• ìˆ˜ì •: {{ case.updated_at.strftime('%Y-%m-%d %H:%M') }}{% if case.updater %} ({{ case.updater.name }}){% endif %}</span>
                        </div>
                    </div>
                    {% if current_user.role in ['admin', 'author'] %}
                    <div class="case-actions">
                        <button class="case-menu-trigger" onclick="event.stopPropagation(); toggleCaseMenu({{ case.id }}, event)" title="ë©”ë‰´">â‹®</button>
                        <div class="case-context-menu" id="case-menu-{{ case.id }}">
                            <button class="case-context-menu-item" onclick="event.stopPropagation(); showCaseDetail({{ case.id }}); closeCaseMenu({{ case.id }})">
                                <span>âœï¸</span>
                                <span>í¸ì§‘</span>
                            </button>
                            <button class="case-context-menu-item" onclick="event.stopPropagation(); copyCase({{ case.id }}); closeCaseMenu({{ case.id }})">
                                <span>ğŸ“‹</span>
                                <span>ë³µì œ</span>
                            </button>
                            <button class="case-context-menu-item danger" onclick="event.stopPropagation(); deleteCase({{ case.id }}); closeCaseMenu({{ case.id }})">
                                <span>ğŸ—‘ï¸</span>
                                <span>ì‚­ì œ</span>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% endfor %}
            {% else %}
                {# ì „ì²´ ì¼€ì´ìŠ¤ ë˜ëŠ” ë‹¨ì¼ ì„¹ì…˜ ì¼€ì´ìŠ¤ í‘œì‹œ #}
                {% if cases %}
                {% for case in cases %}
                <div class="case-item" data-case-id="{{ case.id }}" data-section-id="{{ case.section_id }}" data-order-index="{{ case.order_index }}">
                    <div class="case-drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â˜°</div>
                    <input type="checkbox" class="case-checkbox" data-case-id="{{ case.id }}" data-case-index="{{ loop.index0 }}" onchange="handleCheckboxChange(this, event)" onclick="event.stopPropagation()">
                    <div class="case-content" onclick="selectCase({{ case.id }}, event)" style="cursor: pointer; flex: 1;">
                        <div class="case-title" id="case-title-{{ case.id }}" data-case-id="{{ case.id }}" contenteditable="false" onclick="handleCaseTitleClick({{ case.id }}, event)">
                            <span class="case-title-text">{{ case.title }}</span>
                            <span class="case-title-edit-hint">í´ë¦­í•˜ì—¬ í¸ì§‘</span>
                        </div>
                        <div class="case-meta">
                            <span class="priority-badge priority-{{ case.priority }}">
                                {% if case.priority == 'Blocker' %}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 15c-3.9 0-7-3.1-7-7s3.1-7 7-7 7 3.1 7 7-3.1 7-7 7zM4 7c-.6 0-1 .4-1 1s.4 1 1 1h8c.6 0 1-.4 1-1s-.4-1-1-1H4z" fill="#ff5630"/></svg>
                                {% elif case.priority == 'Critical' %}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><linearGradient id="grad-critical-{{ case.id }}" gradientUnits="userSpaceOnUse" x1="-46.25" y1="65.1105" x2="-46.25" y2="64.1105" gradientTransform="matrix(12 0 0 -13.1121 563 854.7415)"><stop offset="0" stop-color="#ff5630"/><stop offset="1" stop-color="#ff8f73"/></linearGradient><path d="M2.5 4l5-2.9c.3-.2.7-.2 1 0l5 2.9c.3.2.5.5.5.9v8.2c0 .6-.4 1-1 1-.2 0-.4 0-.5-.1L8 11.4 3.5 14c-.5.3-1.1.1-1.4-.4-.1-.1-.1-.3-.1-.5V4.9c0-.4.2-.7.5-.9z" fill="url(#grad-critical-{{ case.id }})"/></svg>
                                {% elif case.priority == 'High' %}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M7.984436 3.200867l-4.5 2.7c-.5.3-1.1.1-1.3-.4s-.2-1.1.3-1.3l5-3c.3-.2.7-.2 1 0l5 3c.5.3.6.9.3 1.4-.3.5-.9.6-1.4.3l-4.4-2.7z" fill="#ff5630"/><path d="M3.484436 10.200867c-.5.3-1.1.1-1.3-.3s-.2-1.1.3-1.4l5-3c.3-.2.7-.2 1 0l5 3c.5.3.6.9.3 1.4-.3.5-.9.6-1.4.3l-4.4-2.7-4.5 2.7z" fill="#ff7452"/><path d="M3.484436 14.500867c-.5.3-1.1.2-1.3-.3s-.2-1.1.3-1.4l5-3c.3-.2.7-.2 1 0l5 3c.5.3.6.9.3 1.4-.3.5-.9.6-1.4.3l-4.4-2.7-4.5 2.7z" fill="#ff8f73"/></svg>
                                {% elif case.priority == 'Medium' %}
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14 6.5L2 6.5L2 5L14 5L14 6.5ZM14 11L2 11L2 9.5L14 9.5L14 11Z" fill="#E06C00"/></svg>
                                {% elif case.priority == 'Low' %}
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.5874 10.8762L2.0874 7.25122L2.91287 5.99878L8.00014 9.35175L13.0874 5.99878L13.9129 7.25122L8.41287 10.8762C8.16246 11.0413 7.83781 11.0413 7.5874 10.8762Z" fill="#4688EC"/></svg>
                                {% endif %}
                            </span>
                            {% if case.owner %}
                            <span>ğŸ‘¤ {{ case.owner.name }}</span>
                            {% endif %}
                            {% for tag in case.tags %}
                            <span class="tag-badge">{{ tag.name }}</span>
                            {% endfor %}
                            <span style="font-size: 0.85rem; color: #666;">ğŸ“… ìƒì„±: {{ case.created_at.strftime('%Y-%m-%d %H:%M') }}{% if case.creator %} ({{ case.creator.name }}){% endif %}</span>
                            <span style="font-size: 0.85rem; color: #666;">ğŸ• ìˆ˜ì •: {{ case.updated_at.strftime('%Y-%m-%d %H:%M') }}{% if case.updater %} ({{ case.updater.name }}){% endif %}</span>
                        </div>
                    </div>
                    {% if current_user.role in ['admin', 'author'] %}
                    <div class="case-actions">
                        <button class="case-menu-trigger" onclick="event.stopPropagation(); toggleCaseMenu({{ case.id }}, event)" title="ë©”ë‰´">â‹®</button>
                        <div class="case-context-menu" id="case-menu-{{ case.id }}">
                            <button class="case-context-menu-item" onclick="event.stopPropagation(); showCaseDetail({{ case.id }}); closeCaseMenu({{ case.id }})">
                                <span>âœï¸</span>
                                <span>í¸ì§‘</span>
                            </button>
                            <button class="case-context-menu-item" onclick="event.stopPropagation(); copyCase({{ case.id }}); closeCaseMenu({{ case.id }})">
                                <span>ğŸ“‹</span>
                                <span>ë³µì œ</span>
                            </button>
                            <button class="case-context-menu-item danger" onclick="event.stopPropagation(); deleteCase({{ case.id }}); closeCaseMenu({{ case.id }})">
                                <span>ğŸ—‘ï¸</span>
                                <span>ì‚­ì œ</span>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                {# ì¼€ì´ìŠ¤ê°€ ì—†ì„ ë•Œ ì•ˆë‚´ ë©”ì‹œì§€ #}
                <div style="text-align: center; padding: 3rem; color: #999;">
                    ì¼€ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. Quick Addë¡œ ë¹ ë¥´ê²Œ ì¶”ê°€í•´ë³´ì„¸ìš”!
                </div>
                {% endif %}
            {% endif %}
            </div>
            
            {% if not current_section_id %}
            <div style="text-align: center; padding: 4rem 2rem; color: #999;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ“‹</div>
                <h3 style="color: #666; margin-bottom: 0.5rem;">ì„¹ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
                <p style="font-size: 0.9rem;">ì™¼ìª½ ì„¹ì…˜ íŠ¸ë¦¬ì—ì„œ ì„¹ì…˜ì„ ì„ íƒí•˜ë©´ ì¼€ì´ìŠ¤ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ì¼€ì´ìŠ¤ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
<div id="caseDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalCaseTitle">ì¼€ì´ìŠ¤ ìƒì„¸</h3>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <button class="close" onclick="closeCaseDetail()" style="margin-left: auto;">&times;</button>
            </div>
        </div>
        <div class="modal-body" id="modalCaseContent">
            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
        </div>
    </div>
</div>

<!-- ì»¤ìŠ¤í…€ Alert ëª¨ë‹¬ -->
<div id="customAlertModal" class="modal" style="display: none; z-index: 2000;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="customAlertTitle">ì•Œë¦¼</h3>
            <button class="close" onclick="closeCustomAlert()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="customAlertMessage" style="white-space: pre-wrap; word-break: break-word; user-select: text; cursor: text; padding: 1rem; background: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 0.9rem; max-height: 400px; overflow-y: auto;">
                <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
            </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-primary" onclick="closeCustomAlert()">í™•ì¸</button>
            </div>
        </div>
    </div>
</div>

<!-- ì„¹ì…˜ ì„ íƒ ëª¨ë‹¬ (Importìš©) -->
<div id="rootSectionSelectorModal" class="modal" style="display: none; z-index: 1100;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>ğŸ“‚ ìµœìƒìœ„ ì„¹ì…˜ ì„ íƒ</h3>
            <button class="close" onclick="closeRootSectionSelector()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 1rem;">
                <input type="text" id="sectionSearchInput" class="form-control" placeholder="ì„¹ì…˜ ê²€ìƒ‰..." oninput="filterSections()">
            </div>
            <div id="rootSectionList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
                <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
            </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-secondary" onclick="closeRootSectionSelector()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<!-- Import ëª¨ë‹¬ -->
<div id="importModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3>ğŸ“¥ ì¼€ì´ìŠ¤ Import (CSV/Excel)</h3>
            <button class="close" onclick="closeImportModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Step 1: íŒŒì¼ ì—…ë¡œë“œ -->
            <div id="importStep1" style="display: block;">
                <h4 style="margin-bottom: 1rem;">1. íŒŒì¼ ì„ íƒ</h4>
                <div id="dropZone" style="border: 2px dashed #3498db; border-radius: 8px; padding: 3rem; text-align: center; background: #f8f9fa; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“</div>
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</p>
                    <p style="color: #666; font-size: 0.9rem;">ì§€ì› í˜•ì‹: CSV, Excel (.xlsx, .xls)</p>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>
                <div id="fileInfo" style="display: none; margin-top: 1rem; padding: 1rem; background: #e8f5e9; border-radius: 4px;">
                    <strong>ì„ íƒëœ íŒŒì¼:</strong> <span id="fileName"></span>
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; background: #e3f2fd; border-radius: 4px;">
                    <strong>ğŸ“‹ íŒŒì¼ í˜•ì‹ ì•ˆë‚´:</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                        <li>ì²« ë²ˆì§¸ í–‰ì€ ì»¬ëŸ¼ëª…ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤</li>
                        <li>ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì»¬ëŸ¼ì„ ë§¤í•‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                        <li>ì„¹ì…˜ ì •ë³´ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ (ìµœëŒ€ depth 4)</li>
                        <li>ë¹ˆ ì œëª©ì€ ìë™ìœ¼ë¡œ ê±´ë„ˆëœë‹ˆë‹¤</li>
                    </ul>
                </div>
            </div>
            
            <!-- Step 2: ì»¬ëŸ¼ ë§¤í•‘ -->
            <div id="importStep2" style="display: none;">
                <h4 style="margin-bottom: 1rem;">2. ì»¬ëŸ¼ ë§¤í•‘ ë° ìµœìƒìœ„ ì„¹ì…˜ ì„ íƒ</h4>
                
                <div style="margin-bottom: 1rem; padding: 1rem; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px;">
                    <strong>âš ï¸ ì•ˆë‚´:</strong> íŒŒì¼ì˜ ì»¬ëŸ¼ì„ QuickRail í•„ë“œì— ë§¤í•‘í•´ì£¼ì„¸ìš”. ì œëª©(Title)ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.
                </div>
                
                <!-- ìµœìƒìœ„ ì„¹ì…˜ ì„ íƒ -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #e3f2fd; border-radius: 4px;">
                    <label class="form-label"><strong>ğŸ“‚ ìµœìƒìœ„ ì„¹ì…˜ ì„ íƒ (ì„ íƒì‚¬í•­)</strong></label>
                    <p style="font-size: 0.9rem; color: #666; margin: 0.5rem 0;">Importí•  ì¼€ì´ìŠ¤ë“¤ì´ ë°°ì¹˜ë  ìµœìƒìœ„ ì„¹ì…˜ì„ ì„ íƒí•˜ì„¸ìš”. ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ íŒŒì¼ì˜ ì„¹ì…˜ ì •ë³´ê°€ ìµœìƒìœ„ê°€ ë©ë‹ˆë‹¤.</p>
                    <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem;">
                        <input type="text" id="selectedRootSectionName" class="form-control" readonly placeholder="ì„ íƒëœ ì„¹ì…˜ ì—†ìŒ" style="flex: 1; background: white; cursor: pointer;" onclick="openRootSectionSelector()">
                        <button type="button" class="btn btn-secondary" onclick="openRootSectionSelector()">ì„¹ì…˜ ì„ íƒ</button>
                        <button type="button" class="btn btn-secondary" onclick="clearRootSection()" style="padding: 0.5rem 1rem;">âœ•</button>
                    </div>
                    <input type="hidden" id="selectedRootSectionId" value="">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <!-- ì œëª© (í•„ìˆ˜) -->
                    <div>
                        <label class="form-label"><strong style="color: #e74c3c;">* ì œëª© (Title)</strong></label>
                        <select id="mapTitle" class="form-control" required>
                            <option value="">-- ì»¬ëŸ¼ ì„ íƒ --</option>
                        </select>
                    </div>
                    
                    <!-- ìš°ì„ ìˆœìœ„ -->
                    <div>
                        <label class="form-label">ìš°ì„ ìˆœìœ„ (Priority)</label>
                        <select id="mapPriority" class="form-control">
                            <option value="">-- ì»¬ëŸ¼ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
                        </select>
                    </div>
                    
                    <!-- í…ŒìŠ¤íŠ¸ ìŠ¤í… -->
                    <div>
                        <label class="form-label">í…ŒìŠ¤íŠ¸ ìŠ¤í… (Steps)</label>
                        <select id="mapSteps" class="form-control">
                            <option value="">-- ì»¬ëŸ¼ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
                        </select>
                    </div>
                    
                    <!-- ê¸°ëŒ€ ê²°ê³¼ -->
                    <div>
                        <label class="form-label">ê¸°ëŒ€ ê²°ê³¼ (Expected Result)</label>
                        <select id="mapExpectedResult" class="form-control">
                            <option value="">-- ì»¬ëŸ¼ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                    <strong>ğŸ“‚ ì„¹ì…˜ ë§¤í•‘ (ì„ íƒì‚¬í•­)</strong>
                    <p style="font-size: 0.9rem; color: #666; margin: 0.5rem 0;">ì„¹ì…˜ ì •ë³´ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ê³„ì¸µ êµ¬ì¡°ê°€ ìƒì„±ë©ë‹ˆë‹¤.</p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div style="grid-column: 1 / -1;">
                            <label class="form-label">ì„¹ì…˜ ì „ì²´ (ì˜ˆ: a > b > c)</label>
                            <select id="mapSectionFull" class="form-control" onchange="onSectionFullMappingChanged()">
                                <option value="">-- ì»¬ëŸ¼ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
                            </select>
                            <small style="color:#666; display:block; margin-top:0.25rem;">
                                '>'ë¡œ êµ¬ë¶„ëœ ê°’ì„ ìë™ìœ¼ë¡œ Depth 1~4ë¡œ ë¶„í•´í•©ë‹ˆë‹¤. (ì„¹ì…˜ ì „ì²´ë¥¼ ì„ íƒí•˜ë©´ Depth 1~4 ë§¤í•‘ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤)
                            </small>
                            <div id="sectionFullPreview" style="margin-top:0.5rem; color:#666; font-size:0.85rem;"></div>
                        </div>
                        <div>
                            <label class="form-label">ì„¹ì…˜ Depth 1</label>
                            <select id="mapSection1" class="form-control">
                                <option value="">-- ì»¬ëŸ¼ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">ì„¹ì…˜ Depth 2</label>
                            <select id="mapSection2" class="form-control">
                                <option value="">-- ì»¬ëŸ¼ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">ì„¹ì…˜ Depth 3</label>
                            <select id="mapSection3" class="form-control">
                                <option value="">-- ì»¬ëŸ¼ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">ì„¹ì…˜ Depth 4</label>
                            <select id="mapSection4" class="form-control">
                                <option value="">-- ì»¬ëŸ¼ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                    <strong>ğŸ§· Jira ë§í¬ / ğŸ–¼ï¸ ë¯¸ë””ì–´ (ì„ íƒì‚¬í•­)</strong>
                    <p style="font-size: 0.9rem; color: #666; margin: 0.5rem 0;">
                        Jira ë§í¬ëŠ” ì—¬ëŸ¬ ê°œ ê°€ëŠ¥(êµ¬ë¶„: ì¤„ë°”ê¿ˆ/ì‰¼í‘œ/|). ë¯¸ë””ì–´ëŠ” URLì„ ë„£ìœ¼ë©´ Import ì‹œ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì¼€ì´ìŠ¤ ë¯¸ë””ì–´ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div>
                            <label class="form-label">Jira Links</label>
                            <select id="mapJiraLinks" class="form-control">
                                <option value="">-- ì»¬ëŸ¼ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Media URLs (image/video)</label>
                            <select id="mapMedia" class="form-control">
                                <option value="">-- ì»¬ëŸ¼ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ìƒ˜í”Œ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° -->
                <div style="margin-bottom: 1.5rem;">
                    <strong>ğŸ“Š ìƒ˜í”Œ ë°ì´í„° (ì²˜ìŒ 5í–‰)</strong>
                    <div id="sampleDataPreview" style="max-height: 200px; overflow: auto; margin-top: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="backToStep1()">â† ë’¤ë¡œ</button>
                    <button class="btn btn-primary" onclick="proceedToPreview()">ë‹¤ìŒ â†’</button>
                </div>
            </div>
            
            <!-- Step 3: ë¯¸ë¦¬ë³´ê¸° -->
            <div id="importStep3" style="display: none;">
                <h4 style="margin-bottom: 1rem;">3. ë¯¸ë¦¬ë³´ê¸°</h4>
                
                <div id="previewSummary" style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                    <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
                </div>
                
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead style="position: sticky; top: 0; background: #f8f9fa;">
                            <tr>
                                <th style="padding: 0.75rem; border-bottom: 2px solid #ddd; text-align: left; width: 50px;">í–‰</th>
                                <th style="padding: 0.75rem; border-bottom: 2px solid #ddd; text-align: left;">ì„¹ì…˜</th>
                                <th style="padding: 0.75rem; border-bottom: 2px solid #ddd; text-align: left;">ì œëª©</th>
                                <th style="padding: 0.75rem; border-bottom: 2px solid #ddd; text-align: left; width: 100px;">ìš°ì„ ìˆœìœ„</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
                        </tbody>
                    </table>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="backToStep2()">â† ë’¤ë¡œ</button>
                    <button class="btn btn-success" onclick="confirmImport()">âœ“ Import í™•ì •</button>
                </div>
            </div>
            
            <!-- Step 4: ì™„ë£Œ -->
            <div id="importStep4" style="display: none; text-align: center; padding: 2rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">âœ…</div>
                <h3 style="margin-bottom: 1rem;">Import ì™„ë£Œ!</h3>
                <p id="importResultMessage" style="font-size: 1.1rem; color: #666;"></p>
                <button class="btn btn-primary" onclick="closeImportModalAndReload()" style="margin-top: 1.5rem;">í™•ì¸</button>
            </div>
        </div>
    </div>
</div>

<script>
const projectId = {{ project.id }};
const currentSectionId = {{ current_section_id or 'null' }};

// ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initSortable();
    applyViewMode(); // ì €ì¥ëœ ë·° ëª¨ë“œ ì ìš©
});

function initSortable() {
    const sortableLists = document.querySelectorAll('.sortable-list');
    let dragOverTimer = null;
    
    sortableLists.forEach(list => {
        new Sortable(list, {
            group: 'nested',
            animation: 150,
            fallbackOnBody: true,
            swapThreshold: 0.65,
            handle: '.section-item',
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            onEnd: function(evt) {
                updateSectionOrder(evt);
                // íƒ€ì´ë¨¸ ì •ë¦¬
                if (dragOverTimer) {
                    clearTimeout(dragOverTimer);
                    dragOverTimer = null;
                }
            },
            onMove: function(evt) {
                // ë“œë˜ê·¸ ì¤‘ì¸ ìš”ì†Œê°€ ì ‘íŒ ì„¹ì…˜ ìœ„ì— ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ í¼ì¹˜ê¸°
                const relatedElement = evt.related;
                if (relatedElement && relatedElement.classList.contains('section-item')) {
                    const wrapper = relatedElement.closest('.section-wrapper');
                    
                    if (wrapper && wrapper.classList.contains('collapsed')) {
                        // 0.5ì´ˆ í›„ì— ìë™ìœ¼ë¡œ í¼ì¹˜ê¸°
                        if (dragOverTimer) {
                            clearTimeout(dragOverTimer);
                        }
                        
                        dragOverTimer = setTimeout(() => {
                            wrapper.classList.remove('collapsed');
                            
                            // ìƒíƒœ ì—…ë°ì´íŠ¸
                            const sectionId = parseInt(wrapper.dataset.sectionId);
                            const collapsedSections = getCollapsedSections();
                            collapsedSections.delete(sectionId);
                            saveCollapsedSections(collapsedSections);
                        }, 500);
                    }
                }
            }
        });
    });
}

function updateSectionOrder(evt) {
    const sectionWrapper = evt.item;
    const sectionId = sectionWrapper.dataset.sectionId;
    const newParentList = evt.to;
    const newParentId = newParentList.dataset.parentId || null;
    const newIndex = evt.newIndex;
    
    fetch(`/api/sections/${sectionId}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            parent_id: newParentId,
            order_index: newIndex
        })
    })
    .then(res => res.json())
    .then(data => {
        console.log('ì„¹ì…˜ ìˆœì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    })
    .catch(err => {
        alert('ì„¹ì…˜ ì´ë™ ì‹¤íŒ¨: ' + err);
        location.reload();
    });
}

// ì „ì—­ í•¨ìˆ˜ë¡œ ëª…ì‹œì ìœ¼ë¡œ ì„ ì–¸ (onclickì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
window.goToSection = function(sectionId) {
    // ì„¹ì…˜ ì„ íƒ ì‹œì  ê¸°ë¡ (ë¡œë“œ ì‹œê°„ ì¸¡ì •ìš©) - í˜ì´ì§€ ë¦¬ë¡œë“œ ì „ì— ì €ì¥
    const sectionLoadStart = Date.now(); // performance.now() ëŒ€ì‹  Date.now() ì‚¬ìš©
    sessionStorage.setItem('sectionLoadStart', sectionLoadStart.toString());
    
    // ì¦‰ì‹œ ì„ íƒ ì²˜ë¦¬ (UI ì—…ë°ì´íŠ¸)
    document.querySelectorAll('.section-item').forEach(item => {
        item.classList.remove('active');
    });
    const clickedSection = document.querySelector(`.section-item[data-section-id="${sectionId}"]`);
    if (clickedSection) {
        clickedSection.classList.add('active');
    }
    
    // ë¡œë”© í‘œì‹œ
    const caseList = document.getElementById('caseList');
    if (caseList) {
        caseList.classList.add('loading');
    }
    
    // ë§ˆì§€ë§‰ ë°©ë¬¸ ì„¹ì…˜ ì €ì¥
    if (sectionId) {
        localStorage.setItem('lastVisitedSection_' + projectId, sectionId);
        location.href = `/p/${projectId}/cases?section_id=${sectionId}`;
    } else {
        localStorage.removeItem('lastVisitedSection_' + projectId);
        location.href = `/p/${projectId}/cases`;
    }
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë§ˆì§€ë§‰ ë°©ë¬¸ ì„¹ì…˜ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
function redirectToLastSection() {
    const urlParams = new URLSearchParams(window.location.search);
    const currentSectionId = urlParams.get('section_id');
    
    // section_idê°€ ì—†ê³ , ì €ì¥ëœ ë§ˆì§€ë§‰ ì„¹ì…˜ì´ ìˆìœ¼ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸
    if (!currentSectionId) {
        const lastSectionId = localStorage.getItem('lastVisitedSection_' + projectId);
        if (lastSectionId) {
            location.href = `/p/${projectId}/cases?section_id=${lastSectionId}`;
        }
    }
}

// ì„¹ì…˜ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í† ê¸€
function toggleSectionMenu(sectionId, event) {
    event.stopPropagation();
    
    // ë‹¤ë¥¸ ì—´ë¦° ë©”ë‰´ ëª¨ë‘ ë‹«ê¸°
    document.querySelectorAll('.section-context-menu.show').forEach(menu => {
        if (menu.id !== `section-menu-${sectionId}`) {
            menu.classList.remove('show');
        }
    });
    
    // í˜„ì¬ ë©”ë‰´ í† ê¸€
    const menu = document.getElementById(`section-menu-${sectionId}`);
    if (menu) {
        menu.classList.toggle('show');
    }
}

// ì„¹ì…˜ ë©”ë‰´ ë‹«ê¸°
function closeSectionMenu(sectionId) {
    const menu = document.getElementById(`section-menu-${sectionId}`);
    if (menu) {
        menu.classList.remove('show');
    }
}

// ëª¨ë“  ì„¹ì…˜ ë©”ë‰´ ë‹«ê¸°
function closeAllSectionMenus() {
    document.querySelectorAll('.section-context-menu.show').forEach(menu => {
        menu.classList.remove('show');
    });
}

// ì¼€ì´ìŠ¤ íƒ€ì´í‹€ í´ë¦­ ì²˜ë¦¬
function handleCaseTitleClick(caseId, event) {
    event.stopPropagation();
    
    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í´ë¦­ ì‹œì—ëŠ” ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
    if (event.target.closest('.case-menu-trigger') || 
        event.target.closest('.case-context-menu')) {
        return;
    }
    
    // í¸ì§‘ íŒíŠ¸ í´ë¦­ ì‹œì—ë„ í¸ì§‘ ëª¨ë“œ ì§„ì…
    const isHintClick = event.target.classList.contains('case-title-edit-hint');
    
    // í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ í™œì„±í™”
    if (!isEditMode) {
        const editModeBtn = document.getElementById('editModeToggle');
        const caseListContainer = document.querySelector('.case-list-container');
        const shortcutGuide = document.getElementById('editModeShortcutGuide');
        
        isEditMode = true;
        if (editModeBtn) {
            editModeBtn.classList.add('active');
        }
        if (caseListContainer) {
            caseListContainer.classList.add('edit-mode');
        }
        if (shortcutGuide) {
            shortcutGuide.style.display = 'block';
            shortcutGuide.classList.add('edit-mode-active');
            shortcutGuide.classList.remove('collapsed');
            // inline displayê°€ ë‚¨ì•„ìˆìœ¼ë©´ CSSê°€ ì´ê²¨ë„ ì•ˆ ë³´ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì´ˆê¸°í™”
            shortcutGuide.querySelectorAll('.shortcut-item').forEach(item => item.style.display = '');
        }
    }
    
    // í¸ì§‘ ëª¨ë“œì—ì„œ ì¼€ì´ìŠ¤ ì„ íƒ (toggleEditModeì™€ ë™ì¼)
    selectCaseInEditMode(caseId);
    
    // í¸ì§‘ ëª¨ë“œ ì§„ì…
    startTitleEdit(caseId);
}

// ì¼€ì´ìŠ¤ ë©”ë‰´ í† ê¸€
function toggleCaseMenu(caseId, event) {
    event.stopPropagation();
    
    // ë‹¤ë¥¸ ì—´ë¦° ë©”ë‰´ ëª¨ë‘ ë‹«ê¸°
    document.querySelectorAll('.case-context-menu.show').forEach(menu => {
        if (menu.id !== `case-menu-${caseId}`) {
            menu.classList.remove('show');
        }
    });
    
    // í˜„ì¬ ë©”ë‰´ í† ê¸€
    const menu = document.getElementById(`case-menu-${caseId}`);
    if (menu) {
        menu.classList.toggle('show');
    }
}

// ì¼€ì´ìŠ¤ ë©”ë‰´ ë‹«ê¸°
function closeCaseMenu(caseId) {
    const menu = document.getElementById(`case-menu-${caseId}`);
    if (menu) {
        menu.classList.remove('show');
    }
}

// ëª¨ë“  ì¼€ì´ìŠ¤ ë©”ë‰´ ë‹«ê¸°
function closeAllCaseMenus() {
    document.querySelectorAll('.case-context-menu.show').forEach(menu => {
        menu.classList.remove('show');
    });
}

// ì„¹ì…˜ ì ‘ê¸°/í¼ì¹˜ê¸°
function toggleSection(sectionId) {
    const wrapper = document.querySelector(`.section-wrapper[data-section-id="${sectionId}"]`);
    if (!wrapper) return;
    
    wrapper.classList.toggle('collapsed');
    
    // ìƒíƒœ ì €ì¥
    const collapsedSections = getCollapsedSections();
    if (wrapper.classList.contains('collapsed')) {
        collapsedSections.add(sectionId);
    } else {
        collapsedSections.delete(sectionId);
    }
    saveCollapsedSections(collapsedSections);
}

// ì ‘íŒ ì„¹ì…˜ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
function getCollapsedSections() {
    const saved = localStorage.getItem('collapsedSections_' + projectId);
    return saved ? new Set(JSON.parse(saved)) : new Set();
}

// ì ‘íŒ ì„¹ì…˜ ìƒíƒœ ì €ì¥
function saveCollapsedSections(collapsedSections) {
    localStorage.setItem('collapsedSections_' + projectId, JSON.stringify([...collapsedSections]));
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì ‘íŒ ì„¹ì…˜ ë³µì›
function restoreCollapsedSections() {
    const collapsedSections = getCollapsedSections();
    collapsedSections.forEach(sectionId => {
        const wrapper = document.querySelector(`.section-wrapper[data-section-id="${sectionId}"]`);
        if (wrapper) {
            wrapper.classList.add('collapsed');
        }
    });
}

// ì„¹ì…˜ ê²€ìƒ‰
function filterSectionTree(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const wrappers = document.querySelectorAll('.section-wrapper');
    
    if (!term) {
        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ëª¨ë‘ í‘œì‹œ
        wrappers.forEach(wrapper => {
            wrapper.classList.remove('hidden');
        });
        return;
    }
    
    // ëª¨ë“  ì„¹ì…˜ì„ ë¨¼ì € ìˆ¨ê¹€
    wrappers.forEach(wrapper => {
        wrapper.classList.add('hidden');
    });
    
    // ê²€ìƒ‰ì–´ì™€ ì¼ì¹˜í•˜ëŠ” ì„¹ì…˜ ì°¾ê¸°
    wrappers.forEach(wrapper => {
        const sectionName = wrapper.dataset.sectionName.toLowerCase();
        
        if (sectionName.includes(term)) {
            // ì¼ì¹˜í•˜ëŠ” ì„¹ì…˜ê³¼ ëª¨ë“  ë¶€ëª¨ ì„¹ì…˜ í‘œì‹œ
            showSectionAndParents(wrapper);
            // ëª¨ë“  ìì‹ ì„¹ì…˜ë„ í‘œì‹œ
            showAllChildren(wrapper);
        }
    });
}

// ì„¹ì…˜ê³¼ ëª¨ë“  ë¶€ëª¨ ì„¹ì…˜ í‘œì‹œ
function showSectionAndParents(wrapper) {
    wrapper.classList.remove('hidden');
    
    // ë¶€ëª¨ ì„¹ì…˜ ì°¾ê¸°
    let parent = wrapper.parentElement;
    while (parent) {
        if (parent.classList.contains('section-wrapper')) {
            parent.classList.remove('hidden');
            // ê²€ìƒ‰ ì¤‘ì—ëŠ” ìë™ìœ¼ë¡œ í¼ì¹˜ê¸°
            parent.classList.remove('collapsed');
        }
        parent = parent.parentElement;
    }
}

// ëª¨ë“  ìì‹ ì„¹ì…˜ í‘œì‹œ
function showAllChildren(wrapper) {
    const children = wrapper.querySelectorAll('.section-wrapper');
    children.forEach(child => {
        child.classList.remove('hidden');
    });
}

// ëª¨ë“  ì„¹ì…˜ í¼ì¹˜ê¸°
function expandAllSections() {
    const wrappers = document.querySelectorAll('.section-wrapper');
    wrappers.forEach(wrapper => {
        wrapper.classList.remove('collapsed');
    });
    
    // ìƒíƒœ ì €ì¥ (ë¹ˆ Set)
    saveCollapsedSections(new Set());
}

// ëª¨ë“  ì„¹ì…˜ ì ‘ê¸°
function collapseAllSections() {
    const wrappers = document.querySelectorAll('.section-wrapper');
    const allSectionIds = new Set();
    
    wrappers.forEach(wrapper => {
        const sectionId = parseInt(wrapper.dataset.sectionId);
        // í•˜ìœ„ ì„¹ì…˜ì´ ìˆëŠ” ê²½ìš°ë§Œ ì ‘ê¸°
        const hasChildren = wrapper.querySelector('.section-children');
        if (hasChildren) {
            wrapper.classList.add('collapsed');
            allSectionIds.add(sectionId);
        }
    });
    
    // ìƒíƒœ ì €ì¥
    saveCollapsedSections(allSectionIds);
}

function quickAddCase(event) {
    event.preventDefault();
    const title = document.getElementById('quickAddTitle').value;
    
    if (!currentSectionId) {
        alert('ì„¹ì…˜ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    fetch(`/api/projects/${projectId}/cases`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            title: title,
            section_id: currentSectionId
        })
    })
    .then(res => res.json())
    .then(data => {
        location.reload();
    })
    .catch(err => alert('ì¼€ì´ìŠ¤ ì¶”ê°€ ì‹¤íŒ¨: ' + err));
}

function filterCases() {
    const search = document.querySelector('input[placeholder="ê²€ìƒ‰..."]').value;
    const priority = document.querySelectorAll('select')[0].value;
    const tag = document.querySelectorAll('select')[1].value;
    
    let url = `/p/${projectId}/cases?`;
    if (currentSectionId) url += `section_id=${currentSectionId}&`;
    if (search) url += `q=${search}&`;
    if (priority) url += `priority=${priority}&`;
    if (tag) url += `tag=${tag}&`;
    
    location.href = url;
}

function addSection(parentId, depth = 0) {
    // ìµœëŒ€ ê¹Šì´ ì²´í¬ (0: ë£¨íŠ¸, 1: 1ë‹¨ê³„, 2: 2ë‹¨ê³„, 3: 3ë‹¨ê³„, 4: 4ë‹¨ê³„)
    // depth 4 ì´ìƒ(5ë‹¨ê³„ ì´ìƒ)ì€ ìƒì„± ë¶ˆê°€
    if (depth >= 4) {
        alert('ì„¹ì…˜ì€ ìµœëŒ€ 4ë‹¨ê³„ê¹Œì§€ë§Œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    const name = prompt('ì„¹ì…˜ ì´ë¦„:');
    if (!name) return;
    
    fetch(`/api/projects/${projectId}/sections`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: name,
            parent_id: parentId
        })
    })
    .then(res => {
        if (!res.ok) {
            return res.json().then(data => {
                throw new Error(data.error || 'ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨');
            });
        }
        return res.json();
    })
    .then(data => {
        location.reload();
    })
    .catch(err => {
        alert(err.message || 'ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨: ' + err);
    });
}

function editSection(sectionId, currentName) {
    const name = prompt('ìƒˆ ì„¹ì…˜ ì´ë¦„:', currentName);
    if (!name || name === currentName) return;
    
    fetch(`/api/sections/${sectionId}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name: name })
    })
    .then(res => res.json())
    .then(data => {
        location.reload();
    })
    .catch(err => alert('ì„¹ì…˜ ìˆ˜ì • ì‹¤íŒ¨: ' + err));
}

function deleteSection(sectionId) {
    if (!confirm('ì´ ì„¹ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í•˜ìœ„ ì¼€ì´ìŠ¤ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) return;
    
    fetch(`/api/sections/${sectionId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (response.ok || response.status === 204) {
            location.reload();
            return;
        }
        // ì—ëŸ¬ ì‘ë‹µì¼ ê²½ìš°ì—ë§Œ JSON íŒŒì‹± ì‹œë„
        if (response.headers.get('content-type')?.includes('application/json')) {
            return response.json().then(data => {
                throw new Error(data.error || 'ì„¹ì…˜ ì‚­ì œ ì‹¤íŒ¨');
            });
        } else {
            throw new Error('ì„¹ì…˜ ì‚­ì œ ì‹¤íŒ¨');
        }
    })
    .catch(err => {
        console.error('ì„¹ì…˜ ì‚­ì œ ì˜¤ë¥˜:', err);
        alert('ì„¹ì…˜ ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
    });
}

// showCaseDetail í•¨ìˆ˜ëŠ” ì•„ë˜ì— ì‹¤ì œ êµ¬í˜„ì´ ìˆìŒ

// ì¤‘ë³µ ê°ì§€
let duplicateCheckTimeout;
async function checkDuplicates(title) {
    clearTimeout(duplicateCheckTimeout);
    
    const warningDiv = document.getElementById('duplicateWarning');
    const listDiv = document.getElementById('duplicateList');
    
    if (!title || title.length < 3) {
        warningDiv.style.display = 'none';
        return;
    }
    
    duplicateCheckTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`/api/projects/${projectId}/cases/check-duplicates`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ title: title })
            });
            
            const data = await res.json();
            
            if (data.duplicates && data.duplicates.length > 0) {
                listDiv.innerHTML = data.duplicates.map(dup => {
                    const matchIcon = dup.match_type === 'exact' ? 'ğŸ”´' : 
                                    dup.match_type === 'substring' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                    return `
                        <div style="padding: 0.5rem; margin: 0.25rem 0; background: white; border-radius: 3px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                ${matchIcon} <strong>${dup.title}</strong>
                                <span style="color: #666; font-size: 0.85rem;">(${dup.section_name}, ${dup.similarity}% ìœ ì‚¬)</span>
                            </div>
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;" onclick="goToCaseDetail(${dup.id})">ë³´ê¸°</button>
                        </div>
                    `;
                }).join('');
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        } catch (err) {
            console.error('ì¤‘ë³µ ì²´í¬ ì‹¤íŒ¨:', err);
        }
    }, 500);  // 500ms debounce
}

function goToCaseDetail(caseId) {
    // ì¼€ì´ìŠ¤ ìƒì„¸ë¡œ ì´ë™ (í˜„ì¬ëŠ” alert)
    alert(`ì¼€ì´ìŠ¤ #${caseId} ìƒì„¸ ë³´ê¸° (í–¥í›„ êµ¬í˜„)`);
}

// editCase í•¨ìˆ˜ëŠ” showCaseDetailë¡œ ëŒ€ì²´ë¨ (í¸ì§‘ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°)

// ì¼€ì´ìŠ¤ ì‚­ì œ (ì•„ì¹´ì´ë¸Œ)
async function deleteCase(caseId, options = {}) {
    const { confirmDelete = true, showAlert = false } = options;
    if (confirmDelete && !confirm('ì´ ì¼€ì´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const res = await fetch(`/api/cases/${caseId}/archive`, { method: 'POST' });
        if (!res.ok) throw new Error(`ì‚­ì œ ì‹¤íŒ¨ (${res.status})`);
        await res.json();
        if (showAlert) {
            alert('âœ… ì¼€ì´ìŠ¤ê°€ ì‚­ì œ(ì•„ì¹´ì´ë¸Œ)ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        location.reload();
    } catch (err) {
        alert('ì¼€ì´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
    }
}

// ì¼ê´„ ì¶”ê°€ í† ê¸€
function toggleBulkAdd() {
    const singleForm = document.getElementById('singleAddForm');
    const bulkForm = document.getElementById('bulkAddForm');
    
    if (bulkForm.style.display === 'none') {
        singleForm.style.display = 'none';
        bulkForm.style.display = 'block';
        document.getElementById('bulkAddText').focus();
    } else {
        singleForm.style.display = 'flex';
        bulkForm.style.display = 'none';
        document.getElementById('bulkAddText').value = '';
    }
}

// ì—¬ëŸ¬ ì¼€ì´ìŠ¤ ì¼ê´„ ì¶”ê°€
async function bulkAddCases(event) {
    event.preventDefault();
    
    if (!currentSectionId) {
        alert('ì„¹ì…˜ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const text = document.getElementById('bulkAddText').value;
    const titles = text.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
    
    if (titles.length === 0) {
        alert('ì¶”ê°€í•  ì¼€ì´ìŠ¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!confirm(`${titles.length}ê°œì˜ ì¼€ì´ìŠ¤ë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    let successCount = 0;
    let failCount = 0;
    
    for (const title of titles) {
        try {
            const res = await fetch(`/api/projects/${projectId}/cases`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title: title,
                    section_id: currentSectionId
                })
            });
            
            if (res.ok) {
                successCount++;
            } else {
                failCount++;
            }
        } catch (err) {
            failCount++;
        }
    }
    
    alert(`ì™„ë£Œ!\nì„±ê³µ: ${successCount}ê°œ\nì‹¤íŒ¨: ${failCount}ê°œ`);
    location.reload();
}

// ì •ë ¬ ë³€ê²½
function changeSort(sortType) {
    const url = new URL(window.location.href);
    url.searchParams.set('sort', sortType);
    window.location.href = url.toString();
}

// ì¼€ì´ìŠ¤ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™”
let caseSortable = null;
let draggedCaseItem = null;
let selectedCaseIdsBeforeDrag = [];
let dragContext = null;

function initCaseSortable() {
    const caseList = document.getElementById('caseListSortable');
    if (!caseList || typeof Sortable === 'undefined') return;
    
    // í•­ìƒ ë“œë˜ê·¸ ê°€ëŠ¥ (ì •ë ¬ ë“œë¡­ë‹¤ìš´ ì œê±°ë¡œ í•­ìƒ ê¸°ë³¸ ì •ë ¬)
    caseSortable = new Sortable(caseList, {
        animation: 150,
        handle: '.case-drag-handle',
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        disabled: false,  // í•­ìƒ í™œì„±í™”
        onStart: function(evt) {
            draggedCaseItem = evt.item;
            dragContext = {
                parent: evt.item.parentNode,
                nextSibling: evt.item.nextSibling,
                caseId: parseInt(evt.item.dataset.caseId),
                sectionId: parseInt(evt.item.dataset.sectionId),
                oldIndex: evt.oldIndex
            };
            // ë“œë˜ê·¸ ì‹œì‘ ì‹œ ì„ íƒëœ ì¼€ì´ìŠ¤ë“¤ ì €ì¥
            const selectedCases = getSelectedCaseItems();
            selectedCaseIdsBeforeDrag = selectedCases.map(item => parseInt(item.dataset.caseId));
        },
        onEnd: function(evt) {
            const selectedCases = getSelectedCaseItems();
            const draggedCaseId = parseInt(evt.item.dataset.caseId);
            
            // ë‹¤ë¥¸ ì„¹ì…˜ ì˜ì—­ìœ¼ë¡œ ë“œë¡­í•œ ê²½ìš°: ë˜ëŒë¦¬ê¸° (ì„¹ì…˜ ì´ë™ ë¯¸ì§€ì›)
            const visualSectionId = getVisualSectionIdForCaseItem(evt.item);
            const originalSectionId = dragContext?.sectionId;
            if (visualSectionId && originalSectionId && visualSectionId !== originalSectionId) {
                console.warn('[QuickRail] ì¼€ì´ìŠ¤ ì„¹ì…˜ ê°„ ì´ë™ì€ ì§€ì›í•˜ì§€ ì•ŠìŒ:', { draggedCaseId, originalSectionId, visualSectionId });
                // ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì›
                if (dragContext?.parent) {
                    if (dragContext.nextSibling) {
                        dragContext.parent.insertBefore(evt.item, dragContext.nextSibling);
                    } else {
                        dragContext.parent.appendChild(evt.item);
                    }
                }
                alert('í˜„ì¬ëŠ” ì„¹ì…˜ ê°„ ì¼€ì´ìŠ¤ ì´ë™ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                // ì •ë¦¬
                draggedCaseItem = null;
                selectedCaseIdsBeforeDrag = [];
                dragContext = null;
                return;
            }
            
            // ì—¬ëŸ¬ ì¼€ì´ìŠ¤ê°€ ì„ íƒë˜ì–´ ìˆê³ , ë“œë˜ê·¸í•œ ì¼€ì´ìŠ¤ê°€ ì„ íƒëœ ê²½ìš°
            if (selectedCaseIdsBeforeDrag.length > 1 && selectedCaseIdsBeforeDrag.includes(draggedCaseId)) {
                // ì—¬ëŸ¬ ì¼€ì´ìŠ¤ ë™ì‹œ ì´ë™
                updateMultipleCaseOrder(selectedCaseIdsBeforeDrag, evt);
            } else {
                // ë‹¨ì¼ ì¼€ì´ìŠ¤ ì´ë™
                updateCaseOrder(evt);
            }
            
            // ì •ë¦¬
            draggedCaseItem = null;
            selectedCaseIdsBeforeDrag = [];
            dragContext = null;
        }
    });
    
    console.log('ì¼€ì´ìŠ¤ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™” ì™„ë£Œ');
}

function getVisualSectionIdForCaseItem(caseItemEl) {
    // DOM ìƒì—ì„œ í•´ë‹¹ case-item ë°”ë¡œ ìœ„ì— ìˆëŠ” section-group-headerì˜ data-section-idë¥¼ ê¸°ì¤€ìœ¼ë¡œ "ë³´ì´ëŠ” ì„¹ì…˜" íŒë‹¨
    let el = caseItemEl.previousElementSibling;
    while (el) {
        if (el.classList.contains('section-group-header')) {
            const sid = parseInt(el.dataset.sectionId);
            return isNaN(sid) ? null : sid;
        }
        el = el.previousElementSibling;
    }
    return null;
}

function refreshCaseCheckboxIndices() {
    const allCheckboxes = Array.from(document.querySelectorAll('.case-checkbox'));
    allCheckboxes.forEach((cb, idx) => {
        cb.dataset.caseIndex = idx;
    });
}

async function persistSectionOrderFromDom(sectionId, context = {}) {
    const sectionCaseItems = Array.from(document.querySelectorAll(`.case-item[data-section-id="${sectionId}"]`));
    const newOrder = sectionCaseItems.map(item => ({
        id: parseInt(item.dataset.caseId),
        el: item
    })).filter(x => !isNaN(x.id));

    const changes = [];
    newOrder.forEach((x, idx) => {
        const prev = parseInt(x.el.dataset.orderIndex);
        if (isNaN(prev) || prev !== idx) {
            changes.push({ id: x.id, from: isNaN(prev) ? null : prev, to: idx });
        }
    });

    const caseList = document.getElementById('caseList');
    caseList?.classList.add('loading');

    console.groupCollapsed(`ğŸ§© [QuickRail] ì„¹ì…˜ order_index ì €ì¥ (section=${sectionId})`);
    console.log('context:', context);
    console.log('changes:', changes);
    const t0 = performance.now();

    try {
        await Promise.all(changes.map(ch =>
            fetch(`/api/cases/${ch.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_index: ch.to })
            }).then(r => {
                if (!r.ok) throw new Error(`PATCH /api/cases/${ch.id} failed (${r.status})`);
                return r.json();
            })
        ));

        // DOM ë°ì´í„° ê°±ì‹ 
        newOrder.forEach((x, idx) => {
            x.el.dataset.orderIndex = idx;
        });

        refreshCaseCheckboxIndices();
        updateSectionHeaderCheckboxState(sectionId);
        updateSelectAllState();

        console.log(`âœ… done: ${(performance.now() - t0).toFixed(2)}ms, updated=${changes.length}`);
    } catch (err) {
        console.error('âŒ order_index ì €ì¥ ì‹¤íŒ¨:', err);
        alert('ì¼€ì´ìŠ¤ ìˆœì„œ ì €ì¥ ì‹¤íŒ¨: ' + err.message);
    } finally {
        console.groupEnd();
        caseList?.classList.remove('loading');
    }
}

// ì„ íƒëœ ì¼€ì´ìŠ¤ ì•„ì´í…œë“¤ ê°€ì ¸ì˜¤ê¸°
function getSelectedCaseItems() {
    const selectedCheckboxes = document.querySelectorAll('.case-checkbox:checked');
    return Array.from(selectedCheckboxes).map(cb => {
        const caseId = parseInt(cb.dataset.caseId);
        return document.querySelector(`.case-item[data-case-id="${caseId}"]`);
    }).filter(item => item !== null);
}

// ì¼€ì´ìŠ¤ ìˆœì„œ ì—…ë°ì´íŠ¸
function updateCaseOrder(evt) {
    const sectionId = parseInt(evt.item.dataset.sectionId);
    const draggedCaseId = parseInt(evt.item.dataset.caseId);
    if (isNaN(sectionId) || isNaN(draggedCaseId)) return;

    persistSectionOrderFromDom(sectionId, {
        type: 'single',
        draggedCaseId,
        oldIndex: evt.oldIndex,
        newIndex: evt.newIndex
    });
}

// ì—¬ëŸ¬ ì¼€ì´ìŠ¤ ë™ì‹œ ìˆœì„œ ì—…ë°ì´íŠ¸
async function updateMultipleCaseOrder(selectedCaseIds, evt) {
    if (selectedCaseIds.length === 0) return;

    const draggedCaseId = parseInt(evt.item.dataset.caseId);
    const sectionId = parseInt(evt.item.dataset.sectionId);
    if (isNaN(sectionId) || isNaN(draggedCaseId)) return;

    // ì„ íƒëœ ì¼€ì´ìŠ¤ê°€ ê°™ì€ ì„¹ì…˜ì¸ì§€ í™•ì¸
    const selectedItems = selectedCaseIds
        .map(id => document.querySelector(`.case-item[data-case-id="${id}"]`))
        .filter(Boolean);
    const sectionMismatch = selectedItems.some(it => parseInt(it.dataset.sectionId) !== sectionId);
    if (sectionMismatch) {
        alert('ì—¬ëŸ¬ ì¼€ì´ìŠ¤ ë™ì‹œ ì´ë™ì€ ê°™ì€ ì„¹ì…˜ ë‚´ì—ì„œë§Œ ì§€ì›í•©ë‹ˆë‹¤.');
        await persistSectionOrderFromDom(sectionId, { type: 'multi-fallback', draggedCaseId });
        return;
    }

    // ì„¹ì…˜ ë‚´ DOM ìˆœì„œ ê¸°ë°˜ìœ¼ë¡œ ìƒˆ ìˆœì„œ ê³„ì‚°
    const sectionCaseIds = Array.from(document.querySelectorAll(`.case-item[data-section-id="${sectionId}"]`))
        .map(it => parseInt(it.dataset.caseId))
        .filter(id => !isNaN(id));

    const selectedInOrder = sectionCaseIds.filter(id => selectedCaseIds.includes(id));
    const remaining = sectionCaseIds.filter(id => !selectedCaseIds.includes(id));
    const dropIndex = sectionCaseIds.indexOf(draggedCaseId);
    const insertAt = Math.max(0, Math.min(dropIndex, remaining.length));
    const newOrder = [
        ...remaining.slice(0, insertAt),
        ...selectedInOrder,
        ...remaining.slice(insertAt)
    ];

    const caseList = document.getElementById('caseList');
    caseList?.classList.add('loading');

    console.groupCollapsed(`ğŸ§© [QuickRail] ë‹¤ì¤‘ ì´ë™ ì €ì¥ (section=${sectionId})`);
    console.log({ draggedCaseId, selectedCaseIds, dropIndex, insertAt });
    console.log('newOrder:', newOrder);
    const t0 = performance.now();

    try {
        const updatePromises = newOrder.map((caseId, index) => 
            fetch(`/api/cases/${caseId}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    order_index: index
                })
            })
        );
        
        await Promise.all(updatePromises);
        console.log(`âœ… done: ${(performance.now() - t0).toFixed(2)}ms`);
        
        // ì„ íƒ í•´ì œ
        document.querySelectorAll('.case-checkbox:checked').forEach(cb => {
            cb.checked = false;
        });
        updateSelectAllState();
        
        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì •í™•í•œ ìˆœì„œ ë°˜ì˜
        location.reload();
    } catch (err) {
        console.error('ìˆœì„œ ë³€ê²½ ì‹¤íŒ¨:', err);
        alert('ìˆœì„œ ë³€ê²½ ì‹¤íŒ¨: ' + err);
        location.reload();
    } finally {
        console.groupEnd();
        caseList?.classList.remove('loading');
    }
}

// ì „ì²´ ì„ íƒ/í•´ì œ
function toggleSelectAll(checked) {
    const checkboxes = document.querySelectorAll('.case-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = checked;
    });
    updateDeleteButtonVisibility();
}

// ì „ì²´ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê°œë³„ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ)
function updateSelectAllState() {
    const checkboxes = document.querySelectorAll('.case-checkbox');
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    const selectAllCheckbox = document.getElementById('selectAllCases');
    
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }
    updateDeleteButtonVisibility();
    updateSelectedItemsHighlight();
}

// Shift í´ë¦­ìœ¼ë¡œ ë²”ìœ„ ì„ íƒ
let lastCheckedIndex = -1;

function handleCheckboxChange(checkbox, event) {
    if (event.shiftKey && lastCheckedIndex !== -1) {
        // Shift í´ë¦­: ë²”ìœ„ ì„ íƒ
        const currentIndex = parseInt(checkbox.dataset.caseIndex);
        const startIndex = Math.min(lastCheckedIndex, currentIndex);
        const endIndex = Math.max(lastCheckedIndex, currentIndex);
        
        const allCheckboxes = Array.from(document.querySelectorAll('.case-checkbox'));
        const targetState = checkbox.checked;
        
        for (let i = startIndex; i <= endIndex; i++) {
            if (allCheckboxes[i]) {
                allCheckboxes[i].checked = targetState;
            }
        }
    } else {
        // ì¼ë°˜ í´ë¦­: ë§ˆì§€ë§‰ ì²´í¬ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
        lastCheckedIndex = parseInt(checkbox.dataset.caseIndex);
    }
    
    updateSelectAllState();

    // ì„¹ì…˜ í—¤ë” ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë™ê¸°í™”
    const caseItem = checkbox.closest('.case-item');
    if (caseItem && caseItem.dataset.sectionId) {
        updateSectionHeaderCheckboxState(parseInt(caseItem.dataset.sectionId));
    }
}

// ì„¹ì…˜ ê·¸ë£¹ í—¤ë” ì²´í¬ë°•ìŠ¤ë¡œ í•´ë‹¹ ì„¹ì…˜ ì¼€ì´ìŠ¤ ì „ì²´ ì„ íƒ/í•´ì œ
function toggleSectionCasesSelection(sectionId, headerCheckbox, event) {
    if (event) event.stopPropagation();
    const targetChecked = !!headerCheckbox.checked;
    const checkboxes = document.querySelectorAll(`.case-item[data-section-id="${sectionId}"] .case-checkbox`);
    checkboxes.forEach(cb => {
        if (cb.checked !== targetChecked) {
            cb.checked = targetChecked;
            cb.dispatchEvent(new Event('change', { bubbles: true }));
        }
    });
    updateSectionHeaderCheckboxState(sectionId);
    updateSelectAllState();
}

function updateSectionHeaderCheckboxState(sectionId) {
    const headerCb = document.querySelector(`.section-select-checkbox[data-section-id="${sectionId}"]`);
    if (!headerCb) return;
    const checkboxes = Array.from(document.querySelectorAll(`.case-item[data-section-id="${sectionId}"] .case-checkbox`));
    if (checkboxes.length === 0) {
        headerCb.checked = false;
        headerCb.indeterminate = false;
        return;
    }
    const checkedCount = checkboxes.filter(cb => cb.checked).length;
    headerCb.checked = checkedCount === checkboxes.length;
    headerCb.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
}

// ì„ íƒëœ í•­ëª© í•˜ì´ë¼ì´íŠ¸
function updateSelectedItemsHighlight() {
    const checkboxes = document.querySelectorAll('.case-checkbox');
    checkboxes.forEach((checkbox, index) => {
        const caseItem = checkbox.closest('.case-item');
        if (caseItem) {
            if (checkbox.checked) {
                caseItem.classList.add('selected');
                caseItem.classList.add('checkbox-selected'); // ì²´í¬ë°•ìŠ¤ë¡œ ì¸í•œ ì„ íƒ í‘œì‹œ
            } else {
                caseItem.classList.remove('selected');
                caseItem.classList.remove('checkbox-selected');
            }
        }
    });
}

// ì¼€ì´ìŠ¤ ì„ íƒ (í´ë¦­ ì‹œ)
let selectedCaseId = null;
let titleEditTimeout = null;
let lastClickTime = 0;
let lastClickCaseId = null;
let isEditMode = false; // í¸ì§‘ ëª¨ë“œ ìƒíƒœ

function selectCase(caseId, event) {
    // ì²´í¬ë°•ìŠ¤ë‚˜ ë“œë˜ê·¸ í•¸ë“¤ í´ë¦­ì´ë©´ ë¬´ì‹œ
    if (event.target.closest('.case-checkbox') || event.target.closest('.case-drag-handle') || event.target.closest('.case-actions')) {
        return;
    }
    
    const currentTime = Date.now();
    const titleElement = document.getElementById(`case-title-${caseId}`);
    
    // í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ê¸°ì¡´ ë¡œì§ ì‹¤í–‰
    if (!isEditMode) {
        const caseItem = document.querySelector(`.case-item[data-case-id="${caseId}"]`);
        const checkbox = caseItem?.querySelector('.case-checkbox');
        
        // case-title í´ë¦­ì€ handleCaseTitleClickì—ì„œ ì²˜ë¦¬
        if (event.target.closest('.case-title') || event.target.classList.contains('case-title')) {
            return;
        }
        
        // ê°™ì€ ì¼€ì´ìŠ¤ë¥¼ ë‹¤ì‹œ í´ë¦­í•œ ê²½ìš° (ì´ë¯¸ ì„ íƒëœ ìƒíƒœ)
        if (selectedCaseId === caseId) {
            // íƒ€ì´í‹€ ì™¸ ì˜ì—­ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
            if (titleElement) {
                titleElement.contentEditable = 'false';
                titleElement.classList.remove('editing');
            }
            if (caseItem) {
                caseItem.classList.remove('selected');
            }
            if (checkbox) {
                checkbox.checked = false;
            }
            selectedCaseId = null;
            updateSelectAllState();
            return;
        }
        
        // ì´ì „ ì¼€ì´ìŠ¤ì˜ í¸ì§‘ ëª¨ë“œ ì €ì¥ ë° í•´ì œ
        if (selectedCaseId && selectedCaseId !== caseId) {
            const prevTitle = document.getElementById(`case-title-${selectedCaseId}`);
            if (prevTitle && prevTitle.classList.contains('editing')) {
                // í¸ì§‘ ì¤‘ì´ë©´ ì¦‰ì‹œ ì €ì¥ í›„ í•´ì œ
                // ì—°í•„ ì•„ì´ì½˜ì„ ì œì™¸í•œ í…ìŠ¤íŠ¸ë§Œ ê°€ì ¸ì˜¤ê¸°
                const textSpan = prevTitle.querySelector('.case-title-text');
                const newTitle = textSpan ? textSpan.textContent.trim() : prevTitle.textContent.replace('âœï¸', '').trim();
                const prevCaseId = parseInt(prevTitle.dataset.caseId);
                // blur ì´ë²¤íŠ¸ë¥¼ íŠ¸ë¦¬ê±°í•˜ì—¬ ì €ì¥
                const focusElement = textSpan || prevTitle;
                if (document.activeElement === focusElement) {
                    focusElement.blur();
                }
                saveCaseTitle(prevCaseId, newTitle, true); // ì¦‰ì‹œ ì €ì¥
            }
            // ì„ íƒ ìƒíƒœ(ì²´í¬ë°•ìŠ¤, selected í´ë˜ìŠ¤)ëŠ” ìœ ì§€
        }
        
        // ìƒˆ ì¼€ì´ìŠ¤ ì„ íƒ
        selectedCaseId = caseId;
        lastClickCaseId = caseId;
        lastClickTime = currentTime;
        
        if (caseItem && checkbox && titleElement) {
            // ì²´í¬ë°•ìŠ¤ ì„ íƒ
            checkbox.checked = true;
            updateSelectAllState();
            
            // ì¼€ì´ìŠ¤ ì•„ì´í…œ ì„ íƒ í‘œì‹œ
            caseItem.classList.add('selected');
        }
    }
    // í¸ì§‘ ëª¨ë“œì¼ ë•ŒëŠ” í´ë¦­ìœ¼ë¡œ ì¼€ì´ìŠ¤ ì„ íƒí•˜ì§€ ì•ŠìŒ
}

// í¸ì§‘ ëª¨ë“œ í† ê¸€
function toggleEditMode() {
    isEditMode = !isEditMode;
    const editModeBtn = document.getElementById('editModeToggle');
    const editModeIcon = document.getElementById('editModeIcon');
    const caseListContainer = document.querySelector('.case-list-container');
    const shortcutGuide = document.getElementById('editModeShortcutGuide');
    
    if (isEditMode) {
        editModeBtn.classList.add('active');
        // editModeIcon.textContent = 'âœ…';
        caseListContainer?.classList.add('edit-mode');
        
        // ë‹¨ì¶•í‚¤ ê°€ì´ë“œ í‘œì‹œ (í¸ì§‘ëª¨ë“œ: ì „ì²´ í‘œì‹œ)
        if (shortcutGuide) {
            shortcutGuide.style.display = 'block';
            shortcutGuide.classList.remove('collapsed');
            shortcutGuide.classList.add('edit-mode-active');
            // inline display ì´ˆê¸°í™” (CSSë¡œ ì œì–´)
            shortcutGuide.querySelectorAll('.shortcut-item').forEach(item => item.style.display = '');
        }
        
        // í¸ì§‘ ëª¨ë“œ ì§„ì… ì‹œ ì²« ë²ˆì§¸ ì¼€ì´ìŠ¤ ì„ íƒ
        const firstCase = document.querySelector('.case-item');
        if (firstCase) {
            const caseId = firstCase.dataset.caseId;
            selectCaseInEditMode(caseId);
        }
    } else {
        editModeBtn.classList.remove('active');
        // editModeIcon.textContent = 'ğŸ“';
        caseListContainer?.classList.remove('edit-mode');
        
        // ë‹¨ì¶•í‚¤ ê°€ì´ë“œ í‘œì‹œ ìœ ì§€ (ë¹„í¸ì§‘ëª¨ë“œ: í† ê¸€ í‚¤ë§Œ í‘œì‹œ)
        if (shortcutGuide) {
            shortcutGuide.style.display = 'block';
            shortcutGuide.classList.remove('edit-mode-active');
            // ì ‘í˜€ìˆìœ¼ë©´ í† ê¸€ í‚¤ë„ ì•ˆ ë³´ì´ë¯€ë¡œ ë¹„í¸ì§‘ëª¨ë“œì—ì„œëŠ” í¼ì¹¨ ìœ ì§€
            shortcutGuide.classList.remove('collapsed');
            // inline display ì´ˆê¸°í™” (CSSë¡œ ì œì–´)
            shortcutGuide.querySelectorAll('.shortcut-item').forEach(item => item.style.display = '');
        }
        
        // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ ì‹œ í¸ì§‘ ì¤‘ì¸ íƒ€ì´í‹€ ì €ì¥
        if (selectedCaseId) {
            const titleElement = document.getElementById(`case-title-${selectedCaseId}`);
            if (titleElement && titleElement.classList.contains('editing')) {
                titleElement.blur();
            }
        }
        
        // ì„ íƒ í•´ì œ
        deselectAllInEditMode();
        selectedCaseId = null;
    }
}

// í¸ì§‘ ëª¨ë“œì—ì„œ ì¼€ì´ìŠ¤ ì„ íƒ
function selectCaseInEditMode(caseId) {
    if (!isEditMode) return;
    
    // ì´ì „ ì„ íƒ í•´ì œ
    if (selectedCaseId) {
        const prevTitle = document.getElementById(`case-title-${selectedCaseId}`);
        if (prevTitle && prevTitle.classList.contains('editing')) {
            prevTitle.blur(); // ì €ì¥
        }
        const prevItem = document.querySelector(`.case-item[data-case-id="${selectedCaseId}"]`);
        if (prevItem) {
            prevItem.classList.remove('edit-mode-selected');
        }
    }
    
    // ìƒˆ ì¼€ì´ìŠ¤ ì„ íƒ (ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥)
    selectedCaseId = parseInt(caseId);
    const caseItem = document.querySelector(`.case-item[data-case-id="${caseId}"]`);
    if (caseItem) {
        caseItem.classList.add('edit-mode-selected');
        
        // ìŠ¤í¬ë¡¤í•˜ì—¬ ë³´ì´ê²Œ
        caseItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// í¸ì§‘ ëª¨ë“œì—ì„œ ëª¨ë“  ì„ íƒ í•´ì œ
function deselectAllInEditMode() {
    document.querySelectorAll('.case-item').forEach(item => {
        item.classList.remove('edit-mode-selected');
    });
}

// ë‹¨ì¶•í‚¤ ê°€ì´ë“œ ì ‘ê¸°/í¼ì¹˜ê¸°
function toggleShortcutGuide() {
    const shortcutGuide = document.getElementById('editModeShortcutGuide');
    if (shortcutGuide) {
        shortcutGuide.classList.toggle('collapsed');
    }
}

// í¸ì§‘ ëª¨ë“œì—ì„œ ë‹¤ìŒ/ì´ì „ ì¼€ì´ìŠ¤ë¡œ ì´ë™
function moveToNextCase() {
    if (!isEditMode || !selectedCaseId) return;
    
    const allCases = Array.from(document.querySelectorAll('.case-item'));
    // selectedCaseIdë¥¼ ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
    const currentIndex = allCases.findIndex(item => parseInt(item.dataset.caseId) === parseInt(selectedCaseId));
    
    if (currentIndex === -1) {
        // í˜„ì¬ ì„ íƒëœ ì¼€ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì¼€ì´ìŠ¤ ì„ íƒ
        if (allCases.length > 0) {
            selectCaseInEditMode(allCases[0].dataset.caseId);
        }
        return;
    }
    
    if (currentIndex < allCases.length - 1) {
        const nextCase = allCases[currentIndex + 1];
        selectCaseInEditMode(nextCase.dataset.caseId);
    }
}

function moveToPrevCase() {
    if (!isEditMode || !selectedCaseId) return;
    
    const allCases = Array.from(document.querySelectorAll('.case-item'));
    // selectedCaseIdë¥¼ ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
    const currentIndex = allCases.findIndex(item => parseInt(item.dataset.caseId) === parseInt(selectedCaseId));
    
    if (currentIndex === -1) {
        // í˜„ì¬ ì„ íƒëœ ì¼€ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì¼€ì´ìŠ¤ ì„ íƒ
        if (allCases.length > 0) {
            selectCaseInEditMode(allCases[0].dataset.caseId);
        }
        return;
    }
    
    if (currentIndex > 0) {
        const prevCase = allCases[currentIndex - 1];
        selectCaseInEditMode(prevCase.dataset.caseId);
    }
}

// í¸ì§‘ ëª¨ë“œì—ì„œ ìƒˆ ì¼€ì´ìŠ¤ ì¶”ê°€
async function createNewCaseAt(position) {
    if (!isEditMode || !selectedCaseId) return;
    
    const currentCaseItem = document.querySelector(`.case-item[data-case-id="${selectedCaseId}"]`);
    if (!currentCaseItem) return;
    
    const currentCaseId = selectedCaseId;
    const allCases = Array.from(document.querySelectorAll('.case-item'));
    const currentIndex = allCases.findIndex(item => item.dataset.caseId === currentCaseId);
    
    // í˜„ì¬ ì¼€ì´ìŠ¤ì˜ ì„¹ì…˜ ID ê°€ì ¸ì˜¤ê¸°
    const sectionId = currentCaseItem.dataset.sectionId;
    
    if (!sectionId) {
        alert('ì„¹ì…˜ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // í˜„ì¬ ì¼€ì´ìŠ¤ì˜ order_index ê°€ì ¸ì˜¤ê¸°
    const currentOrderIndex = parseInt(currentCaseItem.dataset.orderIndex) || currentIndex;
    
    // ìƒˆ ì¼€ì´ìŠ¤ì˜ order_index ê³„ì‚°
    let newOrderIndex;
    if (position === 'before') {
        newOrderIndex = currentOrderIndex;
    } else {
        newOrderIndex = currentOrderIndex + 1;
    }
    
    try {
        // ìƒˆ ì¼€ì´ìŠ¤ ìƒì„±
        const response = await fetch(`/api/projects/${projectId}/cases`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: 'ìƒˆ ì¼€ì´ìŠ¤',
                section_id: parseInt(sectionId),
                steps: '',
                expected_result: '',
                priority: 'Medium',
                order_index: newOrderIndex
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'ì¼€ì´ìŠ¤ ìƒì„± ì‹¤íŒ¨');
        }
        
        const newCase = await response.json();
        
        // ë²ˆì—­ ê²½ê³ ê°€ ìˆìœ¼ë©´ í‘œì‹œ
        if (newCase.translation_warning) {
            alert('âš ï¸ ë²ˆì—­ ê²½ê³ \n\n' + newCase.translation_warning + '\n\nì¼€ì´ìŠ¤ëŠ” ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // ìš°ì„ ìˆœìœ„ ì•„ì´ì½˜ SVG ê°€ì ¸ì˜¤ê¸°
        const priorityIcons = {
            'Blocker': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 15c-3.9 0-7-3.1-7-7s3.1-7 7-7 7 3.1 7 7-3.1 7-7 7zM4 7c-.6 0-1 .4-1 1s.4 1 1 1h8c.6 0 1-.4 1-1s-.4-1-1-1H4z" fill="#ff5630"/></svg>',
            'Critical': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><linearGradient id="grad-critical-new" gradientUnits="userSpaceOnUse" x1="-46.25" y1="65.1105" x2="-46.25" y2="64.1105" gradientTransform="matrix(12 0 0 -13.1121 563 854.7415)"><stop offset="0" stop-color="#ff5630"/><stop offset="1" stop-color="#ff8f73"/></linearGradient><path d="M2.5 4l5-2.9c.3-.2.7-.2 1 0l5 2.9c.3.2.5.5.5.9v8.2c0 .6-.4 1-1 1-.2 0-.4 0-.5-.1L8 11.4 3.5 14c-.5.3-1.1.1-1.4-.4-.1-.1-.1-.3-.1-.5V4.9c0-.4.2-.7.5-.9z" fill="url(#grad-critical-new)"/></svg>',
            'High': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M7.984436 3.200867l-4.5 2.7c-.5.3-1.1.1-1.3-.4s-.2-1.1.3-1.3l5-3c.3-.2.7-.2 1 0l5 3c.5.3.6.9.3 1.4-.3.5-.9.6-1.4.3l-4.4-2.7z" fill="#ff5630"/><path d="M3.484436 10.200867c-.5.3-1.1.1-1.3-.3s-.2-1.1.3-1.4l5-3c.3-.2.7-.2 1 0l5 3c.5.3.6.9.3 1.4-.3.5-.9.6-1.4.3l-4.4-2.7-4.5 2.7z" fill="#ff7452"/><path d="M3.484436 14.500867c-.5.3-1.1.2-1.3-.3s-.2-1.1.3-1.4l5-3c.3-.2.7-.2 1 0l5 3c.5.3.6.9.3 1.4-.3.5-.9.6-1.4.3l-4.4-2.7-4.5 2.7z" fill="#ff8f73"/></svg>',
            'Medium': '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14 6.5L2 6.5L2 5L14 5L14 6.5ZM14 11L2 11L2 9.5L14 9.5L14 11Z" fill="#E06C00"/></svg>',
            'Low': '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.5874 10.8762L2.0874 7.25122L2.91287 5.99878L8.00014 9.35175L13.0874 5.99878L13.9129 7.25122L8.41287 10.8762C8.16246 11.0413 7.83781 11.0413 7.5874 10.8762Z" fill="#4688EC"/></svg>'
        };
        
        // í˜„ì¬ ë‚ ì§œ í¬ë§·íŒ…
        const now = new Date();
        const dateStr = now.getFullYear() + '-' + 
                        String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(now.getDate()).padStart(2, '0') + ' ' +
                        String(now.getHours()).padStart(2, '0') + ':' +
                        String(now.getMinutes()).padStart(2, '0');
        
        // ìƒˆ ì¼€ì´ìŠ¤ DOM ìš”ì†Œ ìƒì„±
        const newCaseHtml = `
            <div class="case-item" data-case-id="${newCase.id}" data-section-id="${newCase.section_id}" data-order-index="${newCase.order_index}">
                <div class="case-drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â˜°</div>
                <input type="checkbox" class="case-checkbox" data-case-id="${newCase.id}" data-case-index="0" onchange="handleCheckboxChange(this, event)" onclick="event.stopPropagation()">
                <div class="case-content" onclick="selectCase(${newCase.id}, event)" style="cursor: pointer; flex: 1;">
                    <div class="case-title" id="case-title-${newCase.id}" data-case-id="${newCase.id}" contenteditable="false" onclick="handleCaseTitleClick(${newCase.id}, event)">
                        <span class="case-title-text">${newCase.title}</span>
                        <span class="case-title-edit-hint">í´ë¦­í•˜ì—¬ í¸ì§‘</span>
                    </div>
                    <div class="case-meta">
                        <span class="priority-badge priority-${newCase.priority}">${priorityIcons[newCase.priority] || ''}</span>
                        <span style="font-size: 0.85rem; color: #666;">ğŸ“… ìƒì„±: ${dateStr}</span>
                        <span style="font-size: 0.85rem; color: #666;">ğŸ• ìˆ˜ì •: ${dateStr}</span>
                    </div>
                </div>
                <div class="case-actions">
                    <button class="case-menu-trigger" onclick="event.stopPropagation(); toggleCaseMenu(${newCase.id}, event)" title="ë©”ë‰´">â‹®</button>
                    <div class="case-context-menu" id="case-menu-${newCase.id}">
                        <button class="case-context-menu-item" onclick="event.stopPropagation(); showCaseDetail(${newCase.id}); closeCaseMenu(${newCase.id})">
                            <span>âœï¸</span>
                            <span>í¸ì§‘</span>
                        </button>
                        <button class="case-context-menu-item" onclick="event.stopPropagation(); copyCase(${newCase.id}); closeCaseMenu(${newCase.id})">
                            <span>ğŸ“‹</span>
                            <span>ë³µì œ</span>
                        </button>
                        <button class="case-context-menu-item danger" onclick="event.stopPropagation(); deleteCase(${newCase.id}); closeCaseMenu(${newCase.id})">
                            <span>ğŸ—‘ï¸</span>
                            <span>ì‚­ì œ</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // ì¼€ì´ìŠ¤ë¥¼ ì ì ˆí•œ ìœ„ì¹˜ì— ì‚½ì…
        const caseListContainer = document.getElementById('caseListSortable');
        if (position === 'before') {
            currentCaseItem.insertAdjacentHTML('beforebegin', newCaseHtml);
        } else {
            currentCaseItem.insertAdjacentHTML('afterend', newCaseHtml);
        }
        
        // ëª¨ë“  ì¼€ì´ìŠ¤ì˜ order_index ì—…ë°ì´íŠ¸
        const allCases = Array.from(document.querySelectorAll('.case-item'));
        allCases.forEach((item, index) => {
            item.dataset.orderIndex = index;
        });
        
        // Sortable ì¬ì´ˆê¸°í™”
        initCaseSortable();
        
        // ìƒˆë¡œ ìƒì„±ëœ ì¼€ì´ìŠ¤ì˜ ì›ë³¸ íƒ€ì´í‹€ ì €ì¥
        const newTitleElement = document.getElementById(`case-title-${newCase.id}`);
        if (newTitleElement) {
            newTitleElement.dataset.originalTitle = newCase.title;
        }
        
        // ìƒˆë¡œ ìƒì„±ëœ ì¼€ì´ìŠ¤ ì„ íƒ ë° í¸ì§‘ ëª¨ë“œë¡œ ì§„ì…
        setTimeout(() => {
            selectCaseInEditMode(newCase.id);
            startTitleEdit(newCase.id, 'replace');
        }, 50);
        
    } catch (error) {
        console.error('ì¼€ì´ìŠ¤ ìƒì„± ì˜¤ë¥˜:', error);
        alert('ì¼€ì´ìŠ¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// í‚¤ë³´ë“œ ì…ë ¥ìœ¼ë¡œ íƒ€ì´í‹€ ìˆ˜ì • (ì—‘ì…€ì²˜ëŸ¼)
document.addEventListener('keydown', function(e) {
    // í¸ì§‘ ëª¨ë“œ í† ê¸€ ë‹¨ì¶•í‚¤ (Ctrl+E ë˜ëŠ” Cmd+E)
    if ((e.ctrlKey || e.metaKey) && (e.key === 'e' || e.key === 'E')) {
        e.preventDefault();
        toggleEditMode();
        return;
    }
    
    // í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•ŒëŠ” ê¸°ì¡´ ë¡œì§
    if (!isEditMode) {
        if (!selectedCaseId) return;
        
        const titleElement = document.getElementById(`case-title-${selectedCaseId}`);
        if (!titleElement) return;
        
        // ì´ë¯¸ í¸ì§‘ ì¤‘ì´ë©´ Enter/Escapeë§Œ ì²˜ë¦¬
        if (titleElement.classList.contains('editing')) {
            if (e.key === 'Enter') {
                e.preventDefault();
                titleElement.blur(); // blur ì´ë²¤íŠ¸ë¡œ ì €ì¥
                return;
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                cancelTitleEdit(selectedCaseId);
                return;
            }
            return; // í¸ì§‘ ì¤‘ì—ëŠ” ë‹¤ë¥¸ í‚¤ëŠ” ê·¸ëŒ€ë¡œ ì²˜ë¦¬
        }
        
        // í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œ: F2ë¡œ í¸ì§‘ ì‹œì‘
        if (e.key === 'F2') {
            e.preventDefault();
            startTitleEdit(selectedCaseId, 'end');
        }
        return;
    }
    
    // í¸ì§‘ ëª¨ë“œì¼ ë•Œ
    if (!selectedCaseId) return;
    
    const titleElementEdit = document.getElementById(`case-title-${selectedCaseId}`);
    if (!titleElementEdit) return;
    
    // ì´ë¯¸ í¸ì§‘ ì¤‘ì´ë©´
    if (titleElementEdit.classList.contains('editing')) {
        if (e.key === 'Enter') {
            e.preventDefault();
            titleElementEdit.blur(); // blur ì´ë²¤íŠ¸ë¡œ ì €ì¥
            // ë‹¤ìŒ ì¼€ì´ìŠ¤ë¡œ ì´ë™
            moveToNextCase();
            return;
        }
        if (e.key === 'Escape') {
            e.preventDefault();
            cancelTitleEdit(selectedCaseId);
            return;
        }
        if (e.key === 'ArrowUp') {
            e.preventDefault();
            titleElementEdit.blur(); // ì €ì¥
            moveToPrevCase();
            return;
        }
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            titleElementEdit.blur(); // ì €ì¥
            moveToNextCase();
            return;
        }
        return; // í¸ì§‘ ì¤‘ì—ëŠ” ë‹¤ë¥¸ í‚¤ëŠ” ê·¸ëŒ€ë¡œ ì²˜ë¦¬
    }
    
    // í¸ì§‘ ì¤‘ì´ ì•„ë‹ ë•Œ
    if (e.key === 'ArrowUp' && e.ctrlKey) {
        // Ctrl + ìœ„ ë°©í–¥í‚¤: í˜„ì¬ ìœ„ì¹˜ ìœ„ì— ìƒˆ ì¼€ì´ìŠ¤ ì¶”ê°€
        e.preventDefault();
        createNewCaseAt('before');
    } else if (e.key === 'ArrowDown' && e.ctrlKey) {
        // Ctrl + ì•„ë˜ ë°©í–¥í‚¤: í˜„ì¬ ìœ„ì¹˜ ì•„ë˜ì— ìƒˆ ì¼€ì´ìŠ¤ ì¶”ê°€
        e.preventDefault();
        createNewCaseAt('after');
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        moveToPrevCase();
    } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        moveToNextCase();
    } else if (e.key === 'F2' || e.key === 'Enter') {
        e.preventDefault();
        startTitleEdit(selectedCaseId, 'end');
    } else if ((e.ctrlKey || e.metaKey) && (e.key === 'Delete' || e.key === 'Backspace')) {
        // Ctrl+Delete (Win) / Cmd+Backspace (Mac): ì¼€ì´ìŠ¤ ì‚­ì œ(ì•„ì¹´ì´ë¸Œ)
        e.preventDefault();
        const ok = confirm('í˜„ì¬ ì¼€ì´ìŠ¤ë¥¼ ì‚­ì œ(ì•„ì¹´ì´ë¸Œ)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (ok) {
            deleteCase(selectedCaseId, { confirmDelete: false, showAlert: true });
        } else {
            alert('â ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    } else if ((e.ctrlKey || e.metaKey) && (e.key === 'd' || e.key === 'D')) {
        // Ctrl+D: ì¼€ì´ìŠ¤ ë³µì œ (ë‹¤ìŒ ìˆœì„œ)
        e.preventDefault();
        copyCase(selectedCaseId, { confirmCopy: false, showAlert: true });
    } else if (e.key === 'F4') {
        // ìƒì„¸ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸° (F4)
        e.preventDefault();
        showCaseDetail(selectedCaseId);
    }
});

// ë¬¸ì„œ ì „ì²´ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
document.addEventListener('click', function(e) {
    // ì¼€ì´ìŠ¤ ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
    if (!e.target.closest('.case-menu-trigger') && !e.target.closest('.case-context-menu')) {
        closeAllCaseMenus();
    }
    
    // ì¼€ì´ìŠ¤ ì•„ì´í…œ ì™¸ë¶€ë¥¼ í´ë¦­í•œ ê²½ìš°
    if (!e.target.closest('.case-item') && !e.target.closest('.modal')) {
        if (selectedCaseId) {
            const titleElement = document.getElementById(`case-title-${selectedCaseId}`);
            if (titleElement && titleElement.classList.contains('editing')) {
                // í¸ì§‘ ì¤‘ì´ë©´ ì €ì¥
                titleElement.blur();
            }
            // ì„ íƒ í•´ì œëŠ” í•˜ì§€ ì•ŠìŒ (ì²´í¬ë°•ìŠ¤ëŠ” ìœ ì§€)
        }
    }
});

// íƒ€ì´í‹€ í¸ì§‘ ì‹œì‘
function startTitleEdit(caseId, mode) {
    const titleElement = document.getElementById(`case-title-${caseId}`);
    if (!titleElement) return;
    
    // í¸ì§‘ ëª¨ë“œ ì§„ì… ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ ì €ì¥
    const textSpan = titleElement.querySelector('.case-title-text');
    if (textSpan && !titleElement.dataset.originalTitle) {
        titleElement.dataset.originalTitle = textSpan.textContent.trim();
    }
    
    // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” í…ìŠ¤íŠ¸ë§Œ í¸ì§‘ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
    if (textSpan) {
        textSpan.contentEditable = 'true';
        titleElement.contentEditable = 'false';
    } else {
        titleElement.contentEditable = 'true';
    }
    
    titleElement.classList.add('editing');
    const focusElement = textSpan || titleElement;
    focusElement.focus();
    
    // modeê°€ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •ëœ ê²½ìš°ì—ë§Œ ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
    const targetElement = textSpan || titleElement;
    if (mode === 'end') {
        // F2: ì»¤ì„œë¥¼ ëìœ¼ë¡œ
        setTimeout(() => {
            const range = document.createRange();
            range.selectNodeContents(targetElement);
            range.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }, 0);
    } else if (mode === 'replace') {
        // ì§ì ‘ ì…ë ¥: ì „ì²´ ì„ íƒ (ë‚˜ì¤‘ì— ì…ë ¥í•œ ë¬¸ìë¡œ ëŒ€ì²´)
        setTimeout(() => {
            const range = document.createRange();
            range.selectNodeContents(targetElement);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }, 0);
    }
    // modeê°€ ì—†ìœ¼ë©´ (í´ë¦­ìœ¼ë¡œ ì§„ì…) ì»¤ì„œ ìœ„ì¹˜ë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŒ
}

// íƒ€ì´í‹€ í¸ì§‘ ì·¨ì†Œ
function cancelTitleEdit(caseId) {
    const titleElement = document.getElementById(`case-title-${caseId}`);
    if (titleElement) {
        // ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
        const originalTitle = titleElement.dataset.originalTitle;
        if (originalTitle) {
            restoreTitleStructure(titleElement, originalTitle);
        } else {
            // ì„œë²„ì—ì„œ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
            fetch(`/api/cases/${caseId}`)
                .then(res => res.json())
                .then(data => {
                    titleElement.dataset.originalTitle = data.title;
                    restoreTitleStructure(titleElement, data.title);
                })
                .catch(err => console.error('ì¼€ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨:', err));
        }
        titleElement.contentEditable = 'false';
        titleElement.classList.remove('editing');
    }
}

// íƒ€ì´í‹€ ì €ì¥ (ë””ë°”ìš´ìŠ¤)
function saveCaseTitle(caseId, newTitle, immediate = false) {
    const titleElement = document.getElementById(`case-title-${caseId}`);
    if (!titleElement) return;
    
    const originalTitle = titleElement.dataset.originalTitle || titleElement.textContent.trim();
    
    if (newTitle === originalTitle || !newTitle) {
        // ë³€ê²½ì‚¬í•­ ì—†ìŒ
        titleElement.contentEditable = 'false';
        titleElement.classList.remove('editing');
        // í¸ì§‘ ì¢…ë£Œ ì‹œ êµ¬ì¡° ë³µì›
        restoreTitleStructure(titleElement, newTitle);
        return;
    }
    
    const saveFunction = () => {
        fetch(`/api/cases/${caseId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ title: newTitle })
        })
        .then(res => res.json())
        .then(data => {
            titleElement.dataset.originalTitle = newTitle;
            titleElement.contentEditable = 'false';
            titleElement.classList.remove('editing');
            // í¸ì§‘ ì¢…ë£Œ ì‹œ êµ¬ì¡° ë³µì›
            restoreTitleStructure(titleElement, newTitle);
            console.log('íƒ€ì´í‹€ ì €ì¥ ì™„ë£Œ');
        })
        .catch(err => {
            console.error('íƒ€ì´í‹€ ì €ì¥ ì‹¤íŒ¨:', err);
            alert('íƒ€ì´í‹€ ì €ì¥ ì‹¤íŒ¨: ' + err);
            cancelTitleEdit(caseId);
        });
    };
    
    if (immediate) {
        // ì¦‰ì‹œ ì €ì¥ (ë‹¤ë¥¸ case ì„ íƒ ì‹œ ë“±)
        clearTimeout(titleEditTimeout);
        saveFunction();
    } else {
        // ë””ë°”ìš´ìŠ¤: íƒ€ì´í•‘ì´ ëë‚œ í›„ ì €ì¥
        clearTimeout(titleEditTimeout);
        titleEditTimeout = setTimeout(saveFunction, 500); // 500ms ë””ë°”ìš´ìŠ¤
    }
}

// íƒ€ì´í‹€ êµ¬ì¡° ë³µì› (í¸ì§‘ ì¢…ë£Œ ì‹œ)
function restoreTitleStructure(titleElement, text) {
    // í¸ì§‘ ëª¨ë“œì—ì„œ êµ¬ì¡°ê°€ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³µì›
    const existingTextSpan = titleElement.querySelector('.case-title-text');
    const existingHint = titleElement.querySelector('.case-title-edit-hint');
    
    if (!existingTextSpan) {
        // êµ¬ì¡°ê°€ ì—†ìœ¼ë©´ ë‹¤ì‹œ ìƒì„±
        titleElement.innerHTML = `<span class="case-title-text">${text}</span><span class="case-title-edit-hint">í´ë¦­í•˜ì—¬ í¸ì§‘</span>`;
    } else {
        // í…ìŠ¤íŠ¸ë§Œ ì—…ë°ì´íŠ¸
        existingTextSpan.textContent = text;
        existingTextSpan.contentEditable = 'false';
        if (!existingHint) {
            // íŒíŠ¸ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            const hint = document.createElement('span');
            hint.className = 'case-title-edit-hint';
            hint.textContent = 'í´ë¦­í•˜ì—¬ í¸ì§‘';
            titleElement.appendChild(hint);
        }
    }
    titleElement.contentEditable = 'false';
}

// íƒ€ì´í‹€ í¸ì§‘ ì¤‘ ì‹¤ì‹œê°„ ì €ì¥ (blur ì´ë²¤íŠ¸)
document.addEventListener('blur', function(e) {
    const titleElement = e.target.closest('.case-title');
    if (titleElement && titleElement.classList.contains('editing')) {
        const caseId = parseInt(titleElement.dataset.caseId);
        // ì—°í•„ ì•„ì´ì½˜ì„ ì œì™¸í•œ í…ìŠ¤íŠ¸ë§Œ ê°€ì ¸ì˜¤ê¸°
        const textSpan = titleElement.querySelector('.case-title-text');
        const newTitle = textSpan ? textSpan.textContent.trim() : titleElement.textContent.replace('âœï¸', '').trim();
        saveCaseTitle(caseId, newTitle);
    }
}, true);

// ì„ íƒ ì‚­ì œ ë²„íŠ¼ ë° ìš°ì„ ìˆœìœ„ ë³€ê²½ UI í‘œì‹œ/ìˆ¨ê¹€
function updateDeleteButtonVisibility() {
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const bulkPriorityContainer = document.getElementById('bulkPriorityContainer');
    if (!deleteBtn) return;
    
    const checkedBoxes = document.querySelectorAll('.case-checkbox:checked');
    if (checkedBoxes.length > 0) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.textContent = `ì„ íƒ ì‚­ì œ (${checkedBoxes.length})`;
        if (bulkPriorityContainer) {
            bulkPriorityContainer.style.display = 'flex';
        }
    } else {
        deleteBtn.style.display = 'none';
        if (bulkPriorityContainer) {
            bulkPriorityContainer.style.display = 'none';
        }
    }
}

// ìš°ì„ ìˆœìœ„ ì¼ê´„ ë³€ê²½
async function bulkChangePriority() {
    const select = document.getElementById('bulkPrioritySelect');
    const priority = select.value;
    
    if (!priority) {
        alert('ìš°ì„ ìˆœìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const checkedBoxes = document.querySelectorAll('.case-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('ë³€ê²½í•  ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const caseIds = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.caseId));
    
    if (!confirm(`ì„ íƒí•œ ${caseIds.length}ê°œ ì¼€ì´ìŠ¤ì˜ ìš°ì„ ìˆœìœ„ë¥¼ ${priority}ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    try {
        // ê° ì¼€ì´ìŠ¤ì˜ ìš°ì„ ìˆœìœ„ ì—…ë°ì´íŠ¸
        const promises = caseIds.map(caseId => 
            fetch(`/api/cases/${caseId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    priority: priority
                })
            })
        );
        
        await Promise.all(promises);
        
        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        alert('ìš°ì„ ìˆœìœ„ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.reload();
        
    } catch (error) {
        console.error('ìš°ì„ ìˆœìœ„ ë³€ê²½ ì˜¤ë¥˜:', error);
        alert('ìš°ì„ ìˆœìœ„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì„ íƒëœ ì¼€ì´ìŠ¤ ì „ì²´ ì‚­ì œ
async function deleteSelectedCases() {
    const checkedBoxes = document.querySelectorAll('.case-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('ì‚­ì œí•  ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const caseIds = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.caseId));
    const count = caseIds.length;
    
    if (!confirm(`ì„ íƒí•œ ${count}ê°œì˜ ì¼€ì´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    let successCount = 0;
    let failCount = 0;
    
    for (const caseId of caseIds) {
        try {
            const res = await fetch(`/api/cases/${caseId}/archive`, {
                method: 'POST'
            });
            
            if (res.ok) {
                successCount++;
            } else {
                failCount++;
            }
        } catch (err) {
            console.error('ì¼€ì´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨:', caseId, err);
            failCount++;
        }
    }
    
    if (successCount > 0) {
        alert(`ì™„ë£Œ!\nì„±ê³µ: ${successCount}ê°œ\nì‹¤íŒ¨: ${failCount}ê°œ`);
        location.reload();
    } else {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + failCount + 'ê°œ');
    }
}

// ê°„í¸ë³´ê¸°/ìƒì„¸ë³´ê¸° í† ê¸€
const VIEW_MODE_KEY = 'quickrail_case_view_mode';
let currentViewMode = localStorage.getItem(VIEW_MODE_KEY) || 'detail'; // 'compact' or 'detail'

function toggleViewMode() {
    // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í† ê¸€
    currentViewMode = currentViewMode === 'compact' ? 'detail' : 'compact';
    localStorage.setItem(VIEW_MODE_KEY, currentViewMode);
    
    const caseItems = document.querySelectorAll('.case-item');
    const viewToggleBtn = document.getElementById('viewToggleBtn');
    const viewToggleIcon = document.getElementById('viewToggleIcon');
    
    // ì• ë‹ˆë©”ì´ì…˜ ì™„ì „íˆ ë°©ì§€
    caseItems.forEach(item => {
        // transitionì„ ì™„ì „íˆ ì œê±°í•˜ê³  í´ë˜ìŠ¤ ë³€ê²½
        const meta = item.querySelector('.case-meta');
        const content = item.querySelector('.case-content');
        
        item.style.transition = 'none';
        if (meta) meta.style.transition = 'none';
        if (content) content.style.transition = 'none';
        
        if (currentViewMode === 'compact') {
            item.classList.add('compact-view');
        } else {
            item.classList.remove('compact-view');
        }
        
        // transitionì€ ë³µì›í•˜ì§€ ì•ŠìŒ (ì• ë‹ˆë©”ì´ì…˜ ì™„ì „ ì œê±°)
    });
    
    if (currentViewMode === 'compact') {
        viewToggleBtn.classList.add('active');
        viewToggleIcon.textContent = 'ğŸ“‹';
        viewToggleBtn.title = 'ìƒì„¸ë³´ê¸°ë¡œ ì „í™˜';
    } else {
        viewToggleBtn.classList.remove('active');
        viewToggleIcon.textContent = 'ğŸ“„';
        viewToggleBtn.title = 'ê°„í¸ë³´ê¸°ë¡œ ì „í™˜';
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë·° ëª¨ë“œ ì ìš©
function applyViewMode() {
    const caseItems = document.querySelectorAll('.case-item');
    const viewToggleBtn = document.getElementById('viewToggleBtn');
    const viewToggleIcon = document.getElementById('viewToggleIcon');
    
    if (currentViewMode === 'compact') {
        caseItems.forEach(item => item.classList.add('compact-view'));
        if (viewToggleBtn) {
            viewToggleBtn.classList.add('active');
        }
        if (viewToggleIcon) {
            viewToggleIcon.textContent = 'ğŸ“‹';
        }
    } else {
        caseItems.forEach(item => item.classList.remove('compact-view'));
        if (viewToggleBtn) {
            viewToggleBtn.classList.remove('active');
        }
        if (viewToggleIcon) {
            viewToggleIcon.textContent = 'ğŸ“„';
        }
    }
}

// ì¼€ì´ìŠ¤ ë³µì‚¬
async function copyCase(caseId, options = {}) {
    const { confirmCopy = true, showAlert = false } = options;
    if (confirmCopy && !confirm('ì´ ì¼€ì´ìŠ¤ë¥¼ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        // ì„œë²„ê°€ ì›ë³¸ ì¼€ì´ìŠ¤ì˜ order_index + 1 ìœ„ì¹˜ë¡œ ì‚½ì… (ë‹¤ìŒ ìˆœì„œ)
        const res = await fetch(`/api/cases/${caseId}/copy`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        
        if (!res.ok) throw new Error(`ë³µì‚¬ ì‹¤íŒ¨ (${res.status})`);
        await res.json();
        if (showAlert) {
            alert('âœ… ì¼€ì´ìŠ¤ê°€ ë‹¤ìŒ ìˆœì„œë¡œ ë³µì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        location.reload();
    } catch (err) {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
    }
}

// ì¼€ì´ìŠ¤ ìƒì„¸ë³´ê¸°
let currentCaseId = null;

let modalCurrentLang = 'original';
let modalOriginalData = null;
let modalTranslationData = null;

async function showCaseDetail(caseId) {
    try {
        const res = await fetch(`/api/cases/${caseId}`);
        if (!res.ok) throw new Error('ì¼€ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨');
        
        const caseData = await res.json();
        currentCaseId = caseId;
        modalOriginalData = caseData;
        modalCurrentLang = 'original';
        modalTranslationData = null;
        
        const modalTitle = document.getElementById('modalCaseTitle');
        const modalContent = document.getElementById('modalCaseContent');
        const modal = document.getElementById('caseDetailModal');
        
        if (!modalTitle || !modalContent || !modal) {
            console.error('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            alert('ëª¨ë‹¬ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        const escapeHtml = (text) => {
            if (!text) return '';
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return String(text).replace(/[&<>"']/g, m => map[m]);
        };
        
        modalTitle.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div contenteditable="true" id="modalTitle" 
                     style="display: inline-block; min-width: 300px; border: 1px solid transparent; padding: 0.25rem; border-radius: 4px; outline: none; flex: 1;"
                     onblur="updateModalField('title', this.textContent.trim())"
                     onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                     onblur="this.style.border='1px solid transparent'; this.style.background='transparent';">
${escapeHtml(caseData.title)}</div>
                <span style="padding: 0.25rem 0.75rem; background: #e3f2fd; color: #1976d2; border-radius: 12px; font-size: 0.85rem; white-space: nowrap;">
                    v${caseData.version || 1}
                </span>
            </div>
        `;
        
        modalContent.innerHTML = `
            <div style="margin-bottom: 1rem;">
                <strong>ìš°ì„ ìˆœìœ„:</strong>
                <select id="modalPriority" class="form-control" style="display: inline-block; width: auto; margin-left: 0.5rem;" 
                        onchange="updateModalField('priority', this.value)">
                    <option value="Blocker" ${caseData.priority === 'Blocker' ? 'selected' : ''}>Blocker</option>
                    <option value="Critical" ${caseData.priority === 'Critical' ? 'selected' : ''}>Critical</option>
                    <option value="High" ${caseData.priority === 'High' ? 'selected' : ''}>High</option>
                    <option value="Medium" ${caseData.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                    <option value="Low" ${caseData.priority === 'Low' ? 'selected' : ''}>Low</option>
                </select>
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>ë‹´ë‹¹ì:</strong> ${escapeHtml(caseData.owner_name) || 'ì—†ìŒ'}
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>ì„¹ì…˜:</strong> ${escapeHtml(caseData.section_name)}
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>íƒœê·¸:</strong> ${caseData.tags.length > 0 ? caseData.tags.map(t => `<span class="tag-badge">${escapeHtml(t)}</span>`).join(' ') : 'ì—†ìŒ'}
            </div>
            <div style="margin-bottom: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0;">ğŸ§· Jira ë§í¬</h4>
                <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
                    <input type="text" id="modalJiraLinkInput" class="form-control" placeholder="https://... ë˜ëŠ” JIRA-123" style="flex:1;"
                           onkeypress="if(event.key==='Enter'){event.preventDefault(); addCaseJiraLink();}">
                    <button type="button" class="btn btn-primary" onclick="addCaseJiraLink()">ì¶”ê°€</button>
                </div>
                <div id="modalJiraLinksList" style="display:flex; flex-direction:column; gap:0.35rem;">
                    ${(caseData.jira_links && caseData.jira_links.length > 0) ? caseData.jira_links.map((u) => `
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                            <a href="${escapeHtml(u)}" target="_blank" rel="noopener noreferrer" style="flex:1; color:#3498db; text-decoration:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">ğŸ”— ${escapeHtml(u)}</a>
                        </div>
                    `).join('') : `<div style="color:#999; font-size:0.9rem;">ë“±ë¡ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`}
                </div>
            </div>
            <div style="margin-bottom: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0;">ğŸ–¼ï¸ ë¯¸ë””ì–´ (ì´ë¯¸ì§€/ì˜ìƒ)</h4>
                <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
                    <input type="file" id="modalCaseMediaInput" class="form-control" accept="image/*,video/*">
                    <button type="button" class="btn btn-primary" onclick="uploadCaseMedia()">ì—…ë¡œë“œ</button>
                </div>
                <div id="modalCaseMediaList" style="display:flex; flex-direction:column; gap:0.35rem;">
                    ${(caseData.media && caseData.media.length > 0) ? caseData.media.map((m) => `
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                            <a href="${escapeHtml(m.url)}" target="_blank" rel="noopener noreferrer"
                               style="flex:1; color:#3498db; text-decoration:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">ğŸ“ ${escapeHtml(m.original_name)}</a>
                            <button type="button" class="btn btn-secondary" style="padding:0.25rem 0.5rem;" onclick="deleteCaseMedia(${m.id})">ì‚­ì œ</button>
                        </div>
                    `).join('') : `<div style="color:#999; font-size:0.9rem;">ë“±ë¡ëœ ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`}
                </div>
            </div>
            <hr>
            <div style="margin-bottom: 1rem;">
                <h4>í…ŒìŠ¤íŠ¸ ìŠ¤í… <small style="color: #999; font-weight: normal;">ğŸ’¡ í´ë¦­í•˜ì—¬ í¸ì§‘</small></h4>
                <div contenteditable="true" id="modalSteps" 
                     style="white-space: pre-wrap; background: #f9f9f9; padding: 1rem; border-radius: 4px; border: 1px solid transparent; min-height: 100px; outline: none;"
                     onblur="updateModalField('steps', this.textContent.trim())"
                     onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                     onblur="this.style.border='1px solid transparent'; this.style.background='#f9f9f9';">${escapeHtml(caseData.steps) || 'ìŠ¤í… ì •ë³´ ì—†ìŒ'}</div>
            </div>
            <div style="margin-bottom: 1rem;">
                <h4>ê¸°ëŒ€ ê²°ê³¼ <small style="color: #999; font-weight: normal;">ğŸ’¡ í´ë¦­í•˜ì—¬ í¸ì§‘</small></h4>
                <div contenteditable="true" id="modalExpected" 
                     style="white-space: pre-wrap; background: #f9f9f9; padding: 1rem; border-radius: 4px; border: 1px solid transparent; min-height: 100px; outline: none;"
                     onblur="updateModalField('expected_result', this.textContent.trim())"
                     onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                     onblur="this.style.border='1px solid transparent'; this.style.background='#f9f9f9';">${escapeHtml(caseData.expected_result) || 'ê¸°ëŒ€ ê²°ê³¼ ì—†ìŒ'}</div>
            </div>
            <hr>
            <div style="font-size: 0.9rem; color: #666;">
                <div>ìƒì„±: ${new Date(caseData.created_at).toLocaleString('ko-KR')}</div>
                <div>ìˆ˜ì •: ${new Date(caseData.updated_at).toLocaleString('ko-KR')}</div>
            </div>
        `;
        
        // ì–¸ì–´ ë²„íŠ¼ ì´ˆê¸°í™”
        modal.classList.add('show');

        // ë§í¬/ë¯¸ë””ì–´ ë°ì´í„°ê°€ ìµœì‹ ì´ ì•„ë‹ ìˆ˜ ìˆì–´ ì¬ë¡œë”© (ë°±ì—”ë“œ ì €ì¥ í›„ ì¦‰ì‹œ ë°˜ì˜)
        refreshCaseLinksAndMedia();
    } catch (err) {
        console.error('ì¼€ì´ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', err);
        alert('ì¼€ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
    }
}

async function refreshCaseLinksAndMedia() {
    if (!currentCaseId) return;
    try {
        const res = await fetch(`/api/cases/${currentCaseId}`);
        if (!res.ok) return;
        const caseData = await res.json();
        modalOriginalData = caseData;

        // ë¦¬ìŠ¤íŠ¸ë§Œ ê°±ì‹ 
        const escapeHtml = (text) => {
            if (!text) return '';
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return String(text).replace(/[&<>"']/g, m => map[m]);
        };

        const linksEl = document.getElementById('modalJiraLinksList');
        if (linksEl) {
            linksEl.innerHTML = (caseData.jira_links && caseData.jira_links.length > 0)
                ? caseData.jira_links.map((u) => `
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <a href="${escapeHtml(u)}" target="_blank" rel="noopener noreferrer" style="flex:1; color:#3498db; text-decoration:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">ğŸ”— ${escapeHtml(u)}</a>
                    </div>
                `).join('')
                : `<div style="color:#999; font-size:0.9rem;">ë“±ë¡ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        }

        const mediaEl = document.getElementById('modalCaseMediaList');
        if (mediaEl) {
            mediaEl.innerHTML = (caseData.media && caseData.media.length > 0)
                ? caseData.media.map((m) => `
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <a href="${escapeHtml(m.url)}" target="_blank" rel="noopener noreferrer"
                           style="flex:1; color:#3498db; text-decoration:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">ğŸ“ ${escapeHtml(m.original_name)}</a>
                        <button type="button" class="btn btn-secondary" style="padding:0.25rem 0.5rem;" onclick="deleteCaseMedia(${m.id})">ì‚­ì œ</button>
                    </div>
                `).join('')
                : `<div style="color:#999; font-size:0.9rem;">ë“±ë¡ëœ ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        }
    } catch (e) {
        // noop
    }
}

async function addCaseJiraLink() {
    const input = document.getElementById('modalJiraLinkInput');
    if (!input || !currentCaseId) return;
    const url = (input.value || '').trim();
    if (!url) return alert('ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    try {
        const res = await fetch(`/api/cases/${currentCaseId}/jira-links`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) return alert(data.error || 'ì €ì¥ ì‹¤íŒ¨');
        input.value = '';
        await refreshCaseLinksAndMedia();
    } catch (e) {
        alert('ì €ì¥ ì‹¤íŒ¨: ' + e);
    }
}

async function uploadCaseMedia() {
    const input = document.getElementById('modalCaseMediaInput');
    if (!input || !currentCaseId) return;
    const file = input.files && input.files[0];
    if (!file) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    const form = new FormData();
    form.append('file', file);
    try {
        const res = await fetch(`/api/cases/${currentCaseId}/media`, { method: 'POST', body: form });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) return alert(data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
        input.value = '';
        await refreshCaseLinksAndMedia();
    } catch (e) {
        alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e);
    }
}

async function deleteCaseMedia(mediaId) {
    if (!confirm('ì´ ë¯¸ë””ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        const res = await fetch(`/api/case-media/${mediaId}`, { method: 'DELETE' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) return alert(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
        await refreshCaseLinksAndMedia();
    } catch (e) {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + e);
    }
}

// ëª¨ë‹¬ ì–¸ì–´ í† ê¸€ í•¨ìˆ˜ ì œê±°ë¨ (ë²„íŠ¼ ì œê±°ë¡œ ì¸í•´ ë¶ˆí•„ìš”)

// ëª¨ë‹¬ ì½˜í…ì¸  í‘œì‹œ
function displayModalContent(caseData) {
    const modalTitle = document.getElementById('modalCaseTitle');
    const modalContent = document.getElementById('modalCaseContent');
    
    const escapeHtml = (text) => {
        if (!text) return '';
        const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
        return String(text).replace(/[&<>"']/g, m => map[m]);
    };
    
    // ì œëª©ë§Œ ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ ìš”ì†ŒëŠ” ìœ ì§€)
    const titleElement = document.getElementById('modalTitle');
    if (titleElement) {
        titleElement.textContent = caseData.title;
    }
    
    // ìŠ¤í…ê³¼ ê¸°ëŒ€ ê²°ê³¼ ì—…ë°ì´íŠ¸
    const stepsElement = document.getElementById('modalSteps');
    if (stepsElement) {
        stepsElement.textContent = caseData.steps || 'ìŠ¤í… ì •ë³´ ì—†ìŒ';
    }
    
    const expectedElement = document.getElementById('modalExpected');
    if (expectedElement) {
        expectedElement.textContent = caseData.expected_result || 'ê¸°ëŒ€ ê²°ê³¼ ì—†ìŒ';
    }
}

// ëª¨ë‹¬ í•„ë“œ ì—…ë°ì´íŠ¸
async function updateModalField(field, value) {
    if (!currentCaseId) return;
    
    try {
        const response = await fetch(`/api/cases/${currentCaseId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ [field]: value })
        });
        
        if (!response.ok) {
            throw new Error('ì €ì¥ ì‹¤íŒ¨');
        }
        
        const result = await response.json();
        
        // ë²ˆì—­ ê²½ê³ ê°€ ìˆìœ¼ë©´ í‘œì‹œ
        if (result.translation_warning) {
            console.warn('ë²ˆì—­ ê²½ê³ :', result.translation_warning);
            // ëª¨ë‹¬ ë‚´ì— ê²½ê³  í‘œì‹œ (ì„ íƒì )
            showTranslationWarning(result.translation_warning);
        }
        
        console.log('ì €ì¥ ì™„ë£Œ:', field, value);
        
        // í˜ì´ì§€ì˜ ì¼€ì´ìŠ¤ ëª©ë¡ë„ ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨ ì—†ì´)
        const caseItem = document.querySelector(`.case-item[data-case-id="${currentCaseId}"]`);
        if (caseItem && field === 'title') {
            const titleElement = caseItem.querySelector('.case-title');
            if (titleElement) {
                // ì›ë³¸ íƒ€ì´í‹€ë„ ê°±ì‹ 
                titleElement.dataset.baseTitle = value;
                restoreTitleStructure(titleElement, value);
            }
        }
        
    } catch (err) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', err);
        alert('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
    }
}

function closeCaseDetail() {
    const modal = document.getElementById('caseDetailModal');
    if (modal) {
        modal.classList.remove('show');
    }
    // ë²ˆì—­ ê²½ê³  ì œê±°
    const warningDiv = document.getElementById('translationWarning');
    if (warningDiv) {
        warningDiv.remove();
    }
}

function showTranslationWarning(message) {
    // ê¸°ì¡´ ê²½ê³  ì œê±°
    const existingWarning = document.getElementById('translationWarning');
    if (existingWarning) {
        existingWarning.remove();
    }
    
    // ìƒˆ ê²½ê³  í‘œì‹œ
    const modalBody = document.getElementById('modalCaseContent');
    if (modalBody) {
        const warningDiv = document.createElement('div');
        warningDiv.id = 'translationWarning';
        warningDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;';
        warningDiv.innerHTML = `
            <strong>âš ï¸ ë²ˆì—­ ê²½ê³ </strong><br>
            ${message}
        `;
        modalBody.insertBefore(warningDiv, modalBody.firstChild);
        
        // 5ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (warningDiv.parentNode) {
                warningDiv.remove();
            }
        }, 5000);
    }
}

// caseDetailModal: ëª¨ë‹¬ ì™¸ë¶€(ë°±ë“œë¡­) í´ë¦­ìœ¼ë¡œ ë‹«íˆì§€ ì•Šë„ë¡ í•¨
// (ë‹«ê¸°ëŠ” X ë²„íŠ¼ ë˜ëŠ” ESCë§Œ)

// ì–¸ì–´ ë³€ê²½
let currentLanguage = 'original';
const translationCache = {};
let translationBaseTitlesInitialized = false;

// CSV Export í•¨ìˆ˜
function exportSectionCasesCSV() {
    if (!currentSectionId) {
        alert('ì„¹ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const url = `/api/sections/${currentSectionId}/cases/export.csv`;
    window.location.href = url;
}

function initBaseTitlesIfNeeded() {
    if (translationBaseTitlesInitialized) return;
    document.querySelectorAll('.case-title').forEach(el => {
        const textSpan = el.querySelector('.case-title-text');
        const titleText = textSpan ? textSpan.textContent.trim() : el.textContent.trim();
        if (!el.dataset.baseTitle) {
            el.dataset.baseTitle = titleText;
        }
    });
    translationBaseTitlesInitialized = true;
}

function updateRetranslateButtonVisibility() {
    const btn = document.getElementById('retranslateBtn');
    if (!btn) return;
    btn.style.display = (currentLanguage === 'ko' || currentLanguage === 'en') ? 'inline-block' : 'none';
}

async function retranslateCurrentLanguage() {
    if (!(currentLanguage === 'ko' || currentLanguage === 'en')) return;
    const ok = confirm(`í˜„ì¬ ì–¸ì–´(${currentLanguage})ë¡œ ì¬ë²ˆì—­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- ê¸°ì¡´ ë²ˆì—­ ìºì‹œëŠ” ë¬´ì‹œ/ê°±ì‹ ë©ë‹ˆë‹¤.\n- ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    if (!ok) return;
    await changeLanguage(currentLanguage, { force: true });
}

async function changeLanguage(lang, options = {}) {
    currentLanguage = lang;
    const force = !!options.force;
    initBaseTitlesIfNeeded();
    updateRetranslateButtonVisibility();
    
    // ì„ íƒí•œ ì–¸ì–´ë¥¼ localStorageì— ì €ì¥ (ì›ë³¸ì€ ê¸°ë³¸ê°’ìœ¼ë¡œ ìœ ì§€)
    if (lang === 'original') {
        localStorage.setItem('preferredLanguage', 'original');
    } else {
        localStorage.setItem('preferredLanguage', lang);
    }

    // ì›ë³¸ì´ë©´ ì¦‰ì‹œ ë³µì› (API í˜¸ì¶œ ì—†ìŒ)
    if (lang === 'original') {
        const caseItems = Array.from(document.querySelectorAll('.case-item'));
        caseItems.forEach(item => {
            const titleEl = item.querySelector('.case-title');
            if (!titleEl) return;
            const baseTitle = titleEl.dataset.baseTitle;
            if (baseTitle) {
                restoreTitleStructure(titleEl, baseTitle);
            }
        });
        return;
    }
    
    // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
    showTranslationLoading();
    
    // ë²ˆì—­ í‘œì‹œ
    const caseItems = Array.from(document.querySelectorAll('.case-item'));
    const totalCases = caseItems.length;
    
    try {
        // ëª¨ë“  ì¼€ì´ìŠ¤ ID ìˆ˜ì§‘
        const caseIds = caseItems.map(item => parseInt(item.dataset.caseId)).filter(id => !isNaN(id));
        
        if (caseIds.length === 0) {
            hideTranslationLoading();
            return;
        }
        
        updateTranslationProgress(0, totalCases, 'ë²ˆì—­ ìš”ì²­ ì¤‘...');
        
        // ë°°ì¹˜ ë²ˆì—­ API í˜¸ì¶œ (force=trueë©´ ìºì‹œ ë¬´ì‹œ)
        const response = await fetch('/api/cases/translate-batch', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                case_ids: caseIds,
                target_lang: lang,
                force: force
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'ë²ˆì—­ ì‹¤íŒ¨');
        }
        
        const result = await response.json();
        
        updateTranslationProgress(totalCases / 2, totalCases, 'ë²ˆì—­ ì ìš© ì¤‘...');
        
        // ë²ˆì—­ ê²°ê³¼ë¥¼ ìºì‹œì— ì €ì¥í•˜ê³  í™”ë©´ì— í‘œì‹œ
        let appliedCount = 0;
        for (const translationResult of result.results) {
            const caseId = translationResult.case_id;
            const translation = translationResult.translation;
            
            if (translation) {
                // ìºì‹œì— ì €ì¥
                const cacheKey = `${caseId}-${lang}`;
                translationCache[cacheKey] = translation;
                
                // í™”ë©´ì— í‘œì‹œ
                const item = caseItems.find(el => parseInt(el.dataset.caseId) === caseId);
                if (item) {
                    const titleElement = item.querySelector('.case-title');
                    if (titleElement && translation.title) {
                        restoreTitleStructure(titleElement, translation.title);
                    }
                }
            }
            
            appliedCount++;
            updateTranslationProgress(totalCases / 2 + (appliedCount / result.results.length) * (totalCases / 2), totalCases, 'ë²ˆì—­ ì ìš© ì¤‘...');
        }
        
        console.log(`âœ… ë°°ì¹˜ ë²ˆì—­ ì™„ë£Œ: ì´ ${totalCases}ê°œ ì¼€ì´ìŠ¤ (ì‹ ê·œ ë²ˆì—­: ${result.translated_count}ê°œ, ìºì‹œ ì‚¬ìš©: ${result.cached_count}ê°œ, force=${force})`);
        
    } catch (error) {
        console.error('ë°°ì¹˜ ë²ˆì—­ ì‹¤íŒ¨:', error);
        alert(`âš ï¸ ë²ˆì—­ ì‹¤íŒ¨\n\n${error.message}\n\në²ˆì—­ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
    } finally {
        // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
        hideTranslationLoading();
    }
}

// ë²ˆì—­ ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
function showTranslationLoading() {
    let overlay = document.getElementById('translationLoadingOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'translationLoadingOverlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;
        
        overlay.innerHTML = `
            <div style="background: white; padding: 2rem 3rem; border-radius: 12px; text-align: center; min-width: 300px;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸŒ</div>
                <h3 style="margin: 0 0 1rem 0;">ë²ˆì—­ ì¤‘...</h3>
                <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="translationProgressBar" style="background: #4caf50; height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
    }
    overlay.style.display = 'flex';
}

// ë²ˆì—­ ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
function hideTranslationLoading() {
    const overlay = document.getElementById('translationLoadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// ë²ˆì—­ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
function updateTranslationProgress(current, total, message = null) {
    const progressBar = document.getElementById('translationProgressBar');
    
    if (progressBar) {
        const percentage = (current / total) * 100;
        progressBar.style.width = percentage + '%';
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™”

// í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ì¸¡ì • ì‹œì‘
let pageLoadStart = performance.now();
let domContentLoadedTime = 0;
let initialSetupTime = 0;

// í˜ì´ì§€ ë¡œë“œ ì‹œì‘ (ë¡œê·¸ ì œê±°)

// ë§ˆì§€ë§‰ ë°©ë¬¸ ì„¹ì…˜ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ìµœì´ˆ ì‹¤í–‰)
redirectToLastSection();

document.addEventListener('DOMContentLoaded', function() {
    domContentLoadedTime = performance.now();
    
    // ì„¹ì…˜ ë¡œë“œ ì‹œê°„ ì¸¡ì • ë° ì¶œë ¥ (DOMContentLoaded ì‹œì )
    const sectionLoadStart = sessionStorage.getItem('sectionLoadStart');
    if (sectionLoadStart) {
        const loadTime = Date.now() - parseFloat(sectionLoadStart);
        console.log(`â±ï¸ [ì„¹ì…˜ ë¡œë“œ - DOMContentLoaded] ${loadTime.toFixed(2)}ms`);
    }
    
    // ë¡œë”© í‘œì‹œ ì œê±°
    const caseList = document.getElementById('caseList');
    if (caseList) {
        caseList.classList.remove('loading');
    }
    
    // ì¦‰ì‹œ í•„ìš”í•œ ê²ƒë§Œ ì´ˆê¸°í™”
    applyViewMode();
    
    // ë‹¨ì¶•í‚¤ ê°€ì´ë“œ ì´ˆê¸°í™” (í¸ì§‘ëª¨ë“œê°€ ì•„ë‹ ë•Œë„ í‘œì‹œ, í† ê¸€ í‚¤ë§Œ)
    const shortcutGuide = document.getElementById('editModeShortcutGuide');
    if (shortcutGuide) {
        // í˜ì´ì§€ ë¡œë“œ ì‹œì—ëŠ” í•­ìƒ í¸ì§‘ëª¨ë“œê°€ ì•„ë‹ˆë¯€ë¡œ í† ê¸€ í‚¤ë§Œ í‘œì‹œ
        shortcutGuide.style.display = 'block';
        shortcutGuide.classList.remove('edit-mode-active');
        const shortcutItems = shortcutGuide.querySelectorAll('.shortcut-item');
        shortcutItems.forEach((item, index) => {
            if (index === 0) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
        console.log('ë‹¨ì¶•í‚¤ ê°€ì´ë“œ ì´ˆê¸°í™” ì™„ë£Œ (í† ê¸€ í‚¤ë§Œ í‘œì‹œ)');
    }
    
    // ê¸°ë³¸ê°’: ì›ë³¸ (ì„¹ì…˜ ì´ë™/ë¦¬ë¡œë“œ ì‹œ ìë™ ë²ˆì—­ ë¡œë”© ë°©ì§€)
    const langSelect = document.getElementById('languageSelect');
    if (langSelect) {
        langSelect.value = 'original';
    }
    localStorage.setItem('preferredLanguage', 'original');
    initBaseTitlesIfNeeded();
    currentLanguage = 'original';
    updateRetranslateButtonVisibility();
    
    // ì ‘íŒ ì„¹ì…˜ ë³µì›
    restoreCollapsedSections();
    
    // ë¬¸ì„œ í´ë¦­ ì‹œ ì„¹ì…˜ ë©”ë‰´ ë‹«ê¸°
    document.addEventListener('click', function(event) {
        // ë©”ë‰´ íŠ¸ë¦¬ê±°ë‚˜ ë©”ë‰´ ìì²´ë¥¼ í´ë¦­í•œ ê²½ìš°ê°€ ì•„ë‹ˆë©´ ëª¨ë“  ë©”ë‰´ ë‹«ê¸°
        if (!event.target.closest('.section-menu-trigger') && !event.target.closest('.section-context-menu') &&
            !event.target.closest('.case-menu-trigger') && !event.target.closest('.case-context-menu')) {
            closeAllSectionMenus();
        }
    });
    
    initialSetupTime = performance.now();
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const customAlertModal = document.getElementById('customAlertModal');
        const importModal = document.getElementById('importModal');
        const rootSectionModal = document.getElementById('rootSectionSelectorModal');
        
        if (event.target === customAlertModal) {
            closeCustomAlert();
        } else if (event.target === importModal) {
            closeImportModal();
        } else if (event.target === rootSectionModal) {
            closeRootSectionSelector();
        }
        // caseDetailModalì€ ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«íˆì§€ ì•ŠìŒ (ESC í‚¤ë¡œë§Œ ë‹«ê¸°)
    };
    
    // ESC í‚¤ë¡œ ì¼€ì´ìŠ¤ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const caseDetailModal = document.getElementById('caseDetailModal');
            if (caseDetailModal && caseDetailModal.classList.contains('show')) {
                closeCaseDetail();
            }
        }
    });
    
    // ë‚˜ë¨¸ì§€ëŠ” ì§€ì—° ì´ˆê¸°í™” (ì¦‰ì‹œ ì‹¤í–‰ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ)
    // requestIdleCallback ëŒ€ì‹  ì¦‰ì‹œ ì‹¤í–‰í•˜ì—¬ ì„¹ì…˜ ë¡œë“œ ì†ë„ í–¥ìƒ
    initDeferredFeatures();
});

function initDeferredFeatures() {
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™”
    initCaseSortable();
    
    // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ìµœì í™”)
    const caseListContainer = document.querySelector('.case-list');
    if (caseListContainer) {
        caseListContainer.addEventListener('change', function(e) {
            if (e.target.classList.contains('case-checkbox')) {
                handleCheckboxChange(e.target, e);
            }
        });
    }
    
    // ì´ˆê¸° í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
    updateSelectedItemsHighlight();
    
    // ì„¹ì…˜ ë¡œë“œ ì™„ë£Œ ì‹œê°„ ì¸¡ì • ë° ì¶œë ¥ (ëª¨ë“  ì´ˆê¸°í™” ì™„ë£Œ ì‹œì )
    const sectionLoadStart = sessionStorage.getItem('sectionLoadStart');
    if (sectionLoadStart) {
        const loadTime = Date.now() - parseFloat(sectionLoadStart);
        console.log(`âœ… [ì„¹ì…˜ ë¡œë“œ ì™„ë£Œ] ì´ ${loadTime.toFixed(2)}ms`);
        sessionStorage.removeItem('sectionLoadStart');
    }
    
    // ë¡œë”© í‘œì‹œ ì œê±°
    const caseList = document.getElementById('caseList');
    if (caseList) {
        caseList.classList.remove('loading');
    }
}

// ============================================================
// ì»¤ìŠ¤í…€ Alert í•¨ìˆ˜ (ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì—ëŸ¬ ë©”ì‹œì§€)
// ============================================================

function showCustomAlert(message, title = 'ì•Œë¦¼') {
    const modal = document.getElementById('customAlertModal');
    const titleElement = document.getElementById('customAlertTitle');
    const messageElement = document.getElementById('customAlertMessage');
    
    titleElement.textContent = title;
    messageElement.textContent = message;
    modal.style.display = 'block';
}

function closeCustomAlert() {
    document.getElementById('customAlertModal').style.display = 'none';
}

// ê¸°ì¡´ alert í•¨ìˆ˜ë¥¼ ì»¤ìŠ¤í…€ alertë¡œ ì˜¤ë²„ë¼ì´ë“œ
const originalAlert = window.alert;
window.alert = function(message) {
    // ì—ëŸ¬ ë©”ì‹œì§€ì¸ ê²½ìš° ì»¤ìŠ¤í…€ alert ì‚¬ìš©
    if (typeof message === 'string' && (message.includes('ì‹¤íŒ¨') || message.includes('ì˜¤ë¥˜') || message.includes('ì—ëŸ¬') || message.includes('Import'))) {
        showCustomAlert(message, message.includes('ì‹¤íŒ¨') || message.includes('ì˜¤ë¥˜') || message.includes('ì—ëŸ¬') ? 'âš ï¸ ì˜¤ë¥˜' : 'ì•Œë¦¼');
    } else {
        showCustomAlert(message);
    }
};

// ============================================================
// Import ê¸°ëŠ¥
// ============================================================

let importFileData = null;
let importPreviewData = null;
let selectedFile = null;
let allSectionsForImport = [];
let selectedRootSectionId = null;
let selectedRootSectionDepth = 0;

function openImportModal() {
    document.getElementById('importModal').style.display = 'block';
    document.getElementById('importStep1').style.display = 'block';
    document.getElementById('importStep2').style.display = 'none';
    document.getElementById('importStep3').style.display = 'none';
    document.getElementById('importStep4').style.display = 'none';
    
    importFileData = null;
    importPreviewData = null;
    selectedFile = null;

    // íŒŒì¼ ì„ íƒ UI ì´ˆê¸°í™” (ì¬ì˜¤í”ˆ ì‹œ ìœ ì§€ë˜ëŠ” ë²„ê·¸ ë°©ì§€)
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileInput = document.getElementById('fileInput');
    if (fileName) fileName.textContent = '';
    if (fileInfo) fileInfo.style.display = 'none';
    if (fileInput) fileInput.value = '';
    const sectionFullPreview = document.getElementById('sectionFullPreview');
    if (sectionFullPreview) sectionFullPreview.textContent = '';
    selectedRootSectionDepth = 0;
    applyImportSectionDepthConstraints();
    
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
    const dropZone = document.getElementById('dropZone');
    // fileInputì€ ìœ„ì—ì„œ ì´ë¯¸ ì°¸ì¡°
    
    dropZone.onclick = () => fileInput.click();
    
    dropZone.ondragover = (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#2980b9';
        dropZone.style.background = '#e3f2fd';
    };
    
    dropZone.ondragleave = () => {
        dropZone.style.borderColor = '#3498db';
        dropZone.style.background = '#f8f9fa';
    };
    
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#3498db';
        dropZone.style.background = '#f8f9fa';
        
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            handleFileSelect(e.dataTransfer.files[0]);
        }
    };
    
    fileInput.onchange = (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    };
}

function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
    importFileData = null;
    importPreviewData = null;
    selectedFile = null;
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileInput = document.getElementById('fileInput');
    if (fileName) fileName.textContent = '';
    if (fileInfo) fileInfo.style.display = 'none';
    if (fileInput) fileInput.value = '';
}

function closeImportModalAndReload() {
    closeImportModal();
    location.reload();
}

async function handleFileSelect(file) {
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    
    fileName.textContent = file.name;
    fileInfo.style.display = 'block';
    selectedFile = file;
    
    // íŒŒì¼ ì—…ë¡œë“œ ë° ì»¬ëŸ¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const res = await fetch(`/api/projects/${projectId}/cases/import/preview`, {
            method: 'POST',
            body: formData
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨');
        }
        
        const data = await res.json();
        importFileData = data;
        
        // Step 2ë¡œ ì´ë™ (ì»¬ëŸ¼ ë§¤í•‘)
        showColumnMapping(data);
        
    } catch (err) {
        alert('íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨: ' + err.message);
        console.error(err);
    }
}

function showColumnMapping(data) {
    document.getElementById('importStep1').style.display = 'none';
    document.getElementById('importStep2').style.display = 'block';
    
    // ì»¬ëŸ¼ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
    const selects = [
        'mapTitle', 'mapPriority', 'mapSteps', 'mapExpectedResult',
        'mapSectionFull', 'mapSection1', 'mapSection2', 'mapSection3', 'mapSection4',
        'mapJiraLinks', 'mapMedia'
    ];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        const isRequired = selectId === 'mapTitle';
        select.innerHTML = isRequired 
            ? '<option value="">-- ì»¬ëŸ¼ ì„ íƒ --</option>'
            : '<option value="">-- ì»¬ëŸ¼ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>';
        
        data.columns.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = col;
            select.appendChild(option);
        });
        
        // ìë™ ë§¤í•‘ ì‹œë„
        const colLower = data.columns.map(c => c.toLowerCase());
        if (selectId === 'mapTitle' && colLower.includes('title')) {
            select.value = data.columns[colLower.indexOf('title')];
        } else if (selectId === 'mapPriority' && colLower.includes('priority')) {
            select.value = data.columns[colLower.indexOf('priority')];
        } else if (selectId === 'mapSteps' && colLower.includes('steps')) {
            select.value = data.columns[colLower.indexOf('steps')];
        } else if (selectId === 'mapExpectedResult' && colLower.includes('expected_result')) {
            select.value = data.columns[colLower.indexOf('expected_result')];
        } else if (selectId === 'mapSection1' && (colLower.includes('section_1') || colLower.includes('section1'))) {
            const idx = colLower.indexOf('section_1') >= 0 ? colLower.indexOf('section_1') : colLower.indexOf('section1');
            select.value = data.columns[idx];
        } else if (selectId === 'mapSection2' && (colLower.includes('section_2') || colLower.includes('section2'))) {
            const idx = colLower.indexOf('section_2') >= 0 ? colLower.indexOf('section_2') : colLower.indexOf('section2');
            select.value = data.columns[idx];
        } else if (selectId === 'mapSection3' && (colLower.includes('section_3') || colLower.includes('section3'))) {
            const idx = colLower.indexOf('section_3') >= 0 ? colLower.indexOf('section_3') : colLower.indexOf('section3');
            select.value = data.columns[idx];
        } else if (selectId === 'mapSection4' && (colLower.includes('section_4') || colLower.includes('section4'))) {
            const idx = colLower.indexOf('section_4') >= 0 ? colLower.indexOf('section_4') : colLower.indexOf('section4');
            select.value = data.columns[idx];
        } else if (selectId === 'mapSectionFull' && (colLower.includes('section') || colLower.includes('section_path') || colLower.includes('section full') || colLower.includes('section_full'))) {
            const candidates = ['section_full', 'section full', 'section_path', 'section path', 'section'];
            const found = candidates.map(x => colLower.indexOf(x)).find(i => i >= 0);
            if (found !== undefined) select.value = data.columns[found];
        } else if (selectId === 'mapJiraLinks' && (colLower.includes('jira_links') || colLower.includes('jira links') || colLower.includes('jira'))) {
            const candidates = ['jira_links', 'jira links', 'jira'];
            const found = candidates.map(x => colLower.indexOf(x)).find(i => i >= 0);
            if (found !== undefined) select.value = data.columns[found];
        } else if (selectId === 'mapMedia' && (colLower.includes('media') || colLower.includes('attachments') || colLower.includes('attachment') || colLower.includes('image') || colLower.includes('video'))) {
            const candidates = ['media', 'attachments', 'attachment', 'image', 'video'];
            const found = candidates.map(x => colLower.indexOf(x)).find(i => i >= 0);
            if (found !== undefined) select.value = data.columns[found];
        }
    });

    onSectionFullMappingChanged();
    applyImportSectionDepthConstraints();
    
    // ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ
    const samplePreview = document.getElementById('sampleDataPreview');
    let tableHtml = '<table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;"><thead><tr>';
    
    data.columns.forEach(col => {
        tableHtml += `<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: left;">${col}</th>`;
    });
    tableHtml += '</tr></thead><tbody>';
    
    data.sample_data.forEach(row => {
        tableHtml += '<tr>';
        data.columns.forEach(col => {
            const val = row[col] || '-';
            const truncated = val.length > 30 ? val.substring(0, 30) + '...' : val;
            tableHtml += `<td style="padding: 0.5rem; border: 1px solid #ddd;">${truncated}</td>`;
        });
        tableHtml += '</tr>';
    });
    
    tableHtml += '</tbody></table>';
    samplePreview.innerHTML = tableHtml;
}

async function proceedToPreview() {
    // ì»¬ëŸ¼ ë§¤í•‘ ìˆ˜ì§‘
    const columnMapping = {
        title: document.getElementById('mapTitle').value,
        priority: document.getElementById('mapPriority').value,
        steps: document.getElementById('mapSteps').value,
        expected_result: document.getElementById('mapExpectedResult').value,
        section_full: document.getElementById('mapSectionFull').value,
        section_1: document.getElementById('mapSection1').value,
        section_2: document.getElementById('mapSection2').value,
        section_3: document.getElementById('mapSection3').value,
        section_4: document.getElementById('mapSection4').value,
        jira_links: document.getElementById('mapJiraLinks').value,
        media: document.getElementById('mapMedia').value
    };
    
    // í•„ìˆ˜ í•„ë“œ í™•ì¸
    if (!columnMapping.title) {
        alert('ì œëª©(Title) ì»¬ëŸ¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
    }
    
    // ì„¹ì…˜ í•„ë“œ í™•ì¸
    const hasSectionMapping = columnMapping.section_full || columnMapping.section_1 || columnMapping.section_2 ||
                              columnMapping.section_3 || columnMapping.section_4;
    
    if (!hasSectionMapping) {
        alert('ìµœì†Œ 1ê°œì˜ ì„¹ì…˜ ì»¬ëŸ¼ì„ ë§¤í•‘í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // íŒŒì¼ê³¼ ë§¤í•‘ ì •ë³´ ì „ì†¡
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('column_mapping', JSON.stringify(columnMapping));
    
    try {
        const res = await fetch(`/api/projects/${projectId}/cases/import/parse`, {
            method: 'POST',
            body: formData
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨');
        }
        
        const data = await res.json();
        importPreviewData = data;
        
        // Step 3ë¡œ ì´ë™ (ë¯¸ë¦¬ë³´ê¸°)
        showFinalPreview(data);
        
    } catch (err) {
        alert('ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨: ' + err.message);
        console.error(err);
    }
}

function showFinalPreview(data) {
    document.getElementById('importStep2').style.display = 'none';
    document.getElementById('importStep3').style.display = 'block';
    
    // ìš”ì•½ ì •ë³´
    const summary = document.getElementById('previewSummary');
    summary.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
            <div>
                <strong>ì´ í–‰ ìˆ˜:</strong> ${data.total_rows}
            </div>
            <div style="color: #27ae60;">
                <strong>ìœ íš¨ ì¼€ì´ìŠ¤:</strong> ${data.valid_cases}
            </div>
            <div style="color: #e74c3c;">
                <strong>ê±´ë„ˆë›´ í–‰:</strong> ${data.skipped_rows}
            </div>
            <div style="color: #3498db;">
                <strong>ìƒì„±ë  ì„¹ì…˜:</strong> ${data.section_names.length}ê°œ
            </div>
        </div>
    `;
    
    // í…Œì´ë¸” ì±„ìš°ê¸°
    const tbody = document.getElementById('previewTableBody');
    tbody.innerHTML = '';
    
    data.cases.forEach(caseData => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #eee';
        
        const truncate = (text, maxLen = 50) => {
            if (!text) return '-';
            return text.length > maxLen ? text.substring(0, maxLen) + '...' : text;
        };
        
        // ì„¹ì…˜ ê²½ë¡œ ìƒì„±
        const sectionPath = [
            caseData.section_1,
            caseData.section_2,
            caseData.section_3,
            caseData.section_4
        ].filter(s => s).join(' > ');
        
        row.innerHTML = `
            <td style="padding: 0.75rem;">${caseData.row_number}</td>
            <td style="padding: 0.75rem; color: #666; font-size: 0.85rem;">${sectionPath}</td>
            <td style="padding: 0.75rem; font-weight: 500;">${truncate(caseData.title, 60)}</td>
            <td style="padding: 0.75rem;">
                <span class="priority-badge priority-${caseData.priority}">${caseData.priority}</span>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function backToStep1() {
    document.getElementById('importStep1').style.display = 'block';
    document.getElementById('importStep2').style.display = 'none';
}

function backToStep2() {
    document.getElementById('importStep2').style.display = 'block';
    document.getElementById('importStep3').style.display = 'none';
}

async function confirmImport() {
    if (!importPreviewData || !importPreviewData.cases) {
        alert('Importí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ìµœìƒìœ„ ì„¹ì…˜ì´ ì„ íƒë˜ì—ˆìœ¼ë©´ ëª¨ë“  ì¼€ì´ìŠ¤ì˜ ì„¹ì…˜ ì •ë³´ ì•ì— ì¶”ê°€
    const rootSectionId = document.getElementById('selectedRootSectionId').value;
    let casesData = importPreviewData.cases;
    
    if (rootSectionId) {
        // ìµœìƒìœ„ ì„¹ì…˜ì˜ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
        const rootSection = allSectionsForImport.find(s => s.id == rootSectionId);
        if (rootSection) {
            const rootPath = getRootSectionPath(rootSection);
            
            // ëª¨ë“  ì¼€ì´ìŠ¤ì˜ ì„¹ì…˜ ì •ë³´ ì•ì— ìµœìƒìœ„ ì„¹ì…˜ ê²½ë¡œ ì¶”ê°€
            casesData = importPreviewData.cases.map(caseData => {
                const newCase = {...caseData};
                
                // ê¸°ì¡´ ì„¹ì…˜ ì •ë³´ë¥¼ ë’¤ë¡œ ë°€ê¸°
                for (let i = 4; i >= 1; i--) {
                    if (i <= 4 - rootPath.length) {
                        newCase[`section_${i + rootPath.length}`] = caseData[`section_${i}`] || '';
                    }
                }
                
                // ìµœìƒìœ„ ì„¹ì…˜ ê²½ë¡œ ì¶”ê°€
                rootPath.forEach((sectionName, idx) => {
                    newCase[`section_${idx + 1}`] = sectionName;
                });
                
                return newCase;
            });
        }
    }
    
    try {
        const res = await fetch(`/api/projects/${projectId}/cases/import/confirm`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                cases: casesData
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'Import ì‹¤íŒ¨');
        }
        
        const result = await res.json();
        
        // Step 4ë¡œ ì´ë™
        document.getElementById('importStep3').style.display = 'none';
        document.getElementById('importStep4').style.display = 'block';
        document.getElementById('importResultMessage').textContent = 
            `${result.created_count}ê°œì˜ ì¼€ì´ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\n` +
            `(${result.created_sections}ê°œì˜ ì„¹ì…˜ ìƒì„± ë˜ëŠ” ì‚¬ìš©)`;
        
    } catch (err) {
        alert('Import ì‹¤íŒ¨: ' + err.message);
        console.error(err);
    }
}

// ì„¹ì…˜ ì„ íƒ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
async function openRootSectionSelector() {
    document.getElementById('rootSectionSelectorModal').style.display = 'block';
    
    // ì„¹ì…˜ ëª©ë¡ ë¡œë“œ
    if (allSectionsForImport.length === 0) {
        try {
            const res = await fetch(`/api/projects/${projectId}/sections`);
            allSectionsForImport = await res.json();
        } catch (err) {
            console.error('ì„¹ì…˜ ë¡œë“œ ì‹¤íŒ¨:', err);
            alert('ì„¹ì…˜ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
            return;
        }
    }
    
    renderRootSectionList();
}

function closeRootSectionSelector() {
    document.getElementById('rootSectionSelectorModal').style.display = 'none';
}

function renderRootSectionList(searchTerm = '') {
    const container = document.getElementById('rootSectionList');
    container.innerHTML = '';
    
    // ì„¹ì…˜ ê³„ì¸µ êµ¬ì¡° ë¹Œë“œ
    const buildSectionTree = (sections, parentId = null, depth = 0) => {
        const filtered = sections.filter(s => s.parent_id === parentId);
        
        filtered.forEach(section => {
            const searchLower = searchTerm.toLowerCase();
            const nameMatch = section.name.toLowerCase().includes(searchLower);
            
            if (!searchTerm || nameMatch) {
                const item = document.createElement('div');
                item.className = 'section-list-item';
                item.style.paddingLeft = `${depth * 1.5 + 0.5}rem`;
                item.onclick = () => selectRootSection(section);
                
                const icon = depth === 0 ? 'ğŸ“‚' : 'ğŸ“„';
                
                item.innerHTML = `
                    <span>${icon}</span>
                    <span>${section.name}</span>
                `;
                
                container.appendChild(item);
            }
            
            // ìì‹ ì„¹ì…˜ ì¬ê·€ ë Œë”ë§
            buildSectionTree(sections, section.id, depth + 1);
        });
    };
    
    buildSectionTree(allSectionsForImport);
    
    if (container.children.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">ì„¹ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
}

function filterSections() {
    const searchTerm = document.getElementById('sectionSearchInput').value;
    renderRootSectionList(searchTerm);
}

function selectRootSection(section) {
    document.getElementById('selectedRootSectionId').value = section.id;
    
    // ì„¹ì…˜ ê²½ë¡œ í‘œì‹œ
    const path = getRootSectionPath(section);
    document.getElementById('selectedRootSectionName').value = path.join(' > ');
    selectedRootSectionDepth = path.length;
    applyImportSectionDepthConstraints();
    
    closeRootSectionSelector();
}

function getRootSectionPath(section) {
    const path = [section.name];
    let current = section;
    
    while (current.parent_id) {
        const parent = allSectionsForImport.find(s => s.id === current.parent_id);
        if (parent) {
            path.unshift(parent.name);
            current = parent;
        } else {
            break;
        }
    }
    
    return path;
}

function clearRootSection() {
    document.getElementById('selectedRootSectionId').value = '';
    document.getElementById('selectedRootSectionName').value = '';
    selectedRootSectionDepth = 0;
    applyImportSectionDepthConstraints();
}

function applyImportSectionDepthConstraints() {
    // root depthì— ë”°ë¼ fileì—ì„œ ë§¤í•‘ ê°€ëŠ¥í•œ ì„¹ì…˜ ë ˆë²¨ ìˆ˜ ì œí•œ
    const maxLevels = Math.max(0, 4 - (selectedRootSectionDepth || 0)); // ì˜ˆ: rootDepth=2 -> 2ë ˆë²¨ë§Œ í—ˆìš©
    const ids = ['mapSection1', 'mapSection2', 'mapSection3', 'mapSection4'];
    ids.forEach((id, idx) => {
        const el = document.getElementById(id);
        if (!el) return;
        const enable = (idx + 1) <= maxLevels;
        el.disabled = !enable;
        if (!enable) el.value = '';
    });
}

function onSectionFullMappingChanged() {
    const fullSel = document.getElementById('mapSectionFull');
    const fullCol = fullSel ? fullSel.value : '';
    const depthSelects = ['mapSection1', 'mapSection2', 'mapSection3', 'mapSection4'].map(id => document.getElementById(id)).filter(Boolean);
    const previewEl = document.getElementById('sectionFullPreview');

    if (fullCol) {
        depthSelects.forEach(s => { s.value = ''; s.disabled = true; });

        // ìƒ˜í”Œ 5í–‰ ê¸°ì¤€ìœ¼ë¡œ ë¶„í•´ í”„ë¦¬ë·°
        try {
            const rows = (importFileData && importFileData.sample_data) ? importFileData.sample_data : [];
            const samples = rows.slice(0, 5).map(r => {
                const raw = (r[fullCol] || '').toString();
                const parts = raw.split('>').map(x => x.trim()).filter(Boolean).slice(0, 4);
                return parts.join(' > ') || '(ë¹ˆ ê°’)';
            });
            if (previewEl) previewEl.textContent = samples.length ? `í”„ë¦¬ë·°: ${samples.join(' / ')}` : '';
        } catch (e) {
            if (previewEl) previewEl.textContent = '';
        }
    } else {
        // ì„¹ì…˜ ì „ì²´ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ depth ì œì•½ë§Œ ì ìš©
        depthSelects.forEach(s => { s.disabled = false; });
        applyImportSectionDepthConstraints();
        if (previewEl) previewEl.textContent = '';
    }
}
</script>

<!-- í¸ì§‘ ëª¨ë“œ ë‹¨ì¶•í‚¤ ê°€ì´ë“œ -->
<div id="editModeShortcutGuide">
    <div class="shortcut-content">
        <h4>
            <span class="shortcut-toggle-header">
                <span>âŒ¨ï¸ í¸ì§‘ ëª¨ë“œ ë‹¨ì¶•í‚¤</span>
                <button class="shortcut-collapse-btn" onclick="toggleShortcutGuide()" title="ì ‘ê¸°">âˆ’</button>
            </span>
        </h4>
        <div class="shortcut-item">
            <span class="shortcut-desc">í¸ì§‘ ëª¨ë“œ í† ê¸€</span>
            <span class="shortcut-key">Ctrl + E</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">ì¼€ì´ìŠ¤ ì´ë™</span>
            <span class="shortcut-key">â†‘ / â†“</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">í¸ì§‘ ì‹œì‘</span>
            <span class="shortcut-key">Enter / F2</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">í¸ì§‘ ì €ì¥</span>
            <span class="shortcut-key">Enter</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">í¸ì§‘ ì·¨ì†Œ</span>
            <span class="shortcut-key">Esc</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">ìœ„ì— ì¼€ì´ìŠ¤ ì¶”ê°€</span>
            <span class="shortcut-key">Ctrl + â†‘</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">ì•„ë˜ì— ì¼€ì´ìŠ¤ ì¶”ê°€</span>
            <span class="shortcut-key">Ctrl + â†“</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">ìƒì„¸ í¸ì§‘</span>
            <span class="shortcut-key">F4</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">ì¼€ì´ìŠ¤ ë³µì œ</span>
            <span class="shortcut-key">Ctrl + D</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">ì¼€ì´ìŠ¤ ì‚­ì œ</span>
            <span class="shortcut-key">Ctrl + Del</span>
        </div>
    </div>
    <button class="shortcut-toggle-btn" onclick="toggleShortcutGuide()" title="í¼ì¹˜ê¸°">+</button>
</div>

{% endblock %}


