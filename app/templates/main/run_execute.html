{% extends "base.html" %}

{% block title %}{{ run.name }} - ì‹¤í–‰{% endblock %}

{% block extra_css %}
<style>
    .run-execute-layout {
        display: flex;
        gap: 0;
        height: calc(100vh - 150px);
        position: relative;
    }
    
    .run-cases-sidebar {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        overflow-y: auto;
        min-width: 300px;
        max-width: 800px;
        flex-shrink: 0;
    }
    
    .resizer {
        width: 5px;
        background: #e0e0e0;
        cursor: col-resize;
        position: relative;
        flex-shrink: 0;
        transition: background 0.2s;
    }
    
    .resizer:hover {
        background: #3498db;
    }
    
    .resizer::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 40px;
        background: transparent;
    }
    
    .run-case-item {
        padding: 0.75rem;
        margin: 0.5rem 0;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
    }
    
    .run-case-item:hover {
        background: #f5f5f5;
    }
    
    .run-case-item.active {
        border-color: #3498db;
        background: #ebf5fb;
    }
    
    .run-case-item.status-pass {
        border-left: 4px solid #27ae60;
    }
    
    .run-case-item.status-fail {
        border-left: 4px solid #e74c3c;
    }
    
    .run-case-item.status-blocked {
        border-left: 4px solid #95a5a6;
    }
    
    .run-case-item.status-retest {
        border-left: 4px solid #f39c12;
    }
    
    .run-case-item.status-na {
        border-left: 4px solid #bdc3c7;
    }
    
    .case-detail-panel {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
        min-width: 400px;
    }
    
    .status-buttons {
        display: flex;
        gap: 1rem;
        margin: 1.5rem 0;
        flex-wrap: wrap;
    }
    
    .status-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        background: white;
    }
    
    .status-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .status-btn.pass {
        border-color: #27ae60;
        color: #27ae60;
    }
    
    .status-btn.pass:hover {
        background: #27ae60;
        color: white;
    }
    
    .status-btn.fail {
        border-color: #e74c3c;
        color: #e74c3c;
    }
    
    .status-btn.fail:hover {
        background: #e74c3c;
        color: white;
    }
    
    .status-btn.blocked {
        border-color: #95a5a6;
        color: #95a5a6;
    }
    
    .status-btn.blocked:hover {
        background: #95a5a6;
        color: white;
    }
    
    .status-btn.retest {
        border-color: #f39c12;
        color: #f39c12;
    }
    
    .status-btn.retest:hover {
        background: #f39c12;
        color: white;
    }
    
    .status-btn.na {
        border-color: #bdc3c7;
        color: #7f8c8d;
    }
    
    .status-btn.na:hover {
        background: #bdc3c7;
        color: white;
    }
    
    .comment-section {
        display: none;
        margin-top: 1rem;
    }
    
    .comment-section.show {
        display: block;
    }
    
    .stats-bar {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-around;
        text-align: center;
    }
    
    .stat-item {
        flex: 1;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #666;
    }
    
    .hotkey-hint {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        max-width: 250px;
        z-index: 1000;
    }
    
    .hotkey-hint.hidden {
        display: none;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
    
    .refresh-indicator {
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(39, 174, 96, 0.9);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        z-index: 999;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .refresh-indicator.active {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <h2>{{ run.name }}</h2>
    <p style="color: #666;">{{ run.description }}</p>
</div>

<!-- ì‹¤ì‹œê°„ ìƒˆë¡œê³ ì¹¨ ì¸ë””ì¼€ì´í„° -->
<div class="refresh-indicator active" id="refreshIndicator">
    ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘ (5ì´ˆ)
</div>

<!-- í†µê³„ ë°” -->
<div class="stats-bar">
    <div class="stat-item">
        <div class="stat-value" id="statProgress" style="color: #3498db;">{{ stats.progress }}%</div>
        <div class="stat-label">ì§„í–‰ë¥ </div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="statExecuted">{{ stats.executed }} / {{ stats.total }}</div>
        <div class="stat-label">ì‹¤í–‰</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="statPass" style="color: #27ae60;">{{ stats.pass }}</div>
        <div class="stat-label">Pass</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="statFail" style="color: #e74c3c;">{{ stats.fail }}</div>
        <div class="stat-label">Fail</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="statBlocked" style="color: #95a5a6;">{{ stats.blocked }}</div>
        <div class="stat-label">Blocked</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="statRetest" style="color: #f39c12;">{{ stats.retest }}</div>
        <div class="stat-label">Retest</div>
    </div>
</div>

<div class="run-execute-layout">
    <!-- ì¢Œì¸¡: RunCase ëª©ë¡ -->
    <div class="run-cases-sidebar" id="runCasesSidebar">
        <h4 style="margin-bottom: 1rem;">ì¼€ì´ìŠ¤ ëª©ë¡</h4>
        {% for item in run_cases %}
        <div class="run-case-item {% if item.result %}status-{{ item.result.status }}{% endif %} {% if loop.index0 == 0 %}active{% endif %}" 
             data-case-id="{{ item.case.id }}"
             onclick="selectCase({{ loop.index0 }})">
            <div style="font-weight: 500; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                 title="{{ item.case.title }}">
                #{{ item.case.id }} {{ item.case.title }}
            </div>
            <div style="font-size: 0.85rem; color: #666;">
                {% if item.result %}
                    <span style="color: {% if item.result.status == 'pass' %}#27ae60{% elif item.result.status == 'fail' %}#e74c3c{% else %}#95a5a6{% endif %};">
                        {{ item.result.status|upper }}
                    </span>
                {% else %}
                    <span style="color: #999;">ë¯¸ì‹¤í–‰</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- ë¦¬ì‚¬ì´ì € -->
    <div class="resizer" id="resizer"></div>
    
    <!-- ìš°ì¸¡: ì¼€ì´ìŠ¤ ìƒì„¸ + ê²°ê³¼ ì…ë ¥ -->
    <div class="case-detail-panel" id="caseDetailPanel">
        <div id="caseContent">
            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
        </div>
    </div>
</div>

<!-- í•«í‚¤ íŒíŠ¸ -->
<div class="hotkey-hint" id="hotkeyHint">
    <strong>âŒ¨ï¸ ë‹¨ì¶•í‚¤</strong><br>
    <kbd>1</kbd> Pass<br>
    <kbd>2</kbd> Fail<br>
    <kbd>3</kbd> Blocked<br>
    <kbd>4</kbd> Retest<br>
    <kbd>5</kbd> N/A<br>
    <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid rgba(255,255,255,0.3);">
    <kbd>n</kbd> ë‹¤ìŒ ë¯¸ì‹¤í–‰<br>
    <kbd>p</kbd> ì´ì „ ë¯¸ì‹¤í–‰<br>
    <kbd>j/k</kbd> ë‹¤ìŒ/ì´ì „<br>
    <kbd>g</kbd> ì²« ì¼€ì´ìŠ¤<br>
    <kbd>G</kbd> ë§ˆì§€ë§‰ ì¼€ì´ìŠ¤<br>
    <kbd>c</kbd> ì½”ë©˜íŠ¸ í¬ì»¤ìŠ¤<br>
    <kbd>r</kbd> ëŸ° í†µê³„ ìƒˆë¡œê³ ì¹¨<br>
    <kbd>?</kbd> íŒíŠ¸ í† ê¸€<br>
    <kbd>Esc</kbd> ì½”ë©˜íŠ¸ ë‹«ê¸°
</div>

<script>
const runId = {{ run.id }};
let runCases = {{ run_cases | tojson }};
let currentIndex = 0;
let autoRefreshInterval = null;
let isRefreshing = false;

// ì´ˆê¸° ì¼€ì´ìŠ¤ ë¡œë“œ
window.onload = function() {
    loadCase(0);
    startAutoRefresh();
    initResizer();
    loadSidebarWidth();
};

function selectCase(index) {
    currentIndex = index;
    loadCase(index);
    
    // ì‚¬ì´ë“œë°” í™œì„±í™” í‘œì‹œ
    document.querySelectorAll('.run-case-item').forEach((item, i) => {
        if (i === index) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}

function loadCase(index) {
    const item = runCases[index];
    const caseData = item.case;
    const result = item.result;
    
    const html = `
        <div style="margin-bottom: 1.5rem;">
            <h3 contenteditable="true" id="caseTitle" 
                style="border: 1px solid transparent; padding: 0.5rem; border-radius: 4px; outline: none;" 
                onblur="updateCaseField('title', this.textContent.trim())"
                onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                onblur="this.style.border='1px solid transparent'; this.style.background='transparent';">
${escapeHtml(caseData.title)}</h3>
            <small style="color: #999;">ğŸ’¡ í´ë¦­í•˜ì—¬ í¸ì§‘ ê°€ëŠ¥</small>
        </div>
        
        <div style="margin: 1rem 0; padding: 1rem; background: #f9f9f9; border-radius: 4px;">
            <strong>ìš°ì„ ìˆœìœ„:</strong> 
            <select id="casePriority" class="form-control" style="display: inline-block; width: auto; margin-left: 0.5rem;" 
                    onchange="updateCaseField('priority', this.value)">
                <option value="P0" ${caseData.priority === 'P0' ? 'selected' : ''}>P0</option>
                <option value="P1" ${caseData.priority === 'P1' ? 'selected' : ''}>P1</option>
                <option value="P2" ${caseData.priority === 'P2' ? 'selected' : ''}>P2</option>
                <option value="P3" ${caseData.priority === 'P3' ? 'selected' : ''}>P3</option>
            </select>
        </div>
        
        <div style="margin: 1.5rem 0;">
            <h4>í…ŒìŠ¤íŠ¸ ìŠ¤í… <small style="color: #999; font-weight: normal;">ğŸ’¡ í´ë¦­í•˜ì—¬ í¸ì§‘ ê°€ëŠ¥</small></h4>
            <div contenteditable="true" id="caseSteps" 
                 style="white-space: pre-wrap; padding: 1rem; background: #f9f9f9; border-radius: 4px; border: 1px solid transparent; min-height: 100px; outline: none;"
                 onblur="updateCaseField('steps', this.textContent.trim())"
                 onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                 onblur="this.style.border='1px solid transparent'; this.style.background='#f9f9f9';">${escapeHtml(caseData.steps) || 'ìŠ¤í… ì •ë³´ ì—†ìŒ'}</div>
        </div>
        
        <div style="margin: 1.5rem 0;">
            <h4>ê¸°ëŒ€ ê²°ê³¼ <small style="color: #999; font-weight: normal;">ğŸ’¡ í´ë¦­í•˜ì—¬ í¸ì§‘ ê°€ëŠ¥</small></h4>
            <div contenteditable="true" id="caseExpected" 
                 style="white-space: pre-wrap; padding: 1rem; background: #f9f9f9; border-radius: 4px; border: 1px solid transparent; min-height: 100px; outline: none;"
                 onblur="updateCaseField('expected_result', this.textContent.trim())"
                 onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                 onblur="this.style.border='1px solid transparent'; this.style.background='#f9f9f9';">${escapeHtml(caseData.expected) || 'ê¸°ëŒ€ ê²°ê³¼ ì •ë³´ ì—†ìŒ'}</div>
        </div>
        
        <hr style="margin: 2rem 0;">
        
        <h4>ê²°ê³¼ ê¸°ë¡</h4>
        
        <div class="status-buttons">
            <button class="status-btn pass" onclick="recordResult('pass')">
                <kbd>1</kbd> Pass
            </button>
            <button class="status-btn fail" onclick="recordResult('fail')">
                <kbd>2</kbd> Fail
            </button>
            <button class="status-btn blocked" onclick="recordResult('blocked')">
                <kbd>3</kbd> Blocked
            </button>
            <button class="status-btn retest" onclick="recordResult('retest')">
                <kbd>4</kbd> Retest
            </button>
            <button class="status-btn na" onclick="recordResult('na')">
                <kbd>5</kbd> N/A
            </button>
        </div>
        
        <div class="comment-section" id="commentSection">
            <label class="form-label">ì½”ë©˜íŠ¸ ${result && result.status === 'fail' ? '(í•„ìˆ˜)' : '(ì„ íƒ)'}</label>
            <textarea id="commentInput" class="form-control" placeholder="ê²°ê³¼ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <button class="btn btn-success" style="margin-top: 0.5rem;" onclick="saveComment()">ì €ì¥</button>
        </div>
        
        ${result ? `
            <hr style="margin: 2rem 0;">
            <h4>í˜„ì¬ ìƒíƒœ</h4>
            <div style="padding: 1rem; background: #e8f5e9; border-radius: 4px; margin: 1rem 0;">
                <strong>ìƒíƒœ:</strong> ${result.status.toUpperCase()}<br>
                <strong>ì‹¤í–‰ì:</strong> ${result.executor}<br>
                <strong>ì‹œê°„:</strong> ${new Date(result.created_at).toLocaleString('ko-KR')}<br>
                ${result.comment ? `<strong>ì½”ë©˜íŠ¸:</strong> ${result.comment}` : ''}
            </div>
        ` : ''}
    `;
    
    document.getElementById('caseContent').innerHTML = html;
}

let pendingStatus = null;

function recordResult(status) {
    const caseData = runCases[currentIndex].case;
    
    // Failì¸ ê²½ìš° ì½”ë©˜íŠ¸ ì…ë ¥ ì˜ì—­ í‘œì‹œ
    if (status === 'fail') {
        const commentSection = document.getElementById('commentSection');
        commentSection.classList.add('show');
        document.getElementById('commentInput').focus();
        pendingStatus = status;
        return;
    }
    
    // ì¦‰ì‹œ ì €ì¥
    saveResult(caseData.id, status, '');
}

function saveComment() {
    const comment = document.getElementById('commentInput').value;
    const caseData = runCases[currentIndex].case;
    
    if (pendingStatus === 'fail' && !comment.trim()) {
        alert('Fail ìƒíƒœëŠ” ì½”ë©˜íŠ¸ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
    }
    
    saveResult(caseData.id, pendingStatus || 'pass', comment);
}

function saveResult(caseId, status, comment) {
    fetch(`/api/runs/${runId}/results`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            case_id: caseId,
            status: status,
            comment: comment
        })
    })
    .then(res => res.json())
    .then(data => {
        // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
        runCases[currentIndex].result = {
            id: data.id,
            status: status,
            comment: comment,
            executor: '{{ current_user.name }}',
            created_at: data.created_at
        };
        
        // ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        const sidebarItem = document.querySelectorAll('.run-case-item')[currentIndex];
        sidebarItem.classList.remove('status-pass', 'status-fail', 'status-blocked', 'status-retest', 'status-na');
        sidebarItem.classList.add(`status-${status}`);
        sidebarItem.querySelector('span[style*="color"]').style.color = getStatusColor(status);
        sidebarItem.querySelector('span[style*="color"]').textContent = status.toUpperCase();
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        updateRunStats();
        
        // ë‹¤ìŒ ë¯¸ì‹¤í–‰ ì¼€ì´ìŠ¤ë¡œ ì´ë™
        goToNextUnexecuted();
    })
    .catch(err => {
        console.error('ê²°ê³¼ ì €ì¥ ì˜¤ë¥˜:', err);
        alert('ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨: ' + err);
    });
    
    pendingStatus = null;
}

function getStatusColor(status) {
    const colors = {
        'pass': '#27ae60',
        'fail': '#e74c3c',
        'blocked': '#95a5a6',
        'retest': '#f39c12',
        'na': '#95a5a6'
    };
    return colors[status] || '#999';
}

function updateRunStats() {
    // í†µê³„ ì¬ê³„ì‚°
    let pass = 0, fail = 0, blocked = 0, retest = 0, na = 0, untested = 0;
    
    runCases.forEach(rc => {
        if (rc.result) {
            switch(rc.result.status) {
                case 'pass': pass++; break;
                case 'fail': fail++; break;
                case 'blocked': blocked++; break;
                case 'retest': retest++; break;
                case 'na': na++; break;
            }
        } else {
            untested++;
        }
    });
    
    const total = runCases.length;
    const executed = pass + fail + blocked + retest + na;
    const progress = total > 0 ? Math.round((executed / total) * 100) : 0;
    
    // í†µê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
    document.getElementById('statProgress').textContent = `${progress}%`;
    document.getElementById('statExecuted').textContent = `${executed} / ${total}`;
    document.getElementById('statPass').textContent = pass;
    document.getElementById('statFail').textContent = fail;
    document.getElementById('statBlocked').textContent = blocked;
    document.getElementById('statRetest').textContent = retest;
}

// ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
function startAutoRefresh() {
    // 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
    autoRefreshInterval = setInterval(() => {
        refreshRunData();
    }, 5000);
    
    console.log('ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘ (5ì´ˆ ê°„ê²©)');
}

// ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€');
    }
}

// ëŸ° ë°ì´í„° ìƒˆë¡œê³ ì¹¨
async function refreshRunData() {
    if (isRefreshing) return;
    
    isRefreshing = true;
    
    try {
        const response = await fetch(`/api/runs/${runId}/cases`);
        if (!response.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        
        const newData = await response.json();
        
        // ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì—…ë°ì´íŠ¸
        let hasChanges = false;
        
        newData.forEach((newCase, index) => {
            const oldCase = runCases[index];
            
            // ê²°ê³¼ ë³€ê²½ í™•ì¸
            const oldResult = oldCase.result;
            const newResult = newCase.result;
            
            if (!oldResult && newResult) {
                // ìƒˆë¡œìš´ ê²°ê³¼ ì¶”ê°€ë¨
                hasChanges = true;
                runCases[index].result = newResult;
                updateSidebarItem(index, newResult.status);
            } else if (oldResult && newResult && oldResult.status !== newResult.status) {
                // ê²°ê³¼ ìƒíƒœ ë³€ê²½ë¨
                hasChanges = true;
                runCases[index].result = newResult;
                updateSidebarItem(index, newResult.status);
            } else if (oldResult && newResult && oldResult.comment !== newResult.comment) {
                // ì½”ë©˜íŠ¸ ë³€ê²½ë¨
                hasChanges = true;
                runCases[index].result = newResult;
            }
        });
        
        if (hasChanges) {
            console.log('ë³€ê²½ì‚¬í•­ ê°ì§€ - UI ì—…ë°ì´íŠ¸');
            updateRunStats();
            
            // í˜„ì¬ ë³´ê³  ìˆëŠ” ì¼€ì´ìŠ¤ ìƒˆë¡œê³ ì¹¨
            loadCase(currentIndex);
            
            // ì‹œê°ì  í”¼ë“œë°±
            showRefreshNotification();
        }
        
    } catch (err) {
        console.error('ìë™ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', err);
    } finally {
        isRefreshing = false;
    }
}

// ì‚¬ì´ë“œë°” ì•„ì´í…œ ì—…ë°ì´íŠ¸
function updateSidebarItem(index, status) {
    const sidebarItem = document.querySelectorAll('.run-case-item')[index];
    if (!sidebarItem) return;
    
    // ê¸°ì¡´ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
    sidebarItem.classList.remove('status-pass', 'status-fail', 'status-blocked', 'status-retest', 'status-na');
    
    // ìƒˆ ìƒíƒœ í´ë˜ìŠ¤ ì¶”ê°€
    if (status) {
        sidebarItem.classList.add(`status-${status}`);
        
        // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        const statusSpan = sidebarItem.querySelector('span[style*="color"]');
        if (statusSpan) {
            statusSpan.style.color = getStatusColor(status);
            statusSpan.textContent = status.toUpperCase();
        }
    }
}

// ìƒˆë¡œê³ ì¹¨ ì•Œë¦¼ í‘œì‹œ
function showRefreshNotification() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #27ae60;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
    `;
    notification.innerHTML = 'ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¨';
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨
function manualRefresh() {
    console.log('ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰');
    refreshRunData();
}

// í˜ì´ì§€ ë– ë‚  ë•Œ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
window.addEventListener('beforeunload', () => {
    stopAutoRefresh();
});

// ============ ì‚¬ì´ë“œë°” ë¦¬ì‚¬ì´ì € ============

function initResizer() {
    const resizer = document.getElementById('resizer');
    const sidebar = document.getElementById('runCasesSidebar');
    const detailPanel = document.getElementById('caseDetailPanel');
    
    let isResizing = false;
    let startX = 0;
    let startWidth = 0;
    
    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = sidebar.offsetWidth;
        
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const deltaX = e.clientX - startX;
        const newWidth = startWidth + deltaX;
        
        // ìµœì†Œ/ìµœëŒ€ ë„ˆë¹„ ì œí•œ
        if (newWidth >= 300 && newWidth <= 800) {
            sidebar.style.width = newWidth + 'px';
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            // ë„ˆë¹„ ì €ì¥
            saveSidebarWidth(sidebar.offsetWidth);
        }
    });
}

function saveSidebarWidth(width) {
    localStorage.setItem('runExecuteSidebarWidth', width);
    console.log('ì‚¬ì´ë“œë°” ë„ˆë¹„ ì €ì¥:', width);
}

function loadSidebarWidth() {
    const savedWidth = localStorage.getItem('runExecuteSidebarWidth');
    if (savedWidth) {
        const sidebar = document.getElementById('runCasesSidebar');
        sidebar.style.width = savedWidth + 'px';
        console.log('ì‚¬ì´ë“œë°” ë„ˆë¹„ ë¡œë“œ:', savedWidth);
    } else {
        // ê¸°ë³¸ê°’ ì„¤ì •
        const sidebar = document.getElementById('runCasesSidebar');
        sidebar.style.width = '450px';  // ê¸°ë³¸ê°’ì„ ë” ë„“ê²Œ ì„¤ì •
    }
}

function goToNextUnexecuted() {
    for (let i = currentIndex + 1; i < runCases.length; i++) {
        if (!runCases[i].result) {
            selectCase(i);
            return;
        }
    }
    // ì²˜ìŒë¶€í„° ë‹¤ì‹œ ê²€ìƒ‰
    for (let i = 0; i < currentIndex; i++) {
        if (!runCases[i].result) {
            selectCase(i);
            return;
        }
    }
    alert('ëª¨ë“  ì¼€ì´ìŠ¤ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

function goToPrevUnexecuted() {
    for (let i = currentIndex - 1; i >= 0; i--) {
        if (!runCases[i].result) {
            selectCase(i);
            return;
        }
    }
    // ë’¤ì—ì„œë¶€í„° ë‹¤ì‹œ ê²€ìƒ‰
    for (let i = runCases.length - 1; i > currentIndex; i--) {
        if (!runCases[i].result) {
            selectCase(i);
            return;
        }
    }
    alert('ì´ì „ ë¯¸ì‹¤í–‰ ì¼€ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
}

function goToFirst() {
    selectCase(0);
}

function goToLast() {
    selectCase(runCases.length - 1);
}

function focusComment() {
    const commentSection = document.getElementById('commentSection');
    const commentInput = document.getElementById('commentInput');
    
    if (commentSection && commentInput) {
        commentSection.classList.add('show');
        commentInput.focus();
    }
}

function closeComment() {
    const commentSection = document.getElementById('commentSection');
    if (commentSection) {
        commentSection.classList.remove('show');
    }
}

// ì¼€ì´ìŠ¤ í•„ë“œ ì—…ë°ì´íŠ¸
async function updateCaseField(field, value) {
    const caseData = runCases[currentIndex].case;
    const caseId = caseData.id;
    
    // ê°’ì´ ë³€ê²½ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¬´ì‹œ
    const oldValue = field === 'title' ? caseData.title :
                     field === 'priority' ? caseData.priority :
                     field === 'steps' ? caseData.steps :
                     field === 'expected_result' ? caseData.expected : '';
    
    if (value === oldValue) {
        return;
    }
    
    try {
        const response = await fetch(`/api/cases/${caseId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ [field]: value })
        });
        
        if (!response.ok) {
            const error = await response.json();
            if (response.status === 404) {
                alert('âš ï¸ ì›ë³¸ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ê°€ ì‚­ì œë˜ì–´ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            } else if (response.status === 409) {
                alert('âš ï¸ ì›ë³¸ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ê°€ ë‹¤ë¥¸ ì‚¬ìš©ìì— ì˜í•´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            } else {
                alert(`ë³€ê²½ ì‹¤íŒ¨: ${error.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }
            // ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
            loadCase(currentIndex);
            return;
        }
        
        const data = await response.json();
        
        // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
        if (field === 'title') {
            caseData.title = value;
        } else if (field === 'priority') {
            caseData.priority = value;
        } else if (field === 'steps') {
            caseData.steps = value;
        } else if (field === 'expected_result') {
            caseData.expected = value;
        }
        
        // ì‹œê°ì  í”¼ë“œë°±
        showSaveNotification('âœ… ì €ì¥ ì™„ë£Œ');
        
        console.log('ì¼€ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', field, value);
        
    } catch (err) {
        console.error('ì¼€ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', err);
        alert('âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        // ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
        loadCase(currentIndex);
    }
}

// ì €ì¥ ì•Œë¦¼ í‘œì‹œ
function showSaveNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #27ae60;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}


// HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', function(e) {
    // ì…ë ¥ í•„ë“œ ë˜ëŠ” í¸ì§‘ ê°€ëŠ¥í•œ ìš”ì†Œì—ì„œëŠ” ì¼ë¶€ ë‹¨ì¶•í‚¤ë§Œ í—ˆìš©
    const isInputField = e.target.tagName === 'TEXTAREA' || 
                        e.target.tagName === 'INPUT' ||
                        e.target.tagName === 'SELECT' ||
                        e.target.isContentEditable;
    
    // EscëŠ” í•­ìƒ ì‘ë™
    if (e.key === 'Escape') {
        if (isInputField) {
            e.target.blur();
            closeComment();
        }
        return;
    }
    
    // ì…ë ¥ í•„ë“œì—ì„œëŠ” ë‹¤ë¥¸ ë‹¨ì¶•í‚¤ ë¬´ì‹œ
    if (isInputField) {
        return;
    }
    
    // Shift í‚¤ ì¡°í•© ì²˜ë¦¬
    if (e.shiftKey && e.key === 'G') {
        e.preventDefault();
        goToLast();
        return;
    }
    
    switch(e.key) {
        case '1':
            e.preventDefault();
            recordResult('pass');
            break;
        case '2':
            e.preventDefault();
            recordResult('fail');
            break;
        case '3':
            e.preventDefault();
            recordResult('blocked');
            break;
        case '4':
            e.preventDefault();
            recordResult('retest');
            break;
        case '5':
            e.preventDefault();
            recordResult('na');
            break;
        case 'n':
            e.preventDefault();
            goToNextUnexecuted();
            break;
        case 'p':
            e.preventDefault();
            goToPrevUnexecuted();
            break;
        case 'j':
            e.preventDefault();
            if (currentIndex < runCases.length - 1) {
                selectCase(currentIndex + 1);
            }
            break;
        case 'k':
            e.preventDefault();
            if (currentIndex > 0) {
                selectCase(currentIndex - 1);
            }
            break;
        case 'g':
            e.preventDefault();
            goToFirst();
            break;
        case 'c':
            e.preventDefault();
            focusComment();
            break;
        case 'r':
            e.preventDefault();
            manualRefresh();
            break;
        case '?':
            e.preventDefault();
            const hint = document.getElementById('hotkeyHint');
            hint.classList.toggle('hidden');
            break;
    }
});

// íŒíŠ¸ ì´ˆê¸° í‘œì‹œ (3ì´ˆ í›„ ìë™ ìˆ¨ê¹€)
setTimeout(() => {
    const hint = document.getElementById('hotkeyHint');
    if (hint) {
        hint.classList.add('hidden');
    }
}, 5000);
</script>
{% endblock %}


