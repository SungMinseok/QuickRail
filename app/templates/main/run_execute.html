{% extends "base.html" %}

{% block title %}{{ run.name }} - ì‹¤í–‰{% endblock %}

{% block extra_css %}
<style>
    /* ========================================
       1. í˜ì´ì§€ ì „ì²´ ìŠ¤í¬ë¡¤ ì œê±° (html, body ê³ ì •)
       ======================================== */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* ë¸Œë¼ìš°ì € ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨ */
    }
    
    /* ========================================
       2. ë©”ì¸ ë˜í¼ (ë†’ì´ í™•ì •)
       ======================================== */
    .main-wrapper {
        height: calc(100vh - 80px); /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ì œì™¸ */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
        padding: 0 1rem 0.25rem 1rem; /* ì¢Œìš°, í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ (í•˜ë‹¨ íŒ¨ë”© ì¶•ì†Œ) */
    }
    
    /* ========================================
       3. í—¤ë” ì˜ì—­ (ê³ ì • í¬ê¸°)
       ======================================== */
    .header-section {
        flex-shrink: 0; /* ê³ ì • í¬ê¸° ìœ ì§€ */
        margin-bottom: 1rem; /* í—¤ë”ì™€ ë©”ì¸ ë ˆì´ì•„ì›ƒ ì‚¬ì´ ì—¬ë°± */
    }
    
    /* ========================================
       4. ë©”ì¸ ë ˆì´ì•„ì›ƒ (Flex í™•ì¥)
       ======================================== */
    .run-execute-layout {
        flex: 1; /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
        display: flex;
        gap: 1rem; /* ì¼€ì´ìŠ¤ ëª©ë¡ê³¼ ìƒì„¸ íŒ¨ë„ ì‚¬ì´ ì—¬ë°± */
        position: relative;
        overflow: hidden; /* ë ˆì´ì•„ì›ƒ ìì²´ëŠ” ìŠ¤í¬ë¡¤ ì—†ìŒ */
        min-height: 0; /* Flexbox ì œì•½ í•´ì œ - í•µì‹¬! */
    }
    
    /* ========================================
       5. ì¼€ì´ìŠ¤ ëª©ë¡ (ìŠ¤í¬ë¡¤ ì˜ì—­)
       ======================================== */
    #runCasesSidebar {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™” */
        overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ìˆ¨ê¹€ */
        min-height: 0; /* Flexbox ì œì•½ í•´ì œ - í•µì‹¬! */
        max-height: 95%; /* ë¶€ëª¨ ë†’ì´ë¥¼ ë„˜ì§€ ì•Šë„ë¡ */
        flex: 1; /* 1:1 ë¹„ìœ¨ì„ ìœ„í•´ flex: 1 ì„¤ì • */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* ê·¸ë¦¼ì ì¶”ê°€ */
        min-width: 0; /* flex ì•„ì´í…œì´ ì¶•ì†Œë˜ì§€ ì•Šë„ë¡ */
        height: fit-content; /* ë‚´ìš©ë¬¼ ë†’ì´ì— ë§ì¶¤ */
        align-self: flex-start; /* ìƒë‹¨ ì •ë ¬ */
    }
    
    /* íŒ¨ë„ì´ ì ‘í˜€ ìˆì„ ë•Œ */
    .run-execute-layout.panel-collapsed #runCasesSidebar {
        flex: 1 1 100%; /* ì „ì²´ ë„ˆë¹„ ì°¨ì§€ */
        max-width: 100%;
    }
    
    .run-execute-layout.panel-collapsed .resizer {
        display: none !important;
        flex: 0 0 0 !important;
        width: 0 !important;
        min-width: 0 !important;
        max-width: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        visibility: hidden !important;
    }
    
    .resizer {
        width: 5px;
        background: #e0e0e0;
        cursor: col-resize;
        position: relative;
        flex-shrink: 0;
        max-height: 95%; /* ë¶€ëª¨ ë†’ì´ë¥¼ ë„˜ì§€ ì•Šë„ë¡ */
    }
    
    .resizer:hover {
        background: #3498db;
    }
    
    .resizer::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 40px;
        background: transparent;
    }
    
    .run-case-item {
        padding: 0.75rem;
        margin: 0.5rem 0;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
    }
    
    .run-case-item:hover {
        background: #f5f5f5;
    }
    
    .run-case-item.active {
        border-color: #3498db;
        background: #ebf5fb;
    }
    
    .run-case-item.status-pass {
        border-left: 4px solid #27ae60;
    }
    
    .run-case-item.status-fail {
        border-left: 4px solid #e74c3c;
    }
    
    .run-case-item.status-blocked {
        border-left: 4px solid #95a5a6;
    }
    
    .run-case-item.status-retest {
        border-left: 4px solid #f39c12;
    }
    
    .run-case-item.status-na {
        border-left: 4px solid #bdc3c7;
    }
    
    /* ê²°ê³¼ ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .result-badge {
        display: inline-block;
    }
    
    .result-badge.result-pass {
        background: #27ae60 !important;
        color: white !important;
    }
    
    .result-badge.result-fail {
        background: #e74c3c !important;
        color: white !important;
    }
    
    .result-badge.result-blocked {
        background: #95a5a6 !important;
        color: white !important;
    }
    
    .result-badge.result-retest {
        background: #f39c12 !important;
        color: white !important;
    }
    
    .result-badge.result-na {
        background: #bdc3c7 !important;
        color: white !important;
    }
    
    .result-badge.result-none {
        background: #ecf0f1 !important;
        color: #7f8c8d !important;
    }
    
    /* ========================================
       6. ìƒì„¸ íŒ¨ë„ (ìŠ¤í¬ë¡¤ ì˜ì—­)
       ======================================== */
    .case-detail-panel {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™” */
        overflow-x: visible; /* ë²„íŠ¼ì´ ë³´ì´ë„ë¡ */
        flex: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
        min-width: 300px;
        position: relative;
        min-height: 0; /* Flexbox ì œì•½ í•´ì œ - í•µì‹¬! */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* ê·¸ë¦¼ì ì¶”ê°€ */
        max-height: 95%; /* ë¶€ëª¨ ë†’ì´ë¥¼ ë„˜ì§€ ì•Šë„ë¡ */

    }
    
    .case-detail-panel.collapsed {
        display: none !important;
        flex: 0 0 0 !important;
        min-width: 0 !important;
        max-width: 0 !important;
        width: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        overflow: hidden !important;
        visibility: hidden !important;
    }
    
    .panel-toggle-btn {
        position: absolute;
        left: -40px;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 80px;
        background: #3498db;
        border: none;
        border-radius: 8px 0 0 8px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: background 0.2s;
        z-index: 100; /* ì¼€ì´ìŠ¤ ë¦¬ìŠ¤íŠ¸ë³´ë‹¤ ìœ„ì— í‘œì‹œ */
        box-shadow: -2px 0 8px rgba(0,0,0,0.15);
    }
    
    .panel-toggle-btn:hover {
        background: #2980b9;
    }
    
    .case-detail-panel.collapsed .panel-toggle-btn {
        left: auto;
        right: -40px;
        border-radius: 0 8px 8px 0;
    }
    
    .status-buttons {
        display: flex;
        gap: 1rem;
        margin: 1.5rem 0;
        flex-wrap: wrap;
    }
    
    .status-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        background: white;
    }
    
    .status-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .status-btn.pass {
        border-color: #27ae60;
        color: #27ae60;
    }
    
    .status-btn.pass:hover {
        background: #27ae60;
        color: white;
    }
    
    .status-btn.fail {
        border-color: #e74c3c;
        color: #e74c3c;
    }
    
    .status-btn.fail:hover {
        background: #e74c3c;
        color: white;
    }
    
    .status-btn.blocked {
        border-color: #95a5a6;
        color: #95a5a6;
    }
    
    .status-btn.blocked:hover {
        background: #95a5a6;
        color: white;
    }
    
    .status-btn.retest {
        border-color: #f39c12;
        color: #f39c12;
    }
    
    .status-btn.retest:hover {
        background: #f39c12;
        color: white;
    }
    
    .status-btn.na {
        border-color: #bdc3c7;
        color: #7f8c8d;
    }
    
    .status-btn.na:hover {
        background: #bdc3c7;
        color: white;
    }
    
    .comment-section {
        display: none;
        margin-top: 1rem;
    }
    
    .comment-section.show {
        display: block;
    }
    
    .stats-bar {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-around;
        text-align: center;
    }
    
    .stat-item {
        flex: 1;
        transition: transform 0.2s, background 0.2s;
        padding: 0.5rem;
        border-radius: 4px;
    }
    
    .stat-item.clickable:hover {
        transform: translateY(-2px);
        background: #f5f5f5;
    }
    
    .stat-item.clickable.active {
        background: #e3f2fd;
        border: 2px solid #2196f3;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #666;
    }
    
    /* ë‹¨ì¶•í‚¤ ê°€ì´ë“œ - cases í˜ì´ì§€ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼ */
    .hotkey-hint {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        font-size: 0.85rem;
        z-index: 1000;
        min-width: 280px;
        display: block; /* í•­ìƒ í‘œì‹œ */
    }
    
    .hotkey-hint h4 {
        margin: 0 0 0.75rem 0;
        font-size: 0.95rem;
        color: #3498db;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 0.5rem;
    }
    
    .hotkey-hint .shortcut-item {
        display: flex;
        justify-content: space-between;
        margin: 0.4rem 0;
        line-height: 1.4;
    }
    
    .hotkey-hint .shortcut-key {
        background: rgba(255, 255, 255, 0.15);
        padding: 0.15rem 0.5rem;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.8rem;
        margin-left: 1rem;
        white-space: nowrap;
    }
    
    .hotkey-hint .shortcut-desc {
        flex: 1;
    }
    
    .hotkey-hint hr {
        margin: 0.75rem 0;
        border: none;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .hotkey-hint.hidden {
        display: none;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
    
    .refresh-indicator {
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(39, 174, 96, 0.9);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        z-index: 999;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .refresh-indicator.active {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    /* Toast ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
    .toast-container {
        position: fixed;
        top: 80px; /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ì•„ë˜ */
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .toast {
        background: #2ecc71;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 300px;
        max-width: 400px;
        animation: slideInRight 0.3s ease-out;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
    }
    
    .toast.error {
        background: #e74c3c;
    }
    
    .toast.warning {
        background: #f39c12;
    }
    
    .toast.info {
        background: #3498db;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .toast.hiding {
        animation: slideOutRight 0.3s ease-out forwards;
    }
</style>
{% endblock %}

{% block content %}
<!-- Toast ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
<div class="toast-container" id="toastContainer"></div>

<!-- ë©”ì¸ ë˜í¼: ë†’ì´ í™•ì • -->
<div class="main-wrapper">
    <!-- í—¤ë” ì˜ì—­ (ê³ ì •) -->
    <div class="header-section">
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
                <h2 style="margin: 0 0 0.5rem 0;">
                    {{ run.name }}
                    {% if run.is_closed %}
                    <span style="background: #95a5a6; color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.9rem; margin-left: 0.5rem;">ì™„ë£Œë¨ (ì½ê¸° ì „ìš©)</span>
                    {% endif %}
                </h2>
                <div style="color: #666; margin: 0;">
                    {% if run.build_label %}
                    <div style="margin-bottom: 0.25rem;">
                        <span style="color: #3498db; font-weight: 500;">ğŸ·ï¸ Build: {{ run.build_label }}</span>
                    </div>
                    {% endif %}
                    {% if run.description %}
                    <p style="margin: 0;">{{ run.description }}</p>
                    {% endif %}
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                <button onclick="togglePanel()" class="btn btn-secondary" id="topPanelToggleBtn" style="display: flex; align-items: center; gap: 0.5rem;" title="ìš°ì¸¡ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°">
                    <span id="topPanelToggleIcon">â—€</span>
                    <span>íŒ¨ë„</span>
                </button>
                <!-- Export ë²„íŠ¼ + ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ (CSV/ìœ„í‚¤) -->
                <div style="position: relative;">
                    <button onclick="toggleExportMenu(event)" class="btn btn-secondary" style="display: flex; align-items: center; gap: 0.5rem;" title="ë‚´ë³´ë‚´ê¸° ì˜µì…˜">
                        <span>ğŸ“¤</span>
                        <span>ë‚´ë³´ë‚´ê¸°</span>
                        <span style="font-size: 0.9rem;">â–¾</span>
                    </button>
                    <div id="exportMenu" style="display:none; position:absolute; right:0; top: 42px; min-width: 180px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); z-index: 11000; overflow:hidden;">
                        <button class="btn btn-secondary" style="width:100%; border:none; border-radius:0; text-align:left; padding: 0.6rem 0.9rem; background: transparent;" onclick="exportCSV(); closeExportMenu();">
                            ğŸ“„ CSV
                        </button>
                        <button class="btn btn-secondary" style="width:100%; border:none; border-radius:0; text-align:left; padding: 0.6rem 0.9rem; background: transparent;" onclick="openWikiDraftModal(); closeExportMenu();">
                            ğŸ“ ìœ„í‚¤ ì´ˆì•ˆ
                        </button>
                    </div>
                </div>
                {% if not run.is_closed %}
                <button onclick="resetAllResults()" class="btn btn-secondary" style="display: flex; align-items: center; gap: 0.5rem;" title="ëª¨ë“  ê²°ê³¼ë¥¼ ë¯¸ì‹¤í–‰ìœ¼ë¡œ ì´ˆê¸°í™”">
                    <span>ğŸ”„</span>
                    <span>ì´ˆê¸°í™”</span>
                </button>
                <button onclick="completeRun()" class="btn btn-success" style="display: flex; align-items: center; gap: 0.5rem;" title="í…ŒìŠ¤íŠ¸ëŸ° ì™„ë£Œ ì²˜ë¦¬">
                    <span>âœ“</span>
                    <span>ì™„ë£Œ</span>
                </button>
                {% endif %}
                <button onclick="goBackToRuns()" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;" title="ëŸ° ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°">
                    <span>â†</span>
                    <span>ë’¤ë¡œê°€ê¸°</span>
                </button>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ ìƒˆë¡œê³ ì¹¨ ì¸ë””ì¼€ì´í„° -->
        {% if not run.is_closed %}
        <div class="refresh-indicator active" id="refreshIndicator">
            ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘ (5ì´ˆ)
        </div>
        {% endif %}

        <!-- í†µê³„ ë°” -->
        <div class="stats-bar" style="margin-bottom: 0.5rem;">
    <div class="stat-item">
        <div class="stat-value" id="statProgress" style="color: #3498db;">{{ stats.progress }}%</div>
        <div class="stat-label">ì§„í–‰ë¥ </div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="statPassRate" style="color: {% if stats.pass_rate >= 90 %}#27ae60{% elif stats.pass_rate >= 70 %}#f39c12{% else %}#e74c3c{% endif %};">{{ stats.pass_rate }}%</div>
        <div class="stat-label">ì„±ê³µë¥ </div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="statExecuted">{{ stats.executed }} / {{ stats.total }}</div>
        <div class="stat-label">ì‹¤í–‰</div>
    </div>
    <div class="stat-item clickable" onclick="filterByStatus('pass')" style="cursor: pointer;" title="Pass ì¼€ì´ìŠ¤ë§Œ ë³´ê¸°">
        <div class="stat-value" id="statPass" style="color: #27ae60;">{{ stats.pass }}</div>
        <div class="stat-label">Pass</div>
    </div>
    <div class="stat-item clickable" onclick="filterByStatus('fail')" style="cursor: pointer;" title="Fail ì¼€ì´ìŠ¤ë§Œ ë³´ê¸°">
        <div class="stat-value" id="statFail" style="color: #e74c3c;">{{ stats.fail }}</div>
        <div class="stat-label">Fail</div>
    </div>
    <div class="stat-item clickable" onclick="filterByStatus('blocked')" style="cursor: pointer;" title="Blocked ì¼€ì´ìŠ¤ë§Œ ë³´ê¸°">
        <div class="stat-value" id="statBlocked" style="color: #95a5a6;">{{ stats.blocked }}</div>
        <div class="stat-label">Blocked</div>
    </div>
    <div class="stat-item clickable" onclick="filterByStatus('retest')" style="cursor: pointer;" title="Retest ì¼€ì´ìŠ¤ë§Œ ë³´ê¸°">
        <div class="stat-value" id="statRetest" style="color: #f39c12;">{{ stats.retest }}</div>
        <div class="stat-label">Retest</div>
    </div>
    <div class="stat-item clickable" onclick="filterByStatus('na')" style="cursor: pointer;" title="N/A ì¼€ì´ìŠ¤ë§Œ ë³´ê¸°">
        <div class="stat-value" id="statNA" style="color: #bdc3c7;">{{ stats.na }}</div>
        <div class="stat-label">N/A</div>
    </div>
    <div class="stat-item clickable" onclick="filterByStatus('none')" style="cursor: pointer;" title="ë¯¸ì‹¤í–‰ ì¼€ì´ìŠ¤ë§Œ ë³´ê¸°">
        <div class="stat-value" id="statPending" style="color: #999;">{{ stats.total - stats.executed }}</div>
        <div class="stat-label">ë¯¸ì‹¤í–‰</div>
    </div>
    </div>
    
    <!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
    <div style="background: #ecf0f1; height: 10px; border-radius: 15px; overflow: hidden; position: relative; margin-bottom: 0.5rem;">
        <div id="progressPass" style="position: absolute; height: 100%; background: #27ae60; width: 0%; transition: width 0.3s;"></div>
        <div id="progressFail" style="position: absolute; height: 100%; background: #e74c3c; width: 0%; left: 0%; transition: width 0.3s, left 0.3s;"></div>
        <div id="progressBlocked" style="position: absolute; height: 100%; background: #95a5a6; width: 0%; left: 0%; transition: width 0.3s, left 0.3s;"></div>
        <div id="progressRetest" style="position: absolute; height: 100%; background: #f39c12; width: 0%; left: 0%; transition: width 0.3s, left 0.3s;"></div>
        <div id="progressNA" style="position: absolute; height: 100%; background: #bdc3c7; width: 0%; left: 0%; transition: width 0.3s, left 0.3s;"></div>
    </div>
    
    <!-- í•„í„° ìƒíƒœ í‘œì‹œ ë° ì´ˆê¸°í™” ë²„íŠ¼ -->
    <div id="filterStatus" style="display: none; background: #e3f2fd; padding: 0.5rem 1rem; border-radius: 4px; margin-bottom: 0.5rem; justify-content: space-between; align-items: center;">
        <span id="filterText" style="color: #1976d2; font-weight: 500;"></span>
        <button onclick="clearFilter()" class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">âœ• í•„í„° í•´ì œ</button>
    </div>
    </div>
    
    <!-- AI ìš”ì•½ ì˜ì—­ (ì™„ë£Œëœ ëŸ°ë§Œ) -->
    {% if run.is_closed %}
    <div id="aiSummarySection" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #e0e0e0; max-height: 250px; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; flex-shrink: 0;">
            <h4 style="margin: 0;">ğŸ¤– AI ìš”ì•½</h4>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <select id="summaryPromptSelect" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">í”„ë¡¬í”„íŠ¸ ì„ íƒ...</option>
                </select>
                <button id="generateSummaryBtn" onclick="generateAISummary()" class="btn btn-primary" style="padding: 0.5rem 1rem;">
                    {% if run.summary %}ìš”ì•½ ì¬ìƒì„±{% else %}ìš”ì•½ ìƒì„±{% endif %}
                </button>
            </div>
        </div>
        <!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” ë° ì§„í–‰ ìƒí™© í‘œì‹œ -->
        <div id="aiSummaryProgress" style="display: none; margin-bottom: 0.5rem; flex-shrink: 0;">
            <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 0.25rem;">
                <div id="aiSummaryProgressBar" style="background: #3498db; height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <div id="aiSummaryProgressText" style="font-size: 0.85rem; color: #666; text-align: center;">
                ì¤€ë¹„ ì¤‘...
            </div>
        </div>
        <div id="aiSummaryContent" style="flex: 1; overflow-y: auto; min-height: 0;">
            {% if run.summary %}
            <div style="position: relative; background: white; padding: 1rem; border-radius: 4px;">
                <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem;">
                    <button onclick="copyAISummary()" class="btn btn-sm btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;" title="AI ìš”ì•½ ë³µì‚¬">
                        ğŸ“‹ ë³µì‚¬
                    </button>
                    <button onclick="openAISummaryInNewWindow()" class="btn btn-sm btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;" title="ìƒˆ ì°½ì—ì„œ ì—´ê¸°">
                        ğŸ”— ìƒˆì°½
                    </button>
                </div>
                <div id="aiSummaryText" style="white-space: pre-wrap; line-height: 1.6; padding-right: 6rem;">{{ run.summary }}</div>
            </div>
            {% else %}
            <div style="color: #999; padding: 1rem; text-align: center;">
                AI ìš”ì•½ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìœ„ì˜ ë“œë¡­ë‹¤ìš´ì—ì„œ í”„ë¡¬í”„íŠ¸ë¥¼ ì„ íƒí•˜ê³  "ìš”ì•½ ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ (Flex í™•ì¥) -->
    <div class="run-execute-layout">
        <!-- ì¢Œì¸¡: RunCase ëª©ë¡ (ìŠ¤í¬ë¡¤ ì˜ì—­) -->
        <div id="runCasesSidebar">
        <h4 style="margin-bottom: 1rem;">ì¼€ì´ìŠ¤ ëª©ë¡</h4>
        {% for item in run_cases %}
        <div class="run-case-item {% if item.result %}status-{{ item.result.status }}{% endif %} {% if loop.index0 == 0 %}active{% endif %}" 
             data-case-id="{{ item.case.id }}"
             onclick="selectCase({{ loop.index0 }})">
            <div style="font-weight: 500; margin-bottom: 0.25rem; word-wrap: break-word; line-height: 1.4;">
                #{{ item.case.id }} {{ item.case.title }}
            </div>
            <div style="font-size: 0.85rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    {% if item.result %}
                        <span class="result-badge result-{{ item.result.status }}" style="padding: 0.15rem 0.5rem; border-radius: 4px; font-weight: 600; font-size: 0.75rem;">
                            {{ item.result.status|upper }}
                        </span>
                    {% else %}
                        <span class="result-badge result-none" style="padding: 0.15rem 0.5rem; border-radius: 4px; font-weight: 600; font-size: 0.75rem;">ë¯¸ì‹¤í–‰</span>
                    {% endif %}
                </div>
                {% if item.sidebar_comment %}
                <div class="case-comment-preview" style="font-size: 0.7rem; color: #666; margin-top: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 600px; max-width: 600px;">
                    ğŸ’¬ {{ item.sidebar_comment }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- ë¦¬ì‚¬ì´ì € -->
    <div class="resizer" id="resizer"></div>
    
    <!-- ìš°ì¸¡: ì¼€ì´ìŠ¤ ìƒì„¸ + ê²°ê³¼ ì…ë ¥ -->
    <div class="case-detail-panel" id="caseDetailPanel">
        <button class="panel-toggle-btn" id="panelToggleBtn" onclick="togglePanel()" title="íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°">
            â—€
        </button>
        <div id="caseContent">
            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
        </div>
    </div>
</div>
<!-- /main-wrapper -->

<!-- ì½”ë©˜íŠ¸ ì…ë ¥ ëª¨ë‹¬ -->
<div id="commentModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 1.5rem; max-width: 500px; width: 90%;">
        <h4 style="margin: 0 0 1rem 0;">ì½”ë©˜íŠ¸ ì…ë ¥</h4>
        <textarea id="modalCommentInput" class="form-control" placeholder="ê²°ê³¼ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..." style="min-height: 100px; width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 1rem;"></textarea>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeCommentModal()">ì·¨ì†Œ</button>
            <button class="btn btn-success" onclick="confirmCommentModal()">í™•ì¸</button>
        </div>
    </div>
</div>

<!-- Jira ë²„ê·¸ ë“±ë¡ ëª¨ë‹¬ -->
<div id="jiraIssueModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 1.5rem; max-width: 720px; width: 92%; max-height: 92vh; overflow: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <h4 style="margin: 0;">ğŸ› Jira ë²„ê·¸ ë“±ë¡</h4>
            <button class="btn btn-secondary" onclick="closeJiraIssueModal()" style="padding: 0.35rem 0.75rem;">ë‹«ê¸°</button>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.35rem;">Summary <span style="color: #e74c3c;">*</span></label>
            <input type="text" id="jiraSummaryInput" class="form-control" placeholder="í•„ìˆ˜ - ì´ìŠˆ ì œëª©" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 0.35rem;">Component</label>
                <input type="text" id="jiraComponentInput" class="form-control" placeholder="ì˜ˆ: UI,Matchmaking" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 0.35rem;">Labels</label>
                <input type="text" id="jiraLabelsInput" class="form-control" placeholder="ì˜ˆ: quickrail,run" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.35rem;">Priority</label>
            <input type="text" id="jiraPriorityInput" class="form-control" placeholder="ì˜ˆ: High" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.35rem;">Steps</label>
            <textarea id="jiraStepsInput" class="form-control" placeholder="ì„ íƒ - ì¬í˜„ ìŠ¤í…" style="width: 100%; min-height: 90px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.35rem;">Description</label>
            <textarea id="jiraDescriptionInput" class="form-control" placeholder="ì„ íƒ - ìƒì„¸ ì„¤ëª…" style="width: 100%; min-height: 120px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
        </div>
        
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeJiraIssueModal()">ì·¨ì†Œ</button>
            <button class="btn btn-danger" onclick="confirmJiraIssueModal()">ë“±ë¡</button>
        </div>
        
        <div style="margin-top: 0.75rem; color: #666; font-size: 0.9rem;">
            ì„¤ì •ì´ ì—†ìœ¼ë©´ ë“±ë¡ì— ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <code>/settings</code>ì—ì„œ Jira ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.
        </div>
    </div>
</div>

<!-- ìœ„í‚¤ ì´ˆì•ˆ ì‘ì„± ëª¨ë‹¬ -->
<div id="wikiDraftModal" style="display:none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10002; align-items: center; justify-content: center;">
    <div style="background:#fff; width: min(1100px, 92vw); max-height: 88vh; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.25); display:flex; flex-direction: column;">
        <div style="padding: 1rem 1.25rem; border-bottom: 1px solid #e0e0e0; display:flex; align-items:center; justify-content: space-between; gap: 1rem;">
            <div>
                <h3 style="margin:0;">ğŸ“ ìœ„í‚¤ ì´ˆì•ˆ ì‘ì„±</h3>
                <div style="color:#666; font-size:0.9rem; margin-top:0.25rem;">
                    ëŸ° ê²°ê³¼ ê¸°ë°˜ìœ¼ë¡œ ìœ„í‚¤ì— ë¶™ì—¬ë„£ê¸° ì‰¬ìš´ ì´ˆì•ˆì„ ìƒì„±í•©ë‹ˆë‹¤. (ë‹¤ìš´ë¡œë“œ/ë³µì‚¬ ì§€ì›)
                </div>
            </div>
            <div style="display:flex; gap:0.5rem; align-items:center;">
                <button class="btn btn-secondary" onclick="copyWikiMarkdownToClipboard()" title="ë§ˆí¬ë‹¤ìš´ì„ í´ë¦½ë³´ë“œë¡œ ë³µì‚¬">ğŸ“‹ ë³µì‚¬</button>
                <button class="btn btn-secondary" onclick="closeWikiDraftModal()">ë‹«ê¸°</button>
            </div>
        </div>

        <div style="padding: 1rem 1.25rem; overflow:auto; flex:1;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <div style="background:#f8f9fa; border:1px solid #e0e0e0; border-radius: 8px; padding: 0.9rem; margin-bottom: 1rem;">
                        <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <h4 style="margin:0;">1. QA ì •ë³´</h4>
                            <small style="color:#666;">(2ì—´ 5í–‰)</small>
                        </div>
                        <table style="width:100%; border-collapse: collapse; background:#fff; border:1px solid #eee;">
                            <tbody>
                                <tr>
                                    <td style="width: 32%; padding: 0.55rem; border-bottom:1px solid #eee; background:#fafafa;"><strong>1-1. QA ëŒ€ìƒ</strong><br><small style="color:#666;">(JIRA ë§í¬)</small></td>
                                    <td style="padding: 0.55rem; border-bottom:1px solid #eee;"><input id="wikiQaTarget" class="form-control" placeholder="ì˜ˆ: https://.../browse/PROJ-123" /></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.55rem; border-bottom:1px solid #eee; background:#fafafa;"><strong>1-2. ê¸°íš ë¬¸ì„œ</strong><br><small style="color:#666;">(wiki ë§í¬ ë“±)</small></td>
                                    <td style="padding: 0.55rem; border-bottom:1px solid #eee;"><input id="wikiPlanDoc" class="form-control" placeholder="ì˜ˆ: https://wiki/..." /></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.55rem; border-bottom:1px solid #eee; background:#fafafa;"><strong>1-3. QA í™˜ê²½</strong><br><small style="color:#666;">(ë¹Œë“œ/ì„œë²„ ë“±)</small></td>
                                    <td style="padding: 0.55rem; border-bottom:1px solid #eee;"><input id="wikiQaEnv" class="form-control" placeholder="ì˜ˆ: Build, ì„œë²„, ìŠ¤í…Œì´ì§€ ë“±" /></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.55rem; border-bottom:1px solid #eee; background:#fafafa;"><strong>1-4. íƒ€ê²Ÿ ì—…ë°ì´íŠ¸</strong><br><small style="color:#666;">(JIRA í•„í„° ë§í¬)</small></td>
                                    <td style="padding: 0.55rem; border-bottom:1px solid #eee;"><input id="wikiTargetUpdate" class="form-control" placeholder="ì˜ˆ: https://.../issues/?jql=..." /></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.55rem; background:#fafafa;"><strong>1-5. ë‹´ë‹¹ QA</strong></td>
                                    <td style="padding: 0.55rem;"><input id="wikiQaOwner" class="form-control" placeholder="ì˜ˆ: í™ê¸¸ë™" /></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="background:#f8f9fa; border:1px solid #e0e0e0; border-radius: 8px; padding: 0.9rem;">
                        <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <h4 style="margin:0;">2. QA ê²°ê³¼/í˜„í™©</h4>
                            <button class="btn btn-primary" onclick="aiFillWikiDraft()" title="ê°€ëŠ¥í•œ í•­ëª©ì„ AIë¡œ ìë™ ì‘ì„±">ğŸ¤– AI ì‘ì„±</button>
                        </div>

                        <div style="background:#fff; border:1px solid #eee; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem;">
                            <div style="display:flex; align-items:center; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <strong>2-1. í…ŒìŠ¤íŠ¸ ê²°ê³¼</strong>
                                <small style="color:#666;">(ë„ë„› ì°¨íŠ¸ + ìˆ˜ì¹˜)</small>
                            </div>
                            <div style="display:grid; grid-template-columns: 180px 1fr; gap: 0.75rem; align-items:center;">
                                <canvas id="wikiDonutChart" width="180" height="180" style="border:1px solid #eee; border-radius: 8px;"></canvas>
                                <table style="width:100%; border-collapse: collapse;">
                                    <thead>
                                        <tr>
                                            <th style="text-align:left; padding:0.35rem; border-bottom:1px solid #eee;">í•­ëª©</th>
                                            <th style="text-align:right; padding:0.35rem; border-bottom:1px solid #eee;">ê°’</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wikiResultStatsTable"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 1ì—´ 2í–‰ í‘œ í˜•íƒœ: header(1í–‰) + content(2í–‰) -->
                        <table style="width:100%; border-collapse: collapse; background:#fff; border:1px solid #eee; margin-bottom: 0.75rem;">
                            <tr><th style="text-align:left; padding:0.6rem; background:#fafafa; border-bottom:1px solid #eee;">2-2. ì”ì—¬ ì´ìŠˆ (JIRA ë§í¬ ë“±)</th></tr>
                            <tr><td style="padding:0.6rem;"><textarea id="wikiRemainingIssues" class="form-control" rows="3" placeholder="- PROJ-123&#10;- https://..."></textarea></td></tr>
                        </table>
                        <table style="width:100%; border-collapse: collapse; background:#fff; border:1px solid #eee; margin-bottom: 0.75rem;">
                            <tr><th style="text-align:left; padding:0.6rem; background:#fafafa; border-bottom:1px solid #eee;">2-3. Closed í‹°ì¼“ (ê¸°íšì˜ë„/ìˆ˜ì •ì•ˆí•¨ ë“±)</th></tr>
                            <tr><td style="padding:0.6rem;"><textarea id="wikiClosedIssues" class="form-control" rows="3" placeholder="- PROJ-456 (Won't Fix) : ..."></textarea></td></tr>
                        </table>
                        <table style="width:100%; border-collapse: collapse; background:#fff; border:1px solid #eee;">
                            <tr><th style="text-align:left; padding:0.6rem; background:#fafafa; border-bottom:1px solid #eee;">2-4. ê¸°íƒ€ ì°¸ê³ ì‚¬í•­</th></tr>
                            <tr><td style="padding:0.6rem;"><textarea id="wikiNotes" class="form-control" rows="4" placeholder="- ..."></textarea></td></tr>
                        </table>
                    </div>
                </div>

                <div>
                    <div style="background:#f8f9fa; border:1px solid #e0e0e0; border-radius: 8px; padding: 0.9rem; margin-bottom: 1rem;">
                        <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <h4 style="margin:0;">3. ì²´í¬ë¦¬ìŠ¤íŠ¸</h4>
                            <small style="color:#666;">(ì„ íƒ + ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°)</small>
                        </div>
                        <div style="display:flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiCol" value="section1" checked onchange="renderWikiChecklistPreview()"> ì„¹ì…˜1</label>
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiCol" value="section2" checked onchange="renderWikiChecklistPreview()"> ì„¹ì…˜2</label>
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiCol" value="title" checked onchange="renderWikiChecklistPreview()"> íƒ€ì´í‹€</label>
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiCol" value="result" checked onchange="renderWikiChecklistPreview()"> ê²°ê³¼</label>
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiCol" value="bug" onchange="renderWikiChecklistPreview()"> ë²„ê·¸</label>
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiCol" value="comment" onchange="renderWikiChecklistPreview()"> ì°¸ê³ (ì½”ë©˜íŠ¸)</label>
                        </div>
                        <div style="display:flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; color:#666; font-size:0.9rem;">
                            <span style="font-weight:600; color:#333;">í¬í•¨ ìƒíƒœ:</span>
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiStatus" value="pass" checked onchange="renderWikiChecklistPreview()"> Pass</label>
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiStatus" value="fail" checked onchange="renderWikiChecklistPreview()"> Fail</label>
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiStatus" value="blocked" checked onchange="renderWikiChecklistPreview()"> Blocked</label>
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiStatus" value="retest" checked onchange="renderWikiChecklistPreview()"> Retest</label>
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiStatus" value="na" checked onchange="renderWikiChecklistPreview()"> N/A</label>
                            <label style="display:flex; align-items:center; gap:0.35rem;"><input type="checkbox" class="wikiStatus" value="notrun" checked onchange="renderWikiChecklistPreview()"> ë¯¸ì‹¤í–‰</label>
                        </div>
                        <div style="max-height: 280px; overflow:auto; background:#fff; border:1px solid #eee; border-radius: 6px;">
                            <table style="width:100%; border-collapse: collapse;">
                                <thead id="wikiChecklistHead" style="position: sticky; top: 0; background:#fafafa; border-bottom: 1px solid #eee;"></thead>
                                <tbody id="wikiChecklistBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div style="background:#f8f9fa; border:1px solid #e0e0e0; border-radius: 8px; padding: 0.9rem;">
                        <h4 style="margin:0 0 0.5rem 0;">ìœ„í‚¤ ë§í¬</h4>
                        <input id="wikiLink" class="form-control" placeholder="ì˜ˆ: Confluence í˜ì´ì§€ URL (pageId í¬í•¨ ì‹œ ì„œë²„ ì—…ë¡œë“œ ì‹œë„ ê°€ëŠ¥)" />
                        <div style="display:flex; gap:0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="downloadWikiMarkdown()">â¬‡ï¸ MD ë‹¤ìš´ë¡œë“œ</button>
                            <button class="btn btn-secondary" onclick="downloadWikiPDF()">â¬‡ï¸ PDF(í”„ë¦°íŠ¸) ë‹¤ìš´ë¡œë“œ</button>
                            <button class="btn btn-success" onclick="publishWikiDraft()">ğŸ“¤ ìœ„í‚¤ë¡œ ë‚´ë³´ë‚´ê¸°</button>
                        </div>
                        <div style="margin-top:0.75rem;">
                            <h4 style="margin:0 0 0.5rem 0;">ë¯¸ë¦¬ë³´ê¸°(Markdown)</h4>
                            <pre id="wikiPreview" style="white-space: pre-wrap; background:#fff; border:1px solid #eee; border-radius: 6px; padding: 0.75rem; max-height: 260px; overflow:auto; margin:0;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="padding: 0.9rem 1.25rem; border-top: 1px solid #e0e0e0; display:flex; justify-content: space-between; align-items:center; gap: 0.75rem;">
            <small style="color:#666;">
                íŒ: â€œğŸ“‹ ë³µì‚¬â€ í›„ ìœ„í‚¤ í¸ì§‘ê¸°ì— ë¶™ì—¬ë„£ìœ¼ë©´ ê°€ì¥ ë¹ ë¦…ë‹ˆë‹¤. (ì„œë²„ ìœ„í‚¤ ì—°ë™ì€ ì„ íƒ ì‚¬í•­)
            </small>
            <div style="display:flex; gap:0.5rem;">
                <button class="btn btn-secondary" onclick="closeWikiDraftModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ë‹¨ì¶•í‚¤ ê°€ì´ë“œ -->
<div class="hotkey-hint" id="hotkeyHint">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 0.5rem;">
        <h4 style="margin: 0; font-size: 0.95rem; color: #3498db;">âŒ¨ï¸ ë‹¨ì¶•í‚¤</h4>
        <button onclick="toggleHotkeyHint()" style="background: transparent; border: none; color: white; cursor: pointer; font-size: 1.2rem; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;" title="ì ‘ê¸°/í¼ì¹˜ê¸°">âˆ’</button>
    </div>
    <div id="hotkeyContent">
    <div class="shortcut-item">
        <span class="shortcut-desc">Pass</span>
        <span class="shortcut-key">1</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-desc">Fail</span>
        <span class="shortcut-key">2</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-desc">Blocked</span>
        <span class="shortcut-key">3</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-desc">Retest</span>
        <span class="shortcut-key">4</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-desc">N/A</span>
        <span class="shortcut-key">5</span>
    </div>
    <hr>
    <div class="shortcut-item">
        <span class="shortcut-desc">ë‹¤ìŒ ë¯¸ì‹¤í–‰</span>
        <span class="shortcut-key">n</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-desc">ì´ì „ ë¯¸ì‹¤í–‰</span>
        <span class="shortcut-key">p</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-desc">ë‹¤ìŒ/ì´ì „</span>
        <span class="shortcut-key">j / k</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-desc">ì²« ì¼€ì´ìŠ¤</span>
        <span class="shortcut-key">g</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-desc">ë§ˆì§€ë§‰ ì¼€ì´ìŠ¤</span>
        <span class="shortcut-key">Shift + G</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-desc">ëŸ° í†µê³„ ìƒˆë¡œê³ ì¹¨</span>
        <span class="shortcut-key">r</span>
    </div>
    <div class="shortcut-item">
        <span class="shortcut-desc">ì½”ë©˜íŠ¸ ë‹«ê¸°</span>
        <span class="shortcut-key">Esc</span>
    </div>
    </div>
</div>

<script>
const runId = {{ run.id }};
const isRunClosed = {{ 'true' if run.is_closed else 'false' }};
let runCases = {{ run_cases | tojson }};
let currentIndex = 0;
let autoRefreshInterval = null;
let isRefreshing = false;
let currentFilter = null; // í˜„ì¬ í•„í„° ìƒíƒœ
const runName = {{ run.name | tojson }};
const runBuildLabel = {{ (run.build_label or '') | tojson }};
const currentUserName = {{ (current_user.name if current_user.is_authenticated else '') | tojson }};

let jiraPublicConfig = null;

// Toast ì•Œë¦¼ í•¨ìˆ˜
function showToast(message, type = 'success', duration = 3000) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    // ì•„ì´ì½˜ ì„¤ì •
    let icon = 'âœ“';
    if (type === 'error') icon = 'âœ•';
    else if (type === 'warning') icon = 'âš ';
    else if (type === 'info') icon = 'â„¹';
    
    toast.innerHTML = `
        <span style="font-size: 1.2rem;">${icon}</span>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    // ìë™ ì œê±°
    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, duration);
}

// ì´ˆê¸° ì¼€ì´ìŠ¤ ë¡œë“œ
window.onload = function() {
    loadCase(0);
    loadJiraPublicConfig();
    if (!isRunClosed) {
        startAutoRefresh();
    }
    initResizer();
    loadSidebarWidth();
    loadPanelState();
    updateProgressBar();
    loadHotkeyHintState();
    
    // ì™„ë£Œëœ ëŸ°ì¸ ê²½ìš° ìš”ì•½ í”„ë¡¬í”„íŠ¸ ëª©ë¡ ë¡œë“œ
    if (isRunClosed) {
        loadSummaryPrompts();
    }
};

// ===== Export ë©”ë‰´ (CSV/ìœ„í‚¤) =====
function toggleExportMenu(e) {
    try { e?.stopPropagation(); } catch (_) {}
    const menu = document.getElementById('exportMenu');
    if (!menu) return;
    const isOpen = menu.style.display === 'block';
    menu.style.display = isOpen ? 'none' : 'block';
}
function closeExportMenu() {
    const menu = document.getElementById('exportMenu');
    if (menu) menu.style.display = 'none';
}
document.addEventListener('click', function() {
    closeExportMenu();
});

// ===== Wiki Draft Modal =====
function openWikiDraftModal() {
    const modal = document.getElementById('wikiDraftModal');
    if (!modal) return;
    modal.style.display = 'flex';
    initWikiDraftDefaults();
    renderWikiRunStats();
    renderWikiChecklistPreview();
    updateWikiPreview();
    // ë„ë„›ì€ canvasê°€ ë³´ì´ëŠ” ìƒíƒœì—ì„œ ê·¸ë ¤ì•¼ ì„ ëª…í•¨
    setTimeout(() => renderWikiDonutChart(), 0);
}
function closeWikiDraftModal() {
    const modal = document.getElementById('wikiDraftModal');
    if (modal) modal.style.display = 'none';
}
document.getElementById('wikiDraftModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeWikiDraftModal();
});

function initWikiDraftDefaults() {
    // ì´ë¯¸ ì‚¬ìš©ìê°€ ì…ë ¥í–ˆìœ¼ë©´ ë®ì–´ì“°ì§€ ì•ŠìŒ
    const envEl = document.getElementById('wikiQaEnv');
    if (envEl && !envEl.value) {
        envEl.value = runBuildLabel ? `Build: ${runBuildLabel}` : '';
    }
    const ownerEl = document.getElementById('wikiQaOwner');
    if (ownerEl && !ownerEl.value) {
        ownerEl.value = currentUserName || '';
    }

    // ì”ì—¬ ì´ìŠˆ ê¸°ë³¸ê°’: ëŸ° ê²°ê³¼ì˜ bug_linksë¥¼ ì¤‘ë³µ ì œê±°í•˜ì—¬ ì±„ì›€(ì‚¬ìš©ì ì…ë ¥ ì—†ì„ ë•Œë§Œ)
    const remainingEl = document.getElementById('wikiRemainingIssues');
    if (remainingEl && !remainingEl.value) {
        const links = extractBugLinksFromRunCases();
        if (links.length) remainingEl.value = links.map(l => `- ${l}`).join('\n');
    }
}

function getWikiStatusKey(rc) {
    const st = rc?.result?.status;
    if (!st) return 'notrun';
    const s = String(st).toLowerCase();
    if (['pass','fail','blocked','retest','na'].includes(s)) return s;
    return s;
}

function computeWikiStats() {
    const counts = { pass:0, fail:0, blocked:0, retest:0, na:0, notrun:0, total:0, executed:0 };
    counts.total = runCases.length;
    runCases.forEach(rc => {
        const key = getWikiStatusKey(rc);
        if (counts[key] == null) counts[key] = 0;
        counts[key] += 1;
        if (key !== 'notrun') counts.executed += 1;
    });
    return counts;
}

function renderWikiRunStats() {
    const tbody = document.getElementById('wikiResultStatsTable');
    if (!tbody) return;
    const c = computeWikiStats();
    const rows = [
        ['Total', c.total],
        ['Executed', c.executed],
        ['Pass', c.pass],
        ['Fail', c.fail],
        ['Blocked', c.blocked],
        ['Retest', c.retest],
        ['N/A', c.na],
        ['NotRun', c.notrun],
    ];
    tbody.innerHTML = rows.map(([k,v]) => (
        `<tr><td style="padding:0.35rem; border-bottom:1px solid #f0f0f0;">${k}</td><td style="padding:0.35rem; text-align:right; border-bottom:1px solid #f0f0f0;">${v}</td></tr>`
    )).join('');
}

function renderWikiDonutChart() {
    const canvas = document.getElementById('wikiDonutChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    const c = computeWikiStats();
    const data = [
        { key:'pass', label:'Pass', value:c.pass, color:'#27ae60' },
        { key:'fail', label:'Fail', value:c.fail, color:'#e74c3c' },
        { key:'blocked', label:'Blocked', value:c.blocked, color:'#95a5a6' },
        { key:'retest', label:'Retest', value:c.retest, color:'#f39c12' },
        { key:'na', label:'N/A', value:c.na, color:'#bdc3c7' },
        { key:'notrun', label:'NotRun', value:c.notrun, color:'#dddddd' },
    ].filter(d => d.value > 0);

    const total = data.reduce((a, d) => a + d.value, 0) || 1;
    const cx = canvas.width / 2, cy = canvas.height / 2;
    const rOuter = Math.min(cx, cy) - 8;
    const rInner = rOuter * 0.62;

    ctx.clearRect(0,0,canvas.width, canvas.height);
    let start = -Math.PI / 2;
    data.forEach(d => {
        const ang = (d.value / total) * Math.PI * 2;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, rOuter, start, start + ang);
        ctx.closePath();
        ctx.fillStyle = d.color;
        ctx.fill();
        start += ang;
    });
    // inner hole
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalCompositeOperation = 'source-over';

    // center text
    const passRate = Math.round((c.pass / Math.max(1, c.executed)) * 100);
    ctx.fillStyle = '#333';
    ctx.font = 'bold 18px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(`${passRate}%`, cx, cy - 6);
    ctx.font = '12px Arial';
    ctx.fillStyle = '#666';
    ctx.fillText('Pass Rate', cx, cy + 12);
}

function extractBugLinksFromRunCases() {
    const links = new Set();
    runCases.forEach(rc => {
        const bl = rc?.result?.bug_links;
        if (bl && String(bl).trim()) {
            // ì½¤ë§ˆ/ê³µë°±/ì¤„ë°”ê¿ˆ ê¸°ë°˜ìœ¼ë¡œ ë¶„ë¦¬
            String(bl).split(/[\s,]+/).map(s => s.trim()).filter(Boolean).forEach(x => links.add(x));
        }
    });
    return Array.from(links);
}

function getSelectedWikiCols() {
    return Array.from(document.querySelectorAll('.wikiCol'))
        .filter(el => el.checked)
        .map(el => el.value);
}
function getSelectedWikiStatuses() {
    return new Set(Array.from(document.querySelectorAll('.wikiStatus'))
        .filter(el => el.checked)
        .map(el => el.value));
}

function splitSectionPath(path) {
    if (!path) return { section1:'', section2:'' };
    const parts = String(path).split('>').map(s => s.trim()).filter(Boolean);
    return {
        section1: parts[0] || '',
        section2: parts[1] || '',
    };
}

function renderWikiChecklistPreview() {
    const head = document.getElementById('wikiChecklistHead');
    const body = document.getElementById('wikiChecklistBody');
    if (!head || !body) return;

    const cols = getSelectedWikiCols();
    const statusSet = getSelectedWikiStatuses();

    const colTitles = {
        section1: 'ì„¹ì…˜1',
        section2: 'ì„¹ì…˜2',
        title: 'íƒ€ì´í‹€',
        result: 'ê²°ê³¼',
        bug: 'ë²„ê·¸',
        comment: 'ì°¸ê³ ',
    };

    head.innerHTML = `<tr>${cols.map(c => `<th style="text-align:left; padding:0.5rem; border-bottom:1px solid #eee;">${colTitles[c] || c}</th>`).join('')}</tr>`;

    const rows = [];
    runCases.forEach(rc => {
        const st = getWikiStatusKey(rc);
        if (!statusSet.has(st)) return;
        const sec = splitSectionPath(rc?.case?.section_path);
        const title = rc?.case?.title || '';
        const bug = rc?.result?.bug_links || '';
        const comment = rc?.result?.comment || rc?.sidebar_comment || '';

        const cell = (key) => {
            if (key === 'section1') return sec.section1;
            if (key === 'section2') return sec.section2;
            if (key === 'title') return title;
            if (key === 'result') return st;
            if (key === 'bug') return bug;
            if (key === 'comment') return comment;
            return '';
        };
        rows.push(`<tr>${cols.map(k => `<td style="padding:0.45rem; border-bottom:1px solid #f0f0f0; vertical-align: top;">${escapeHtml(String(cell(k) || ''))}</td>`).join('')}</tr>`);
    });
    body.innerHTML = rows.join('') || `<tr><td style="padding:0.75rem; color:#999;" colspan="${Math.max(1, cols.length)}">í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    updateWikiPreview();
}

function escapeHtml(text) {
    const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
    return String(text || '').replace(/[&<>"']/g, m => map[m]);
}

function collectWikiDraft() {
    const c = computeWikiStats();
    const qaTarget = document.getElementById('wikiQaTarget')?.value || '';
    const planDoc = document.getElementById('wikiPlanDoc')?.value || '';
    const qaEnv = document.getElementById('wikiQaEnv')?.value || '';
    const targetUpdate = document.getElementById('wikiTargetUpdate')?.value || '';
    const qaOwner = document.getElementById('wikiQaOwner')?.value || '';
    const remaining = document.getElementById('wikiRemainingIssues')?.value || '';
    const closed = document.getElementById('wikiClosedIssues')?.value || '';
    const notes = document.getElementById('wikiNotes')?.value || '';
    const wikiLink = document.getElementById('wikiLink')?.value || '';

    const cols = getSelectedWikiCols();
    const statusSet = getSelectedWikiStatuses();
    const checklistRows = runCases
        .filter(rc => statusSet.has(getWikiStatusKey(rc)))
        .map(rc => {
            const sec = splitSectionPath(rc?.case?.section_path);
            return {
                section1: sec.section1,
                section2: sec.section2,
                title: rc?.case?.title || '',
                result: getWikiStatusKey(rc),
                bug: rc?.result?.bug_links || '',
                comment: rc?.result?.comment || rc?.sidebar_comment || '',
            };
        });

    return {
        run: { name: runName, build_label: runBuildLabel },
        qa_info: { qa_target: qaTarget, plan_doc: planDoc, qa_env: qaEnv, target_update: targetUpdate, qa_owner: qaOwner },
        stats: c,
        qa_status: { remaining_issues: remaining, closed_issues: closed, notes: notes },
        checklist: { cols, rows: checklistRows },
        wiki_link: wikiLink,
    };
}

function generateWikiMarkdown(d) {
    const now = new Date();
    const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
    const runTitle = d?.run?.name || runName;
    const build = d?.run?.build_label || '';
    const s = d?.stats || computeWikiStats();
    const passRate = Math.round((s.pass / Math.max(1, s.executed)) * 100);

    const qa = d?.qa_info || {};
    const qs = d?.qa_status || {};

    const md = [];
    md.push(`# QA Wiki Draft`);
    md.push(`- Run: **${runTitle}**`);
    if (build) md.push(`- Build: **${build}**`);
    md.push(`- Date: ${dateStr}`);
    md.push('');

    md.push(`## 1. QA ì •ë³´`);
    md.push(`| í•­ëª© | ë‚´ìš© |`);
    md.push(`|---|---|`);
    md.push(`| 1-1. QA ëŒ€ìƒ (JIRA) | ${qa.qa_target || ''} |`);
    md.push(`| 1-2. ê¸°íš ë¬¸ì„œ | ${qa.plan_doc || ''} |`);
    md.push(`| 1-3. QA í™˜ê²½ | ${qa.qa_env || ''} |`);
    md.push(`| 1-4. íƒ€ê²Ÿ ì—…ë°ì´íŠ¸ | ${qa.target_update || ''} |`);
    md.push(`| 1-5. ë‹´ë‹¹ QA | ${qa.qa_owner || ''} |`);
    md.push('');

    md.push(`## 2. QA ê²°ê³¼/í˜„í™©`);
    md.push(`| 2-1. í…ŒìŠ¤íŠ¸ ê²°ê³¼ |`);
    md.push(`|---|`);
    md.push(`| Total ${s.total} / Executed ${s.executed} / Pass ${s.pass} / Fail ${s.fail} / Blocked ${s.blocked} / Retest ${s.retest} / N/A ${s.na} / NotRun ${s.notrun} (PassRate ${passRate}%) |`);
    md.push('');

    md.push(`| 2-2. ì”ì—¬ ì´ìŠˆ |`);
    md.push(`|---|`);
    md.push(`| ${normalizeMultilineCell(qs.remaining_issues || '')} |`);
    md.push('');

    md.push(`| 2-3. Closed í‹°ì¼“(ê¸°íšì˜ë„/ìˆ˜ì •ì•ˆí•¨ ë“±) |`);
    md.push(`|---|`);
    md.push(`| ${normalizeMultilineCell(qs.closed_issues || '')} |`);
    md.push('');

    md.push(`| 2-4. ê¸°íƒ€ ì°¸ê³ ì‚¬í•­ |`);
    md.push(`|---|`);
    md.push(`| ${normalizeMultilineCell(qs.notes || '')} |`);
    md.push('');

    md.push(`## 3. ì²´í¬ë¦¬ìŠ¤íŠ¸`);
    const cols = d?.checklist?.cols || getSelectedWikiCols();
    const rows = d?.checklist?.rows || [];
    const colTitle = { section1:'ì„¹ì…˜1', section2:'ì„¹ì…˜2', title:'íƒ€ì´í‹€', result:'ê²°ê³¼', bug:'ë²„ê·¸', comment:'ì°¸ê³ ' };
    md.push(`| ${cols.map(c => colTitle[c] || c).join(' | ')} |`);
    md.push(`| ${cols.map(() => '---').join(' | ')} |`);
    rows.forEach(r => {
        md.push(`| ${cols.map(c => sanitizeMdCell(r[c] || '')).join(' | ')} |`);
    });
    md.push('');

    if (d?.wiki_link) {
        md.push(`---`);
        md.push(`Wiki Link: ${d.wiki_link}`);
        md.push('');
    }

    return md.join('\n');
}

function sanitizeMdCell(v) {
    return String(v || '').replace(/\r?\n/g, '<br>').replace(/\|/g, '\\|');
}
function normalizeMultilineCell(v) {
    const s = String(v || '').trim();
    if (!s) return '';
    return s.replace(/\r?\n/g, '<br>').replace(/\|/g, '\\|');
}

function updateWikiPreview() {
    const pre = document.getElementById('wikiPreview');
    if (!pre) return;
    const md = generateWikiMarkdown(collectWikiDraft());
    pre.textContent = md;
}

function downloadWikiMarkdown() {
    const md = generateWikiMarkdown(collectWikiDraft());
    const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `run_${runId}_${(runName || 'wiki').replace(/[\\/:*?"<>|]/g, '_')}.md`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 2000);
    showToast('MD íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.', 'success');
}

function downloadWikiPDF() {
    // ë¸Œë¼ìš°ì € Print to PDF ë°©ì‹(ì¶”ê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ ë™ì‘)
    const md = generateWikiMarkdown(collectWikiDraft());
    const w = window.open('', '_blank');
    if (!w) {
        showToast('íŒì—… ì°¨ë‹¨ìœ¼ë¡œ PDF ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    const html = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Wiki Draft - ${escapeHtml(runName)}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; }
    pre { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
    h1,h2 { margin: 0 0 12px 0; }
    .hint { color:#666; margin-bottom: 12px; }
  </style>
</head>
<body>
  <h2>Wiki Draft (Markdown)</h2>
  <div class="hint">ì¸ì‡„ ëŒ€í™”ìƒìì—ì„œ â€œPDFë¡œ ì €ì¥â€ì„ ì„ íƒí•˜ì„¸ìš”.</div>
  <pre>${escapeHtml(md)}</pre>
</body>
</html>`;
    w.document.open();
    w.document.write(html);
    w.document.close();
    // NOTE: ìƒˆ ì°½ HTML ë‚´ë¶€ì— "</scr" + "ipt>" ê°™ì€ ì‹œí€€ìŠ¤ê°€ í¬í•¨ë˜ë©´ ë¶€ëª¨ ë¬¸ì„œì˜ script íƒœê·¸ê°€ ëŠê¸¸ ìˆ˜ ìˆì–´, ì—¬ê¸°ì„œ printë¥¼ í˜¸ì¶œ
    try {
        w.focus();
        setTimeout(() => {
            try { w.print(); } catch (_) {}
        }, 150);
    } catch (_) {}
}

async function copyWikiMarkdownToClipboard() {
    const md = generateWikiMarkdown(collectWikiDraft());
    try {
        await navigator.clipboard.writeText(md);
        showToast('ìœ„í‚¤ ì´ˆì•ˆ(Markdown)ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    } catch (e) {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = md;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        showToast('í´ë¦½ë³´ë“œ ë³µì‚¬(ëŒ€ì²´ ë°©ì‹) ì™„ë£Œ.', 'success');
    }
}

async function publishWikiDraft() {
    const d = collectWikiDraft();
    const wikiUrl = (d.wiki_link || '').trim();
    const md = generateWikiMarkdown(d);
    if (!wikiUrl) {
        showToast('ìœ„í‚¤ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
        return;
    }

    // ìš°ì„  ì„œë²„ ì—…ë¡œë“œ ì‹œë„(ì„¤ì • ì—†ìœ¼ë©´ 501ë¡œ ì•ˆë‚´)
    try {
        const res = await fetch(`/api/runs/${runId}/wiki-draft/publish`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wiki_url: wikiUrl, markdown: md, title: `QA Wiki Draft - ${runName}` })
        });
        if (res.ok) {
            showToast('ìœ„í‚¤ë¡œ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ(ì„œë²„ ì—…ë¡œë“œ).', 'success');
            window.open(wikiUrl, '_blank');
            return;
        }
        const j = await res.json().catch(() => ({}));
        if (res.status === 501) {
            // ì„œë²„ ì—°ë™ ì—†ìœ¼ë©´: ë³µì‚¬ + ìœ„í‚¤ ì—´ê¸° fallback
            await copyWikiMarkdownToClipboard();
            window.open(wikiUrl, '_blank');
            showToast('ì„œë²„ ìœ„í‚¤ ì—°ë™ì´ ì—†ì–´ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ë°©ì‹ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.', 'info', 5000);
            return;
        }
        showToast(j.error || 'ìœ„í‚¤ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨', 'error', 5000);
    } catch (e) {
        await copyWikiMarkdownToClipboard();
        window.open(wikiUrl, '_blank');
        showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì„œë²„ ì—…ë¡œë“œ ì‹¤íŒ¨. ë³µì‚¬/ë¶™ì—¬ë„£ê¸°ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.', 'warning', 5000);
    }
}

async function aiFillWikiDraft() {
    const stats = computeWikiStats();
    const test_results = runCases.map(rc => ({
        case_title: rc?.case?.title || '',
        status: getWikiStatusKey(rc),
        bug_links: rc?.result?.bug_links || '',
        comment: rc?.result?.comment || rc?.sidebar_comment || '',
    }));

    try {
        const res = await fetch(`/api/runs/${runId}/wiki-draft/ai-fill`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                current_page_data: {
                    run_name: runName,
                    build_label: runBuildLabel,
                    stats: stats,
                    test_results: test_results
                }
            })
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok) {
            showToast(j.error || 'AI ì‘ì„± ì‹¤íŒ¨', 'error', 5000);
            return;
        }

        const remainingEl = document.getElementById('wikiRemainingIssues');
        const closedEl = document.getElementById('wikiClosedIssues');
        const notesEl = document.getElementById('wikiNotes');
        if (remainingEl && j.remaining_issues) remainingEl.value = j.remaining_issues;
        if (closedEl && j.closed_issues) closedEl.value = j.closed_issues;
        if (notesEl && j.notes) notesEl.value = j.notes;

        updateWikiPreview();
        showToast('AI ì‘ì„± ì™„ë£Œ: ì‘ì„± ê°€ëŠ¥í•œ í•­ëª©ì„ ì±„ì› ìŠµë‹ˆë‹¤.', 'success');
    } catch (e) {
        showToast('AI ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error', 5000);
    }
}

// íŒ¨ë„ í† ê¸€ í•¨ìˆ˜
function togglePanel() {
    const panel = document.getElementById('caseDetailPanel');
    const layout = document.querySelector('.run-execute-layout');
    const sidebar = document.getElementById('runCasesSidebar');
    const sideBtn = document.getElementById('panelToggleBtn');
    const topBtn = document.getElementById('topPanelToggleBtn');
    const topIcon = document.getElementById('topPanelToggleIcon');
    const isCollapsed = panel.classList.toggle('collapsed');
    
    // ë ˆì´ì•„ì›ƒì—ë„ í´ë˜ìŠ¤ ì¶”ê°€ (ì¼€ì´ìŠ¤ ëª©ë¡ í™•ì¥ìš©)
    if (layout) {
        if (isCollapsed) {
            layout.classList.add('panel-collapsed');
        } else {
            layout.classList.remove('panel-collapsed');
        }
    }
    
    // ì‚¬ì´ë“œë°” ë„ˆë¹„ ì¡°ì •
    if (sidebar) {
        if (isCollapsed) {
            // íŒ¨ë„ ì ‘ê¸°: ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì œê±°í•˜ì—¬ CSSê°€ ì ìš©ë˜ë„ë¡ í•¨
            sidebar.style.flex = '';
        } else {
            // íŒ¨ë„ í¼ì¹˜ê¸°: ì €ì¥ëœ ë„ˆë¹„ ë³µì›
            const savedWidth = localStorage.getItem('runExecuteSidebarWidth');
            if (savedWidth) {
                sidebar.style.flex = `0 0 ${savedWidth}px`;
            } else {
                sidebar.style.flex = '1'; // ê¸°ë³¸ê°’
            }
        }
    }
    
    // ì‚¬ì´ë“œ ë²„íŠ¼ ì—…ë°ì´íŠ¸
    if (sideBtn) {
        sideBtn.textContent = isCollapsed ? 'â–¶' : 'â—€';
    }
    
    // ìƒë‹¨ ë²„íŠ¼ ì—…ë°ì´íŠ¸
    if (topIcon) {
        topIcon.textContent = isCollapsed ? 'â–¶' : 'â—€';
    }
    
    // ìƒíƒœ ì €ì¥
    localStorage.setItem('detailPanelCollapsed', isCollapsed);
}

// íŒ¨ë„ ìƒíƒœ ë¡œë“œ
function loadPanelState() {
    const isCollapsed = localStorage.getItem('detailPanelCollapsed') === 'true';
    if (isCollapsed) {
        const panel = document.getElementById('caseDetailPanel');
        const layout = document.querySelector('.run-execute-layout');
        const sidebar = document.getElementById('runCasesSidebar');
        const sideBtn = document.getElementById('panelToggleBtn');
        const topIcon = document.getElementById('topPanelToggleIcon');
        
        panel.classList.add('collapsed');
        
        if (layout) {
            layout.classList.add('panel-collapsed');
        }
        
        // ì‚¬ì´ë“œë°” ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì œê±°í•˜ì—¬ CSSê°€ ì ìš©ë˜ë„ë¡ í•¨
        if (sidebar) {
            sidebar.style.flex = '';
        }
        
        if (sideBtn) {
            sideBtn.textContent = 'â–¶';
        }
        
        if (topIcon) {
            topIcon.textContent = 'â–¶';
        }
    }
}

// ë’¤ë¡œê°€ê¸° - ëŸ° ëª©ë¡ìœ¼ë¡œ ì´ë™
function goBackToRuns() {
    const projectId = {{ run.project_id }};
    window.location.href = `/p/${projectId}/runs`;
}

// í…ŒìŠ¤íŠ¸ëŸ° ì™„ë£Œ
function completeRun() {
    if (isRunClosed) {
        alert('ì´ë¯¸ ì™„ë£Œëœ ëŸ°ì…ë‹ˆë‹¤.');
        return;
    }
    
    if (!confirm('í…ŒìŠ¤íŠ¸ëŸ°ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì™„ë£Œëœ ëŸ°ì€ "ì™„ë£Œëœ ëŸ°" íƒ­ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤.')) {
        return;
    }
    
    fetch(`/api/runs/{{ run.id }}/close`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('í…ŒìŠ¤íŠ¸ëŸ°ì´ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            goBackToRuns();
        } else {
            alert('ì˜¤ë¥˜: ' + (data.error || 'í…ŒìŠ¤íŠ¸ëŸ° ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('í…ŒìŠ¤íŠ¸ëŸ° ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ëª¨ë“  ê²°ê³¼ ì´ˆê¸°í™”
function resetAllResults() {
    if (isRunClosed) {
        alert('ì™„ë£Œëœ ëŸ°ì€ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    if (!confirm('ëª¨ë“  í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }
    
    fetch(`/api/runs/${runId}/reset`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // ëª¨ë“  ì¼€ì´ìŠ¤ ê²°ê³¼ ì´ˆê¸°í™”
            runCases.forEach((item, index) => {
                item.result = null;
                
                // ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                const sidebarItem = document.querySelectorAll('.run-case-item')[index];
                sidebarItem.classList.remove('status-pass', 'status-fail', 'status-blocked', 'status-retest', 'status-na');
                
                // ê²°ê³¼ ë°°ì§€ ì—…ë°ì´íŠ¸
                const badge = sidebarItem.querySelector('.result-badge');
                if (badge) {
                    badge.className = 'result-badge result-none';
                    badge.style.padding = '0.15rem 0.5rem';
                    badge.style.borderRadius = '4px';
                    badge.style.fontWeight = '600';
                    badge.style.fontSize = '0.75rem';
                    badge.textContent = 'ë¯¸ì‹¤í–‰';
                }
            });
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            updateRunStats();
            
            // í˜„ì¬ ì¼€ì´ìŠ¤ ë‹¤ì‹œ ë¡œë“œ
            loadCase(currentIndex);
            
            alert('ëª¨ë“  ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            alert('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    })
    .catch(err => {
        console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
        alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function selectCase(index) {
    currentIndex = index;
    loadCase(index);
    
    // ì‚¬ì´ë“œë°” í™œì„±í™” í‘œì‹œ ë° ìŠ¤í¬ë¡¤
    const sidebar = document.getElementById('runCasesSidebar');
    const items = document.querySelectorAll('.run-case-item');
    
    items.forEach((item, i) => {
        if (i === index) {
            item.classList.add('active');
            
            // ì„ íƒëœ ì¼€ì´ìŠ¤ ìœ„ì¹˜ ê³„ì‚°
            const itemTop = item.offsetTop;
            const itemHeight = item.offsetHeight;
            
            // ì²« ë²ˆì§¸ ì¼€ì´ìŠ¤: ë§¨ ìœ„ì— í‘œì‹œ
            if (index === 0) {
                sidebar.scrollTop = 0;
            }
            // ë‘ ë²ˆì§¸ ì´í›„ ì¼€ì´ìŠ¤: í•­ìƒ ë‘ ë²ˆì§¸ ìœ„ì¹˜ì— í‘œì‹œ
            else {
                // ì²« ë²ˆì§¸ ì•„ì´í…œì˜ ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‘ ë²ˆì§¸ ìœ„ì¹˜ ê³„ì‚°
                const firstItemHeight = items[0] ? items[0].offsetHeight : itemHeight;
                const headerHeight = 60; // h4 í—¤ë” ë†’ì´ + ì—¬ìœ 
                
                // ì„ íƒëœ ì¼€ì´ìŠ¤ê°€ ë‘ ë²ˆì§¸ ìœ„ì¹˜ì— ì˜¤ë„ë¡ ìŠ¤í¬ë¡¤
                // (í—¤ë” ë†’ì´ + ì²« ë²ˆì§¸ ì•„ì´í…œ ë†’ì´)ë§Œí¼ ìœ„ë¡œ ì˜¬ë¦¼
                sidebar.scrollTop = itemTop - headerHeight - firstItemHeight;
            }
        } else {
            item.classList.remove('active');
        }
    });
}

function loadCase(index) {
    const item = runCases[index];
    const caseData = item.case;
    const result = item.result;
    
    const html = `
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                <h3 contenteditable="${!isRunClosed}" id="caseTitle" 
                    style="border: 1px solid transparent; padding: 0.5rem; border-radius: 4px; outline: none; flex: 1;" 
                    ${!isRunClosed ? `onblur="updateCaseField('title', this.textContent.trim())"
                    onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                    onblur="this.style.border='1px solid transparent'; this.style.background='transparent';"` : ''}>
${escapeHtml(caseData.title)}</h3>
                <span style="padding: 0.25rem 0.75rem; background: #e3f2fd; color: #1976d2; border-radius: 12px; font-size: 0.85rem; white-space: nowrap; margin-left: 0.5rem; cursor: help;" 
                      title="ìƒì„±: ${caseData.created_at ? new Date(caseData.created_at).toLocaleString('ko-KR') : 'N/A'}${caseData.created_by ? ' (' + caseData.created_by + ')' : ''}&#10;ìˆ˜ì •: ${caseData.updated_at ? new Date(caseData.updated_at).toLocaleString('ko-KR') : 'N/A'}${caseData.updated_by ? ' (' + caseData.updated_by + ')' : ''}">
                    v${caseData.version || 1}
                </span>
            </div>
            ${!isRunClosed ? '<small style="color: #999;">ğŸ’¡ í´ë¦­í•˜ì—¬ í¸ì§‘ ê°€ëŠ¥ (ì›ë³¸ ì¼€ì´ìŠ¤ì— ë°˜ì˜ë©ë‹ˆë‹¤)</small>' : '<small style="color: #999;">ğŸ”’ ì™„ë£Œëœ ëŸ° - ëŸ° ìƒì„± ì‹œì ì˜ ì¼€ì´ìŠ¤ ë‚´ìš© (v' + (caseData.version || 1) + ')</small>'}
        </div>
        
        <div style="margin: 1rem 0; padding: 1rem; background: #f9f9f9; border-radius: 4px;">
            <strong>ìš°ì„ ìˆœìœ„:</strong> 
            <select id="casePriority" class="form-control" style="display: inline-block; width: auto; margin-left: 0.5rem;" 
                    ${isRunClosed ? 'disabled' : ''} onchange="updateCaseField('priority', this.value)">
                <option value="Blocker" ${caseData.priority === 'Blocker' ? 'selected' : ''}>Blocker</option>
                <option value="Critical" ${caseData.priority === 'Critical' ? 'selected' : ''}>Critical</option>
                <option value="High" ${caseData.priority === 'High' ? 'selected' : ''}>High</option>
                <option value="Medium" ${caseData.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                <option value="Low" ${caseData.priority === 'Low' ? 'selected' : ''}>Low</option>
            </select>
        </div>
        
        <div style="margin: 1.5rem 0;">
            <h4>í…ŒìŠ¤íŠ¸ ìŠ¤í… ${!isRunClosed ? '<small style="color: #999; font-weight: normal;">ğŸ’¡ í´ë¦­í•˜ì—¬ í¸ì§‘ ê°€ëŠ¥ (ì›ë³¸ ì¼€ì´ìŠ¤ì— ë°˜ì˜)</small>' : '<small style="color: #999; font-weight: normal;">ğŸ”’ ëŸ° ìƒì„± ì‹œì  ìŠ¤ëƒ…ìƒ·</small>'}</h4>
            <div contenteditable="${!isRunClosed}" id="caseSteps" 
                 style="white-space: pre-wrap; padding: 1rem; background: #f9f9f9; border-radius: 4px; border: 1px solid transparent; min-height: 100px; outline: none;"
                 ${!isRunClosed ? `onblur="updateCaseField('steps', this.textContent.trim())"
                 onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                 onblur="this.style.border='1px solid transparent'; this.style.background='#f9f9f9';"` : ''}>${escapeHtml(caseData.steps) || 'ìŠ¤í… ì •ë³´ ì—†ìŒ'}</div>
        </div>
        
        <div style="margin: 1.5rem 0;">
            <h4>ê¸°ëŒ€ ê²°ê³¼ ${!isRunClosed ? '<small style="color: #999; font-weight: normal;">ğŸ’¡ í´ë¦­í•˜ì—¬ í¸ì§‘ ê°€ëŠ¥ (ì›ë³¸ ì¼€ì´ìŠ¤ì— ë°˜ì˜)</small>' : '<small style="color: #999; font-weight: normal;">ğŸ”’ ëŸ° ìƒì„± ì‹œì  ìŠ¤ëƒ…ìƒ·</small>'}</h4>
            <div contenteditable="${!isRunClosed}" id="caseExpected" 
                 style="white-space: pre-wrap; padding: 1rem; background: #f9f9f9; border-radius: 4px; border: 1px solid transparent; min-height: 100px; outline: none;"
                 ${!isRunClosed ? `onblur="updateCaseField('expected_result', this.textContent.trim())"
                 onfocus="this.style.border='1px solid #3498db'; this.style.background='#f0f8ff';"
                 onblur="this.style.border='1px solid transparent'; this.style.background='#f9f9f9';"` : ''}>${escapeHtml(caseData.expected) || 'ê¸°ëŒ€ ê²°ê³¼ ì •ë³´ ì—†ìŒ'}</div>
        </div>
        
        <hr style="margin: 2rem 0;">
        
        <h4>ì¶”ê°€ ì •ë³´</h4>

        <!-- Jira ì›ë²„íŠ¼ ë²„ê·¸ ë“±ë¡ (ìš”ì²­: ì¶”ê°€ ì •ë³´ ì˜ì—­ ì²«ë²ˆì§¸) -->
        <div style="margin: 1rem 0; display: flex; align-items: center; justify-content: space-between; gap: 0.75rem;">
            <div style="min-width: 0;">
                <label class="form-label" style="font-weight: 500; margin-bottom: 0.25rem; display: block;">ğŸ§· Jira</label>
                <small style="color: #666; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ì›ë²„íŠ¼ìœ¼ë¡œ Jira ë²„ê·¸ë¥¼ ìƒì„±í•˜ê³  ë§í¬ë¥¼ ìë™ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤. (ì„¤ì •: /settings â†’ Jira ì›ë²„íŠ¼)
                </small>
            </div>
            <button type="button" class="btn btn-danger" onclick="openJiraIssueModal()" style="padding: 0.5rem 1rem; white-space: nowrap;">
                ğŸ› Jira ë²„ê·¸ ë“±ë¡
            </button>
        </div>
        
        <!-- Jira/ë²„ê·¸ ë§í¬ (ì¼€ì´ìŠ¤ ë§í¬ + ëŸ° ë²„ê·¸ ë§í¬ í†µí•©) -->
        <div style="margin: 1rem 0;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 0.5rem; display: block;">ğŸ§· Jira/ë²„ê·¸ ë§í¬</label>

            <div style="margin-bottom: 0.75rem;">
                <div style="font-weight: 500; color:#666; font-size:0.9rem; margin-bottom:0.35rem;">ì¼€ì´ìŠ¤ ë§í¬</div>
                <div style="display:flex; flex-direction:column; gap:0.35rem;">
                    ${(caseData.jira_links && caseData.jira_links.length > 0)
                        ? caseData.jira_links.map(u => `<a href="${escapeHtml(u)}" target="_blank" rel="noopener noreferrer" style="color:#3498db; text-decoration:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">ğŸ”— ${escapeHtml(u)}</a>`).join('')
                        : `<div style="color:#999; font-size:0.9rem;">ë“±ë¡ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`}
                    ${(isRunClosed && caseData.jira_links_snapshot) ? `<div style="color:#666; font-size:0.85rem;">(ìŠ¤ëƒ…ìƒ·) ${escapeHtml(caseData.jira_links_snapshot)}</div>` : ''}
                </div>
            </div>

            <div style="font-weight: 500; color:#666; font-size:0.9rem; margin-bottom:0.35rem;">ëŸ° ë²„ê·¸ ë§í¬</div>
            ${!isRunClosed ? `
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="bugLinkInput" class="form-control" placeholder="JIRA-123 ë˜ëŠ” https://..." 
                       style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                       onkeypress="if(event.key==='Enter'){event.preventDefault();addBugLink();}">
                <button type="button" class="btn btn-primary" onclick="addBugLink()" style="padding: 0.5rem 1rem; white-space: nowrap;">ì¶”ê°€</button>
            </div>
            ` : ''}
            <div id="bugLinksList" style="margin-top: 0.5rem;">
                <!-- ë²„ê·¸ ë§í¬ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
        
        <!-- ì½”ë©˜íŠ¸ ì˜ì—­ -->
        ${!isRunClosed ? `
        <div style="margin: 1rem 0;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 0.5rem; display: block;">ğŸ’¬ ì½”ë©˜íŠ¸</label>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <textarea id="commentInput" class="form-control" placeholder="í…ŒìŠ¤íŠ¸ ê²°ê³¼ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; min-height: 60px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                <button type="button" class="btn btn-primary" onclick="addComment()" style="padding: 0.5rem 1rem; white-space: nowrap; align-self: flex-start;">ì¶”ê°€</button>
            </div>
        </div>
        ` : ''}
        <div id="commentsList" style="margin: 1rem 0;">
            <!-- ì½”ë©˜íŠ¸ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
        
        <!-- ì²¨ë¶€íŒŒì¼ (ì¼€ì´ìŠ¤ ë¯¸ë””ì–´ + ëŸ° ì²¨ë¶€ í†µí•©) -->
        <div style="margin: 1rem 0;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 0.5rem; display: block;">ğŸ“ ì²¨ë¶€íŒŒì¼ (ì´ë¯¸ì§€/ë™ì˜ìƒ)</label>

            <div style="margin-bottom: 0.75rem;">
                <div style="font-weight: 500; color:#666; font-size:0.9rem; margin-bottom:0.35rem;">ì¼€ì´ìŠ¤ ë¯¸ë””ì–´</div>
                <div style="display:flex; flex-direction:column; gap:0.35rem;">
                    ${(caseData.media && caseData.media.length > 0)
                        ? caseData.media.map(m => `<a href="${escapeHtml(m.url)}" target="_blank" rel="noopener noreferrer" style="color:#3498db; text-decoration:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">ğŸ“ ${escapeHtml(m.original_name)}</a>`).join('')
                        : `<div style="color:#999; font-size:0.9rem;">ë“±ë¡ëœ ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`}
                    ${(isRunClosed && caseData.media_names_snapshot) ? `<div style="color:#666; font-size:0.85rem;">(ìŠ¤ëƒ…ìƒ·) ${escapeHtml(caseData.media_names_snapshot)}</div>` : ''}
                </div>
            </div>

            <div style="font-weight: 500; color:#666; font-size:0.9rem; margin-bottom:0.35rem;">ëŸ° ì²¨ë¶€</div>
            ${!isRunClosed ? `
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="file" id="attachments" class="form-control" multiple accept="image/*,video/*"
                       style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" class="btn btn-secondary" onclick="pasteFromClipboard()" style="padding: 0.5rem 1rem; white-space: nowrap;">
                    ğŸ“‹ í´ë¦½ë³´ë“œ
                </button>
            </div>
            <small style="color: #666; display: block; margin-top: 0.25rem;">ì´ë¯¸ì§€ ë˜ëŠ” ë™ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ í´ë¦½ë³´ë“œì—ì„œ ë¶™ì—¬ë„£ê¸° (Ctrl+V)</small>
            ` : ''}
            <div id="attachmentList" style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.35rem;"></div>
        </div>
        
        ${!isRunClosed ? `
        <hr style="margin: 1.5rem 0;">
        
        <h4>ê²°ê³¼ ê¸°ë¡</h4>
        
        <!-- ê°„ì†Œí™”ëœ ê²°ê³¼ ë²„íŠ¼ -->
        <div style="display: flex; gap: 0.5rem; margin: 1rem 0; flex-wrap: wrap;">
            <button class="status-btn pass" onclick="recordResult('pass')" style="flex: 1; min-width: 100px; padding: 0.6rem;">
                âœ“ Pass <kbd style="margin-left: 0.25rem;">1</kbd>
            </button>
            <button class="status-btn fail" onclick="recordResultWithModal('fail')" style="flex: 1; min-width: 100px; padding: 0.6rem;">
                âœ— Fail <kbd style="margin-left: 0.25rem;">2</kbd>
            </button>
            <button class="status-btn blocked" onclick="recordResultWithModal('blocked')" style="flex: 1; min-width: 100px; padding: 0.6rem;">
                âŠ˜ Blocked <kbd style="margin-left: 0.25rem;">3</kbd>
            </button>
            <button class="status-btn retest" onclick="recordResultWithModal('retest')" style="flex: 1; min-width: 100px; padding: 0.6rem;">
                â†» Retest <kbd style="margin-left: 0.25rem;">4</kbd>
            </button>
            <button class="status-btn na" onclick="recordResultWithModal('na')" style="flex: 1; min-width: 100px; padding: 0.6rem;">
                âˆ’ N/A <kbd style="margin-left: 0.25rem;">5</kbd>
            </button>
        </div>
        ` : ''}
        
        ${result ? `
            <hr style="margin: 2rem 0;">
            <h4>í…ŒìŠ¤íŠ¸ ê²°ê³¼ íˆìŠ¤í† ë¦¬</h4>
            <div id="resultHistory" style="margin: 1rem 0;">
                <div style="text-align: center; padding: 1rem; color: #999;">
                    íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
        ` : ''}
    `;
    
    document.getElementById('caseContent').innerHTML = html;
    
    // ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë¯¸ë¦¬ë³´ê¸° ì—†ì´ ì¦‰ì‹œ ì—…ë¡œë“œ)
    if (!isRunClosed) {
        const attachmentInput = document.getElementById('attachments');
        if (attachmentInput) {
            attachmentInput.addEventListener('change', async (e) => {
                const files = e.target.files ? Array.from(e.target.files) : [];
                await uploadSelectedAttachments(files);
            });
        }
    }
    
    // Phase 1 ê°œì„ : ë²„ê·¸ ë§í¬ ëª©ë¡ ë¡œë“œ (ì™„ë£Œëœ ëŸ°ì—ì„œë„)
    loadBugLinks();
    loadComments();
    loadAttachments();
    
    // ê²°ê³¼ê°€ ìˆìœ¼ë©´ íˆìŠ¤í† ë¦¬ ë¡œë“œ
    if (result) {
        loadResultHistory(caseData.id);
    }
}

// ë²„ê·¸ ë§í¬ ê´€ë¦¬ (Phase 1)
let bugLinksArray = [];

function loadBugLinks() {
    const item = runCases[currentIndex];
    const caseId = item.case.id;

    fetch(`/api/runs/${runId}/cases/${caseId}/bug-links`)
        .then(res => res.json())
        .then(data => {
            const bl = (data.bug_links || '').trim();
            bugLinksArray = bl ? bl.split(',').map(link => link.trim()).filter(link => link) : [];
            renderBugLinks();
        })
        .catch(err => {
            console.error('ë²„ê·¸ ë§í¬ ë¡œë“œ ì˜¤ë¥˜:', err);
            bugLinksArray = [];
            renderBugLinks();
        });
}

function renderBugLinks() {
    const container = document.getElementById('bugLinksList');
    if (!container) return;
    
    if (bugLinksArray.length === 0) {
        container.innerHTML = '<div style="color: #999; font-size: 0.9rem; padding: 0.5rem;">ë“±ë¡ëœ ë²„ê·¸ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    container.innerHTML = bugLinksArray.map((link, index) => {
        const isUrl = link.startsWith('http://') || link.startsWith('https://');
        const displayLink = isUrl ? link : 'https://jira.example.com/browse/' + link;
        
        const deleteButton = !isRunClosed ? 
            '<button type="button" onclick="removeBugLink(' + index + ')" ' +
            'style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.85rem; white-space: nowrap;">' +
            'ì‚­ì œ</button>' : '';
        
        return '<div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9f9f9; border-radius: 4px; margin-bottom: 0.5rem;">' +
            '<a href="' + (isUrl ? link : displayLink) + '" target="_blank" rel="noopener noreferrer" ' +
            'style="flex: 1; color: #3498db; text-decoration: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' +
            'ğŸ”— ' + escapeHtml(link) + '</a>' +
            deleteButton +
            '</div>';
    }).join('');
}

function addBugLink() {
    const input = document.getElementById('bugLinkInput');
    const link = input.value.trim();
    
    if (!link) {
        alert('ë²„ê·¸ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }
    
    bugLinksArray.push(link);
    input.value = '';
    renderBugLinks();
    
    showSaveNotification('âœ… ë²„ê·¸ ë§í¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ ì €ì¥ ì‹œ í•¨ê»˜ ì €ì¥ë©ë‹ˆë‹¤.');
}

function removeBugLink(index) {
    if (confirm('ì´ ë²„ê·¸ ë§í¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        bugLinksArray.splice(index, 1);
        renderBugLinks();
        showSaveNotification('âœ… ë²„ê·¸ ë§í¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ ì €ì¥ ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.');
    }
}

// ì½”ë©˜íŠ¸ ê´€ë¦¬ (Phase 1 ê°œì„ )
let commentsArray = [];  // {id, comment, executor, created_at} í˜•íƒœ

function loadComments() {
    const item = runCases[currentIndex];
    const caseId = item.case.id;
    
    // APIì—ì„œ ëª¨ë“  ì½”ë©˜íŠ¸ ë¡œë“œ
    fetch(`/api/runs/${runId}/cases/${caseId}/comments`)
        .then(res => res.json())
        .then(data => {
            commentsArray = data;  // ì „ì²´ ê°ì²´ ì €ì¥
            renderComments();
            
            // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸ (ìµœì‹  ì½”ë©˜íŠ¸ 1ê°œë§Œ í‘œì‹œ)
            const latestComment = data.length > 0 ? data[0].comment : null;
            updateSidebarItem(currentIndex, item.result ? item.result.status : null, latestComment);
        })
        .catch(err => {
            console.error('ì½”ë©˜íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', err);
            commentsArray = [];
            renderComments();
        });
}

function renderComments() {
    const container = document.getElementById('commentsList');
    if (!container) return;
    
    if (commentsArray.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    container.innerHTML = commentsArray.map((commentObj, index) => {
        const deleteButton = !isRunClosed ? 
            '<button type="button" onclick="removeComment(' + commentObj.id + ')" ' +
            'style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.85rem; white-space: nowrap;">' +
            'ì‚­ì œ</button>' : '';
        
        return '<div style="display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.75rem; background: #f9f9f9; border-left: 3px solid #3498db; border-radius: 4px; margin-bottom: 0.5rem;">' +
            '<div style="flex: 1; color: #333; white-space: pre-wrap; word-break: break-word;">' + escapeHtml(commentObj.comment) + '</div>' +
            deleteButton +
            '</div>';
    }).join('');
}

function addComment() {
    const input = document.getElementById('commentInput');
    const comment = input.value.trim();
    
    if (!comment) {
        alert('ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }
    
    const item = runCases[currentIndex];
    const caseId = item.case.id;
    
    // ì½”ë©˜íŠ¸ ì¦‰ì‹œ ì €ì¥
    fetch(`/api/runs/${runId}/comments`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            case_id: caseId,
            comment: comment
        })
    })
    .then(res => res.json())
    .then(data => {
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        input.value = '';
        
        // ì½”ë©˜íŠ¸ ë‹¤ì‹œ ë¡œë“œ
        loadComments();
        
        // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸ (ìµœì‹  ì½”ë©˜íŠ¸ 1ê°œë§Œ í‘œì‹œ)
        updateSidebarItem(currentIndex, item.result ? item.result.status : null, comment);
        
        showSaveNotification('âœ… ì½”ë©˜íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    })
    .catch(err => {
        console.error('ì½”ë©˜íŠ¸ ì €ì¥ ì˜¤ë¥˜:', err);
        alert('ì½”ë©˜íŠ¸ ì €ì¥ ì‹¤íŒ¨: ' + err);
    });
}

function removeComment(commentId) {
    if (confirm('ì´ ì½”ë©˜íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch(`/api/results/${commentId}`, {
            method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
            // ì½”ë©˜íŠ¸ ë‹¤ì‹œ ë¡œë“œ
            loadComments();
            showSaveNotification('âœ… ì½”ë©˜íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        })
        .catch(err => {
            console.error('ì½”ë©˜íŠ¸ ì‚­ì œ ì˜¤ë¥˜:', err);
            alert('ì½”ë©˜íŠ¸ ì‚­ì œ ì‹¤íŒ¨: ' + err);
        });
    }
}


function addBugLink() {
    const input = document.getElementById('bugLinkInput');
    if (!input) return;
    
    const link = input.value.trim();
    if (!link) {
        alert('ë²„ê·¸ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ì¤‘ë³µ ì²´í¬
    if (bugLinksArray.includes(link)) {
        alert('ì´ë¯¸ ë“±ë¡ëœ ë§í¬ì…ë‹ˆë‹¤.');
        return;
    }
    
    bugLinksArray.push(link);
    input.value = '';
    renderBugLinks();
    
    // ì„œë²„ì— ì €ì¥
    saveBugLinks();
}

function removeBugLink(index) {
    if (confirm('ì´ ë²„ê·¸ ë§í¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        bugLinksArray.splice(index, 1);
        renderBugLinks();
        
        // ì„œë²„ì— ì €ì¥
        saveBugLinks();
    }
}

async function saveBugLinks() {
    const item = runCases[currentIndex];
    const caseId = item.case.id;
    const bugLinksString = bugLinksArray.join(', ');
    
    try {
        const response = await fetch(`/api/runs/${runId}/cases/${caseId}/bug-links`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ bug_links: bugLinksString })
        });

        if (!response.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');

        // ë¡œì»¬ ë°ì´í„°ë„ ìœ ì§€(ê²°ê³¼ ì €ì¥ ì‹œ í•¨ê»˜ í¬í•¨ë˜ë„ë¡)
        const data = await response.json();
        if (item.result) {
            item.result.bug_links = data.bug_links || bugLinksString;
        }
        showSaveNotification('âœ… ë²„ê·¸ ë§í¬ ì €ì¥ ì™„ë£Œ');
    } catch (err) {
        console.error('ë²„ê·¸ ë§í¬ ì €ì¥ ì˜¤ë¥˜:', err);
        alert('ë²„ê·¸ ë§í¬ ì €ì¥ ì‹¤íŒ¨');
    }
}

async function loadAttachments() {
    const item = runCases[currentIndex];
    const caseId = item.case.id;
    const listEl = document.getElementById('attachmentList');
    if (!listEl) return;

    try {
        const res = await fetch(`/api/runs/${runId}/cases/${caseId}/attachments`);
        if (!res.ok) throw new Error('ì²¨ë¶€ ë¡œë“œ ì‹¤íŒ¨');
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
            listEl.innerHTML = '<div style="color:#999; font-size:0.9rem; padding:0.25rem 0;">ë“±ë¡ëœ ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        listEl.innerHTML = data.map(a => {
            const url = `/api/attachments/${a.id}`;
            const downloadUrl = `/api/attachments/${a.id}?download=1`;
            const safeName = escapeHtml(a.original_name || '');
            return `
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <a href="${url}" data-name="${safeName}" onclick="return previewAttachment(event, ${a.id})"
                       style="flex:1; display:inline-flex; align-items:center; gap:0.35rem; padding:0.45rem 0.6rem; border:1px solid #eee; border-radius:6px; background:#fafafa; text-decoration:none; color:#3498db; min-width:0;">
                        <span>ğŸ“</span>
                        <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(a.original_name || ('attachment#' + a.id))}</span>
                    </a>
                    <a href="${downloadUrl}" title="ë‹¤ìš´ë¡œë“œ"
                       style="display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border:1px solid #eee; border-radius:6px; background:#fff; text-decoration:none;">
                        â¬‡ï¸
                    </a>
                    ${!isRunClosed ? `
                    <button type="button" title="ì‚­ì œ" onclick="deleteAttachment(${a.id})"
                            style="display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border:1px solid #eee; border-radius:6px; background:#fff; cursor:pointer;">
                        ğŸ—‘ï¸
                    </button>
                    ` : ''}
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error('ì²¨ë¶€ ë¡œë“œ ì˜¤ë¥˜:', err);
    }
}

async function deleteAttachment(attachmentId) {
    if (!confirm('ì´ ì²¨ë¶€íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        const res = await fetch(`/api/attachments/${attachmentId}`, { method: 'DELETE' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
            alert(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
            return;
        }
        showSaveNotification('âœ… ì²¨ë¶€íŒŒì¼ ì‚­ì œ ì™„ë£Œ');
        await loadAttachments();
    } catch (err) {
        console.error('ì²¨ë¶€ ì‚­ì œ ì˜¤ë¥˜:', err);
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + err);
    }
}

function previewAttachment(event, attachmentId) {
    if (event) event.preventDefault();
    const name = (event && event.currentTarget && event.currentTarget.dataset && event.currentTarget.dataset.name ? event.currentTarget.dataset.name : '').toLowerCase();
    const url = `/api/attachments/${attachmentId}`;

    const isImage = name.match(/\.(png|jpg|jpeg|gif|webp)$/);
    const isVideo = name.match(/\.(mp4|mov|webm|avi|mkv)$/);

    if (isImage) {
        showImageModal(url);
        return false;
    }

    if (isVideo) {
        showVideoModal(url);
        return false;
    }

    // ê¸°íƒ€ íŒŒì¼ì€ ìƒˆ íƒ­(ë¸Œë¼ìš°ì €ê°€ ì§€ì›í•˜ë©´ ë°”ë¡œ ë³´ê¸°, ì•„ë‹ˆë©´ ë‹¤ìš´ë¡œë“œ/í‘œì‹œ)
    window.open(url, '_blank', 'noopener,noreferrer');
    return false;
}

function showVideoModal(videoSrc) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';

    const video = document.createElement('video');
    video.src = videoSrc;
    video.controls = true;
    video.autoplay = true;
    video.style.cssText = 'max-width: 92%; max-height: 92%; background: black; border-radius: 8px;';

    modal.appendChild(video);
    modal.onclick = function(e) {
        // ë¹„ë””ì˜¤ í´ë¦­ì€ ë§‰ê³ , ë°”ê¹¥ í´ë¦­ë§Œ ë‹«ê¸°
        if (e.target === modal) {
            modal.remove();
        }
    };

    document.body.appendChild(modal);
}

// ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬
function showImageModal(imageSrc) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
    
    const img = document.createElement('img');
    img.src = imageSrc;
    img.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain;';
    
    modal.appendChild(img);
    modal.onclick = function() {
        modal.remove();
    };
    
    document.body.appendChild(modal);
}

// í´ë¦½ë³´ë“œì—ì„œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°
async function pasteFromClipboard() {
    try {
        const clipboardItems = await navigator.clipboard.read();
        let hasImage = false;
        
        for (const item of clipboardItems) {
            for (const type of item.types) {
                if (type.startsWith('image/')) {
                    const blob = await item.getType(type);
                    const file = new File([blob], `clipboard-${Date.now()}.png`, { type: blob.type });
                    
                    await uploadSelectedAttachments([file]);
                    hasImage = true;
                    
                    showSaveNotification('âœ… í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì¶”ê°€ë¨');
                    break;
                }
            }
            if (hasImage) break;
        }
        
        if (!hasImage) {
            alert('í´ë¦½ë³´ë“œì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
    } catch (err) {
        console.error('í´ë¦½ë³´ë“œ ì½ê¸° ì˜¤ë¥˜:', err);
        alert('í´ë¦½ë³´ë“œ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
    }
}

// ì „ì—­ Ctrl+V ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.addEventListener('paste', function(e) {
    // ì…ë ¥ í•„ë“œì—ì„œëŠ” ë¬´ì‹œ
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        return;
    }
    
    // ëŸ°ì´ ë‹«í˜”ìœ¼ë©´ ë¬´ì‹œ
    if (isRunClosed) return;
    
    // í´ë¦½ë³´ë“œì— ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìë™ ì¶”ê°€
    if (e.clipboardData && e.clipboardData.items) {
        for (let item of e.clipboardData.items) {
            if (item.type.startsWith('image/')) {
                e.preventDefault();
                const blob = item.getAsFile();
                if (blob) {
                    const file = new File([blob], `paste-${Date.now()}.png`, { type: blob.type });
                    uploadSelectedAttachments([file]).then(() => {
                        showSaveNotification('âœ… ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì™„ë£Œ');
                    }).catch(err => {
                        console.error('ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì—…ë¡œë“œ ì˜¤ë¥˜:', err);
                        alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err);
                    });
                }
                break;
            }
        }
    }
});

async function uploadSelectedAttachments(files) {
    if (!files || files.length === 0) return;
    if (isRunClosed) return;

    const item = runCases[currentIndex];
    const caseId = item.case.id;

    for (const file of files) {
        const form = new FormData();
        form.append('file', file);
        const res = await fetch(`/api/runs/${runId}/cases/${caseId}/attachments`, {
            method: 'POST',
            body: form
        });
        if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
        }
    }

    // ì—…ë¡œë“œ ì™„ë£Œ í›„ ì…ë ¥ ì´ˆê¸°í™” + ì €ì¥ëœ ì²¨ë¶€ ëª©ë¡ ê°±ì‹ 
    const input = document.getElementById('attachments');
    if (input) input.value = '';
    showSaveNotification('âœ… ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ');
    await loadAttachments();
}

// ê²°ê³¼ íˆìŠ¤í† ë¦¬ ë¡œë“œ
async function loadResultHistory(caseId) {
    try {
        const response = await fetch(`/api/runs/${runId}/cases/${caseId}/history`);
        if (!response.ok) throw new Error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨');
        
        const history = await response.json();
        
        const historyContainer = document.getElementById('resultHistory');
        if (!historyContainer) return;
        
        if (history.length === 0) {
            historyContainer.innerHTML = `
                <div style="text-align: center; padding: 1rem; color: #999;">
                    ì•„ì§ ê¸°ë¡ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
            `;
            return;
        }
        
        // íˆìŠ¤í† ë¦¬ HTML ìƒì„±
        const historyHtml = history.map((item, index) => {
            const bgColor = index === 0 ? '#e8f5e9' : '#f9f9f9'; // ìµœì‹  ê²°ê³¼ëŠ” ê°•ì¡°
            const statusColors = {
                'pass': '#27ae60',
                'fail': '#e74c3c',
                'blocked': '#95a5a6',
                'retest': '#f39c12',
                'na': '#bdc3c7'
            };
            const statusColor = statusColors[item.status] || '#999';
            
            return `
                <div style="padding: 1rem; background: ${bgColor}; border-radius: 4px; margin-bottom: 0.5rem; border-left: 4px solid ${statusColor};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div>
                            <span style="display: inline-block; padding: 0.2rem 0.6rem; background: ${statusColor}; color: white; border-radius: 3px; font-weight: 600; font-size: 0.85rem;">
                                ${item.status.toUpperCase()}
                            </span>
                            ${index === 0 ? '<span style="margin-left: 0.5rem; color: #27ae60; font-weight: 600;">ìµœì‹ </span>' : ''}
                        </div>
                        <div style="text-align: right; font-size: 0.85rem; color: #666;">
                            ${new Date(item.created_at).toLocaleString('ko-KR')} <span style="color: #3498db; font-weight: 500;">(${item.executor})</span>
                        </div>
                    </div>
                    ${item.comment ? `
                    <div style="font-size: 0.9rem; color: #555; margin-top: 0.5rem;">
                        <strong>ì½”ë©˜íŠ¸:</strong> ${escapeHtml(item.comment)}
                    </div>
                    ` : ''}
                    ${item.bug_links ? `
                    <div style="font-size: 0.9rem; color: #555; margin-top: 0.5rem;">
                        <strong>ğŸ› ë²„ê·¸ ë§í¬:</strong> ${escapeHtml(item.bug_links)}
                    </div>
                    ` : ''}
                </div>
            `;
        }).join('');
        
        historyContainer.innerHTML = historyHtml;
        
    } catch (err) {
        console.error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', err);
        const historyContainer = document.getElementById('resultHistory');
        if (historyContainer) {
            historyContainer.innerHTML = `
                <div style="text-align: center; padding: 1rem; color: #e74c3c;">
                    íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                </div>
            `;
        }
    }
}

let pendingStatus = null;

// PassëŠ” ì¦‰ì‹œ ì €ì¥
function recordResult(status) {
    if (isRunClosed) {
        alert('ì™„ë£Œëœ ëŸ°ì€ ê²°ê³¼ë¥¼ ê¸°ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const caseData = runCases[currentIndex].case;
    const comment = document.getElementById('commentInput').value.trim();
    
    // ì¦‰ì‹œ ì €ì¥
    saveResult(caseData.id, status, comment);
}

// Pass ì™¸ì˜ ê²°ê³¼ëŠ” ëª¨ë‹¬ë¡œ ì½”ë©˜íŠ¸ ì…ë ¥
function recordResultWithModal(status) {
    if (isRunClosed) {
        alert('ì™„ë£Œëœ ëŸ°ì€ ê²°ê³¼ë¥¼ ê¸°ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    pendingStatus = status;
    
    // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì…ë ¥ ê°’ì„ ëª¨ë‹¬ì— ë³µì‚¬
    const comment = document.getElementById('commentInput').value.trim();
    document.getElementById('modalCommentInput').value = comment;
    
    // ëª¨ë‹¬ í‘œì‹œ
    const modal = document.getElementById('commentModal');
    modal.style.display = 'flex';
    document.getElementById('modalCommentInput').focus();
}

function closeCommentModal() {
    const modal = document.getElementById('commentModal');
    modal.style.display = 'none';
    pendingStatus = null;
}

function confirmCommentModal() {
    if (!pendingStatus) return;
    
    const caseData = runCases[currentIndex].case;
    const comment = document.getElementById('modalCommentInput').value.trim();
    
    // ì½”ë©˜íŠ¸ê°€ ìˆìœ¼ë©´ ë³„ë„ë¡œ ì €ì¥
    if (comment) {
        fetch(`/api/runs/${runId}/comments`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                case_id: caseData.id,
                comment: comment
            })
        })
        .then(res => res.json())
        .then(data => {
            // ì½”ë©˜íŠ¸ ë‹¤ì‹œ ë¡œë“œ
            loadComments();
        })
        .catch(err => {
            console.error('ì½”ë©˜íŠ¸ ì €ì¥ ì˜¤ë¥˜:', err);
        });
    }
    
    // ê²°ê³¼ ì €ì¥ (ì½”ë©˜íŠ¸ ì—†ì´)
    saveResult(caseData.id, pendingStatus, '');
    
    // ëª¨ë‹¬ ë‹«ê¸°
    closeCommentModal();
}

function saveComment() {
    const comment = document.getElementById('commentInput').value;
    const caseData = runCases[currentIndex].case;
    
    if (pendingStatus === 'fail' && !comment.trim()) {
        alert('Fail ìƒíƒœëŠ” ì½”ë©˜íŠ¸ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
    }
    
    saveResult(caseData.id, pendingStatus || 'pass', comment);
}

function saveResult(caseId, status, comment) {
    // Phase 1 ê°œì„ : bug_links ë°°ì—´ì—ì„œ ìˆ˜ì§‘
    const bugLinks = bugLinksArray.join(', ');
    
    // ì½”ë©˜íŠ¸ëŠ” ë³„ë„ë¡œ ì €ì¥ë˜ë¯€ë¡œ ê²°ê³¼ ì €ì¥ ì‹œì—ëŠ” í¬í•¨í•˜ì§€ ì•ŠìŒ
    // (comment íŒŒë¼ë¯¸í„°ëŠ” í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€í•˜ì§€ë§Œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
    
    fetch(`/api/runs/${runId}/results`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            case_id: caseId,
            status: status,
            comment: '',  // ì½”ë©˜íŠ¸ëŠ” ë³„ë„ ì €ì¥
            bug_links: bugLinks
        })
    })
    .then(res => res.json())
    .then(data => {
        // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
        runCases[currentIndex].result = {
            id: data.id,
            status: status,
            comment: '',  // ì½”ë©˜íŠ¸ëŠ” ë³„ë„ ì €ì¥
            bug_links: bugLinks,
            executor: '{{ current_user.name }}',
            created_at: data.created_at
        };
        
        // ìµœì‹  ì½”ë©˜íŠ¸ ê°€ì ¸ì˜¤ê¸°
        const latestComment = commentsArray.length > 0 ? commentsArray[0].comment : null;
        
        // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸ (ìµœì‹  ì½”ë©˜íŠ¸ 1ê°œë§Œ í‘œì‹œ)
        updateSidebarItem(currentIndex, status, latestComment);
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        updateRunStats();
        
        // íˆìŠ¤í† ë¦¬ ë‹¤ì‹œ ë¡œë“œ
        if (document.getElementById('resultHistory')) {
            loadResultHistory(caseId);
        }
        
        // Phase 1 ê°œì„ : ì½”ë©˜íŠ¸ ì…ë ¥ í•„ë“œë§Œ ì´ˆê¸°í™” (ë²„ê·¸ ë§í¬ëŠ” ìœ ì§€)
        const commentInput = document.getElementById('commentInput');
        if (commentInput) commentInput.value = '';
        
        // ë‹¤ìŒ ë¯¸ì‹¤í–‰ ì¼€ì´ìŠ¤ë¡œ ì´ë™
        goToNextUnexecuted();
    })
    .catch(err => {
        console.error('ê²°ê³¼ ì €ì¥ ì˜¤ë¥˜:', err);
        alert('ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨: ' + err);
    });
    
    pendingStatus = null;
}

function getStatusColor(status) {
    const colors = {
        'pass': '#27ae60',
        'fail': '#e74c3c',
        'blocked': '#95a5a6',
        'retest': '#f39c12',
        'na': '#95a5a6'
    };
    return colors[status] || '#999';
}

function updateRunStats() {
    // í†µê³„ ì¬ê³„ì‚°
    let pass = 0, fail = 0, blocked = 0, retest = 0, na = 0, untested = 0;
    
    runCases.forEach(rc => {
        if (rc.result && rc.result.status !== 'comment') {
            // ì½”ë©˜íŠ¸ ì „ìš© ê²°ê³¼ëŠ” í†µê³„ì—ì„œ ì œì™¸
            switch(rc.result.status) {
                case 'pass': pass++; break;
                case 'fail': fail++; break;
                case 'blocked': blocked++; break;
                case 'retest': retest++; break;
                case 'na': na++; break;
            }
        } else if (!rc.result || rc.result.status === 'comment') {
            untested++;
        }
    });
    
    const total = runCases.length;
    const executed = pass + fail + blocked + retest + na;
    const progress = total > 0 ? Math.round((executed / total) * 100) : 0;
    const passRate = executed > 0 ? Math.round((pass / executed) * 100) : 0;
    
    // í†µê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
    document.getElementById('statProgress').textContent = `${progress}%`;
    document.getElementById('statPassRate').textContent = `${passRate}%`;
    
    // Pass Rate ìƒ‰ìƒ ì—…ë°ì´íŠ¸
    const passRateElement = document.getElementById('statPassRate');
    if (passRate >= 90) {
        passRateElement.style.color = '#27ae60';
    } else if (passRate >= 70) {
        passRateElement.style.color = '#f39c12';
    } else {
        passRateElement.style.color = '#e74c3c';
    }
    
    document.getElementById('statExecuted').textContent = `${executed} / ${total}`;
    document.getElementById('statPass').textContent = pass;
    document.getElementById('statFail').textContent = fail;
    document.getElementById('statBlocked').textContent = blocked;
    document.getElementById('statRetest').textContent = retest;
    document.getElementById('statNA').textContent = na;
    document.getElementById('statPending').textContent = untested;
    
    // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸
    updateProgressBar();
}

// ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
function startAutoRefresh() {
    // 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
    autoRefreshInterval = setInterval(() => {
        refreshRunData();
    }, 5000);
    
    console.log('ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘ (5ì´ˆ ê°„ê²©)');
}

// ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€');
    }
}

// ëŸ° ë°ì´í„° ìƒˆë¡œê³ ì¹¨
async function refreshRunData() {
    if (isRefreshing) return;
    
    isRefreshing = true;
    
    try {
        const response = await fetch(`/api/runs/${runId}/cases`);
        if (!response.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        
        const newData = await response.json();
        
        // ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì—…ë°ì´íŠ¸
        let hasChanges = false;
        
        newData.forEach((newCase, index) => {
            const oldCase = runCases[index];
            
            // ì¼€ì´ìŠ¤ ë°ì´í„° ì—…ë°ì´íŠ¸ (ì™„ë£Œëœ ëŸ°ì—ì„œëŠ” ìŠ¤ëƒ…ìƒ· ìœ ì§€, ì§„í–‰ ì¤‘ì¸ ëŸ°ë§Œ ì—…ë°ì´íŠ¸)
            // ì™„ë£Œëœ ëŸ°ì—ì„œëŠ” ì¼€ì´ìŠ¤ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ (ìŠ¤ëƒ…ìƒ· ìœ ì§€)
            if (!isRunClosed) {
                let caseDataChanged = false;
                
                if (newCase.case_title !== undefined && runCases[index].case.title !== newCase.case_title) {
                    runCases[index].case.title = newCase.case_title;
                    caseDataChanged = true;
                }
                if (newCase.case_steps !== undefined && runCases[index].case.steps !== (newCase.case_steps || '')) {
                    runCases[index].case.steps = newCase.case_steps || '';
                    caseDataChanged = true;
                }
                if (newCase.case_expected !== undefined && runCases[index].case.expected !== (newCase.case_expected || '')) {
                    runCases[index].case.expected = newCase.case_expected || '';
                    caseDataChanged = true;
                }
                if (newCase.case_priority !== undefined && runCases[index].case.priority !== newCase.case_priority) {
                    runCases[index].case.priority = newCase.case_priority;
                    caseDataChanged = true;
                }
                if (newCase.case_version !== undefined && runCases[index].case.version !== newCase.case_version) {
                    runCases[index].case.version = newCase.case_version;
                    caseDataChanged = true;
                }
                
                if (caseDataChanged) {
                    hasChanges = true;
                    // í˜„ì¬ ë³´ê³  ìˆëŠ” ì¼€ì´ìŠ¤ë©´ ì¦‰ì‹œ ë‹¤ì‹œ ë¡œë“œ
                    if (index === currentIndex) {
                        loadCase(currentIndex);
                    }
                }
            }
            
            // ê²°ê³¼ ë³€ê²½ í™•ì¸
            const oldResult = oldCase.result;
            const newResult = newCase.result;
            
            if (!oldResult && newResult) {
                // ìƒˆë¡œìš´ ê²°ê³¼ ì¶”ê°€ë¨
                hasChanges = true;
                runCases[index].result = newResult;
                updateSidebarItem(index, newResult.status, newResult.comment);
            } else if (oldResult && !newResult) {
                // ê²°ê³¼ê°€ ì‚­ì œë¨ (ì´ˆê¸°í™” ë“±)
                hasChanges = true;
                runCases[index].result = null;
                updateSidebarItem(index, null);
            } else if (oldResult && newResult && oldResult.status !== newResult.status) {
                // ê²°ê³¼ ìƒíƒœ ë³€ê²½ë¨
                hasChanges = true;
                runCases[index].result = newResult;
                updateSidebarItem(index, newResult.status, newResult.comment);
            } else if (oldResult && newResult && oldResult.comment !== newResult.comment) {
                // ì½”ë©˜íŠ¸ ë³€ê²½ë¨
                hasChanges = true;
                runCases[index].result = newResult;
                updateSidebarItem(index, newResult.status, newResult.comment);
            }
        });
        
        if (hasChanges) {
            console.log('ë³€ê²½ì‚¬í•­ ê°ì§€ - UI ì—…ë°ì´íŠ¸');
            updateRunStats();
            
            // í˜„ì¬ ë³´ê³  ìˆëŠ” ì¼€ì´ìŠ¤ ìƒˆë¡œê³ ì¹¨
            loadCase(currentIndex);
            
            // ì‹œê°ì  í”¼ë“œë°±
            showRefreshNotification();
        }
        
    } catch (err) {
        console.error('ìë™ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', err);
    } finally {
        isRefreshing = false;
    }
}

// ì‚¬ì´ë“œë°” ì•„ì´í…œ ì—…ë°ì´íŠ¸
function updateSidebarItem(index, status, comment = null) {
    const sidebarItem = document.querySelectorAll('.run-case-item')[index];
    if (!sidebarItem) return;
    
    // ê¸°ì¡´ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
    sidebarItem.classList.remove('status-pass', 'status-fail', 'status-blocked', 'status-retest', 'status-na');
    
    // ìƒˆ ìƒíƒœ í´ë˜ìŠ¤ ì¶”ê°€
    if (status) {
        sidebarItem.classList.add(`status-${status}`);
        
        // ê²°ê³¼ ë°°ì§€ ì—…ë°ì´íŠ¸ (ìƒˆë¡œìš´ ë°©ì‹)
        const badge = sidebarItem.querySelector('.result-badge');
        if (badge) {
            badge.className = `result-badge result-${status}`;
            badge.style.padding = '0.15rem 0.5rem';
            badge.style.borderRadius = '4px';
            badge.style.fontWeight = '600';
            badge.style.fontSize = '0.75rem';
            badge.textContent = status.toUpperCase();
        }
        
    } else {
        // ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš° (ì´ˆê¸°í™” ë“±)
        const badge = sidebarItem.querySelector('.result-badge');
        if (badge) {
            badge.className = 'result-badge result-none';
            badge.style.padding = '0.15rem 0.5rem';
            badge.style.borderRadius = '4px';
            badge.style.fontWeight = '600';
            badge.style.fontSize = '0.75rem';
            badge.textContent = 'ë¯¸ì‹¤í–‰';
        }
    }

    // ì½”ë©˜íŠ¸ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (status ìœ ë¬´ì™€ ë¬´ê´€í•˜ê²Œ í‘œì‹œ)
    const container = sidebarItem.querySelector('div[style*="font-size: 0.85rem"]');
    let commentPreview = sidebarItem.querySelector('.case-comment-preview');
    if (comment && String(comment).trim()) {
        if (!commentPreview && container) {
            commentPreview = document.createElement('div');
            commentPreview.className = 'case-comment-preview';
            commentPreview.style.cssText = 'font-size: 0.7rem; color: #666; margin-top: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 600px; max-width: 600px;';
            container.appendChild(commentPreview);
        }
        if (commentPreview) {
            commentPreview.textContent = 'ğŸ’¬ ' + comment;
        }
    } else if (commentPreview) {
        commentPreview.remove();
    }
}

// ìƒˆë¡œê³ ì¹¨ ì•Œë¦¼ í‘œì‹œ
function showRefreshNotification() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #27ae60;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
    `;
    notification.innerHTML = 'ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¨';
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨
function manualRefresh() {
    console.log('ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰');
    refreshRunData();
}

// í˜ì´ì§€ ë– ë‚  ë•Œ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
window.addEventListener('beforeunload', () => {
    stopAutoRefresh();
});

// ============ ì‚¬ì´ë“œë°” ë¦¬ì‚¬ì´ì € ============

function initResizer() {
    const resizer = document.getElementById('resizer');
    const sidebar = document.getElementById('runCasesSidebar');
    const detailPanel = document.getElementById('caseDetailPanel');
    
    let isResizing = false;
    let startX = 0;
    let startWidth = 0;
    
    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = sidebar.offsetWidth;
        
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const deltaX = e.clientX - startX;
        const newWidth = startWidth + deltaX;
        
        // ìµœì†Œ/ìµœëŒ€ ë„ˆë¹„ ì œí•œ
        if (newWidth >= 300 && newWidth <= 800) {
            // flex-basisë¥¼ ë³€ê²½í•˜ì—¬ ë„ˆë¹„ ì¡°ì •
            sidebar.style.flex = `0 0 ${newWidth}px`;
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            // ë„ˆë¹„ ì €ì¥
            saveSidebarWidth(sidebar.offsetWidth);
        }
    });
}

function saveSidebarWidth(width) {
    localStorage.setItem('runExecuteSidebarWidth', width);
    console.log('ì‚¬ì´ë“œë°” ë„ˆë¹„ ì €ì¥:', width);
}

function loadSidebarWidth() {
    const savedWidth = localStorage.getItem('runExecuteSidebarWidth');
    const sidebar = document.getElementById('runCasesSidebar');
    const isCollapsed = localStorage.getItem('detailPanelCollapsed') === 'true';
    
    // íŒ¨ë„ì´ ì ‘í˜€ìˆìœ¼ë©´ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ì§€ ì•ŠìŒ (CSSê°€ ì²˜ë¦¬)
    if (isCollapsed) {
        console.log('íŒ¨ë„ì´ ì ‘í˜€ìˆì–´ ì‚¬ì´ë“œë°” ë„ˆë¹„ ì„¤ì • ìƒëµ');
        return;
    }
    
    if (savedWidth) {
        // flex-basisë¥¼ ì‚¬ìš©í•˜ì—¬ ë„ˆë¹„ ì„¤ì •
        sidebar.style.flex = `0 0 ${savedWidth}px`;
        console.log('ì‚¬ì´ë“œë°” ë„ˆë¹„ ë¡œë“œ:', savedWidth);
    } else {
        // ê¸°ë³¸ê°’ ì„¤ì • (CSSì˜ flex: 1 ì‚¬ìš©)
        console.log('ì‚¬ì´ë“œë°” ê¸°ë³¸ ë„ˆë¹„ ì‚¬ìš©');
    }
}

function goToNextUnexecuted() {
    for (let i = currentIndex + 1; i < runCases.length; i++) {
        if (!runCases[i].result) {
            selectCase(i);
            return;
        }
    }
    // ì²˜ìŒë¶€í„° ë‹¤ì‹œ ê²€ìƒ‰
    for (let i = 0; i < currentIndex; i++) {
        if (!runCases[i].result) {
            selectCase(i);
            return;
        }
    }
    showToast('ëª¨ë“  ì¼€ì´ìŠ¤ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success', 5000);
}

function goToPrevUnexecuted() {
    for (let i = currentIndex - 1; i >= 0; i--) {
        if (!runCases[i].result) {
            selectCase(i);
            return;
        }
    }
    // ë’¤ì—ì„œë¶€í„° ë‹¤ì‹œ ê²€ìƒ‰
    for (let i = runCases.length - 1; i > currentIndex; i--) {
        if (!runCases[i].result) {
            selectCase(i);
            return;
        }
    }
    alert('ì´ì „ ë¯¸ì‹¤í–‰ ì¼€ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
}

function goToFirst() {
    selectCase(0);
}

function goToLast() {
    selectCase(runCases.length - 1);
}

function focusComment() {
    const commentSection = document.getElementById('commentSection');
    const commentInput = document.getElementById('commentInput');
    
    if (commentSection && commentInput) {
        commentSection.classList.add('show');
        commentInput.focus();
    }
}

function closeComment() {
    const commentSection = document.getElementById('commentSection');
    if (commentSection) {
        commentSection.classList.remove('show');
    }
}

// ì¼€ì´ìŠ¤ í•„ë“œ ì—…ë°ì´íŠ¸
async function updateCaseField(field, value) {
    if (isRunClosed) {
        alert('ì™„ë£Œëœ ëŸ°ì—ì„œëŠ” ì¼€ì´ìŠ¤ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        loadCase(currentIndex); // ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
        return;
    }
    
    const caseData = runCases[currentIndex].case;
    const caseId = caseData.id;
    
    // ê°’ì´ ë³€ê²½ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¬´ì‹œ
    const oldValue = field === 'title' ? caseData.title :
                     field === 'priority' ? caseData.priority :
                     field === 'steps' ? caseData.steps :
                     field === 'expected_result' ? caseData.expected : '';
    
    if (value === oldValue) {
        return;
    }
    
    try {
        const response = await fetch(`/api/cases/${caseId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ [field]: value })
        });
        
        if (!response.ok) {
            const error = await response.json();
            if (response.status === 404) {
                alert('âš ï¸ ì›ë³¸ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ê°€ ì‚­ì œë˜ì–´ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            } else if (response.status === 409) {
                alert('âš ï¸ ì›ë³¸ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ê°€ ë‹¤ë¥¸ ì‚¬ìš©ìì— ì˜í•´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            } else {
                alert(`ë³€ê²½ ì‹¤íŒ¨: ${error.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }
            // ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
            loadCase(currentIndex);
            return;
        }
        
        const data = await response.json();
        
        // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
        if (field === 'title') {
            caseData.title = value;
        } else if (field === 'priority') {
            caseData.priority = value;
        } else if (field === 'steps') {
            caseData.steps = value;
        } else if (field === 'expected_result') {
            caseData.expected = value;
        }
        
        // ì‹œê°ì  í”¼ë“œë°±
        showSaveNotification('âœ… ì €ì¥ ì™„ë£Œ');
        
        console.log('ì¼€ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', field, value);
        
    } catch (err) {
        console.error('ì¼€ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', err);
        alert('âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        // ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
        loadCase(currentIndex);
    }
}

// ì €ì¥ ì•Œë¦¼ í‘œì‹œ
function showSaveNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #27ae60;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}


// HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', function(e) {
    // ì…ë ¥ í•„ë“œ ë˜ëŠ” í¸ì§‘ ê°€ëŠ¥í•œ ìš”ì†Œì—ì„œëŠ” ì¼ë¶€ ë‹¨ì¶•í‚¤ë§Œ í—ˆìš©
    const isInputField = e.target.tagName === 'TEXTAREA' || 
                        e.target.tagName === 'INPUT' ||
                        e.target.tagName === 'SELECT' ||
                        e.target.isContentEditable;
    
    // EscëŠ” í•­ìƒ ì‘ë™
    if (e.key === 'Escape') {
        if (isInputField) {
            e.target.blur();
            closeComment();
        }
        return;
    }
    
    // ì…ë ¥ í•„ë“œì—ì„œëŠ” ë‹¤ë¥¸ ë‹¨ì¶•í‚¤ ë¬´ì‹œ
    if (isInputField) {
        return;
    }
    
    // Shift í‚¤ ì¡°í•© ì²˜ë¦¬
    if (e.shiftKey && e.key === 'G') {
        e.preventDefault();
        goToLast();
        return;
    }
    
    switch(e.key) {
        case '1':
            if (!isRunClosed) {
                e.preventDefault();
                recordResult('pass');
            }
            break;
        case '2':
            if (!isRunClosed) {
                e.preventDefault();
                recordResultWithModal('fail');
            }
            break;
        case '3':
            if (!isRunClosed) {
                e.preventDefault();
                recordResultWithModal('blocked');
            }
            break;
        case '4':
            if (!isRunClosed) {
                e.preventDefault();
                recordResultWithModal('retest');
            }
            break;
        case '5':
            if (!isRunClosed) {
                e.preventDefault();
                recordResult('na');
            }
            break;
        case 'n':
            e.preventDefault();
            goToNextUnexecuted();
            break;
        case 'p':
            e.preventDefault();
            goToPrevUnexecuted();
            break;
        case 'j':
            e.preventDefault();
            if (currentIndex < runCases.length - 1) {
                selectCase(currentIndex + 1);
            }
            break;
        case 'k':
            e.preventDefault();
            if (currentIndex > 0) {
                selectCase(currentIndex - 1);
            }
            break;
        case 'g':
            e.preventDefault();
            goToFirst();
            break;
        case 'r':
            if (!isRunClosed) {
                e.preventDefault();
                manualRefresh();
            }
            break;
        case '?':
            e.preventDefault();
            const hint = document.getElementById('hotkeyHint');
            hint.classList.toggle('hidden');
            break;
    }
});

// Phase 1: CSV Export í•¨ìˆ˜
function exportCSV() {
    window.location.href = `/api/runs/${runId}/export.csv`;
}

// í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸
function updateProgressBar() {
    let pass = 0, fail = 0, blocked = 0, retest = 0, na = 0;
    
    runCases.forEach(rc => {
        if (rc.result) {
            switch(rc.result.status) {
                case 'pass': pass++; break;
                case 'fail': fail++; break;
                case 'blocked': blocked++; break;
                case 'retest': retest++; break;
                case 'na': na++; break;
            }
        }
    });
    
    const total = runCases.length;
    const passWidth = total > 0 ? (pass / total * 100) : 0;
    const failWidth = total > 0 ? (fail / total * 100) : 0;
    const blockedWidth = total > 0 ? (blocked / total * 100) : 0;
    const retestWidth = total > 0 ? (retest / total * 100) : 0;
    const naWidth = total > 0 ? (na / total * 100) : 0;
    
    document.getElementById('progressPass').style.width = `${passWidth}%`;
    document.getElementById('progressFail').style.width = `${failWidth}%`;
    document.getElementById('progressFail').style.left = `${passWidth}%`;
    document.getElementById('progressBlocked').style.width = `${blockedWidth}%`;
    document.getElementById('progressBlocked').style.left = `${passWidth + failWidth}%`;
    document.getElementById('progressRetest').style.width = `${retestWidth}%`;
    document.getElementById('progressRetest').style.left = `${passWidth + failWidth + blockedWidth}%`;
    document.getElementById('progressNA').style.width = `${naWidth}%`;
    document.getElementById('progressNA').style.left = `${passWidth + failWidth + blockedWidth + retestWidth}%`;
}

// í•„í„°ë§ í•¨ìˆ˜
function filterByStatus(status) {
    currentFilter = status;
    
    // ëª¨ë“  stat-itemì˜ active í´ë˜ìŠ¤ ì œê±°
    document.querySelectorAll('.stat-item.clickable').forEach(item => {
        item.classList.remove('active');
    });
    
    // í´ë¦­ëœ í•­ëª©ì— active í´ë˜ìŠ¤ ì¶”ê°€
    event.target.closest('.stat-item').classList.add('active');
    
    // ì¼€ì´ìŠ¤ ëª©ë¡ í•„í„°ë§
    const items = document.querySelectorAll('.run-case-item');
    let visibleCount = 0;
    
    items.forEach((item, index) => {
        const result = runCases[index].result;
        let shouldShow = false;
        
        if (status === 'none') {
            // ë¯¸ì‹¤í–‰ ì¼€ì´ìŠ¤
            shouldShow = !result;
        } else {
            // íŠ¹ì • ìƒíƒœì˜ ì¼€ì´ìŠ¤
            shouldShow = result && result.status === status;
        }
        
        if (shouldShow) {
            item.style.display = '';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // í•„í„° ìƒíƒœ í‘œì‹œ
    const filterStatus = document.getElementById('filterStatus');
    const filterText = document.getElementById('filterText');
    const statusNames = {
        'pass': 'Pass',
        'fail': 'Fail',
        'blocked': 'Blocked',
        'retest': 'Retest',
        'na': 'N/A',
        'none': 'ë¯¸ì‹¤í–‰'
    };
    
    filterStatus.style.display = 'flex';
    filterText.textContent = `${statusNames[status]} ì¼€ì´ìŠ¤ë§Œ í‘œì‹œ ì¤‘ (${visibleCount}ê°œ)`;
}

// í•„í„° ì´ˆê¸°í™”
function clearFilter() {
    currentFilter = null;
    
    // ëª¨ë“  stat-itemì˜ active í´ë˜ìŠ¤ ì œê±°
    document.querySelectorAll('.stat-item.clickable').forEach(item => {
        item.classList.remove('active');
    });
    
    // ëª¨ë“  ì¼€ì´ìŠ¤ í‘œì‹œ
    document.querySelectorAll('.run-case-item').forEach(item => {
        item.style.display = '';
    });
    
    // í•„í„° ìƒíƒœ ìˆ¨ê¹€
    document.getElementById('filterStatus').style.display = 'none';
}

// ë‹¨ì¶•í‚¤ íŒ¨ë„ í† ê¸€
function toggleHotkeyHint() {
    const content = document.getElementById('hotkeyContent');
    const button = event.target;
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        button.textContent = 'âˆ’';
        localStorage.setItem('hotkeyHintCollapsed', 'false');
    } else {
        content.style.display = 'none';
        button.textContent = '+';
        localStorage.setItem('hotkeyHintCollapsed', 'true');
    }
}

// ë‹¨ì¶•í‚¤ íŒ¨ë„ ìƒíƒœ ë¡œë“œ
function loadHotkeyHintState() {
    const isCollapsed = localStorage.getItem('hotkeyHintCollapsed') === 'true';
    const content = document.getElementById('hotkeyContent');
    const button = document.querySelector('#hotkeyHint button');
    
    if (isCollapsed && content && button) {
        content.style.display = 'none';
        button.textContent = '+';
    }
}

// ë‹¨ì¶•í‚¤ ê°€ì´ë“œëŠ” í•­ìƒ í‘œì‹œ (ìë™ ìˆ¨ê¹€ ì œê±°)

// ============================================================
// AI ìš”ì•½ ê´€ë ¨ í•¨ìˆ˜
// ============================================================

// ìš”ì•½ í”„ë¡¬í”„íŠ¸ ëª©ë¡ ë¡œë“œ
async function loadSummaryPrompts() {
    try {
        const res = await fetch('/api/summary-prompts');
        if (!res.ok) throw new Error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨');
        
        const prompts = await res.json();
        const select = document.getElementById('summaryPromptSelect');
        if (!select) return;
        
        select.innerHTML = '<option value="">í”„ë¡¬í”„íŠ¸ ì„ íƒ...</option>';
        prompts.forEach(prompt => {
            const option = document.createElement('option');
            option.value = prompt.id;
            option.textContent = `${prompt.name} (${prompt.model})`;
            if (prompt.is_active) {
                option.textContent += ' [í™œì„±]';
            }
            select.appendChild(option);
        });
    } catch (err) {
        console.error('ìš”ì•½ í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', err);
    }
}

// AI ìš”ì•½ ìƒì„±
async function generateAISummary() {
    const promptSelect = document.getElementById('summaryPromptSelect');
    const promptId = promptSelect.value;
    
    if (!promptId) {
        alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ë° ì§„í–‰ ìƒí™© í‘œì‹œ
    const progressDiv = document.getElementById('aiSummaryProgress');
    const progressBar = document.getElementById('aiSummaryProgressBar');
    const progressText = document.getElementById('aiSummaryProgressText');
    const contentDiv = document.getElementById('aiSummaryContent');
    const generateBtn = document.getElementById('generateSummaryBtn');
    
    progressDiv.style.display = 'block';
    contentDiv.style.display = 'none';
    generateBtn.disabled = true;
    generateBtn.textContent = 'ìƒì„± ì¤‘...';
    
    // í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    const updateProgress = (percent, text) => {
        progressBar.style.width = percent + '%';
        progressText.textContent = text;
    };
    
    try {
        // 1ë‹¨ê³„: í˜„ì¬ í˜ì´ì§€ì˜ í…ŒìŠ¤íŠ¸ ëŸ° ë°ì´í„° ìˆ˜ì§‘ (10%)
        updateProgress(10, 'ğŸ“„ í˜„ì¬ í˜ì´ì§€ì˜ í…ŒìŠ¤íŠ¸ ëŸ° ë°ì´í„° ìˆ˜ì§‘ ì¤‘...');
        
        // í˜„ì¬ í˜ì´ì§€ì— í‘œì‹œëœ ì‹¤ì œ ë°ì´í„° ìˆ˜ì§‘
        const currentPageData = {
            run_id: runId,
            run_name: (() => {
                const h2 = document.querySelector('h2');
                if (!h2) return 'í…ŒìŠ¤íŠ¸ ëŸ°';
                let text = h2.textContent.trim();
                // "ì™„ë£Œë¨ (ì½ê¸° ì „ìš©)" ì œê±°
                text = text.replace(/ì™„ë£Œë¨\s*\(ì½ê¸°\s*ì „ìš©\)/g, '').trim();
                return text || 'í…ŒìŠ¤íŠ¸ ëŸ°';
            })(),
            build_label: (() => {
                // ë¹Œë“œ ë¼ë²¨ ì°¾ê¸°
                const buildElements = Array.from(document.querySelectorAll('*')).filter(el => {
                    return el.textContent && el.textContent.includes('ğŸ·ï¸ Build:');
                });
                if (buildElements.length > 0) {
                    const text = buildElements[0].textContent;
                    const match = text.match(/Build:\s*([^\n<]+)/);
                    if (match) return match[1].trim();
                }
                return 'N/A';
            })(),
            test_results: [],
            stats: {
                total: runCases.length,
                executed: 0,
                pass: 0,
                fail: 0,
                blocked: 0,
                retest: 0,
                na: 0
            }
        };
        
        // í˜„ì¬ í˜ì´ì§€ì˜ runCases ë°ì´í„°ì—ì„œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìˆ˜ì§‘
        runCases.forEach((item, index) => {
            if (item.result && item.result.status !== 'comment') {
                // runCasesì˜ case.titleì—ëŠ” ì´ë¯¸ ìŠ¤ëƒ…ìƒ· ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆìŒ (ì„œë²„ì—ì„œ ì²˜ë¦¬ë¨)
                const caseTitle = (item.case && item.case.title) || 'ì œëª© ì—†ìŒ';
                const status = item.result.status.toUpperCase();
                
                currentPageData.test_results.push({
                    case_id: item.case ? item.case.id : null,
                    case_title: caseTitle,
                    status: status,
                    bug_links: (item.result && item.result.bug_links) || '',
                    comment: (item.result && item.result.comment) || ''
                });
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                currentPageData.stats.executed++;
                if (status === 'PASS') currentPageData.stats.pass++;
                else if (status === 'FAIL') currentPageData.stats.fail++;
                else if (status === 'BLOCKED') currentPageData.stats.blocked++;
                else if (status === 'RETEST') currentPageData.stats.retest++;
                else if (status === 'N/A') currentPageData.stats.na++;
            }
        });
        
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // 2ë‹¨ê³„: í…ŒìŠ¤íŠ¸ í™˜ê²½ ìš”ì•½ ì¤‘ (30%)
        updateProgress(30, 'ğŸ” í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„ ì¤‘...');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // 3ë‹¨ê³„: AI ìš”ì•½ ìƒì„± ì¤‘ (50%)
        updateProgress(50, 'ğŸ¤– AI ìš”ì•½ ìƒì„± ì¤‘...');
        
        const res = await fetch(`/api/runs/${runId}/generate-summary`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                prompt_id: parseInt(promptId),
                current_page_data: currentPageData  // í˜„ì¬ í˜ì´ì§€ì˜ ì‹¤ì œ ë°ì´í„° ì „ë‹¬
            })
        });
        
        // 4ë‹¨ê³„: ì‘ë‹µ ì²˜ë¦¬ ì¤‘ (80%)
        updateProgress(80, 'ğŸ“ ìš”ì•½ ë‚´ìš© ì²˜ë¦¬ ì¤‘...');
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'ìš”ì•½ ìƒì„± ì‹¤íŒ¨');
        }
        
        const data = await res.json();
        
        // 5ë‹¨ê³„: ì™„ë£Œ (100%)
        updateProgress(100, 'âœ… ìš”ì•½ ìƒì„± ì™„ë£Œ!');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // ìš”ì•½ í‘œì‹œ (ë³µì‚¬ ë²„íŠ¼ ë° ìƒˆì°½ ë²„íŠ¼ í¬í•¨)
        contentDiv.innerHTML = `
            <div style="position: relative; background: white; padding: 1rem; border-radius: 4px;">
                <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem;">
                    <button onclick="copyAISummary()" class="btn btn-sm btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;" title="AI ìš”ì•½ ë³µì‚¬">
                        ğŸ“‹ ë³µì‚¬
                    </button>
                    <button onclick="openAISummaryInNewWindow()" class="btn btn-sm btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;" title="ìƒˆ ì°½ì—ì„œ ì—´ê¸°">
                        ğŸ”— ìƒˆì°½
                    </button>
                </div>
                <div id="aiSummaryText" style="white-space: pre-wrap; line-height: 1.6; padding-right: 6rem;">${escapeHtml(data.summary)}</div>
            </div>
        `;
        contentDiv.style.display = 'block';
        progressDiv.style.display = 'none';
        
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ "ìš”ì•½ ì¬ìƒì„±"ìœ¼ë¡œ ë³€ê²½
        generateBtn.textContent = 'ìš”ì•½ ì¬ìƒì„±';
        
        showToast('âœ… AI ìš”ì•½ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    } catch (err) {
        console.error('AI ìš”ì•½ ìƒì„± ì˜¤ë¥˜:', err);
        progressDiv.style.display = 'none';
        contentDiv.style.display = 'block';
        showToast('ìš”ì•½ ìƒì„± ì‹¤íŒ¨: ' + err.message, 'error');
    } finally {
        generateBtn.disabled = false;
        if (generateBtn.textContent === 'ìƒì„± ì¤‘...') {
            generateBtn.textContent = 'ìš”ì•½ ìƒì„±';
        }
    }
}

// AI ìš”ì•½ ë³µì‚¬
function copyAISummary() {
    const summaryText = document.getElementById('aiSummaryText');
    if (!summaryText) {
        // ìš”ì•½ì´ ì—†ê±°ë‚˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°
        const contentDiv = document.getElementById('aiSummaryContent');
        if (contentDiv) {
            const textDiv = contentDiv.querySelector('div[style*="white-space: pre-wrap"]');
            if (textDiv) {
                navigator.clipboard.writeText(textDiv.textContent).then(() => {
                    showToast('AI ìš”ì•½ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }).catch(err => {
                    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                    showToast('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message, 'error');
                });
                return;
            }
        }
        showToast('ë³µì‚¬í•  ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    navigator.clipboard.writeText(summaryText.textContent).then(() => {
        showToast('AI ìš”ì•½ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        // Fallback: í…ìŠ¤íŠ¸ ì˜ì—­ì„ ì‚¬ìš©í•œ ë³µì‚¬
        const textArea = document.createElement('textarea');
        textArea.value = summaryText.textContent;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showToast('AI ìš”ì•½ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } catch (fallbackErr) {
            showToast('ë³µì‚¬ ì‹¤íŒ¨: ' + fallbackErr.message, 'error');
        }
        document.body.removeChild(textArea);
    });
}

// AI ìš”ì•½ ìƒˆì°½ì—ì„œ ì—´ê¸°
function openAISummaryInNewWindow() {
    const summaryText = document.getElementById('aiSummaryText');
    if (!summaryText) {
        showToast('ìš”ì•½ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    const newWindow = window.open('', '_blank', 'width=800,height=600');
    if (!newWindow) {
        showToast('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    newWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
                    <title>AI ìš”ì•½ - í…ŒìŠ¤íŠ¸ ëŸ°</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                    padding: 2rem;
                    max-width: 800px;
                    margin: 0 auto;
                    line-height: 1.6;
                    background: #f5f5f5;
                }
                .container {
                    background: white;
                    padding: 2rem;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                h1 {
                    margin-top: 0;
                    color: #333;
                    border-bottom: 2px solid #3498db;
                    padding-bottom: 0.5rem;
                }
                .summary-content {
                    white-space: pre-wrap;
                    word-break: break-word;
                    color: #333;
                    margin-top: 1rem;
                }
                .copy-btn {
                    margin-top: 1rem;
                    padding: 0.5rem 1rem;
                    background: #3498db;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9rem;
                }
                .copy-btn:hover {
                    background: #2980b9;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ¤– AI ìš”ì•½</h1>
                <div class="summary-content">${escapeHtml(summaryText.textContent)}</div>
                <button class="copy-btn" onclick="navigator.clipboard.writeText(\`${summaryText.textContent.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`).then(() => alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'))">ğŸ“‹ ë³µì‚¬</button>
            </div>
        </body>
        </html>
    `);
    newWindow.document.close();
}

// ============================================================
// Jira ì›ë²„íŠ¼ ë²„ê·¸ ë“±ë¡
// ============================================================

async function loadJiraPublicConfig() {
    try {
        const res = await fetch('/api/jira/config/public');
        if (!res.ok) return;
        jiraPublicConfig = await res.json();
    } catch (e) {
        jiraPublicConfig = null;
    }
}

function openJiraIssueModal() {
    const item = runCases[currentIndex];
    const caseData = item.case;
    const result = item.result;
    
    const summary = `[QuickRail][Run ${runId}] [Case #${caseData.id}] ${caseData.title}`;
    const defaultComponents = jiraPublicConfig?.default_components || '';
    const defaultLabels = jiraPublicConfig?.default_labels || `quickrail,run-${runId}`;
    const defaultPriority = jiraPublicConfig?.default_priority || '';
    
    const steps = caseData.steps || '';
    
    const descLines = [];
    descLines.push(`Run: ${runName} (ID: ${runId})`);
    if (runBuildLabel) descLines.push(`Build: ${runBuildLabel}`);
    descLines.push(`Case: #${caseData.id} ${caseData.title}`);
    descLines.push('');
    descLines.push('[Expected]');
    descLines.push(caseData.expected || '');
    descLines.push('');
    descLines.push('[Actual]');
    if (result && result.status) {
        descLines.push(`Status: ${result.status}`);
    } else {
        descLines.push('Status: (not executed)');
    }
    descLines.push('');
    descLines.push('[Quick Notes]');
    descLines.push('(í•„ìš” ì‹œ ìˆ˜ì •í•˜ì„¸ìš”)');
    
    document.getElementById('jiraSummaryInput').value = summary;
    document.getElementById('jiraComponentInput').value = defaultComponents;
    document.getElementById('jiraLabelsInput').value = defaultLabels;
    document.getElementById('jiraPriorityInput').value = defaultPriority;
    document.getElementById('jiraStepsInput').value = steps;
    document.getElementById('jiraDescriptionInput').value = descLines.join('\n');
    
    const modal = document.getElementById('jiraIssueModal');
    modal.style.display = 'flex';
}

function closeJiraIssueModal() {
    const modal = document.getElementById('jiraIssueModal');
    modal.style.display = 'none';
}

async function confirmJiraIssueModal() {
    const summary = document.getElementById('jiraSummaryInput').value.trim();
    const component = document.getElementById('jiraComponentInput').value.trim();
    const label = document.getElementById('jiraLabelsInput').value.trim();
    const priority = document.getElementById('jiraPriorityInput').value.trim();
    const steps = document.getElementById('jiraStepsInput').value;
    const description = document.getElementById('jiraDescriptionInput').value;
    
    if (!summary) {
        showToast('SummaryëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.', 'warning');
        return;
    }
    
    try {
        const res = await fetch('/api/jira/issues', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ summary, component, label, priority, steps, description })
        });
        
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
            const msg = data.error || 'Jira ì´ìŠˆ ìƒì„± ì‹¤íŒ¨';
            showToast(msg, 'error', 6000);
            return;
        }
        
        closeJiraIssueModal();
        
        if (data.issue_url) {
            // ë²„ê·¸ ë§í¬ ìë™ ì¶”ê°€
            if (!bugLinksArray.includes(data.issue_url)) {
                bugLinksArray.push(data.issue_url);
                renderBugLinks();
                saveBugLinks(); // ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë‚´ë¶€ì—ì„œ ì•ˆë‚´ í›„ return
            }
            showToast(`Jira ì´ìŠˆ ìƒì„± ì™„ë£Œ: ${data.issue_key}`, 'success', 5000);
            window.open(data.issue_url, '_blank', 'noopener,noreferrer');
        } else {
            showToast('Jira ì´ìŠˆ ìƒì„± ì™„ë£Œ', 'success', 5000);
        }
    } catch (err) {
        showToast('Jira ì´ìŠˆ ìƒì„± ì‹¤íŒ¨: ' + err.message, 'error', 6000);
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('jiraIssueModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeJiraIssueModal();
});
</script>
{% endblock %}


