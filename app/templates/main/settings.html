{% extends "base.html" %}

{% block title %}ì„¤ì • - QuickRail{% endblock %}

{% block content %}
<!-- Toast ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
<div class="toast-container" id="toastContainer"></div>

<div class="container" style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2 style="margin: 0;">âš™ï¸ ì„¤ì •</h2>
        <button class="btn btn-secondary" onclick="goToAdvancedSettings()" style="padding: 0.5rem 1rem;">
            ğŸ” ê³ ê¸‰ ì„¤ì •
        </button>
    </div>
    
    <!-- íƒ­ ë©”ë‰´ -->
    <div style="border-bottom: 2px solid #e0e0e0; margin-bottom: 2rem;">
        <div style="display: flex; gap: 1rem;">
            <button class="tab-btn active" onclick="switchTab('translation')" id="tabTranslation">
                ğŸŒ ë²ˆì—­ í”„ë¡¬í”„íŠ¸
            </button>
            <button class="tab-btn" onclick="switchTab('summary')" id="tabSummary">
                ğŸ“ ìš”ì•½ í”„ë¡¬í”„íŠ¸
            </button>
            <button class="tab-btn" onclick="switchTab('jira')" id="tabJira">
                ğŸ› Jira ì›ë²„íŠ¼
            </button>
        </div>
    </div>
    
    
    <!-- ë²ˆì—­ í”„ë¡¬í”„íŠ¸ ì„¤ì • -->
    <div id="translationSettings" class="settings-section">
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
            <h3 style="margin-top: 0;">ë²ˆì—­ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬</h3>
            <p style="color: #666; margin-bottom: 0;">
                OpenAI APIë¥¼ ì‚¬ìš©í•œ ì¼€ì´ìŠ¤ ë²ˆì—­ ì‹œ ì ìš©ë˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.<br>
                í™œì„±í™”ëœ í”„ë¡¬í”„íŠ¸ê°€ ëª¨ë“  ë²ˆì—­ì— ì ìš©ë©ë‹ˆë‹¤.
            </p>
        </div>
        
        <!-- í˜„ì¬ í™œì„± í”„ë¡¬í”„íŠ¸ -->
        <div style="background: #e8f5e9; padding: 1.5rem; border-radius: 8px; border: 2px solid #4caf50; margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="margin: 0; color: #2e7d32;">âœ“ í˜„ì¬ í™œì„± í”„ë¡¬í”„íŠ¸</h4>
                {% if current_user.role in ['Super Admin', 'admin'] %}
                <button class="btn btn-primary" onclick="editPrompt({{ active_prompt.id if active_prompt else 'null' }})" style="padding: 0.5rem 1rem;">
                    í¸ì§‘
                </button>
                {% endif %}
            </div>
            {% if active_prompt %}
            <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>ì´ë¦„:</strong> {{ active_prompt.name }}
            </div>
            <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸:</strong>
                <pre style="margin: 0.5rem 0 0 0; white-space: pre-wrap; font-family: monospace; background: #f5f5f5; padding: 0.5rem; border-radius: 4px;">{{ active_prompt.system_prompt }}</pre>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 4px;">
                <strong>ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿:</strong>
                <pre style="margin: 0.5rem 0 0 0; white-space: pre-wrap; font-family: monospace; background: #f5f5f5; padding: 0.5rem; border-radius: 4px;">{{ active_prompt.user_prompt_template }}</pre>
            </div>
            <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                <span>ìµœì¢… ìˆ˜ì •: {{ active_prompt.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
            {% else %}
            <div style="background: white; padding: 1rem; border-radius: 4px; color: #999;">
                í™œì„±í™”ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ê¸°ì¡´ í”„ë¡¬í”„íŠ¸ë¥¼ í™œì„±í™”í•˜ì„¸ìš”.
            </div>
            {% endif %}
        </div>
        
        <!-- í”„ë¡¬í”„íŠ¸ ëª©ë¡ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h4>ì €ì¥ëœ í”„ë¡¬í”„íŠ¸</h4>
            {% if current_user.role in ['Super Admin', 'admin'] %}
            <button class="btn btn-success" onclick="createNewPrompt()" style="padding: 0.5rem 1rem;">
                + ìƒˆ í”„ë¡¬í”„íŠ¸ ì¶”ê°€
            </button>
            {% endif %}
        </div>
        
        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f5f5f5;">
                    <tr>
                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">ì´ë¦„</th>
                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">ìƒíƒœ</th>
                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">ìµœì¢… ìˆ˜ì •</th>
                        {% if current_user.role in ['Super Admin', 'admin'] %}
                        <th style="padding: 1rem; text-align: center; border-bottom: 1px solid #ddd;">ì‘ì—…</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for prompt in prompts %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 1rem;">{{ prompt.name }}</td>
                        <td style="padding: 1rem;">
                            {% if prompt.is_active %}
                            <span style="background: #4caf50; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">í™œì„±</span>
                            {% else %}
                            <span style="background: #999; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">ë¹„í™œì„±</span>
                            {% endif %}
                        </td>
                        <td style="padding: 1rem; color: #666;">{{ prompt.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        {% if current_user.role in ['Super Admin', 'admin'] %}
                        <td style="padding: 1rem; text-align: center;">
                            <button class="btn btn-sm btn-primary" onclick="editPrompt({{ prompt.id }})" style="padding: 0.25rem 0.75rem; margin-right: 0.5rem;">í¸ì§‘</button>
                            {% if not prompt.is_active %}
                            <button class="btn btn-sm btn-success" onclick="activatePrompt({{ prompt.id }})" style="padding: 0.25rem 0.75rem; margin-right: 0.5rem;">í™œì„±í™”</button>
                            {% endif %}
                            {% if not prompt.is_active %}
                            <button class="btn btn-sm btn-danger" onclick="deletePrompt({{ prompt.id }})" style="padding: 0.25rem 0.75rem;">ì‚­ì œ</button>
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                    {% if not prompts %}
                    <tr>
                        <td colspan="{% if current_user.role in ['Super Admin', 'admin'] %}4{% else %}3{% endif %}" style="padding: 2rem; text-align: center; color: #999;">
                            ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ìš”ì•½ í”„ë¡¬í”„íŠ¸ ì„¤ì • -->
    <div id="summarySettings" class="settings-section" style="display: none;">
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
            <h3 style="margin-top: 0;">ìš”ì•½ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬</h3>
            <p style="color: #666; margin-bottom: 0;">
                OpenAI APIë¥¼ ì‚¬ìš©í•œ í…ŒìŠ¤íŠ¸ ëŸ° ê²°ê³¼ ìš”ì•½ ì‹œ ì ìš©ë˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.<br>
                í™œì„±í™”ëœ í”„ë¡¬í”„íŠ¸ê°€ ëª¨ë“  ìš”ì•½ì— ì ìš©ë©ë‹ˆë‹¤.
            </p>
        </div>
        
        <!-- í˜„ì¬ í™œì„± í”„ë¡¬í”„íŠ¸ -->
        <div style="background: #e8f5e9; padding: 1.5rem; border-radius: 8px; border: 2px solid #4caf50; margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="margin: 0; color: #2e7d32;">âœ“ í˜„ì¬ í™œì„± í”„ë¡¬í”„íŠ¸</h4>
                {% if current_user.role in ['Super Admin', 'admin'] %}
                <button class="btn btn-primary" onclick="editSummaryPrompt({{ active_summary_prompt.id if active_summary_prompt else 'null' }})" style="padding: 0.5rem 1rem;">
                    í¸ì§‘
                </button>
                {% endif %}
            </div>
            {% if active_summary_prompt %}
            <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>ì´ë¦„:</strong> {{ active_summary_prompt.name }}
            </div>
            <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>ì‚¬ìš© ëª¨ë¸:</strong> {{ active_summary_prompt.model }}
            </div>
            <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸:</strong>
                <pre style="background: #f5f5f5; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; white-space: pre-wrap; font-size: 0.9rem;">{{ active_summary_prompt.system_prompt }}</pre>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 4px;">
                <strong>ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿:</strong>
                <pre style="background: #f5f5f5; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; white-space: pre-wrap; font-size: 0.9rem;">{{ active_summary_prompt.user_prompt_template }}</pre>
            </div>
            {% else %}
            <div style="background: white; padding: 1rem; border-radius: 4px; color: #999;">
                í™œì„±í™”ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. í”„ë¡¬í”„íŠ¸ë¥¼ ì¶”ê°€í•˜ê³  í™œì„±í™”í•˜ì„¸ìš”.
            </div>
            {% endif %}
        </div>
        
        <!-- í”„ë¡¬í”„íŠ¸ ëª©ë¡ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h4>ì €ì¥ëœ í”„ë¡¬í”„íŠ¸</h4>
            {% if current_user.role in ['Super Admin', 'admin'] %}
            <button class="btn btn-success" onclick="createNewSummaryPrompt()" style="padding: 0.5rem 1rem;">
                + ìƒˆ í”„ë¡¬í”„íŠ¸ ì¶”ê°€
            </button>
            {% endif %}
        </div>
        
        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f5f5f5;">
                    <tr>
                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">ì´ë¦„</th>
                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">ëª¨ë¸</th>
                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">ìƒíƒœ</th>
                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">ìˆ˜ì •ì¼</th>
                        {% if current_user.role in ['Super Admin', 'admin'] %}
                        <th style="padding: 1rem; text-align: center; border-bottom: 1px solid #ddd;">ì‘ì—…</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for prompt in summary_prompts %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 1rem;">{{ prompt.name }}</td>
                        <td style="padding: 1rem;"><code>{{ prompt.model }}</code></td>
                        <td style="padding: 1rem;">
                            {% if prompt.is_active %}
                            <span style="background: #4caf50; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">í™œì„±</span>
                            {% else %}
                            <span style="background: #999; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">ë¹„í™œì„±</span>
                            {% endif %}
                        </td>
                        <td style="padding: 1rem; color: #666;">{{ prompt.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        {% if current_user.role in ['Super Admin', 'admin'] %}
                        <td style="padding: 1rem; text-align: center;">
                            <button class="btn btn-sm btn-primary" onclick="editSummaryPrompt({{ prompt.id }})" style="padding: 0.25rem 0.75rem; margin-right: 0.5rem;">í¸ì§‘</button>
                            {% if not prompt.is_active %}
                            <button class="btn btn-sm btn-success" onclick="activateSummaryPrompt({{ prompt.id }})" style="padding: 0.25rem 0.75rem; margin-right: 0.5rem;">í™œì„±í™”</button>
                            {% endif %}
                            {% if not prompt.is_active %}
                            <button class="btn btn-sm btn-danger" onclick="deleteSummaryPrompt({{ prompt.id }})" style="padding: 0.25rem 0.75rem;">ì‚­ì œ</button>
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                    {% if not summary_prompts %}
                    <tr>
                        <td colspan="{% if current_user.role in ['Super Admin', 'admin'] %}5{% else %}4{% endif %}" style="padding: 2rem; text-align: center; color: #999;">
                            ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Jira ì›ë²„íŠ¼ ì„¤ì • -->
    <div id="jiraSettings" class="settings-section" style="display: none;">
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
            <h3 style="margin-top: 0;">Jira ì›ë²„íŠ¼ ë²„ê·¸ ë“±ë¡</h3>
            <p style="color: #666; margin-bottom: 0;">
                ëŸ° ì‹¤í–‰ í™”ë©´(runs/#)ì—ì„œ <strong>â€œJira ë²„ê·¸ ë“±ë¡â€</strong> ë²„íŠ¼ì„ í†µí•´ Jira ì´ìŠˆë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ ì„¤ì •ì…ë‹ˆë‹¤.<br>
                ë¯¼ê° ì •ë³´(API Token)ëŠ” ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </div>
        
        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                <input type="checkbox" id="jiraEnabled" style="width: 18px; height: 18px;">
                <label for="jiraEnabled" style="font-weight: 600; cursor: pointer;">Jira ì›ë²„íŠ¼ ê¸°ëŠ¥ ì‚¬ìš©</label>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label style="display:block; font-weight: 600; margin-bottom: 0.35rem;">Base URL</label>
                    <input type="text" id="jiraBaseUrl" class="form-control" placeholder="https://your-domain.atlassian.net"
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display:block; font-weight: 600; margin-bottom: 0.35rem;">Email</label>
                    <input type="text" id="jiraEmail" class="form-control" placeholder="jira@example.com"
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display:block; font-weight: 600; margin-bottom: 0.35rem;">API Token</label>
                    <input type="password" id="jiraApiToken" class="form-control" placeholder="(ë¹„ì–´ìˆìœ¼ë©´ ì €ì¥ëœ í† í° ìœ ì§€)"
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                    <small style="color:#666;">Jira Cloud API Token</small>
                </div>
                <div>
                    <label style="display:block; font-weight: 600; margin-bottom: 0.35rem;">Project Key</label>
                    <input type="text" id="jiraProjectKey" class="form-control" placeholder="ì˜ˆ: P2"
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display:block; font-weight: 600; margin-bottom: 0.35rem;">Issue Type</label>
                    <input type="text" id="jiraIssueType" class="form-control" placeholder="ì˜ˆ: Bug"
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display:block; font-weight: 600; margin-bottom: 0.35rem;">Default Priority</label>
                    <input type="text" id="jiraDefaultPriority" class="form-control" placeholder="ì˜ˆ: High"
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label style="display:block; font-weight: 600; margin-bottom: 0.35rem;">Default Components (ì‰¼í‘œ êµ¬ë¶„)</label>
                    <input type="text" id="jiraDefaultComponents" class="form-control" placeholder="ì˜ˆ: UI,Matchmaking"
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label style="display:block; font-weight: 600; margin-bottom: 0.35rem;">Default Labels (ì‰¼í‘œ êµ¬ë¶„)</label>
                    <input type="text" id="jiraDefaultLabels" class="form-control" placeholder="ì˜ˆ: quickrail,run"
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>
            
            <div style="display:flex; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 1.25rem;">
                <div style="color:#666; font-size: 0.9rem;">
                    ëŸ° í˜ì´ì§€ì˜ â€œJira ë²„ê·¸ ë“±ë¡â€ ë²„íŠ¼ì€ ìœ„ ê¸°ë³¸ê°’ì„ ìë™ìœ¼ë¡œ ì±„ì›ë‹ˆë‹¤.
                </div>
                {% if current_user.role in ['Super Admin', 'admin'] %}
                <button class="btn btn-primary" onclick="saveJiraConfig()" style="padding: 0.5rem 1rem;">
                    ì €ì¥
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- í”„ë¡¬í”„íŠ¸ í¸ì§‘ ëª¨ë‹¬ -->
<div id="promptModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="modalTitle">í”„ë¡¬í”„íŠ¸ í¸ì§‘</h3>
            <button class="close" onclick="closePromptModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="promptForm">
                <input type="hidden" id="promptId">
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">í”„ë¡¬í”„íŠ¸ ì´ë¦„</label>
                    <input type="text" id="promptName" class="form-control" required 
                           placeholder="ì˜ˆ: default, custom-strict" 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666;">ì˜ë¬¸, ìˆ«ì, í•˜ì´í”ˆë§Œ ì‚¬ìš© ê°€ëŠ¥</small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</label>
                    <textarea id="systemPrompt" class="form-control" required rows="5"
                              placeholder="ì˜ˆ: You are a professional translator specializing in software testing documentation."
                              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;"></textarea>
                    <small style="color: #666;">AIì˜ ì—­í• ê³¼ ë²ˆì—­ ìŠ¤íƒ€ì¼ì„ ì •ì˜í•©ë‹ˆë‹¤.</small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿</label>
                    <textarea id="userPromptTemplate" class="form-control" required rows="8"
                              placeholder="ì˜ˆ: Translate the following text from {source_lang} to {target_lang}.&#10;Keep the same formatting and structure.&#10;&#10;Text to translate:&#10;{text}"
                              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;"></textarea>
                    <small style="color: #666;">
                        ë³€ìˆ˜: {source_lang}, {target_lang}, {text}<br>
                        ì˜ˆ: ëª¨ë“  ì¼€ì´ìŠ¤ëŠ” "Check if"ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.
                    </small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">OpenAI ëª¨ë¸</label>
                    <select id="promptModel" class="form-control" required 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                            onchange="updateModelInfo()">
                        <option value="">ë¡œë”© ì¤‘...</option>
                    </select>
                    <div id="modelInfo" style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem;">
                        ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closePromptModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ìš”ì•½ í”„ë¡¬í”„íŠ¸ í¸ì§‘ ëª¨ë‹¬ -->
<div id="summaryPromptModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="summaryModalTitle">ìš”ì•½ í”„ë¡¬í”„íŠ¸ í¸ì§‘</h3>
            <button class="close" onclick="closeSummaryPromptModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="summaryPromptForm">
                <input type="hidden" id="summaryPromptId">
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">í”„ë¡¬í”„íŠ¸ ì´ë¦„</label>
                    <input type="text" id="summaryPromptName" class="form-control" required 
                           placeholder="ì˜ˆ: default, sms-style" 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666;">ì˜ë¬¸, ìˆ«ì, í•˜ì´í”ˆë§Œ ì‚¬ìš© ê°€ëŠ¥</small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</label>
                    <textarea id="summarySystemPrompt" class="form-control" required rows="5"
                              placeholder="ì˜ˆ: You are a professional QA engineer summarizing test run results."
                              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;"></textarea>
                    <small style="color: #666;">AIì˜ ì—­í• ê³¼ ìš”ì•½ ìŠ¤íƒ€ì¼ì„ ì •ì˜í•©ë‹ˆë‹¤.</small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿</label>
                    <textarea id="summaryUserPromptTemplate" class="form-control" required rows="10"
                              placeholder="ì˜ˆ: [í™˜ê²½]&#10;- ë¹Œë“œ: {build_label}&#10;- ë°±ì—”ë“œ: {backend_info}&#10;&#10;[ì£¼ìš”í™•ì¸ë‚´ì—­]&#10;{test_results}&#10;&#10;[ì°¸ê³ ì‚¬í•­]&#10;{notes}"
                              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;"></textarea>
                    <small style="color: #666;">
                        ë³€ìˆ˜: {build_label}, {backend_info}, {test_results}, {notes} ë“±<br>
                        í…ŒìŠ¤íŠ¸ ëŸ° ê²°ê³¼ë¥¼ ìš”ì•½í•˜ëŠ” í˜•ì‹ì„ ì •ì˜í•©ë‹ˆë‹¤.
                    </small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">OpenAI ëª¨ë¸</label>
                    <select id="summaryPromptModel" class="form-control" required 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                            onchange="updateSummaryModelInfo()">
                        <option value="">ë¡œë”© ì¤‘...</option>
                    </select>
                    <div id="summaryModelInfo" style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem;">
                        ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeSummaryPromptModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.tab-btn {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 1rem;
    color: #666;
    transition: all 0.3s;
}

.tab-btn:hover {
    color: #333;
    background: #f5f5f5;
}

.tab-btn.active {
    color: #3498db;
    border-bottom-color: #3498db;
    font-weight: bold;
}

.settings-section {
    display: block;
}

.btn-sm {
    font-size: 0.85rem;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 0;
    border: 1px solid #888;
    width: 90%;
    max-width: 600px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
}

.modal-body {
    padding: 1.5rem;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    border: none;
    background: none;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #000;
}

/* Toast ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
.toast-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.toast {
    background: #2ecc71;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 300px;
    max-width: 400px;
    animation: slideInRight 0.3s ease-out;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 500;
}

.toast.error {
    background: #e74c3c;
}

.toast.warning {
    background: #f39c12;
}

.toast.info {
    background: #3498db;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.toast.hiding {
    animation: slideOutRight 0.3s ease-out forwards;
}
</style>

<script>
// Toast ì•Œë¦¼ í•¨ìˆ˜
function showToast(message, type = 'success', duration = 3000) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    // ì•„ì´ì½˜ ì„¤ì •
    let icon = 'âœ“';
    if (type === 'error') icon = 'âœ•';
    else if (type === 'warning') icon = 'âš ';
    else if (type === 'info') icon = 'â„¹';
    
    toast.innerHTML = `
        <span style="font-size: 1.2rem;">${icon}</span>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    // ìë™ ì œê±°
    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, duration);
}

function switchTab(tabName) {
    // íƒ­ ë²„íŠ¼ í™œì„±í™”
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
    
    // ì„¹ì…˜ í‘œì‹œ
    document.querySelectorAll('.settings-section').forEach(section => section.style.display = 'none');
    document.getElementById(tabName + 'Settings').style.display = 'block';

    // Jira íƒ­ ì§„ì… ì‹œ ì„¤ì • ë¡œë“œ
    if (tabName === 'jira') {
        loadJiraConfigIfNeeded();
    }
}

// ê³ ê¸‰ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™
function goToAdvancedSettings() {
    // ê¶Œí•œ ì²´í¬ë¥¼ ìœ„í•´ ì„œë²„ì— ìš”ì²­
    fetch("{{ url_for('main.advanced_settings') }}", {
        method: 'HEAD',
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.ok) {
            // ê¶Œí•œì´ ìˆìœ¼ë©´ í˜ì´ì§€ ì´ë™
            window.location.href = "{{ url_for('main.advanced_settings') }}";
        } else if (response.status === 403) {
            // ê¶Œí•œì´ ì—†ìœ¼ë©´ Toast ì•Œë¦¼ í‘œì‹œ
            showToast('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        } else {
            showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    })
    .catch(err => {
        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±ìœ¼ë¡œ ì¸í•´ HEAD ìš”ì²­ì´ ì‹¤íŒ¨í•˜ë©´ GET ìš”ì²­ìœ¼ë¡œ ì‹œë„
        // (ì‹¤ì œë¡œëŠ” í˜ì´ì§€ ì´ë™ ì‹œ ì„œë²„ì—ì„œ ê¶Œí•œ ì²´í¬ê°€ ì´ë£¨ì–´ì§)
        window.location.href = "{{ url_for('main.advanced_settings') }}";
    });
}

// ì „ì—­ ë³€ìˆ˜: ëª¨ë¸ ëª©ë¡
let availableModels = [];

// í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
async function loadModels() {
    try {
        const res = await fetch('/api/translation-models');
        if (res.ok) {
            availableModels = await res.json();
        }
    } catch (err) {
        console.error('ëª¨ë¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
    }
}

// ëª¨ë¸ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
function populateModelSelect(selectedModel = 'gpt-4o-mini') {
    const select = document.getElementById('promptModel');
    select.innerHTML = '';
    
    availableModels.forEach(model => {
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = `${model.name}${model.recommended ? ' â­ ì¶”ì²œ' : ''}`;
        if (model.id === selectedModel) {
            option.selected = true;
        }
        select.appendChild(option);
    });
    
    updateModelInfo();
}

// ëª¨ë¸ ì •ë³´ ì—…ë°ì´íŠ¸
function updateModelInfo() {
    const select = document.getElementById('promptModel');
    const infoDiv = document.getElementById('modelInfo');
    const selectedModelId = select.value;
    
    const model = availableModels.find(m => m.id === selectedModelId);
    if (model) {
        let html = `<div style="line-height: 1.6;">`;
        html += `<strong>${model.name}</strong><br>`;
        html += `${model.description}<br>`;
        html += `<div style="margin-top: 0.5rem; font-family: monospace; font-size: 0.85rem;">`;
        html += `â€¢ ì…ë ¥: $${model.input_price.toFixed(2)} / 1M tokens<br>`;
        html += `â€¢ ì¶œë ¥: $${model.output_price.toFixed(2)} / 1M tokens`;
        html += `</div>`;
        html += `</div>`;
        infoDiv.innerHTML = html;
        
        // ì¶”ì²œ ëª¨ë¸ì€ ë°°ê²½ìƒ‰ ë³€ê²½
        if (model.recommended) {
            infoDiv.style.background = '#e8f5e9';
            infoDiv.style.border = '1px solid #4caf50';
        } else {
            infoDiv.style.background = '#f8f9fa';
            infoDiv.style.border = 'none';
        }
    }
}

async function createNewPrompt() {
    await loadModels();
    
    document.getElementById('modalTitle').textContent = 'ìƒˆ í”„ë¡¬í”„íŠ¸ ì¶”ê°€';
    document.getElementById('promptId').value = '';
    document.getElementById('promptName').value = '';
    document.getElementById('systemPrompt').value = 'You are a professional translator specializing in software testing documentation.';
    document.getElementById('userPromptTemplate').value = 'Translate the following text from {source_lang} to {target_lang}.\nKeep the same formatting and structure. Only provide the translation, no explanations.\n\nText to translate:\n{text}';
    
    populateModelSelect('gpt-4o-mini');
    document.getElementById('promptModal').classList.add('show');
}

async function editPrompt(promptId) {
    try {
        await loadModels();
        
        const res = await fetch(`/api/translation-prompts/${promptId}`);
        if (!res.ok) throw new Error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨');
        
        const prompt = await res.json();
        
        document.getElementById('modalTitle').textContent = 'í”„ë¡¬í”„íŠ¸ í¸ì§‘';
        document.getElementById('promptId').value = prompt.id;
        document.getElementById('promptName').value = prompt.name;
        document.getElementById('systemPrompt').value = prompt.system_prompt;
        document.getElementById('userPromptTemplate').value = prompt.user_prompt_template;
        
        populateModelSelect(prompt.model || 'gpt-4o-mini');
        document.getElementById('promptModal').classList.add('show');
    } catch (err) {
        alert('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
    }
}

async function activatePrompt(promptId) {
    if (!confirm('ì´ í”„ë¡¬í”„íŠ¸ë¥¼ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const res = await fetch(`/api/translation-prompts/${promptId}/activate`, {
            method: 'POST'
        });
        
        if (!res.ok) throw new Error('í™œì„±í™” ì‹¤íŒ¨');
        
        alert('í”„ë¡¬í”„íŠ¸ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.reload();
    } catch (err) {
        alert('í™œì„±í™” ì‹¤íŒ¨: ' + err.message);
    }
}

async function deletePrompt(promptId) {
    if (!confirm('ì´ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const res = await fetch(`/api/translation-prompts/${promptId}`, {
            method: 'DELETE'
        });
        
        if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
        
        alert('í”„ë¡¬í”„íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.reload();
    } catch (err) {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
    }
}

function closePromptModal() {
    document.getElementById('promptModal').classList.remove('show');
}

// í¼ ì œì¶œ
document.getElementById('promptForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const promptId = document.getElementById('promptId').value;
    const data = {
        name: document.getElementById('promptName').value,
        system_prompt: document.getElementById('systemPrompt').value,
        user_prompt_template: document.getElementById('userPromptTemplate').value,
        model: document.getElementById('promptModel').value
    };
    
    try {
        const url = promptId ? `/api/translation-prompts/${promptId}` : '/api/translation-prompts';
        const method = promptId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'ì €ì¥ ì‹¤íŒ¨');
        }
        
        const selectedModel = availableModels.find(m => m.id === data.model);
        alert(`í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚¬ìš© ëª¨ë¸: ${selectedModel ? selectedModel.name : data.model}`);
        location.reload();
    } catch (err) {
        alert('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
    }
});

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('promptModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePromptModal();
    }
});

// ============================================================
// ìš”ì•½ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ í•¨ìˆ˜
// ============================================================

async function createNewSummaryPrompt() {
    await loadModels();
    
    document.getElementById('summaryModalTitle').textContent = 'ìƒˆ ìš”ì•½ í”„ë¡¬í”„íŠ¸ ì¶”ê°€';
    document.getElementById('summaryPromptId').value = '';
    document.getElementById('summaryPromptName').value = '';
    document.getElementById('summarySystemPrompt').value = '';
    document.getElementById('summaryUserPromptTemplate').value = '';
    document.getElementById('summaryPromptModel').value = '';
    
    // ëª¨ë¸ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
    populateSummaryModelSelect();
    
    document.getElementById('summaryPromptModal').classList.add('show');
}

async function editSummaryPrompt(promptId) {
    try {
        await loadModels();
        
        const res = await fetch(`/api/summary-prompts/${promptId}`);
        if (!res.ok) throw new Error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨');
        
        const prompt = await res.json();
        
        document.getElementById('summaryModalTitle').textContent = 'ìš”ì•½ í”„ë¡¬í”„íŠ¸ í¸ì§‘';
        document.getElementById('summaryPromptId').value = prompt.id;
        document.getElementById('summaryPromptName').value = prompt.name;
        document.getElementById('summarySystemPrompt').value = prompt.system_prompt;
        document.getElementById('summaryUserPromptTemplate').value = prompt.user_prompt_template;
        
        // ëª¨ë¸ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        populateSummaryModelSelect(prompt.model);
        
        document.getElementById('summaryPromptModal').classList.add('show');
    } catch (err) {
        alert('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
    }
}

function closeSummaryPromptModal() {
    document.getElementById('summaryPromptModal').classList.remove('show');
}

async function activateSummaryPrompt(promptId) {
    if (!confirm('ì´ í”„ë¡¬í”„íŠ¸ë¥¼ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const res = await fetch(`/api/summary-prompts/${promptId}/activate`, {
            method: 'POST'
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'í™œì„±í™” ì‹¤íŒ¨');
        }
        
        alert('í”„ë¡¬í”„íŠ¸ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.reload();
    } catch (err) {
        alert('í™œì„±í™” ì‹¤íŒ¨: ' + err.message);
    }
}

async function deleteSummaryPrompt(promptId) {
    if (!confirm('ì´ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const res = await fetch(`/api/summary-prompts/${promptId}`, {
            method: 'DELETE'
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'ì‚­ì œ ì‹¤íŒ¨');
        }
        
        alert('í”„ë¡¬í”„íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.reload();
    } catch (err) {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
    }
}

// ëª¨ë¸ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° (ìš”ì•½ í”„ë¡¬í”„íŠ¸ìš©)
function populateSummaryModelSelect(selectedModel = 'gpt-4o-mini') {
    const select = document.getElementById('summaryPromptModel');
    select.innerHTML = '';
    
    availableModels.forEach(model => {
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = model.name;
        if (model.id === selectedModel) {
            option.selected = true;
        }
        select.appendChild(option);
    });
    
    updateSummaryModelInfo();
}

function updateSummaryModelInfo() {
    const select = document.getElementById('summaryPromptModel');
    const modelId = select.value;
    const infoDiv = document.getElementById('summaryModelInfo');
    
    if (!modelId) {
        infoDiv.textContent = 'ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”';
        return;
    }
    
    const model = availableModels.find(m => m.id === modelId);
    if (model) {
        infoDiv.innerHTML = `<strong>${model.name}</strong><br>${model.description || ''}`;
    } else {
        infoDiv.textContent = 'ëª¨ë¸ ì •ë³´ ì—†ìŒ';
    }
}

// í¼ ì œì¶œ (ìš”ì•½ í”„ë¡¬í”„íŠ¸)
document.getElementById('summaryPromptForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const promptId = document.getElementById('summaryPromptId').value;
    const data = {
        name: document.getElementById('summaryPromptName').value,
        system_prompt: document.getElementById('summarySystemPrompt').value,
        user_prompt_template: document.getElementById('summaryUserPromptTemplate').value,
        model: document.getElementById('summaryPromptModel').value
    };
    
    try {
        const url = promptId ? `/api/summary-prompts/${promptId}` : '/api/summary-prompts';
        const method = promptId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'ì €ì¥ ì‹¤íŒ¨');
        }
        
        const selectedModel = availableModels.find(m => m.id === data.model);
        alert(`í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚¬ìš© ëª¨ë¸: ${selectedModel ? selectedModel.name : data.model}`);
        location.reload();
    } catch (err) {
        alert('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
    }
});

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('summaryPromptModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeSummaryPromptModal();
    }
});

// ============================================================
// Jira ì›ë²„íŠ¼ ì„¤ì •
// ============================================================

let jiraConfigLoaded = false;

async function loadJiraConfigIfNeeded() {
    if (jiraConfigLoaded) return;
    jiraConfigLoaded = true;
    await loadJiraConfig();
}

function _setInputValue(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.type === 'checkbox') {
        el.checked = !!value;
    } else {
        el.value = value ?? '';
    }
}

async function loadJiraConfig() {
    // Adminì´ë©´ /api/jira/config, ì•„ë‹ˆë©´ publicë¡œ fallback
    try {
        const res = await fetch('/api/jira/config');
        if (res.ok) {
            const cfg = await res.json();
            _setInputValue('jiraEnabled', cfg.enabled);
            _setInputValue('jiraBaseUrl', cfg.base_url);
            _setInputValue('jiraEmail', cfg.email);
            _setInputValue('jiraApiToken', cfg.api_token);
            _setInputValue('jiraProjectKey', cfg.project_key);
            _setInputValue('jiraIssueType', cfg.issue_type);
            _setInputValue('jiraDefaultComponents', cfg.default_components);
            _setInputValue('jiraDefaultLabels', cfg.default_labels);
            _setInputValue('jiraDefaultPriority', cfg.default_priority);
            return;
        }
    } catch (e) {
        // ignore and try public
    }
    
    try {
        const res2 = await fetch('/api/jira/config/public');
        if (!res2.ok) return;
        const cfg = await res2.json();
        _setInputValue('jiraEnabled', cfg.enabled);
        _setInputValue('jiraBaseUrl', cfg.base_url);
        _setInputValue('jiraProjectKey', cfg.project_key);
        _setInputValue('jiraIssueType', cfg.issue_type);
        _setInputValue('jiraDefaultComponents', cfg.default_components);
        _setInputValue('jiraDefaultLabels', cfg.default_labels);
        _setInputValue('jiraDefaultPriority', cfg.default_priority);
        // ë¹„ê´€ë¦¬ìëŠ” ë¯¼ê° ì •ë³´ëŠ” ë¹„ì›€
        _setInputValue('jiraEmail', '');
        _setInputValue('jiraApiToken', '');
    } catch (e) {
        // ignore
    }
}

async function saveJiraConfig() {
    const payload = {
        enabled: document.getElementById('jiraEnabled').checked,
        base_url: document.getElementById('jiraBaseUrl').value,
        email: document.getElementById('jiraEmail').value,
        api_token: document.getElementById('jiraApiToken').value,
        project_key: document.getElementById('jiraProjectKey').value,
        issue_type: document.getElementById('jiraIssueType').value,
        default_components: document.getElementById('jiraDefaultComponents').value,
        default_labels: document.getElementById('jiraDefaultLabels').value,
        default_priority: document.getElementById('jiraDefaultPriority').value
    };
    
    try {
        const res = await fetch('/api/jira/config', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || 'ì €ì¥ ì‹¤íŒ¨');
        }
        
        showToast('Jira ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        // í† í° ì…ë ¥ì€ ë³´ì•ˆìƒ ì¬ì…ë ¥ ìœ ë„ (í•„ìš”ì‹œ ì‚¬ìš©ì ì„ íƒ)
        // jiraConfigLoaded ìœ ì§€
    } catch (e) {
        showToast('Jira ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error', 6000);
    }
}
</script>
{% endblock %}

