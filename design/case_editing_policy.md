# 케이스 편집 정책 (Case Editing Policy)

## 개요
QuickRail에서는 테스트 케이스의 버전 관리와 런(Run) 실행 중 편의성을 모두 고려한 케이스 편집 정책을 적용합니다.

## 정책 상세

### 1. 케이스 버전 관리
- 케이스의 제목, 스텝, 기대 결과가 변경될 때마다 버전이 자동으로 증가합니다.
- 초기 버전은 `v1`이며, 내용 변경 시 `v2`, `v3`, ... 순으로 증가합니다.
- 우선순위, 담당자, 태그 등의 메타데이터 변경은 버전에 영향을 주지 않습니다.

### 2. 런 생성 시 스냅샷
- 런이 생성될 때 각 케이스의 현재 내용이 `RunCase` 테이블에 스냅샷으로 저장됩니다.
- 저장되는 스냅샷 데이터:
  - `title_snapshot`: 케이스 제목
  - `steps_snapshot`: 테스트 스텝
  - `expected_result_snapshot`: 기대 결과
  - `case_version_snapshot`: 케이스 버전

### 3. 런 실행 중 케이스 편집

#### 3.1 진행 중인 런 (Status: Open)
**편집 가능 ✅**
- 런 실행 페이지에서 케이스 제목, 스텝, 기대 결과를 직접 편집할 수 있습니다.
- 편집 시 **원본 케이스(`Case` 테이블)**가 수정되며, 버전이 증가합니다.
- 진행 중인 런은 항상 **현재 케이스 데이터**를 표시합니다.
- 다른 진행 중인 런들도 동일하게 업데이트된 내용을 보게 됩니다.

**장점:**
- 테스트 중 발견한 오타나 불명확한 내용을 즉시 수정 가능
- Cases 페이지로 이동할 필요 없이 워크플로우가 간편함
- 실시간으로 케이스 품질 개선 가능

**주의사항:**
- 여러 테스터가 동시에 같은 케이스를 실행 중일 경우, 한 테스터의 수정이 다른 테스터에게도 반영됩니다.
- 중요한 내용 변경 시 팀원들과 커뮤니케이션이 필요할 수 있습니다.

#### 3.2 완료된 런 (Status: Closed)
**편집 불가 🔒**
- 완료된 런에서는 케이스를 편집할 수 없습니다.
- 완료된 런은 **런 생성 시점의 스냅샷 데이터**를 표시합니다.
- 원본 케이스가 변경되어도 완료된 런의 내용은 변경되지 않습니다.

**장점:**
- 테스트 결과의 신뢰성과 재현성 보장
- 과거 테스트가 어떤 내용으로 수행되었는지 정확히 추적 가능
- 감사(Audit) 및 규정 준수 요구사항 충족

## 구현 세부사항

### API 동작
```python
# /api/runs/<run_id>/cases GET 엔드포인트
if run.status == 'closed':
    # 완료된 런: 스냅샷 데이터 사용
    case_title = rc.title_snapshot or rc.case.title
    case_steps = rc.steps_snapshot or rc.case.steps
    case_expected = rc.expected_result_snapshot or rc.case.expected_result
    case_version = rc.case_version_snapshot or rc.case.version or 1
else:
    # 진행 중인 런: 현재 데이터 사용
    case_title = rc.case.title
    case_steps = rc.case.steps
    case_expected = rc.case.expected_result
    case_version = rc.case.version or 1
```

### UI 표시
- **진행 중인 런**: "💡 클릭하여 편집 가능 (원본 케이스에 반영됩니다)"
- **완료된 런**: "🔒 완료된 런 - 런 생성 시점의 케이스 내용 (v2)"

## 사용 시나리오

### 시나리오 1: 테스트 중 오타 발견
1. 테스터가 런 실행 중 케이스 제목에 오타를 발견
2. 런 실행 페이지에서 바로 수정
3. 원본 케이스가 업데이트되고 버전 증가 (v1 → v2)
4. 같은 케이스를 실행 중인 다른 테스터도 수정된 내용을 보게 됨
5. 나중에 생성되는 런은 v2 내용으로 스냅샷 생성

### 시나리오 2: 완료된 런의 케이스 변경
1. 런 A가 완료됨 (케이스 v1 스냅샷 저장)
2. 나중에 케이스 내용이 수정됨 (v1 → v2)
3. 런 A를 다시 열어보면 여전히 v1 내용이 표시됨
4. 새로운 런 B를 생성하면 v2 내용으로 스냅샷 생성

### 시나리오 3: 동시 실행 중인 런들
1. 런 A와 런 B가 동시에 진행 중 (둘 다 케이스 v1)
2. 런 A에서 케이스를 수정 (v1 → v2)
3. 런 B를 새로고침하면 v2 내용이 표시됨
4. 두 런 모두 완료 후, 둘 다 v2 스냅샷을 가지게 됨

## 향후 개선 방안

### 옵션: 런별 독립 스냅샷 편집
현재는 원본 케이스를 수정하는 방식이지만, 향후 다음과 같은 기능을 추가할 수 있습니다:
- 런 실행 중 케이스 수정 시 해당 런의 스냅샷만 업데이트
- 원본 케이스는 수정하지 않음
- 런마다 독립적인 케이스 내용 유지 가능

이 방식은 더 높은 격리성을 제공하지만, 구현 복잡도가 증가하고 케이스 관리가 어려워질 수 있습니다.

## 관련 테스트 케이스
- [TC-P1-010]: 런 생성 후 케이스 내용 변경 시 완료된 런 스냅샷 유지
- [TC-P1-011]: 케이스 버전 증가 확인
- [TC-P1-012]: 완료된 런의 케이스 내용 불변성 확인

## 변경 이력
- 2026-01-05: 초기 정책 문서 작성 (Phase 1 구현 완료)


